<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=9"/>
		<meta name="generator" content="Doxygen 1.8.14"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>Dash Core: src/net_processing.cpp Source File</title>
		<link href="tabs.css" rel="stylesheet" type="text/css"/>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="dynsections.js"></script>
		<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
		<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
		<link href="doxygen.css" rel="stylesheet" type="text/css" />
		<link href="doxygen_stylesheetextra.css" rel="stylesheet" type="text/css"/>
	</head>
	<body>
		<div class="head"><div>
		<!--<a id="menumobile" class="menumobile" onclick="mobileMenuShow(event);" ontouchstart="mobileMenuShow(event);"></a>-->
		<a class="logo" href="/en/"><img src="logotop.png" alt="Dash"></img></a>
		<ul id="menusimple" class="menusimple menumain" onclick="mobileMenuHover(event);" ontouchstart="mobileMenuHover(event);">
		  <li><a href="/en/dash-for-developers">Developers</a></li>
		  <li><a>Documentation</a>
			<ul>
			  <li><a href="/en/developer-guide">Guide</a></li>
			  <li><a href="/en/developer-reference">Reference</a></li>
			  <li><a href="/en/developer-examples">Examples</a></li>
			  <li><a href="/en/developer-glossary">Glossary</a></li>
			</ul>
		  </li>
		  <li><a>Resources</a>
			<ul>
			  <li><a rel="noopener noreferrer" target="_blank" href="https://www.dash.org/community/">Community</a></li>
			  <li><a href="/en/vocabulary">Vocabulary</a></li>
			</ul>
		  </li>
		</ul>
		</div></div>
		<div class="body">
		<div class="breadcrumbs"></div>
		<div id="content" class="content">
		  <!-- <link rel="stylesheet" href="/css/jquery-ui.min.css"> -->
		  <h1>Dash Core Source Documentation (0.16.0.1)</h1>
		  <p class="summary">Find detailed information regarding the Dash Core source code.</p>
		<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
		<!--
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
			 <tbody>
			 <tr style="height: 56px;">
			  <td id="projectlogo"><img alt="Logo" src="logotop.png"/></td>
			  <td id="projectalign" style="padding-left: 0.5em;">
			   <div id="projectname">Dash Core
			   &#160;<span id="projectnumber">0.16.0.1</span>
			   </div>
			   <div id="projectbrief">P2P Digital Currency</div>
			  </td>
			 </tr>
			 </tbody>
			</table>
		</div>
		-->
		<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('net__processing_8cpp_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">net_processing.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="net__processing_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// Copyright (c) 2009-2010 Satoshi Nakamoto</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// Copyright (c) 2009-2016 The Bitcoin Core developers</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Distributed under the MIT software license, see the accompanying</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// file COPYING or http://www.opensource.org/licenses/mit-license.php.</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="net__processing_8h.html">net_processing.h</a>&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="addrman_8h.html">addrman.h</a>&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="arith__uint256_8h.html">arith_uint256.h</a>&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="blockencodings_8h.html">blockencodings.h</a>&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="chainparams_8h.html">chainparams.h</a>&gt;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="consensus_2validation_8h.html">consensus/validation.h</a>&gt;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="hash_8h.html">hash.h</a>&gt;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="init_8h.html">init.h</a>&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="consensus_2validation_8h.html">validation.h</a>&gt;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="merkleblock_8h.html">merkleblock.h</a>&gt;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="netmessagemaker_8h.html">netmessagemaker.h</a>&gt;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="netbase_8h.html">netbase.h</a>&gt;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="policy_2fees_8h.html">policy/fees.h</a>&gt;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="policy_8h.html">policy/policy.h</a>&gt;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="block_8h.html">primitives/block.h</a>&gt;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="transaction_8h.html">primitives/transaction.h</a>&gt;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="random_8h.html">random.h</a>&gt;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="reverse__iterator_8h.html">reverse_iterator.h</a>&gt;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="scheduler_8h.html">scheduler.h</a>&gt;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="tinyformat_8h.html">tinyformat.h</a>&gt;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="txdb_8h.html">txdb.h</a>&gt;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="txmempool_8h.html">txmempool.h</a>&gt;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="ui__interface_8h.html">ui_interface.h</a>&gt;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="util_8h.html">util.h</a>&gt;</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="utilmoneystr_8h.html">utilmoneystr.h</a>&gt;</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="utilstrencodings_8h.html">utilstrencodings.h</a>&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;memory&gt;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="spork_8h.html">spork.h</a>&gt;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="governance_8h.html">governance/governance.h</a>&gt;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="masternode-payments_8h.html">masternode/masternode-payments.h</a>&gt;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="masternode-sync_8h.html">masternode/masternode-sync.h</a>&gt;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="masternode-meta_8h.html">masternode/masternode-meta.h</a>&gt;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#ifdef ENABLE_WALLET</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="privatesend-client_8h.html">privatesend/privatesend-client.h</a>&gt;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#endif // ENABLE_WALLET</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="privatesend-server_8h.html">privatesend/privatesend-server.h</a>&gt;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="deterministicmns_8h.html">evo/deterministicmns.h</a>&gt;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="mnauth_8h.html">evo/mnauth.h</a>&gt;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="simplifiedmns_8h.html">evo/simplifiedmns.h</a>&gt;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__blockprocessor_8h.html">llmq/quorums_blockprocessor.h</a>&gt;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__commitment_8h.html">llmq/quorums_commitment.h</a>&gt;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__chainlocks_8h.html">llmq/quorums_chainlocks.h</a>&gt;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__dkgsessionmgr_8h.html">llmq/quorums_dkgsessionmgr.h</a>&gt;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__init_8h.html">llmq/quorums_init.h</a>&gt;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__instantsend_8h.html">llmq/quorums_instantsend.h</a>&gt;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__signing_8h.html">llmq/quorums_signing.h</a>&gt;</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="quorums__signing__shares_8h.html">llmq/quorums_signing_shares.h</a>&gt;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#if defined(NDEBUG)</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor"># error &quot;Dash Core cannot be compiled without assertions.&quot;</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aa22ab8b72b51c86621b28b923dd85605">   63</a></span>&#160;<span class="keyword">static</span> constexpr int32_t <a class="code" href="net__processing_8cpp.html#aa22ab8b72b51c86621b28b923dd85605">MAX_PEER_OBJECT_IN_FLIGHT</a> = 100;</div><div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ac6b3b660a36c39312cd3247d5da77715">   65</a></span>&#160;<span class="keyword">static</span> constexpr int32_t <a class="code" href="net__processing_8cpp.html#ac6b3b660a36c39312cd3247d5da77715">MAX_PEER_OBJECT_ANNOUNCEMENTS</a> = 2 * <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>;</div><div class="line"><a name="l00067"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aae4bc03700ef51a1dd9e63a6c9dfd47f">   67</a></span>&#160;<span class="keyword">static</span> constexpr std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#aae4bc03700ef51a1dd9e63a6c9dfd47f">INBOUND_PEER_TX_DELAY</a>{std::chrono::seconds{2}};</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a7d2c75d05297fcd566c04189def2b3fa">   69</a></span>&#160;<span class="keyword">static</span> constexpr std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#a7d2c75d05297fcd566c04189def2b3fa">GETDATA_TX_INTERVAL</a>{std::chrono::seconds{60}};</div><div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aae936f7cf0174e2378c22419a18f0f60">   71</a></span>&#160;<span class="keyword">static</span> constexpr std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#aae936f7cf0174e2378c22419a18f0f60">MAX_GETDATA_RANDOM_DELAY</a>{std::chrono::seconds{2}};</div><div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ab4092bed1a4f5967d73212e8b92db3e6">   73</a></span>&#160;<span class="keyword">static</span> constexpr int64_t <a class="code" href="net__processing_8cpp.html#ab4092bed1a4f5967d73212e8b92db3e6">TX_EXPIRY_INTERVAL_FACTOR</a> = 10;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;static_assert(<a class="code" href="net__processing_8cpp.html#aae4bc03700ef51a1dd9e63a6c9dfd47f">INBOUND_PEER_TX_DELAY</a> &gt;= <a class="code" href="net__processing_8cpp.html#aae936f7cf0174e2378c22419a18f0f60">MAX_GETDATA_RANDOM_DELAY</a>,</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="stringliteral">&quot;To preserve security, MAX_GETDATA_RANDOM_DELAY should not exceed INBOUND_PEER_DELAY&quot;</span>);</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a94d0bd41756163cb0cc58f36d8d6676a">   77</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#a94d0bd41756163cb0cc58f36d8d6676a">MAX_GETDATA_SZ</a> = 1000;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;std::atomic&lt;int64_t&gt; <a class="code" href="net__processing_8cpp.html#a147efbcf1410c50c56547340f1fe1ebd">nTimeBestReceived</a>(0); <span class="comment">// Used only to inform the wallet of when we last received a block</span></div><div class="line"><a name="l00080"></a><span class="lineno"><a class="line" href="net__processing_8h.html#a49bc6b19f6102a0e3809e9debbbef3e2">   80</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a> = <a class="code" href="net__processing_8h.html#ae40c02b91a2a019adcb76e5ead8785a0">DEFAULT_ENABLE_BIP61</a>;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="struct_iterator_comparator.html">   82</a></span>&#160;<span class="keyword">struct </span><a class="code" href="struct_iterator_comparator.html">IteratorComparator</a></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;{</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> I&gt;</div><div class="line"><a name="l00085"></a><span class="lineno"><a class="line" href="struct_iterator_comparator.html#a555d49207b43bdc2e33d06581254d6c1">   85</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="struct_iterator_comparator.html#a555d49207b43bdc2e33d06581254d6c1">operator()</a>(<span class="keyword">const</span> I&amp; a, <span class="keyword">const</span> I&amp; b)<span class="keyword"> const</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">    </span>{</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">return</span> &amp;(*a) &lt; &amp;(*b);</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;};</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno"><a class="line" href="struct_c_orphan_tx.html">   91</a></span>&#160;<span class="keyword">struct </span><a class="code" href="struct_c_orphan_tx.html">COrphanTx</a> {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">// When modifying, adapt the copy of this definition in tests/DoS_tests.</span></div><div class="line"><a name="l00093"></a><span class="lineno"><a class="line" href="struct_c_orphan_tx.html#abe878e681f993451d5433d3e12261cb4">   93</a></span>&#160;    <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a> <a class="code" href="struct_c_orphan_tx.html#abe878e681f993451d5433d3e12261cb4">tx</a>;</div><div class="line"><a name="l00094"></a><span class="lineno"><a class="line" href="struct_c_orphan_tx.html#a06fa313a474fd4e6d0ed20bda7cbe69c">   94</a></span>&#160;    <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> <a class="code" href="struct_c_orphan_tx.html#a06fa313a474fd4e6d0ed20bda7cbe69c">fromPeer</a>;</div><div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="struct_c_orphan_tx.html#a09fd824b19c2e8433b44145b7b64f010">   95</a></span>&#160;    int64_t <a class="code" href="struct_c_orphan_tx.html#a09fd824b19c2e8433b44145b7b64f010">nTimeExpire</a>;</div><div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="struct_c_orphan_tx.html#a773aa46801b0dfe3c42f033857bd8830">   96</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="struct_c_orphan_tx.html#a773aa46801b0dfe3c42f033857bd8830">nTxSize</a>;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;};</div><div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">   98</a></span>&#160;<span class="keyword">static</span> <a class="code" href="class_c_critical_section.html">CCriticalSection</a> <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;std::map&lt;uint256, COrphanTx&gt; mapOrphanTransactions <a class="code" href="net__processing_8cpp.html#a96443a5441d3ad2850b2fbd7ad468014">GUARDED_BY</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;std::map&lt;COutPoint, std::set&lt;std::map&lt;uint256, COrphanTx&gt;::iterator, <a class="code" href="struct_iterator_comparator.html">IteratorComparator</a>&gt;&gt; mapOrphanTransactionsByPrev <a class="code" href="net__processing_8cpp.html#a96443a5441d3ad2850b2fbd7ad468014">GUARDED_BY</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l00101"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">  101</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> = 0;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a4a2fcba1719100c7e9a0caf97f6988f4">EraseOrphansFor</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer);</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> vExtraTxnForCompactIt <a class="code" href="net__processing_8cpp.html#a96443a5441d3ad2850b2fbd7ad468014">GUARDED_BY</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>) = 0;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="keyword">static</span> std::vector&lt;std::pair&lt;uint256, CTransactionRef&gt;&gt; vExtraTxnForCompact <a class="code" href="net__processing_8cpp.html#a96443a5441d3ad2850b2fbd7ad468014">GUARDED_BY</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ae091b569e78315bb17c4b0c178aeb3b0">  107</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> uint64_t <a class="code" href="net__processing_8cpp.html#ae091b569e78315bb17c4b0c178aeb3b0">RANDOMIZER_ID_ADDRESS_RELAY</a> = 0x3cac0035b5866b90ULL; <span class="comment">// SHA256(&quot;main address relay&quot;)[0:8]</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a0e6b031d8505920b87ff88be68767f0a">  111</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#a0e6b031d8505920b87ff88be68767f0a">STALE_RELAY_AGE_LIMIT</a> = 30 * 24 * 60 * 60;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ab94135eefe3a6ea8bb6b918d69afb027">  115</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#ab94135eefe3a6ea8bb6b918d69afb027">HISTORICAL_BLOCK_AGE</a> = 7 * 24 * 60 * 60;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#afe7eb24fb43804693ab6c6491f153581">  118</a></span>&#160;<span class="keyword">static</span> constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#afe7eb24fb43804693ab6c6491f153581">AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</a> = 24 * 60 * 60;</div><div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a7ec45a20c72f5a43ec54d6cc213b229d">  120</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#a7ec45a20c72f5a43ec54d6cc213b229d">AVG_ADDRESS_BROADCAST_INTERVAL</a> = 30;</div><div class="line"><a name="l00124"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">  124</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">INVENTORY_BROADCAST_INTERVAL</a> = 5;</div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#acca6adf5d9b189ce87be23364d84261a">  128</a></span>&#160;<span class="keyword">static</span> constexpr <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#acca6adf5d9b189ce87be23364d84261a">INVENTORY_BROADCAST_MAX_PER_1MB_BLOCK</a> = 4 * 7 * <a class="code" href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">INVENTORY_BROADCAST_INTERVAL</a>;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">// Internal stuff</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="keyword">namespace </span>{</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordtype">int</span> nSyncStarted = 0;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    std::map&lt;uint256, std::pair&lt;NodeId, bool&gt;&gt; mapBlockSource;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    std::unique_ptr&lt;CRollingBloomFilter&gt; recentRejects;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <a class="code" href="classuint256.html">uint256</a> hashRecentRejectsChainTip;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <span class="keyword">struct </span>QueuedBlock {</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        <a class="code" href="classuint256.html">uint256</a> hash;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex;                               </div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keywordtype">bool</span> fValidatedHeaders;                                  </div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        std::unique_ptr&lt;PartiallyDownloadedBlock&gt; partialBlock;  </div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    };</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    std::map&lt;uint256, std::pair&lt;NodeId, std::list&lt;QueuedBlock&gt;::iterator&gt; &gt; mapBlocksInFlight;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    std::list&lt;NodeId&gt; lNodesAnnouncingHeaderAndIDs;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordtype">int</span> nPreferredDownload = 0;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordtype">int</span> nPeersWithValidatedDownloads = 0;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="keywordtype">int</span> g_outbound_peers_with_protect_from_disconnect = 0;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    std::atomic&lt;int64_t&gt; g_last_tip_update(0);</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">typedef</span> std::map&lt;uint256, CTransactionRef&gt; MapRelay;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    MapRelay mapRelay;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    std::deque&lt;std::pair&lt;int64_t, MapRelay::iterator&gt;&gt; vRelayExpiration;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;} <span class="comment">// namespace</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keyword">namespace </span>{</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keyword">struct </span>CBlockReject {</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> chRejectCode;</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    std::string strRejectReason;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <a class="code" href="classuint256.html">uint256</a> hashBlock;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;};</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keyword">struct </span>CNodeState {</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_service.html">CService</a> address;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordtype">bool</span> fCurrentlyConnected;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">int</span> nMisbehavior;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">bool</span> fShouldBan;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    <span class="keyword">const</span> std::string <a class="code" href="rest_8cpp.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    std::vector&lt;CBlockReject&gt; rejects;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexBestKnownBlock;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <a class="code" href="classuint256.html">uint256</a> hashLastUnknownBlock;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexLastCommonBlock;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexBestHeaderSent;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordtype">int</span> nUnconnectingHeaders;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordtype">bool</span> fSyncStarted;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    int64_t nHeadersSyncTimeout;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    int64_t nStallingSince;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    std::list&lt;QueuedBlock&gt; vBlocksInFlight;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    int64_t nDownloadingSince;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordtype">int</span> nBlocksInFlight;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordtype">int</span> nBlocksInFlightValidHeaders;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keywordtype">bool</span> fPreferredDownload;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordtype">bool</span> fPreferHeaders;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordtype">bool</span> fPreferHeaderAndIDs;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordtype">bool</span> fProvidesHeaderAndIDs;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordtype">bool</span> fSupportsDesiredCmpctVersion;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keyword">struct </span>ChainSyncTimeoutState {</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        int64_t m_timeout;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> * m_work_header;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <span class="keywordtype">bool</span> m_sent_getheaders;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;        <span class="keywordtype">bool</span> m_protect;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    };</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    ChainSyncTimeoutState m_chain_sync;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    int64_t m_last_block_announcement;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">     * State associated with objects download.</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">     * Tx download algorithm:</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">     *   When inv comes in, queue up (process_time, inv) inside the peer&#39;s</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">     *   CNodeState (m_object_process_time) as long as m_object_announced for the peer</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">     *   isn&#39;t too big (MAX_PEER_OBJECT_ANNOUNCEMENTS).</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">     *   The process_time for a objects is set to nNow for outbound peers,</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">     *   nNow + 2 seconds for inbound peers. This is the time at which we&#39;ll</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">     *   consider trying to request the objects from the peer in</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;<span class="comment">     *   SendMessages(). The delay for inbound peers is to allow outbound peers</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">     *   a chance to announce before we request from inbound peers, to prevent</span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">     *   an adversary from using inbound connections to blind us to a</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">     *   objects (InvBlock).</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">     *   When we call SendMessages() for a given peer,</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">     *   we will loop over the objects in m_object_process_time, looking</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">     *   at the objects whose process_time &lt;= nNow. We&#39;ll request each</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">     *   such objects that we don&#39;t have already and that hasn&#39;t been</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">     *   requested from another peer recently, up until we hit the</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">     *   MAX_PEER_OBJECT_IN_FLIGHT limit for the peer. Then we&#39;ll update</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">     *   g_already_asked_for for each requested inv, storing the time of the</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">     *   GETDATA request. We use g_already_asked_for to coordinate objects</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">     *   requests amongst our peers.</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">     *   For objects that we still need but we have already recently</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">     *   requested from some other peer, we&#39;ll reinsert (process_time, inv)</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">     *   back into the peer&#39;s m_object_process_time at the point in the future at</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">     *   which the most recent GETDATA request would time out (ie</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">     *   GetObjectInterval + the request time stored in g_already_asked_for).</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">     *   We add an additional delay for inbound peers, again to prefer</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">     *   attempting download from outbound peers first.</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">     *   We also add an extra small random delay up to 2 seconds</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">     *   to avoid biasing some peers over others. (e.g., due to fixed ordering</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">     *   of peer processing in ThreadMessageHandler).</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">     *</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">     *   When we receive a objects from a peer, we remove the inv from the</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">     *   peer&#39;s m_object_in_flight set and from their recently announced set</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">     *   (m_object_announced).  We also clear g_already_asked_for for that entry, so</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">     *   that if somehow the objects is not accepted but also not added to</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">     *   the reject filter, then we will eventually redownload from other</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">     *   peers.</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">     */</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keyword">struct </span>ObjectDownloadState {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="comment">/* Track when to attempt download of announced objects (process</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">         * time in micros -&gt; inv)</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">         */</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        std::multimap&lt;std::chrono::microseconds, CInv&gt; m_object_process_time;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        std::set&lt;CInv&gt; m_object_announced;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        std::map&lt;CInv, std::chrono::microseconds&gt; m_object_in_flight;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        std::chrono::microseconds m_check_expiry_timer{0};</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    };</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    ObjectDownloadState m_object_download;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    CNodeState(<a class="code" href="class_c_address.html">CAddress</a> addrIn, std::string addrNameIn) : address(addrIn), <a class="code" href="rest_8cpp.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>(addrNameIn) {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        fCurrentlyConnected = <span class="keyword">false</span>;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        nMisbehavior = 0;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        fShouldBan = <span class="keyword">false</span>;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        pindexBestKnownBlock = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        hashLastUnknownBlock.<a class="code" href="classbase__blob.html#aa340be5328d911272eded433d03f30a3">SetNull</a>();</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        pindexLastCommonBlock = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        pindexBestHeaderSent = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        nUnconnectingHeaders = 0;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        fSyncStarted = <span class="keyword">false</span>;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        nHeadersSyncTimeout = 0;</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        nStallingSince = 0;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        nDownloadingSince = 0;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;        nBlocksInFlight = 0;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        nBlocksInFlightValidHeaders = 0;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        fPreferredDownload = <span class="keyword">false</span>;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        fPreferHeaders = <span class="keyword">false</span>;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        fPreferHeaderAndIDs = <span class="keyword">false</span>;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        fProvidesHeaderAndIDs = <span class="keyword">false</span>;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        fSupportsDesiredCmpctVersion = <span class="keyword">false</span>;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        m_chain_sync = { 0, <span class="keyword">nullptr</span>, <span class="keyword">false</span>, <span class="keyword">false</span> };</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;        m_last_block_announcement = 0;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    }</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;};</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="comment">// Keeps track of the time (in microseconds) when transactions were requested last time</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<a class="code" href="classunordered__limitedmap.html">unordered_limitedmap&lt;uint256, std::chrono::microseconds, StaticSaltedHasher&gt;</a> g_already_asked_for(<a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>, <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a> * 2);</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<a class="code" href="classunordered__limitedmap.html">unordered_limitedmap&lt;uint256, std::chrono::microseconds, StaticSaltedHasher&gt;</a> g_erased_object_requests(<a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>, <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a> * 2);</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;std::map&lt;NodeId, CNodeState&gt; mapNodeState;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="comment">// Requires cs_main.</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;CNodeState *State(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> pnode) {</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    std::map&lt;NodeId, CNodeState&gt;::iterator it = mapNodeState.find(pnode);</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (it == mapNodeState.end())</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">return</span> &amp;it-&gt;second;</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;}</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keywordtype">void</span> UpdatePreferredDownload(<a class="code" href="class_c_node.html">CNode</a>* node, CNodeState* state)</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;{</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    nPreferredDownload -= state-&gt;fPreferredDownload;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="comment">// Whether this node should be marked as a preferred download node.</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    state-&gt;fPreferredDownload = (!node-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> || node-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>) &amp;&amp; !node-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a> &amp;&amp; !node-&gt;<a class="code" href="class_c_node.html#a721e2470c2c961b7599768a14be68781">fClient</a>;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    nPreferredDownload += state-&gt;fPreferredDownload;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;}</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="keywordtype">void</span> PushNodeVersion(<a class="code" href="class_c_node.html">CNode</a> *pnode, <a class="code" href="class_c_connman.html">CConnman</a>* connman, int64_t nTime)</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;{</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; params = <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>();</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537">ServiceFlags</a> nLocalNodeServices = pnode-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>();</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    uint64_t nonce = pnode-&gt;<a class="code" href="class_c_node.html#a3c5bbe8733398b4d14ce05d30aced57e">GetLocalNonce</a>();</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordtype">int</span> nNodeStartingHeight = pnode-&gt;<a class="code" href="class_c_node.html#a62937ed6238077e4c6e4364d75b4c0b7">GetMyStartingHeight</a>();</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid = pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>();</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <a class="code" href="class_c_address.html">CAddress</a> addr = pnode-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <a class="code" href="class_c_address.html">CAddress</a> addrYou = (addr.<a class="code" href="class_c_net_addr.html#a4e3b2fea2a6151c76684b3812df4a5c3">IsRoutable</a>() &amp;&amp; !<a class="code" href="netbase_8cpp.html#aef250c1632d217d8f3b752ddeacc0368">IsProxy</a>(addr) ? addr : <a class="code" href="class_c_address.html">CAddress</a>(<a class="code" href="class_c_service.html">CService</a>(), addr.<a class="code" href="class_c_address.html#a24e2309d92694a5a234751634bdf0458">nServices</a>));</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <a class="code" href="class_c_address.html">CAddress</a> addrMe = <a class="code" href="class_c_address.html">CAddress</a>(<a class="code" href="class_c_service.html">CService</a>(), nLocalNodeServices);</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <a class="code" href="classuint256.html">uint256</a> mnauthChallenge;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <a class="code" href="random_8cpp.html#ada0c29949c4d1ac0cc027d93c4771423">GetRandBytes</a>(mnauthChallenge.<a class="code" href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">begin</a>(), mnauthChallenge.<a class="code" href="classbase__blob.html#a00e7426a5d1ada51c635debf85f5a810">size</a>());</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    {</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pnode-&gt;<a class="code" href="class_c_node.html#a28c9c18f0d9c7488288b87610f0adb91">cs_mnauth</a>);</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        pnode-&gt;<a class="code" href="class_c_node.html#a6aee41fdb8c6a512395e66bb832c5f05">sentMNAuthChallenge</a> = mnauthChallenge;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    }</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordtype">int</span> nProtocolVersion = <a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordflow">if</span> (params.NetworkIDString() != <a class="code" href="class_c_base_chain_params.html#ae2c5dfdbbff4d5f92948258a7b4db47b">CBaseChainParams::MAIN</a> &amp;&amp; <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#a797473ebdea9030ae99f9aa8c0744a6f">IsArgSet</a>(<span class="stringliteral">&quot;-pushversion&quot;</span>)) {</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        nProtocolVersion = <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">GetArg</a>(<span class="stringliteral">&quot;-pushversion&quot;</span>, <a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>);</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    }</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pnode, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#a79d16fca661ece8c17e786943721fd34">NetMsgType::VERSION</a>, nProtocolVersion, (uint64_t)nLocalNodeServices, nTime, addrYou, addrMe,</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            nonce, <a class="code" href="net_8cpp.html#a6c58f8ccc4c93105a44caf588562d609">strSubVersion</a>, nNodeStartingHeight, ::<a class="code" href="net_8cpp.html#a7935254c613d6f3cdadd3ce45f7efbff">fRelayTxes</a>, mnauthChallenge, pnode-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>));</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a8e02420c2f7c53579ccb90acf301ae75">fLogIPs</a>) {</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;send version message: version %d, blocks=%d, us=%s, them=%s, peer=%d\n&quot;</span>, nProtocolVersion, nNodeStartingHeight, addrMe.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>(), addrYou.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>(), nodeid);</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;send version message: version %d, blocks=%d, us=%s, peer=%d\n&quot;</span>, nProtocolVersion, nNodeStartingHeight, addrMe.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>(), nodeid);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    }</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">// Requires cs_main.</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">// Returns a bool indicating whether we requested this block.</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment">// Also used if a block was /not/ received and timed out or started with another peer</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keywordtype">bool</span> MarkBlockAsReceived(<span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash) {</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    std::map&lt;uint256, std::pair&lt;NodeId, std::list&lt;QueuedBlock&gt;::iterator&gt; &gt;::iterator itInFlight = mapBlocksInFlight.find(hash);</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">if</span> (itInFlight != mapBlocksInFlight.end()) {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        CNodeState *state = State(itInFlight-&gt;second.first);</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        state-&gt;nBlocksInFlightValidHeaders -= itInFlight-&gt;second.second-&gt;fValidatedHeaders;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordflow">if</span> (state-&gt;nBlocksInFlightValidHeaders == 0 &amp;&amp; itInFlight-&gt;second.second-&gt;fValidatedHeaders) {</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;            <span class="comment">// Last validated block on the queue was received.</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;            nPeersWithValidatedDownloads--;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        }</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keywordflow">if</span> (state-&gt;vBlocksInFlight.begin() == itInFlight-&gt;second.second) {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            <span class="comment">// First block on the queue was received, update the start download time for the next one</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            state-&gt;nDownloadingSince = std::max(state-&gt;nDownloadingSince, <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>());</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;        }</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;        state-&gt;vBlocksInFlight.erase(itInFlight-&gt;second.second);</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        state-&gt;nBlocksInFlight--;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        state-&gt;nStallingSince = 0;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        mapBlocksInFlight.erase(itInFlight);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    }</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;}</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="comment">// Requires cs_main.</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">// returns false, still setting pit, if the block was already in flight from the same peer</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="comment">// pit will only be valid as long as the same cs_main lock is being held</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keywordtype">bool</span> MarkBlockAsInFlight(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash, <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex = <span class="keyword">nullptr</span>, std::list&lt;QueuedBlock&gt;::iterator **pit = <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <span class="comment">// Short-circuit most stuff in case its from the same node</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    std::map&lt;uint256, std::pair&lt;NodeId, std::list&lt;QueuedBlock&gt;::iterator&gt; &gt;::iterator itInFlight = mapBlocksInFlight.find(hash);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keywordflow">if</span> (itInFlight != mapBlocksInFlight.end() &amp;&amp; itInFlight-&gt;second.first == nodeid) {</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        <span class="keywordflow">if</span> (pit) {</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;            *pit = &amp;itInFlight-&gt;second.second;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        }</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    }</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">// Make sure it&#39;s not listed somewhere already.</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    MarkBlockAsReceived(hash);</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    std::list&lt;QueuedBlock&gt;::iterator it = state-&gt;vBlocksInFlight.insert(state-&gt;vBlocksInFlight.end(),</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;            {hash, pindex, pindex != <span class="keyword">nullptr</span>, std::unique_ptr&lt;PartiallyDownloadedBlock&gt;(pit ? <span class="keyword">new</span> <a class="code" href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a>(&amp;<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>) : nullptr)});</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    state-&gt;nBlocksInFlight++;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    state-&gt;nBlocksInFlightValidHeaders += it-&gt;fValidatedHeaders;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">if</span> (state-&gt;nBlocksInFlight == 1) {</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">// We&#39;re starting a block download (batch) from this peer.</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        state-&gt;nDownloadingSince = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>();</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    }</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">if</span> (state-&gt;nBlocksInFlightValidHeaders == 1 &amp;&amp; pindex != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;        nPeersWithValidatedDownloads++;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    }</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    itInFlight = mapBlocksInFlight.insert(std::make_pair(hash, std::make_pair(nodeid, it))).first;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keywordflow">if</span> (pit)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        *pit = &amp;itInFlight-&gt;second.second;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;}</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordtype">void</span> ProcessBlockAvailability(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid) {</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">if</span> (!state-&gt;hashLastUnknownBlock.IsNull()) {</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        BlockMap::iterator itOld = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(state-&gt;hashLastUnknownBlock);</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="keywordflow">if</span> (itOld != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end() &amp;&amp; itOld-&gt;second-&gt;nChainWork &gt; 0) {</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;            <span class="keywordflow">if</span> (state-&gt;pindexBestKnownBlock == <span class="keyword">nullptr</span> || itOld-&gt;second-&gt;nChainWork &gt;= state-&gt;pindexBestKnownBlock-&gt;nChainWork)</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                state-&gt;pindexBestKnownBlock = itOld-&gt;second;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            state-&gt;hashLastUnknownBlock.SetNull();</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        }</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    }</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;}</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="keywordtype">void</span> UpdateBlockAvailability(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> &amp;hash) {</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    ProcessBlockAvailability(nodeid);</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    BlockMap::iterator it = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(hash);</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordflow">if</span> (it != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end() &amp;&amp; it-&gt;second-&gt;nChainWork &gt; 0) {</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <span class="comment">// An actually better block was announced.</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="keywordflow">if</span> (state-&gt;pindexBestKnownBlock == <span class="keyword">nullptr</span> || it-&gt;second-&gt;nChainWork &gt;= state-&gt;pindexBestKnownBlock-&gt;nChainWork)</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;            state-&gt;pindexBestKnownBlock = it-&gt;second;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <span class="comment">// An unknown block was announced; just assume that the latest one is the best one.</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        state-&gt;hashLastUnknownBlock = hash;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    }</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;}</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="keywordtype">void</span> MaybeSetPeerAsAnnouncingHeaderAndIDs(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <a class="code" href="class_c_connman.html">CConnman</a>* connman) {</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    CNodeState* nodestate = State(nodeid);</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">if</span> (!nodestate || !nodestate-&gt;fSupportsDesiredCmpctVersion) {</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="comment">// Never ask from peers who can&#39;t provide desired version.</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    }</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> (nodestate-&gt;fProvidesHeaderAndIDs) {</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">for</span> (std::list&lt;NodeId&gt;::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            <span class="keywordflow">if</span> (*it == nodeid) {</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;                lNodesAnnouncingHeaderAndIDs.erase(it);</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                lNodesAnnouncingHeaderAndIDs.push_back(nodeid);</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;            }</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        }</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        connman-&gt;<a class="code" href="class_c_connman.html#a28701e595fcd7dd71791f105457db034">ForNode</a>(nodeid, [connman](<a class="code" href="class_c_node.html">CNode</a>* pfrom){</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;            uint64_t nCMPCTBLOCKVersion = 1;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;            <span class="keywordflow">if</span> (lNodesAnnouncingHeaderAndIDs.size() &gt;= 3) {</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                <span class="comment">// As per BIP152, we only get 3 of our peers to announce</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                <span class="comment">// blocks using compact encodings.</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#a28701e595fcd7dd71791f105457db034">ForNode</a>(lNodesAnnouncingHeaderAndIDs.front(), [connman, nCMPCTBLOCKVersion](<a class="code" href="class_c_node.html">CNode</a>* pnodeStop){</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pnodeStop, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(pnodeStop-&gt;GetSendVersion()).Make(<a class="code" href="namespace_net_msg_type.html#a4cdafba4d585b4699628412c7f1c3d8b">NetMsgType::SENDCMPCT</a>, <span class="comment">/*fAnnounceUsingCMPCTBLOCK=*/</span><span class="keyword">false</span>, nCMPCTBLOCKVersion));</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                });</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                lNodesAnnouncingHeaderAndIDs.pop_front();</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;            }</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>()).Make(<a class="code" href="namespace_net_msg_type.html#a4cdafba4d585b4699628412c7f1c3d8b">NetMsgType::SENDCMPCT</a>, <span class="comment">/*fAnnounceUsingCMPCTBLOCK=*/</span><span class="keyword">true</span>, nCMPCTBLOCKVersion));</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;            lNodesAnnouncingHeaderAndIDs.push_back(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        });</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    }</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;}</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordtype">bool</span> TipMayBeStale(<span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a> &amp;consensusParams)</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;{</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">if</span> (g_last_tip_update == 0) {</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;        g_last_tip_update = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    }</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="keywordflow">return</span> g_last_tip_update &lt; <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>() - consensusParams.<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a> * 3 &amp;&amp; mapBlocksInFlight.empty();</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;}</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="comment">// Requires cs_main</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="keywordtype">bool</span> CanDirectFetch(<span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a> &amp;consensusParams)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;{</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() &gt; <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - consensusParams.<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a> * 20;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;}</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">// Requires cs_main</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="keywordtype">bool</span> PeerHasHeader(CNodeState *state, <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex)</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;{</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    <span class="keywordflow">if</span> (state-&gt;pindexBestKnownBlock &amp;&amp; pindex == state-&gt;pindexBestKnownBlock-&gt;GetAncestor(pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>))</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="keywordflow">if</span> (state-&gt;pindexBestHeaderSent &amp;&amp; pindex == state-&gt;pindexBestHeaderSent-&gt;GetAncestor(pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>))</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;}</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="keywordtype">void</span> FindNextBlocksToDownload(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, std::vector&lt;const CBlockIndex*&gt;&amp; vBlocks, <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a>&amp; nodeStaller, <span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a>&amp; consensusParams) {</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> == 0)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    vBlocks.reserve(vBlocks.size() + <a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>);</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="comment">// Make sure pindexBestKnownBlock is up to date, we&#39;ll need it.</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    ProcessBlockAvailability(nodeid);</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">if</span> (state-&gt;pindexBestKnownBlock == <span class="keyword">nullptr</span> || state-&gt;pindexBestKnownBlock-&gt;nChainWork &lt; <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> || state-&gt;pindexBestKnownBlock-&gt;nChainWork &lt; <a class="code" href="validation_8cpp.html#a0bf92b1be4135700eeff6a48f01e3896">nMinimumChainWork</a>) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="comment">// This peer has nothing interesting.</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    }</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordflow">if</span> (state-&gt;pindexLastCommonBlock == <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="comment">// Bootstrap quickly by guessing a parent of our best tip is the forking point.</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        <span class="comment">// Guessing wrong in either direction is not a problem.</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        state-&gt;pindexLastCommonBlock = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>[std::min(state-&gt;pindexBestKnownBlock-&gt;nHeight, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#ad4758bc8872ce065a9579f77c3171d40">Height</a>())];</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    }</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="comment">// If the peer reorganized, our previous pindexLastCommonBlock may not be an ancestor</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;    <span class="comment">// of its current tip anymore. Go back enough to fix that.</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    state-&gt;pindexLastCommonBlock = <a class="code" href="chain_8cpp.html#a821669bb03bef97dac98734b839c3006">LastCommonAncestor</a>(state-&gt;pindexLastCommonBlock, state-&gt;pindexBestKnownBlock);</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">if</span> (state-&gt;pindexLastCommonBlock == state-&gt;pindexBestKnownBlock)</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    std::vector&lt;const CBlockIndex*&gt; vToFetch;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexWalk = state-&gt;pindexLastCommonBlock;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">// Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <span class="comment">// linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">// download that next block if the window were 1 larger.</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="keywordtype">int</span> nWindowEnd = state-&gt;pindexLastCommonBlock-&gt;nHeight + <a class="code" href="validation_8h.html#a3db9a6c313045e841191037a97268a96">BLOCK_DOWNLOAD_WINDOW</a>;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordtype">int</span> nMaxHeight = std::min&lt;int&gt;(state-&gt;pindexBestKnownBlock-&gt;nHeight, nWindowEnd + 1);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> waitingfor = -1;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">while</span> (pindexWalk-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> &lt; nMaxHeight) {</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;        <span class="comment">// Read up to 128 (or more, if more blocks than that are needed) successors of pindexWalk (towards</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="comment">// pindexBestKnownBlock) into vToFetch. We fetch 128, because CBlockIndex::GetAncestor may be as expensive</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="comment">// as iterating over ~100 CBlockIndex* entries anyway.</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keywordtype">int</span> nToFetch = std::min(nMaxHeight - pindexWalk-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, std::max&lt;int&gt;(<a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> - vBlocks.size(), 128));</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        vToFetch.resize(nToFetch);</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        pindexWalk = state-&gt;pindexBestKnownBlock-&gt;GetAncestor(pindexWalk-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> + nToFetch);</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        vToFetch[nToFetch - 1] = pindexWalk;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = nToFetch - 1; i &gt; 0; i--) {</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;            vToFetch[i - 1] = vToFetch[i]-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        }</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="comment">// Iterate over those blocks in vToFetch (in forward direction), adding the ones that</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        <span class="comment">// are not yet downloaded and not in flight to vBlocks. In the mean time, update</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="comment">// pindexLastCommonBlock as long as all ancestors are already downloaded, or if it&#39;s</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="comment">// already part of our chain (and therefore don&#39;t need it even if pruned).</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex : vToFetch) {</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            <span class="keywordflow">if</span> (!pindex-&gt;<a class="code" href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">IsValid</a>(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573">BLOCK_VALID_TREE</a>)) {</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                <span class="comment">// We consider the chain that this peer is on invalid.</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;            }</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;            <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#aef7d4c3c9a4538e62821988bf6193ad8">nStatus</a> &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a> || <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#af1786dc229c215dea7f727c11df2c8dc">Contains</a>(pindex)) {</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#af3c6d6dd8a7579e5ce516d94b98d2db5">nChainTx</a>)</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                    state-&gt;pindexLastCommonBlock = pindex;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mapBlocksInFlight.count(pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()) == 0) {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                <span class="comment">// The block is not already downloaded, and not yet in flight.</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> &gt; nWindowEnd) {</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                    <span class="comment">// We reached the end of the window.</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                    <span class="keywordflow">if</span> (vBlocks.size() == 0 &amp;&amp; waitingfor != nodeid) {</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                        <span class="comment">// We aren&#39;t able to fetch anything, but we would be if the download window was one larger.</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                        nodeStaller = waitingfor;</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;                    }</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;                }</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;                vBlocks.push_back(pindex);</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                <span class="keywordflow">if</span> (vBlocks.size() == <a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>) {</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                }</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (waitingfor == -1) {</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                <span class="comment">// This is the first already-in-flight block.</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                waitingfor = mapBlocksInFlight[pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()].first;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;            }</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;        }</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    }</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;}</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;} <span class="comment">// namespace</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;</div><div class="line"><a name="l00676"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">  676</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">EraseObjectRequest</a>(CNodeState* nodestate, <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;{</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s -- inv=(%s)\n&quot;</span>, __func__, inv.ToString());</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    g_already_asked_for.erase(inv.hash);</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    g_erased_object_requests.insert(std::make_pair(inv.hash, GetTime&lt;std::chrono::microseconds&gt;()));</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordflow">if</span> (nodestate) {</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        nodestate-&gt;m_object_download.m_object_announced.erase(inv);</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        nodestate-&gt;m_object_download.m_object_in_flight.erase(inv);</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    }</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;}</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno"><a class="line" href="net__processing_8h.html#a6e6c32fa5e216d9d0282635c712dc0c9">  689</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">EraseObjectRequest</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeId, <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;{</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keyword">auto</span>* state = State(nodeId);</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="keywordflow">if</span> (!state) {</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    }</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <a class="code" href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">EraseObjectRequest</a>(state, inv);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;}</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a3223f6e35a3458b35bee4d9f6771a8ee">  699</a></span>&#160;std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#a3223f6e35a3458b35bee4d9f6771a8ee">GetObjectRequestTime</a>(<span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;{</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keyword">auto</span> it = g_already_asked_for.find(hash);</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keywordflow">if</span> (it != g_already_asked_for.end()) {</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        <span class="keywordflow">return</span> it-&gt;second;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    }</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">return</span> {};</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;}</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a786a2e6872a53c3559d0ccb4c1422516">  709</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a786a2e6872a53c3559d0ccb4c1422516">UpdateObjectRequestTime</a>(<span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash, std::chrono::microseconds request_time) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;{</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keyword">auto</span> it = g_already_asked_for.find(hash);</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keywordflow">if</span> (it == g_already_asked_for.end()) {</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        g_already_asked_for.insert(std::make_pair(hash, request_time));</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        g_already_asked_for.update(it, request_time);</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;    }</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;}</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">  720</a></span>&#160;std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">GetObjectInterval</a>(<span class="keywordtype">int</span> invType)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;{</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="comment">// some messages need to be re-requested faster when the first announcing peer did not answer to GETDATA</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <span class="keywordflow">switch</span>(invType)</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    {</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa9afeebb1d379d86fc2fdafedc5fb004">MSG_QUORUM_RECOVERED_SIG</a>:</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;            <span class="keywordflow">return</span> std::chrono::seconds{15};</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abd3619e681a4ee498cce0c77e1794e08">MSG_CLSIG</a>:</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;            <span class="keywordflow">return</span> std::chrono::seconds{5};</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236">MSG_ISLOCK</a>:</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;            <span class="keywordflow">return</span> std::chrono::seconds{10};</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="net__processing_8cpp.html#a7d2c75d05297fcd566c04189def2b3fa">GETDATA_TX_INTERVAL</a>;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    }</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;}</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">  736</a></span>&#160;std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">GetObjectExpiryInterval</a>(<span class="keywordtype">int</span> invType)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;{</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">GetObjectInterval</a>(invType) * <a class="code" href="net__processing_8cpp.html#ab4092bed1a4f5967d73212e8b92db3e6">TX_EXPIRY_INTERVAL_FACTOR</a>;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;}</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div><div class="line"><a name="l00741"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a158783474cd905bc1cc706330bdf1db1">  741</a></span>&#160;std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#a158783474cd905bc1cc706330bdf1db1">GetObjectRandomDelay</a>(<span class="keywordtype">int</span> invType)</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;{</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="keywordflow">if</span> (invType == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>) {</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="random_8cpp.html#a49fa92a85621c56f1ce50385f8778505">GetRandMicros</a>(<a class="code" href="net__processing_8cpp.html#aae936f7cf0174e2378c22419a18f0f60">MAX_GETDATA_RANDOM_DELAY</a>);</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    }</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="keywordflow">return</span> {};</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;}</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#acba2818c523a6551451b8bae883e998a">  749</a></span>&#160;std::chrono::microseconds <a class="code" href="net__processing_8cpp.html#acba2818c523a6551451b8bae883e998a">CalculateObjectGetDataTime</a>(<span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv, std::chrono::microseconds current_time, <span class="keywordtype">bool</span> use_inbound_delay) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;{</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    std::chrono::microseconds process_time;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span> last_request_time = <a class="code" href="net__processing_8cpp.html#a3223f6e35a3458b35bee4d9f6771a8ee">GetObjectRequestTime</a>(inv.hash);</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    <span class="comment">// First time requesting this tx</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;    <span class="keywordflow">if</span> (last_request_time.count() == 0) {</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        process_time = current_time;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <span class="comment">// Randomize the delay to avoid biasing some peers over others (such as due to</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="comment">// fixed ordering of peer processing in ThreadMessageHandler)</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        process_time = last_request_time + <a class="code" href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">GetObjectInterval</a>(inv.type) + <a class="code" href="net__processing_8cpp.html#a158783474cd905bc1cc706330bdf1db1">GetObjectRandomDelay</a>(inv.type);</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    }</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="comment">// We delay processing announcements from inbound peers</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">if</span> (inv.type == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a> &amp;&amp; !<a class="code" href="util_8cpp.html#aab0b2c1be849102968dfee289f3b3e2a">fMasternodeMode</a> &amp;&amp; use_inbound_delay) process_time += <a class="code" href="net__processing_8cpp.html#aae4bc03700ef51a1dd9e63a6c9dfd47f">INBOUND_PEER_TX_DELAY</a>;</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="keywordflow">return</span> process_time;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;}</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div><div class="line"><a name="l00769"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">  769</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(CNodeState* state, <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv, std::chrono::microseconds current_time, <span class="keywordtype">bool</span> fForce = <span class="keyword">false</span>) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;{</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    CNodeState::ObjectDownloadState&amp; peer_download_state = state-&gt;m_object_download;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">if</span> (peer_download_state.m_object_announced.size() &gt;= <a class="code" href="net__processing_8cpp.html#ac6b3b660a36c39312cd3247d5da77715">MAX_PEER_OBJECT_ANNOUNCEMENTS</a> ||</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;            peer_download_state.m_object_process_time.size() &gt;= <a class="code" href="net__processing_8cpp.html#ac6b3b660a36c39312cd3247d5da77715">MAX_PEER_OBJECT_ANNOUNCEMENTS</a> ||</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;            peer_download_state.m_object_announced.count(inv)) {</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="comment">// Too many queued announcements from this peer, or we already have</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        <span class="comment">// this announcement</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    }</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    peer_download_state.m_object_announced.insert(inv);</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="comment">// Calculate the time to try requesting this transaction. Use</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="comment">// fPreferredDownload as a proxy for outbound peers.</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    std::chrono::microseconds process_time = <a class="code" href="net__processing_8cpp.html#acba2818c523a6551451b8bae883e998a">CalculateObjectGetDataTime</a>(inv, current_time, !state-&gt;fPreferredDownload);</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    peer_download_state.m_object_process_time.emplace(process_time, inv);</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="keywordflow">if</span> (fForce) {</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="comment">// make sure this object is actually requested ASAP</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        g_erased_object_requests.erase(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        g_already_asked_for.erase(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    }</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s -- inv=(%s), current_time=%d, process_time=%d, delta=%d\n&quot;</span>, __func__, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), current_time.count(), process_time.count(), (process_time - current_time).<a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>());</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;}</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;</div><div class="line"><a name="l00797"></a><span class="lineno"><a class="line" href="net__processing_8h.html#aac851af1e08b31614592eaddf9e62250">  797</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeId, <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv, std::chrono::microseconds current_time, <span class="keywordtype">bool</span> fForce) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;{</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keyword">auto</span>* state = State(nodeId);</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordflow">if</span> (!state) {</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    }</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(state, inv, current_time, fForce);</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;}</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno"><a class="line" href="net__processing_8h.html#a481dcac4bc4d9e82d3785599af5fe6be">  807</a></span>&#160;<span class="keywordtype">size_t</span> <a class="code" href="net__processing_8cpp.html#a481dcac4bc4d9e82d3785599af5fe6be">GetRequestedObjectCount</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeId)</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;{</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <span class="keyword">auto</span>* state = State(nodeId);</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="keywordflow">if</span> (!state) {</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    }</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <span class="keywordflow">return</span> state-&gt;m_object_download.m_object_process_time.size();</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;}</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment">// This function is used for testing the stale tip eviction logic, see</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment">// DoS_tests.cpp</span></div><div class="line"><a name="l00819"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a98bccafe6dffb0ba0adf1e78ce7b9c4c">  819</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a98bccafe6dffb0ba0adf1e78ce7b9c4c">UpdateLastBlockAnnounceTime</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> node, int64_t time_in_seconds)</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;{</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    CNodeState *state = State(node);</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keywordflow">if</span> (state) state-&gt;m_last_block_announcement = time_in_seconds;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;}</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="comment">// Returns true for outbound peers, excluding manual connections, feelers, and</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="comment">// one-shots</span></div><div class="line"><a name="l00828"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">  828</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a>(<span class="keyword">const</span> <a class="code" href="class_c_node.html">CNode</a> *node)</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;{</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">return</span> !(node-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> || node-&gt;<a class="code" href="class_c_node.html#a6d81efc365079ca499a5f6465967d8d9">m_manual_connection</a> || node-&gt;<a class="code" href="class_c_node.html#a25c9b62c42159cc94c6e8ede9ad0ed9d">fFeeler</a> || node-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a>);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;}</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;</div><div class="line"><a name="l00833"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a90c3cb8c05c52b0c8639d51c87ce7017">  833</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a90c3cb8c05c52b0c8639d51c87ce7017">PeerLogicValidation::InitializeNode</a>(<a class="code" href="class_c_node.html">CNode</a> *pnode) {</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <a class="code" href="class_c_address.html">CAddress</a> addr = pnode-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    std::string addrName = pnode-&gt;<a class="code" href="class_c_node.html#a4f5e98d3083fe8359d4c27d97eb0dcbb">GetAddrName</a>();</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid = pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>();</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    {</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    }</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordflow">if</span>(!pnode-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>)</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        PushNodeVersion(pnode, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>, <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>());</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;}</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a0b5c0354f95776ad5af36adb95604339">  845</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a0b5c0354f95776ad5af36adb95604339">PeerLogicValidation::FinalizeNode</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <span class="keywordtype">bool</span>&amp; fUpdateConnectionTime) {</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    fUpdateConnectionTime = <span class="keyword">false</span>;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    assert(state != <span class="keyword">nullptr</span>);</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    <span class="keywordflow">if</span> (state-&gt;fSyncStarted)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        nSyncStarted--;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;    <span class="keywordflow">if</span> (state-&gt;nMisbehavior == 0 &amp;&amp; state-&gt;fCurrentlyConnected) {</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        fUpdateConnectionTime = <span class="keyword">true</span>;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    }</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> QueuedBlock&amp; entry : state-&gt;vBlocksInFlight) {</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        mapBlocksInFlight.erase(entry.hash);</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    }</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <a class="code" href="net__processing_8cpp.html#a4a2fcba1719100c7e9a0caf97f6988f4">EraseOrphansFor</a>(nodeid);</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    nPreferredDownload -= state-&gt;fPreferredDownload;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    nPeersWithValidatedDownloads -= (state-&gt;nBlocksInFlightValidHeaders != 0);</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;    assert(nPeersWithValidatedDownloads &gt;= 0);</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    g_outbound_peers_with_protect_from_disconnect -= state-&gt;m_chain_sync.m_protect;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    assert(g_outbound_peers_with_protect_from_disconnect &gt;= 0);</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    mapNodeState.erase(nodeid);</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    <span class="keywordflow">if</span> (mapNodeState.empty()) {</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="comment">// Do a consistency check after the last peer is removed.</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        assert(mapBlocksInFlight.empty());</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        assert(nPreferredDownload == 0);</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        assert(nPeersWithValidatedDownloads == 0);</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        assert(g_outbound_peers_with_protect_from_disconnect == 0);</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    }</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Cleared nodestate for peer=%d\n&quot;</span>, nodeid);</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;}</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno"><a class="line" href="net__processing_8h.html#af0793c7c14e94d2d642f4ac89067a429">  880</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#af0793c7c14e94d2d642f4ac89067a429">GetNodeStateStats</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> nodeid, <a class="code" href="struct_c_node_state_stats.html">CNodeStateStats</a> &amp;stats) {</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    CNodeState *state = State(nodeid);</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordflow">if</span> (state == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    stats.<a class="code" href="struct_c_node_state_stats.html#a62c2243d09166c1daaad84519700da3c">nMisbehavior</a> = state-&gt;nMisbehavior;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    stats.<a class="code" href="struct_c_node_state_stats.html#a7646deac801098e973a5bc50202f92cd">nSyncHeight</a> = state-&gt;pindexBestKnownBlock ? state-&gt;pindexBestKnownBlock-&gt;nHeight : -1;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    stats.<a class="code" href="struct_c_node_state_stats.html#a67c910a57285a63bbf0bb88ea7a9ca05">nCommonHeight</a> = state-&gt;pindexLastCommonBlock ? state-&gt;pindexLastCommonBlock-&gt;nHeight : -1;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> QueuedBlock&amp; queue : state-&gt;vBlocksInFlight) {</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        <span class="keywordflow">if</span> (queue.pindex)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;            stats.<a class="code" href="struct_c_node_state_stats.html#a4b03fd8ecaa9268f7eca836e5e79c35a">vHeightInFlight</a>.push_back(queue.pindex-&gt;nHeight);</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    }</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;}</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;<span class="comment">// mapOrphanTransactions</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div><div class="line"><a name="l00900"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a189a835fa7e6ae93a2391f38eefd7d2d">  900</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a189a835fa7e6ae93a2391f38eefd7d2d">AddToCompactExtraTransactions</a>(<span class="keyword">const</span> <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a>&amp; tx) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;{</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordtype">size_t</span> max_extra_txn = <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">GetArg</a>(<span class="stringliteral">&quot;-blockreconstructionextratxn&quot;</span>, <a class="code" href="net__processing_8h.html#a9d3753f6b45e9bc12172e63922e704fd">DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN</a>);</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="keywordflow">if</span> (max_extra_txn &lt;= 0)</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="keywordflow">if</span> (!vExtraTxnForCompact.size())</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        vExtraTxnForCompact.resize(max_extra_txn);</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    vExtraTxnForCompact[vExtraTxnForCompactIt] = std::make_pair(tx-&gt;GetHash(), tx);</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    vExtraTxnForCompactIt = (vExtraTxnForCompactIt + 1) % max_extra_txn;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;}</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div><div class="line"><a name="l00911"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#abd6140f46766ceef29bf97f4e83bbec1">  911</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#abd6140f46766ceef29bf97f4e83bbec1">AddOrphanTx</a>(<span class="keyword">const</span> <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a>&amp; tx, <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;{</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash = tx-&gt;GetHash();</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    <span class="keywordflow">if</span> (mapOrphanTransactions.count(hash))</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <span class="comment">// Ignore big transactions, to avoid a</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <span class="comment">// send-big-orphans memory exhaustion attack. If a peer has a legitimate</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="comment">// large transaction with a missing parent then we assume</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    <span class="comment">// it will rebroadcast it later, after the parent transaction(s)</span></div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">// have been mined or received.</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="comment">// 100 orphans, each of which is at most 99,999 bytes big is</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="comment">// at most 10 megabytes of orphans and somewhat more byprev index (in the worst case):</span></div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sz = <a class="code" href="serialize_8h.html#aeb209536f7b746673a9c3fba8651b0e5">GetSerializeSize</a>(*tx, <a class="code" href="serialize_8h.html#a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c">SER_NETWORK</a>, <a class="code" href="class_c_transaction.html#afcc5960eab9d35f10c6f8e6675bf2a93">CTransaction::CURRENT_VERSION</a>);</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="keywordflow">if</span> (sz &gt; <a class="code" href="policy_8h.html#aefbb84a1c575dfc90d140d06f8c8d1e9">MAX_STANDARD_TX_SIZE</a>)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    {</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;ignoring large orphan tx (size: %u, hash: %s)\n&quot;</span>, sz, hash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    }</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <span class="keyword">auto</span> ret = mapOrphanTransactions.emplace(hash, <a class="code" href="struct_c_orphan_tx.html">COrphanTx</a>{tx, peer, <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>() + <a class="code" href="net__processing_8h.html#a1ca092f66c0d0ea7ea0e930b5a72c500">ORPHAN_TX_EXPIRE_TIME</a>, sz});</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    assert(ret.second);</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_tx_in.html">CTxIn</a>&amp; txin : tx-&gt;vin) {</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        mapOrphanTransactionsByPrev[txin.<a class="code" href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">prevout</a>].insert(ret.first);</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    }</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <a class="code" href="net__processing_8cpp.html#a189a835fa7e6ae93a2391f38eefd7d2d">AddToCompactExtraTransactions</a>(tx);</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;    <a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> += sz;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;stored orphan tx %s (mapsz %u outsz %u)\n&quot;</span>, hash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(),</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;             mapOrphanTransactions.size(), mapOrphanTransactionsByPrev.size());</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;}</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;</div><div class="line"><a name="l00946"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">  946</a></span>&#160;<span class="keywordtype">int</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(<a class="code" href="classuint256.html">uint256</a> hash) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>)</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;{</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    std::map&lt;uint256, COrphanTx&gt;::iterator it = mapOrphanTransactions.find(hash);</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    <span class="keywordflow">if</span> (it == mapOrphanTransactions.end())</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_tx_in.html">CTxIn</a>&amp; txin : it-&gt;second.tx-&gt;vin)</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    {</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        <span class="keyword">auto</span> itPrev = mapOrphanTransactionsByPrev.find(txin.<a class="code" href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">prevout</a>);</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="keywordflow">if</span> (itPrev == mapOrphanTransactionsByPrev.end())</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        itPrev-&gt;second.erase(it);</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="keywordflow">if</span> (itPrev-&gt;second.empty())</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;            mapOrphanTransactionsByPrev.erase(itPrev);</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    }</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    assert(<a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> &gt;= it-&gt;second.nTxSize);</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> -= it-&gt;second.nTxSize;</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    mapOrphanTransactions.erase(it);</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;}</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a4a2fcba1719100c7e9a0caf97f6988f4">  966</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a4a2fcba1719100c7e9a0caf97f6988f4">EraseOrphansFor</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> peer)</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;{</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keywordtype">int</span> nErased = 0;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    std::map&lt;uint256, COrphanTx&gt;::iterator iter = mapOrphanTransactions.begin();</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="keywordflow">while</span> (iter != mapOrphanTransactions.end())</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;    {</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        std::map&lt;uint256, COrphanTx&gt;::iterator maybeErase = iter++; <span class="comment">// increment to avoid iterator becoming invalid</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">if</span> (maybeErase-&gt;second.fromPeer == peer)</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        {</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            nErased += <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(maybeErase-&gt;second.tx-&gt;GetHash());</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        }</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;    }</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    <span class="keywordflow">if</span> (nErased &gt; 0) <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;Erased %d orphan tx from peer=%d\n&quot;</span>, nErased, peer);</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;}</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ac880655d6e6468a46d21e713e3f6e3de">  983</a></span>&#160;<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="net__processing_8cpp.html#ac880655d6e6468a46d21e713e3f6e3de">LimitOrphanTxSize</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nMaxOrphansSize)</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;{</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nEvicted = 0;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keyword">static</span> int64_t nNextSweep;</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;    int64_t nNow = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordflow">if</span> (nNextSweep &lt;= nNow) {</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        <span class="comment">// Sweep out expired orphan pool entries:</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        <span class="keywordtype">int</span> nErased = 0;</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        int64_t nMinExpTime = nNow + <a class="code" href="net__processing_8h.html#a1ca092f66c0d0ea7ea0e930b5a72c500">ORPHAN_TX_EXPIRE_TIME</a> - <a class="code" href="net__processing_8h.html#a50cdb9bf0105f8f39008a7ec09909336">ORPHAN_TX_EXPIRE_INTERVAL</a>;</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        std::map&lt;uint256, COrphanTx&gt;::iterator iter = mapOrphanTransactions.begin();</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;        <span class="keywordflow">while</span> (iter != mapOrphanTransactions.end())</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        {</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;            std::map&lt;uint256, COrphanTx&gt;::iterator maybeErase = iter++;</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;            <span class="keywordflow">if</span> (maybeErase-&gt;second.nTimeExpire &lt;= nNow) {</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                nErased += <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(maybeErase-&gt;second.tx-&gt;GetHash());</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                nMinExpTime = std::min(maybeErase-&gt;second.nTimeExpire, nMinExpTime);</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;            }</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        }</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;        <span class="comment">// Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.</span></div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;        nNextSweep = nMinExpTime + <a class="code" href="net__processing_8h.html#a50cdb9bf0105f8f39008a7ec09909336">ORPHAN_TX_EXPIRE_INTERVAL</a>;</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keywordflow">if</span> (nErased &gt; 0) <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;Erased %d orphan tx due to expiration\n&quot;</span>, nErased);</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    }</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="keywordflow">while</span> (!mapOrphanTransactions.empty() &amp;&amp; <a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> &gt; nMaxOrphansSize)</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    {</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        <span class="comment">// Evict a random orphan:</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <a class="code" href="classuint256.html">uint256</a> randomhash = <a class="code" href="random_8cpp.html#af3aedae75efabb170337a497457f7ecf">GetRandHash</a>();</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        std::map&lt;uint256, COrphanTx&gt;::iterator it = mapOrphanTransactions.lower_bound(randomhash);</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="keywordflow">if</span> (it == mapOrphanTransactions.end())</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            it = mapOrphanTransactions.begin();</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(it-&gt;first);</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        ++nEvicted;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    }</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    <span class="keywordflow">return</span> nEvicted;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;}</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="keywordtype">void</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a>(<a class="code" href="class_c_connman.html">CConnman</a>* connman, std::set&lt;uint256&gt;&amp; orphan_work_set) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="comment">// Requires cs_main.</span></div><div class="line"><a name="l01024"></a><span class="lineno"><a class="line" href="net__processing_8h.html#a3c06ea09d37d8eaf7358756054486cac"> 1024</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> pnode, <span class="keywordtype">int</span> howmuch, <span class="keyword">const</span> std::string&amp; message)</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;{</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;    <span class="keywordflow">if</span> (howmuch == 0)</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    CNodeState *state = State(pnode);</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;    <span class="keywordflow">if</span> (state == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    state-&gt;nMisbehavior += howmuch;</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    <span class="keywordtype">int</span> banscore = <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">GetArg</a>(<span class="stringliteral">&quot;-banscore&quot;</span>, <a class="code" href="validation_8h.html#ae034ec95ea656e6d994828c1f5d7d596">DEFAULT_BANSCORE_THRESHOLD</a>);</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    std::string message_prefixed = message.empty() ? <span class="stringliteral">&quot;&quot;</span> : (<span class="stringliteral">&quot;: &quot;</span> + message);</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <span class="keywordflow">if</span> (state-&gt;nMisbehavior &gt;= banscore &amp;&amp; state-&gt;nMisbehavior - howmuch &lt; banscore)</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;    {</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: %s peer=%d (%d -&gt; %d) BAN THRESHOLD EXCEEDED%s\n&quot;</span>, __func__, state-&gt;name, pnode, state-&gt;nMisbehavior-howmuch, state-&gt;nMisbehavior, message_prefixed);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        state-&gt;fShouldBan = <span class="keyword">true</span>;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    } <span class="keywordflow">else</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: %s peer=%d (%d -&gt; %d)%s\n&quot;</span>, __func__, state-&gt;name, pnode, state-&gt;nMisbehavior-howmuch, state-&gt;nMisbehavior, message_prefixed);</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;}</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">// Requires cs_main.</span></div><div class="line"><a name="l01045"></a><span class="lineno"><a class="line" href="net__processing_8h.html#af63c2b55b1f17dfcd9834a7888e1ee5a"> 1045</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#af38e4f57b0dfe17ddfedb664338f5f51">IsBanned</a>(<a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> pnode)</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;{</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    CNodeState *state = State(pnode);</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    <span class="keywordflow">if</span> (state == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    <span class="keywordflow">if</span> (state-&gt;fShouldBan) {</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    }</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;}</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;<span class="comment">// blockchain -&gt; download logic notification</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="comment">// To prevent fingerprinting attacks, only send blocks/headers outside of the</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="comment">// active chain if they are no more than a month older (both in time, and in</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="comment">// best equivalent proof of work) than the best header chain we know about and</span></div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="comment">// we fully-validated them at some point.</span></div><div class="line"><a name="l01070"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a089eec67c3dbd97a69949d830f71d3be"> 1070</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#a089eec67c3dbd97a69949d830f71d3be">BlockRequestAllowed</a>(<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex, <span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a>&amp; consensusParams)</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;{</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#af1786dc229c215dea7f727c11df2c8dc">Contains</a>(pindex)) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">return</span> pindex-&gt;<a class="code" href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">IsValid</a>(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230">BLOCK_VALID_SCRIPTS</a>) &amp;&amp; (<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a> != <span class="keyword">nullptr</span>) &amp;&amp;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        (<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() - pindex-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() &lt; <a class="code" href="net__processing_8cpp.html#a0e6b031d8505920b87ff88be68767f0a">STALE_RELAY_AGE_LIMIT</a>) &amp;&amp;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;        (<a class="code" href="chain_8cpp.html#abe314b9d901829ab0166322b67cffd70">GetBlockProofEquivalentTime</a>(*<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>, *pindex, *<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>, consensusParams) &lt; <a class="code" href="net__processing_8cpp.html#a0e6b031d8505920b87ff88be68767f0a">STALE_RELAY_AGE_LIMIT</a>);</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;}</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;</div><div class="line"><a name="l01079"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a196fe0f4bf56c132a6a83a080144a43b"> 1079</a></span>&#160;<a class="code" href="class_peer_logic_validation.html#a196fe0f4bf56c132a6a83a080144a43b">PeerLogicValidation::PeerLogicValidation</a>(<a class="code" href="class_c_connman.html">CConnman</a>* connmanIn, <a class="code" href="class_c_scheduler.html">CScheduler</a> &amp;<a class="code" href="init_8cpp.html#a8d0a31e674a78e42b06732f8420a3ffa">scheduler</a>) : connman(connmanIn), m_stale_tip_check_time(0) {</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="comment">// Initialize global variables that cannot be constructed at startup.</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    recentRejects.reset(<span class="keyword">new</span> <a class="code" href="class_c_rolling_bloom_filter.html">CRollingBloomFilter</a>(120000, 0.000001));</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a>&amp; consensusParams = <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>().<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>();</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    <span class="comment">// Stale tip checking and peer eviction are on two different timers, but we</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <span class="comment">// don&#39;t want them to get out of sync due to drift in the scheduler, so we</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <span class="comment">// combine them in one function and schedule at the quicker (peer-eviction)</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    <span class="comment">// timer.</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    static_assert(<a class="code" href="net__processing_8h.html#ab005b69fa976939a3f821412b9631068">EXTRA_PEER_CHECK_INTERVAL</a> &lt; <a class="code" href="net__processing_8h.html#a981e8ad003ae095856a6b97679245be2">STALE_CHECK_INTERVAL</a>, <span class="stringliteral">&quot;peer eviction timer should be less than stale tip check timer&quot;</span>);</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    <a class="code" href="init_8cpp.html#a8d0a31e674a78e42b06732f8420a3ffa">scheduler</a>.<a class="code" href="class_c_scheduler.html#aab114cb7085474e0f1a47aa2b54e9cae">scheduleEvery</a>(std::bind(&amp;<a class="code" href="class_peer_logic_validation.html#ad9ba8b8657346c1ce86e061d5fdaeb53">PeerLogicValidation::CheckForStaleTipAndEvictPeers</a>, <span class="keyword">this</span>, consensusParams), <a class="code" href="net__processing_8h.html#ab005b69fa976939a3f821412b9631068">EXTRA_PEER_CHECK_INTERVAL</a> * 1000);</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;}</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;</div><div class="line"><a name="l01092"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a6be1affbdc736f974fd8acb52d1439b9"> 1092</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a6be1affbdc736f974fd8acb52d1439b9">PeerLogicValidation::BlockConnected</a>(<span class="keyword">const</span> std::shared_ptr&lt;const CBlock&gt;&amp; pblock, <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex, <span class="keyword">const</span> std::vector&lt;CTransactionRef&gt;&amp; vtxConflicted) {</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <a class="code" href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    std::vector&lt;uint256&gt; vOrphanErase;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    std::set&lt;uint256&gt; orphanWorkSet;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a>&amp; ptx : pblock-&gt;vtx) {</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_transaction.html">CTransaction</a>&amp; tx = *ptx;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="comment">// Which orphan pool entries we should reprocess and potentially try to accept into mempool again?</span></div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; tx.<a class="code" href="class_c_transaction.html#ad64447ea044ec850313696fc99412d95">vin</a>.size(); i++) {</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            <span class="keyword">auto</span> itByPrev = mapOrphanTransactionsByPrev.find(<a class="code" href="class_c_out_point.html">COutPoint</a>(tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>(), (uint32_t)i));</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;            <span class="keywordflow">if</span> (itByPrev == mapOrphanTransactionsByPrev.end()) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; elem : itByPrev-&gt;second) {</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                orphanWorkSet.insert(elem-&gt;first);</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        }</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;        <span class="comment">// Which orphan pool entries must we evict?</span></div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; txin : tx.<a class="code" href="class_c_transaction.html#ad64447ea044ec850313696fc99412d95">vin</a>) {</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;            <span class="keyword">auto</span> itByPrev = mapOrphanTransactionsByPrev.find(txin.prevout);</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;            <span class="keywordflow">if</span> (itByPrev == mapOrphanTransactionsByPrev.end()) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">auto</span> mi = itByPrev-&gt;second.begin(); mi != itByPrev-&gt;second.end(); ++mi) {</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                <span class="keyword">const</span> <a class="code" href="class_c_transaction.html">CTransaction</a>&amp; orphanTx = *(*mi)-&gt;second.tx;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; orphanHash = orphanTx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>();</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                vOrphanErase.push_back(orphanHash);</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            }</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        }</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    }</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="comment">// Erase orphan transactions include or precluded by this block</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> (vOrphanErase.size()) {</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        <span class="keywordtype">int</span> nErased = 0;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="classuint256.html">uint256</a> &amp;orphanHash : vOrphanErase) {</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;            nErased += <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(orphanHash);</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        }</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;Erased %d orphan tx included or conflicted by block\n&quot;</span>, nErased);</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    }</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keywordflow">while</span> (!orphanWorkSet.empty()) {</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;Trying to process %d orphans\n&quot;</span>, orphanWorkSet.size());</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;        <a class="code" href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a>(<a class="code" href="init_8cpp.html#a152c3d2ceeeaf7a300666dcbcc8bb945">g_connman</a>.get(), orphanWorkSet);</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    }</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    g_last_tip_update = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;}</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment">// All of the following cache a recent block, and are protected by cs_most_recent_block</span></div><div class="line"><a name="l01140"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7"> 1140</a></span>&#160;<span class="keyword">static</span> <a class="code" href="class_c_critical_section.html">CCriticalSection</a> <a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>;</div><div class="line"><a name="l01141"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba"> 1141</a></span>&#160;<span class="keyword">static</span> std::shared_ptr&lt;const CBlock&gt; <a class="code" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a>;</div><div class="line"><a name="l01142"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9"> 1142</a></span>&#160;<span class="keyword">static</span> std::shared_ptr&lt;const CBlockHeaderAndShortTxIDs&gt; <a class="code" href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9">most_recent_compact_block</a>;</div><div class="line"><a name="l01143"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d"> 1143</a></span>&#160;<span class="keyword">static</span> <a class="code" href="classuint256.html">uint256</a> <a class="code" href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d">most_recent_block_hash</a>;</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div><div class="line"><a name="l01145"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a4ed18bc626b7e64f822912cd1057e5cb"> 1145</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a4ed18bc626b7e64f822912cd1057e5cb">PeerLogicValidation::NewPoWValidBlock</a>(<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex, <span class="keyword">const</span> std::shared_ptr&lt;const CBlock&gt;&amp; pblock) {</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    std::shared_ptr&lt;const CBlockHeaderAndShortTxIDs&gt; pcmpctblock = std::make_shared&lt;const CBlockHeaderAndShortTxIDs&gt; (*pblock);</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(<a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>);</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    <span class="keyword">static</span> <span class="keywordtype">int</span> nHighestFastAnnounce = 0;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> &lt;= nHighestFastAnnounce)</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    nHighestFastAnnounce = pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>;</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    <a class="code" href="classuint256.html">uint256</a> hashBlock(pblock-&gt;GetHash());</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    {</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>);</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <a class="code" href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d">most_recent_block_hash</a> = hashBlock;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <a class="code" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a> = pblock;</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <a class="code" href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9">most_recent_compact_block</a> = pcmpctblock;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    }</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2d665bfdec68f6484b9f0d6760f9efd1">ForEachNode</a>([<span class="keyword">this</span>, &amp;pcmpctblock, pindex, &amp;msgMaker, &amp;hashBlock](<a class="code" href="class_c_node.html">CNode</a>* pnode) {</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <span class="comment">// TODO: Avoid the repeated-serialization here</span></div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a>)</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        ProcessBlockAvailability(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        CNodeState &amp;state = *State(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        <span class="comment">// If the peer has, or we announced to them the previous block already,</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        <span class="comment">// but we don&#39;t think they have this one, go ahead and announce it</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;        <span class="keywordflow">if</span> (state.fPreferHeaderAndIDs &amp;&amp;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;                !PeerHasHeader(&amp;state, pindex) &amp;&amp; PeerHasHeader(&amp;state, pindex-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>)) {</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s sending header-and-ids %s to peer=%d\n&quot;</span>, <span class="stringliteral">&quot;PeerLogicValidation::NewPoWValidBlock&quot;</span>,</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;                    hashBlock.ToString(), pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pnode, msgMaker.<a class="code" href="class_c_net_msg_maker.html#ac314ab21062f354bbb885e65060b815f">Make</a>(<a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a>, *pcmpctblock));</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;            state.pindexBestHeaderSent = pindex;</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        }</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    });</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;}</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;</div><div class="line"><a name="l01184"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a91f72d94f777c7af376dbaddd98aaf3f"> 1184</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a91f72d94f777c7af376dbaddd98aaf3f">PeerLogicValidation::UpdatedBlockTip</a>(<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexNew, <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexFork, <span class="keywordtype">bool</span> fInitialDownload) {</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> nNewHeight = pindexNew-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>;</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a36cf799d267785276497583398dfd4cd">SetBestHeight</a>(nNewHeight);</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    <a class="code" href="protocol_8cpp.html#a1b7cb231a14c1ace5268df7f7793529e">SetServiceFlagsIBDCache</a>(!fInitialDownload);</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordflow">if</span> (!fInitialDownload) {</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        <span class="comment">// Find the hashes of all blocks that weren&#39;t previously in the best chain.</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        std::vector&lt;uint256&gt; vHashes;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexToAnnounce = pindexNew;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="keywordflow">while</span> (pindexToAnnounce != pindexFork) {</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;            vHashes.push_back(pindexToAnnounce-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>());</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;            pindexToAnnounce = pindexToAnnounce-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            <span class="keywordflow">if</span> (vHashes.size() == <a class="code" href="validation_8h.html#ad4d4718d1ec747708a31bc47aaa66578">MAX_BLOCKS_TO_ANNOUNCE</a>) {</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                <span class="comment">// Limit announcements in case of a huge reorganization.</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                <span class="comment">// Rely on the peer&#39;s synchronization mechanism in that case.</span></div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;            }</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        }</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="comment">// Relay inventory, but don&#39;t relay old inventory during initial block download.</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2d665bfdec68f6484b9f0d6760f9efd1">ForEachNode</a>([nNewHeight, &amp;vHashes](<a class="code" href="class_c_node.html">CNode</a>* pnode) {</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;            <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;            if (nNewHeight &gt; (pnode-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a> != -1 ? pnode-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a> - 2000 : 0)) {</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;                for (const uint256&amp; hash : reverse_iterate(vHashes)) {</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;                    pnode-&gt;PushBlockHash(hash);</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                }</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            }</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        });</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a999ec42f1515f77096556c94c29c6538">WakeMessageHandler</a>();</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    }</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <a class="code" href="net__processing_8cpp.html#a147efbcf1410c50c56547340f1fe1ebd">nTimeBestReceived</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;}</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div><div class="line"><a name="l01217"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a124965d7310e0df08cc027d4e1cbbe7b"> 1217</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a124965d7310e0df08cc027d4e1cbbe7b">PeerLogicValidation::BlockChecked</a>(<span class="keyword">const</span> <a class="code" href="class_c_block.html">CBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="class_c_validation_state.html">CValidationState</a>&amp; state) {</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> hash(block.<a class="code" href="class_c_block_header.html#af0239f86a13f622a826e9eea66b2d7f3">GetHash</a>());</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    std::map&lt;uint256, std::pair&lt;NodeId, bool&gt; &gt;::iterator it = mapBlockSource.find(hash);</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;    <span class="keywordtype">int</span> nDoS = 0;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <span class="keywordflow">if</span> (state.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDoS)) {</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        <span class="comment">// Don&#39;t send reject message with code 0 or an internal reject code.</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        <span class="keywordflow">if</span> (it != mapBlockSource.end() &amp;&amp; State(it-&gt;second.first) &amp;&amp; state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>() &gt; 0 &amp;&amp; state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>() &lt; <a class="code" href="validation_8h.html#ae98e9fff288e3029a25765a7f924d960">REJECT_INTERNAL</a>) {</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;            CBlockReject reject = {(<span class="keywordtype">unsigned</span> char)state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>(), state.<a class="code" href="class_c_validation_state.html#a8fa9612cb40c3c8592f7cd29b5931ccd">GetRejectReason</a>().substr(0, <a class="code" href="validation_8h.html#af83a9cbb7b3fe9d34a7c4b43f2e040f8">MAX_REJECT_MESSAGE_LENGTH</a>), hash};</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;            State(it-&gt;second.first)-&gt;rejects.push_back(reject);</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;            <span class="keywordflow">if</span> (nDoS &gt; 0 &amp;&amp; it-&gt;second.second)</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(it-&gt;second.first, nDoS);</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        }</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    }</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    <span class="comment">// Check that:</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    <span class="comment">// 1. The block is valid</span></div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="comment">// 2. We&#39;re not in initial block download</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <span class="comment">// 3. This is currently the best block we&#39;re aware of. We haven&#39;t updated</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <span class="comment">//    the tip yet so we have no way to check this directly here. Instead we</span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="comment">//    just check that there are currently no other blocks in flight.</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state.<a class="code" href="class_c_validation_state.html#a7dc31c88ba63ad17a954f247d21b550c">IsValid</a>() &amp;&amp;</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;             !<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>() &amp;&amp;</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;             mapBlocksInFlight.count(hash) == mapBlocksInFlight.size()) {</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;        <span class="keywordflow">if</span> (it != mapBlockSource.end()) {</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;            MaybeSetPeerAsAnnouncingHeaderAndIDs(it-&gt;second.first, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>);</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        }</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    }</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keywordflow">if</span> (it != mapBlockSource.end())</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        mapBlockSource.erase(it);</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;}</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="comment">// Messages</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="comment">//</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div><div class="line"><a name="l01256"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf"> 1256</a></span>&#160;<span class="keywordtype">bool</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(<span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>)</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;{</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    <span class="keywordflow">switch</span> (inv.type)</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;    {</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>:</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>:</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aef9a99c0ec45622a52b26a434bf9af1b">MSG_LEGACY_TXLOCK_REQUEST</a>: <span class="comment">// we treat legacy IX messages as TX messages</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        {</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            assert(recentRejects);</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>() != hashRecentRejectsChainTip)</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            {</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;                <span class="comment">// If the chain tip has changed previously rejected transactions</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                <span class="comment">// might be now valid, e.g. due to a nLockTime&#39;d tx becoming valid,</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                <span class="comment">// or a double-spend. Reset the rejects filter and give those</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                <span class="comment">// txs a second chance.</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                hashRecentRejectsChainTip = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>();</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                recentRejects-&gt;reset();</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;            }</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;            {</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;                <span class="keywordflow">if</span> (mapOrphanTransactions.count(inv.hash)) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;            }</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;            <span class="comment">// When we receive an islock for a previously rejected transaction, we have to</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;            <span class="comment">// drop the first-seen tx (which such a locked transaction was conflicting with)</span></div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;            <span class="comment">// and re-request the locked transaction (which did not make it into the mempool</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;            <span class="comment">// previously due to txn-mempool-conflict rule). This means that we must ignore</span></div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            <span class="comment">// recentRejects filter for such locked txes here.</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;            <span class="comment">// We also ignore recentRejects filter for DSTX-es because a malicious peer  might</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            <span class="comment">// relay a valid DSTX as a regular TX first which would skip all the specific checks</span></div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            <span class="comment">// but would cause such tx to be rejected by ATMP due to 0 fee. Ignoring it here</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            <span class="comment">// should let DSTX to be propagated by honest peer later. Note, that a malicious</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            <span class="comment">// masternode would not be able to exploit this to spam the network with specially</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            <span class="comment">// crafted invalid DSTX-es and potentially cause high load cheaply, because</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;            <span class="comment">// corresponding checks in ProcessMessage won&#39;t let it to send DSTX-es too often.</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;            <span class="keywordtype">bool</span> fIgnoreRecentRejects = <a class="code" href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a>-&gt;<a class="code" href="classllmq_1_1_c_instant_send_manager.html#ae3b62c9f60f11b7c58110fbe66f73a2f">IsLocked</a>(inv.hash) || inv.type == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>;</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;            <span class="keywordflow">return</span> (!fIgnoreRecentRejects &amp;&amp; recentRejects-&gt;contains(inv.hash)) ||</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                   (inv.type == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a> &amp;&amp; static_cast&lt;bool&gt;(<a class="code" href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a>(inv.hash))) ||</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                   <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#a8b7a13b5289ab839d4460f41a7da9789">exists</a>(inv.hash) ||</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                   <a class="code" href="validation_8cpp.html#a751114a714075a2a620f6bedfc36fef3">pcoinsTip</a>-&gt;HaveCoinInCache(<a class="code" href="class_c_out_point.html">COutPoint</a>(inv.hash, 0)) || <span class="comment">// Best effort: only try output 0 and 1</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                   <a class="code" href="validation_8cpp.html#a751114a714075a2a620f6bedfc36fef3">pcoinsTip</a>-&gt;HaveCoinInCache(<a class="code" href="class_c_out_point.html">COutPoint</a>(inv.hash, 1)) ||</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                   (<a class="code" href="validation_8cpp.html#a6b569217f0bbb0a69a42c8769df06a06">fTxIndex</a> &amp;&amp; <a class="code" href="validation_8cpp.html#a1a5a2a93201a25764e8f16b1385b26b2">pblocktree</a>-&gt;HasTxIndex(inv.hash));</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        }</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>:</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.count(inv.hash);</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment">        Dash Related Inventory Messages</span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="comment">        --</span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="comment"></span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment">        We shouldn&#39;t update the sync times for each of the messages when we already have it.</span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="comment">        We&#39;re going to be asking many nodes upfront for the full inventory list, so we&#39;ll get duplicates of these.</span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">        We want to only update the time on new hits, so that we can time out appropriately if needed.</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abacdb1618207a44c1301ae59acf7f5d8">MSG_SPORK</a>:</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        {</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;            <a class="code" href="class_c_spork_message.html">CSporkMessage</a> <a class="code" href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a>;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="spork_8cpp.html#af6873019c3095ea6b554795e4040395c">sporkManager</a>.<a class="code" href="class_c_spork_manager.html#a9cec53a1eb6335507d5c88a17f293e7f">GetSporkByHash</a>(inv.hash, <a class="code" href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a>);</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        }</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ae8208d8fb3855c56c3e5befaeb923fa2">MSG_GOVERNANCE_OBJECT</a>:</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a2cb5fe00e73ee666aa3daef76b299251">MSG_GOVERNANCE_OBJECT_VOTE</a>:</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        <span class="keywordflow">return</span> ! <a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#a5a7e2f9bcf237d99a005dc72d4a6bfac">ConfirmInventoryRequest</a>(inv);</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ad5de2518f7a7e23590f870cf0c57a188">MSG_QUORUM_FINAL_COMMITMENT</a>:</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacellmq.html#a32533f25ea72d1153af50d680a75434d">llmq::quorumBlockProcessor</a>-&gt;<a class="code" href="classllmq_1_1_c_quorum_block_processor.html#a37b9067401b0136f82fa78b80bfe1777">HasMinableCommitment</a>(inv.hash);</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a83fb276c8e205804cbe67bfc620564ea">MSG_QUORUM_CONTRIB</a>:</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a205fd50253ff168914d8feb2b18d24fa">MSG_QUORUM_COMPLAINT</a>:</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a1d84425becf1d3c0ee012002b187d717">MSG_QUORUM_JUSTIFICATION</a>:</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa20b81ee7b9d9af13d5669dc7617efaf">MSG_QUORUM_PREMATURE_COMMITMENT</a>:</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;<a class="code" href="classllmq_1_1_c_d_k_g_session_manager.html#a030fd2b8cd39c032cddf869eb3e25ef0">AlreadyHave</a>(inv);</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa9afeebb1d379d86fc2fdafedc5fb004">MSG_QUORUM_RECOVERED_SIG</a>:</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacellmq.html#ab7c4af133e9f8609793106eaceffd8a3">llmq::quorumSigningManager</a>-&gt;<a class="code" href="classllmq_1_1_c_signing_manager.html#a6d4732770e0a6ba21442fd670c0da93a">AlreadyHave</a>(inv);</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abd3619e681a4ee498cce0c77e1794e08">MSG_CLSIG</a>:</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacellmq.html#aab0e6e59f5052f34a32a83bdd4c2999d">llmq::chainLocksHandler</a>-&gt;<a class="code" href="classllmq_1_1_c_chain_locks_handler.html#a48c5e03d83e3aeb3b06b0f7d3e950289">AlreadyHave</a>(inv);</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keywordflow">case</span> <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236">MSG_ISLOCK</a>:</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a>-&gt;<a class="code" href="classllmq_1_1_c_instant_send_manager.html#a77f081544d3b172a0f5c89a7ffb9e806">AlreadyHave</a>(inv);</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    }</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="comment">// Don&#39;t know what it is, just say we already got one</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;}</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div><div class="line"><a name="l01344"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a9d817cb9e570c539378f8c17a759c157"> 1344</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="net__processing_8cpp.html#a9d817cb9e570c539378f8c17a759c157">RelayAddress</a>(<span class="keyword">const</span> <a class="code" href="class_c_address.html">CAddress</a>&amp; addr, <span class="keywordtype">bool</span> fReachable, <a class="code" href="class_c_connman.html">CConnman</a>* connman)</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;{</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nRelayNodes = fReachable ? 2 : 1; <span class="comment">// limited relaying of addresses outside our network(s)</span></div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="comment">// Relay to a limited number of other nodes</span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="comment">// Use deterministic randomness to send to the same nodes for 24 hours</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="comment">// at a time so the addrKnowns of the chosen nodes prevent repeats</span></div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    uint64_t hashAddr = addr.<a class="code" href="class_c_net_addr.html#a8fae7d32e83e9fbb9ce0216f896133c9">GetHash</a>();</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_sip_hasher.html">CSipHasher</a> hasher = connman-&gt;<a class="code" href="class_c_connman.html#a70b9c66fa48a69fed984062c5cfda281">GetDeterministicRandomizer</a>(<a class="code" href="net__processing_8cpp.html#ae091b569e78315bb17c4b0c178aeb3b0">RANDOMIZER_ID_ADDRESS_RELAY</a>).<a class="code" href="class_c_sip_hasher.html#ad922bf75073152ed1a02789a63f38559">Write</a>(hashAddr &lt;&lt; 32).<a class="code" href="class_c_sip_hasher.html#ad922bf75073152ed1a02789a63f38559">Write</a>((<a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>() + hashAddr) / (24*60*60));</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <a class="code" href="class_fast_random_context.html">FastRandomContext</a> insecure_rand;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    std::array&lt;std::pair&lt;uint64_t, CNode*&gt;,2&gt; best{{{0, <span class="keyword">nullptr</span>}, {0, <span class="keyword">nullptr</span>}}};</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    assert(nRelayNodes &lt;= best.size());</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keyword">auto</span> sortfunc = [&amp;best, &amp;hasher, nRelayNodes](<a class="code" href="class_c_node.html">CNode</a>* pnode) {</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a04ad229ffd8c41a83118551a4d395205">CADDR_TIME_VERSION</a>) {</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;            uint64_t hashKey = <a class="code" href="class_c_sip_hasher.html">CSipHasher</a>(hasher).<a class="code" href="class_c_sip_hasher.html#ad922bf75073152ed1a02789a63f38559">Write</a>(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()).Finalize();</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nRelayNodes; i++) {</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                <span class="keywordflow">if</span> (hashKey &gt; best[i].first) {</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                    <a class="code" href="group__algorithm.html#ga97883642477d6b1e8a2b8525fc113758">std::copy</a>(best.begin() + i, best.begin() + nRelayNodes - 1, best.begin() + i + 1);</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;                    best[i] = std::make_pair(hashKey, pnode);</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                }</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            }</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        }</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    };</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <span class="keyword">auto</span> pushfunc = [&amp;addr, &amp;best, nRelayNodes, &amp;insecure_rand] {</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; nRelayNodes &amp;&amp; best[i].first != 0; i++) {</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;            best[i].second-&gt;PushAddress(addr, insecure_rand);</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;        }</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    };</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    connman-&gt;<a class="code" href="class_c_connman.html#a9b7efcca91a687285efcbad17523e0bf">ForEachNodeThen</a>(std::move(sortfunc), std::move(pushfunc));</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;}</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div><div class="line"><a name="l01380"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a2f59958b48b742e03a34f3aaf865240b"> 1380</a></span>&#160;<span class="keywordtype">void</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#a2f59958b48b742e03a34f3aaf865240b">ProcessGetBlockData</a>(<a class="code" href="class_c_node.html">CNode</a>* pfrom, <span class="keyword">const</span> <a class="code" href="class_c_chain_params.html">CChainParams</a>&amp; chainparams, <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a>&amp; inv, <a class="code" href="class_c_connman.html">CConnman</a>* connman, <span class="keyword">const</span> std::atomic&lt;bool&gt;&amp; interruptMsgProc)</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;{</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="keywordtype">bool</span> send = <span class="keyword">false</span>;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    std::shared_ptr&lt;const CBlock&gt; a_recent_block;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    std::shared_ptr&lt;const CBlockHeaderAndShortTxIDs&gt; a_recent_compact_block;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a>&amp; consensusParams = chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>();</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    {</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>);</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;        a_recent_block = <a class="code" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a>;</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;        a_recent_compact_block = <a class="code" href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9">most_recent_compact_block</a>;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    }</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <span class="keywordtype">bool</span> need_activate_chain = <span class="keyword">false</span>;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    {</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        BlockMap::iterator mi = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        <span class="keywordflow">if</span> (mi != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end())</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        {</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;            <span class="keywordflow">if</span> (mi-&gt;second-&gt;nChainTx &amp;&amp; !mi-&gt;second-&gt;IsValid(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230">BLOCK_VALID_SCRIPTS</a>) &amp;&amp;</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                    mi-&gt;second-&gt;IsValid(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573">BLOCK_VALID_TREE</a>)) {</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                <span class="comment">// If we have the block and all of its parents, but have not yet validated it,</span></div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                <span class="comment">// we might be in the middle of connecting it (ie in the unlock of cs_main</span></div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                <span class="comment">// before ActivateBestChain but after AcceptBlock).</span></div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                <span class="comment">// In this case, we need to run ActivateBestChain prior to checking the relay</span></div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                <span class="comment">// conditions below.</span></div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                need_activate_chain = <span class="keyword">true</span>;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;            }</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        }</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    } <span class="comment">// release cs_main before calling ActivateBestChain</span></div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;    <span class="keywordflow">if</span> (need_activate_chain) {</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;        <a class="code" href="class_c_validation_state.html">CValidationState</a> dummy;</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        <a class="code" href="validation_8cpp.html#a8cfbc84b7aa211f3368d4d3813be276c">ActivateBestChain</a>(dummy, <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>(), a_recent_block);</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    }</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;    BlockMap::iterator mi = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    <span class="keywordflow">if</span> (mi != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end()) {</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        send = <a class="code" href="net__processing_8cpp.html#a089eec67c3dbd97a69949d830f71d3be">BlockRequestAllowed</a>(mi-&gt;second, consensusParams);</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        <span class="keywordflow">if</span> (!send) {</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>,<span class="stringliteral">&quot;%s: ignoring request from peer=%i for old block that isn&#39;t in the main chain\n&quot;</span>, __func__, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        }</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;    }</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    <span class="comment">// disconnect node in case we have reached the outbound limit for serving historical blocks</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;    <span class="comment">// never disconnect whitelisted nodes</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;    <span class="keywordflow">if</span> (send &amp;&amp; connman-&gt;<a class="code" href="class_c_connman.html#aa12d154df14eef07418a36362d1cb8d7">OutboundTargetReached</a>(<span class="keyword">true</span>) &amp;&amp; ( ((<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a> != <span class="keyword">nullptr</span>) &amp;&amp; (<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() - mi-&gt;second-&gt;GetBlockTime() &gt; <a class="code" href="net__processing_8cpp.html#ab94135eefe3a6ea8bb6b918d69afb027">HISTORICAL_BLOCK_AGE</a>)) || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33">MSG_FILTERED_BLOCK</a>) &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>)</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;    {</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;historical block serving limit reached, disconnect peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="comment">//disconnect node</span></div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;        send = <span class="keyword">false</span>;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;    }</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    <span class="comment">// Avoid leaking prune-height by never sending blocks below the NODE_NETWORK_LIMITED threshold</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <span class="keywordflow">if</span> (send &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a> &amp;&amp; (</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;            (((pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>() &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372">NODE_NETWORK_LIMITED</a>) == <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372">NODE_NETWORK_LIMITED</a>) &amp;&amp; ((pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>() &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c">NODE_NETWORK</a>) != <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c">NODE_NETWORK</a>) &amp;&amp; (<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> - mi-&gt;second-&gt;nHeight &gt; (int)<a class="code" href="validation_8h.html#a5df18e7f16a7c3cb6ac8ea991137c5db">NODE_NETWORK_LIMITED_MIN_BLOCKS</a> + 2 <span class="comment">/* add two blocks buffer extension for possible races */</span>) )</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;       )) {</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Ignore block request below NODE_NETWORK_LIMITED threshold from peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="comment">//disconnect node and prevent it from stalling (would otherwise wait for the missing block)</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        send = <span class="keyword">false</span>;</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    }</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;    <span class="comment">// Pruned nodes may have deleted the block, so check whether</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    <span class="comment">// it&#39;s available before trying to send.</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    <span class="keywordflow">if</span> (send &amp;&amp; (mi-&gt;second-&gt;nStatus &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a>))</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    {</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        std::shared_ptr&lt;const CBlock&gt; pblock;</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="keywordflow">if</span> (a_recent_block &amp;&amp; a_recent_block-&gt;GetHash() == (*mi).second-&gt;GetBlockHash()) {</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;            pblock = a_recent_block;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;            <span class="comment">// Send block from disk</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;            std::shared_ptr&lt;CBlock&gt; pblockRead = std::make_shared&lt;CBlock&gt;();</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#a578c1df234b05798180f0235d469a5ba">ReadBlockFromDisk</a>(*pblockRead, (*mi).second, consensusParams))</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;                assert(!<span class="stringliteral">&quot;cannot load block from disk&quot;</span>);</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;            pblock = pblockRead;</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        }</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        <span class="keywordflow">if</span> (pblock) {</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;            <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>)</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a>, *pblock));</div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33">MSG_FILTERED_BLOCK</a>) {</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;                <span class="keywordtype">bool</span> sendMerkleBlock = <span class="keyword">false</span>;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;                <a class="code" href="class_c_merkle_block.html">CMerkleBlock</a> merkleBlock;</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;                {</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;                    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;                    <span class="keywordflow">if</span> (pfrom-&gt;pfilter) {</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;                        sendMerkleBlock = <span class="keyword">true</span>;</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;                        merkleBlock = <a class="code" href="class_c_merkle_block.html">CMerkleBlock</a>(*pblock, *pfrom-&gt;pfilter);</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;                    }</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;                }</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;                <span class="keywordflow">if</span> (sendMerkleBlock) {</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ae5af2ea09090341213f7021f7741e929">NetMsgType::MERKLEBLOCK</a>, merkleBlock));</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;                    <span class="comment">// CMerkleBlock just contains hashes, so also push any transactions in the block the client did not see</span></div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;                    <span class="comment">// This avoids hurting performance by pointlessly requiring a round-trip</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;                    <span class="comment">// Note that there is currently no way for a node to request any single transactions we didn&#39;t send here -</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;                    <span class="comment">// they must either disconnect and retry or request the full block.</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;                    <span class="comment">// Thus, the protocol spec specified allows for us to provide duplicate txn here,</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;                    <span class="comment">// however we MUST always provide at least what the remote peer needs</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;                    <span class="keyword">typedef</span> std::pair&lt;unsigned int, uint256&gt; PairType;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;                    <span class="keywordflow">for</span> (PairType &amp;pair : merkleBlock.<a class="code" href="class_c_merkle_block.html#a73bbbdcb5d83588b15461c02d0228999">vMatchedTxn</a>)</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;                        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>, *pblock-&gt;vtx[pair.first]));</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;                }</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;                <span class="comment">// else</span></div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;                <span class="comment">// no response</span></div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc">MSG_CMPCT_BLOCK</a>) {</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;                <span class="comment">// If a peer is asking for old blocks, we&#39;re almost guaranteed</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;                <span class="comment">// they won&#39;t have a useful mempool to match against a compact block,</span></div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;                <span class="comment">// and we don&#39;t feel like constructing the object for them, so</span></div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;                <span class="comment">// instead we respond with the full, non-compact block.</span></div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;                <span class="keywordflow">if</span> (CanDirectFetch(consensusParams) &amp;&amp;</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;                    mi-&gt;second-&gt;nHeight &gt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#ad4758bc8872ce065a9579f77c3171d40">Height</a>() - <a class="code" href="validation_8h.html#acc576d09fdf7bf11e878a178f15d4a1a">MAX_CMPCTBLOCK_DEPTH</a>) {</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;                    <span class="keywordflow">if</span> (a_recent_compact_block &amp;&amp;</div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;                        a_recent_compact_block-&gt;header.GetHash() == mi-&gt;second-&gt;GetBlockHash()) {</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;                        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a>, *a_recent_compact_block));</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;                        <a class="code" href="class_c_block_header_and_short_tx_i_ds.html">CBlockHeaderAndShortTxIDs</a> cmpctblock(*pblock);</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;                        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a>, cmpctblock));</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;                    }</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a>, *pblock));</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;                }</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            }</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;        }</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;        <span class="comment">// Trigger the peer node to send a getblocks request for the next batch of inventory</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;        <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a> == pfrom-&gt;<a class="code" href="class_c_node.html#a1a1c0d94de0197c5c4abf5a8d13364f3">hashContinue</a>)</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;        {</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;            <span class="comment">// Bypass PushInventory, this must send even if redundant,</span></div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;            <span class="comment">// and we want it right after the last block so they don&#39;t</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;            <span class="comment">// wait for other stuff first.</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;            std::vector&lt;CInv&gt; vInv;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;            vInv.push_back(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()));</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a1a1c0d94de0197c5c4abf5a8d13364f3">hashContinue</a>.<a class="code" href="classbase__blob.html#aa340be5328d911272eded433d03f30a3">SetNull</a>();</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;        }</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;    }</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;}</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;</div><div class="line"><a name="l01517"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a9f058406be3ef6ad83afbb7021424d21"> 1517</a></span>&#160;<span class="keywordtype">void</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#a9f058406be3ef6ad83afbb7021424d21">ProcessGetData</a>(<a class="code" href="class_c_node.html">CNode</a>* pfrom, <span class="keyword">const</span> <a class="code" href="class_c_chain_params.html">CChainParams</a>&amp; chainparams, <a class="code" href="class_c_connman.html">CConnman</a>* connman, <span class="keyword">const</span> std::atomic&lt;bool&gt;&amp; interruptMsgProc)</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;{</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    <a class="code" href="sync_8h.html#a2bc429e4b3e667009b3aea3a6fab8e97">AssertLockNotHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    std::deque&lt;CInv&gt;::iterator it = pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.begin();</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;    std::vector&lt;CInv&gt; vNotFound;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    {</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        <span class="keywordflow">while</span> (it != pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.end() &amp;&amp; it-&gt;IsKnownType()) {</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;            <span class="keywordflow">if</span> (interruptMsgProc)</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;                <span class="keywordflow">return</span>;</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;            <span class="comment">// Don&#39;t bother if send buffer is too full to respond anyway</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a73b323f9e310e3054d909934b37ae671">fPauseSend</a>)</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a> &amp;inv = *it;</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;            <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a> || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33">MSG_FILTERED_BLOCK</a> || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc">MSG_CMPCT_BLOCK</a>) {</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            }</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            it++;</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            <span class="comment">// Send stream from relay memory</span></div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            <span class="keywordtype">bool</span> push = <span class="keyword">false</span>;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;            <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a> || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>) {</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;                <a class="code" href="class_c_private_send_broadcast_tx.html">CPrivateSendBroadcastTx</a> dstx;</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;                <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>) {</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                    dstx = <a class="code" href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                }</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                <span class="keyword">auto</span> mi = mapRelay.find(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;                <span class="keywordflow">if</span> (mi != mapRelay.end()) {</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                    <span class="keywordflow">if</span> (dstx) {</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;                        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a0138bc5c11da6ec5f5890a53ef15ca0c">NetMsgType::DSTX</a>, dstx));</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>, *mi-&gt;second));</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                    }</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a91ddde2164145c8d4ab033e7b75bbc40">timeLastMempoolReq</a>) {</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;                    <span class="keyword">auto</span> txinfo = <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#acf4bb9f52c40164659f484d45d09ecc4">info</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;                    <span class="comment">// To protect privacy, do not answer getdata using the mempool when</span></div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;                    <span class="comment">// that TX couldn&#39;t have been INVed in reply to a MEMPOOL request.</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;                    <span class="keywordflow">if</span> (txinfo.tx &amp;&amp; txinfo.nTime &lt;= pfrom-&gt;<a class="code" href="class_c_node.html#a91ddde2164145c8d4ab033e7b75bbc40">timeLastMempoolReq</a>) {</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;                        <span class="keywordflow">if</span> (dstx) {</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;                            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a0138bc5c11da6ec5f5890a53ef15ca0c">NetMsgType::DSTX</a>, dstx));</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;                        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;                            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>, *txinfo.tx));</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;                        }</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;                        push = <span class="keyword">true</span>;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;                    }</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;                }</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;            }</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abacdb1618207a44c1301ae59acf7f5d8">MSG_SPORK</a>) {</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;                <a class="code" href="class_c_spork_message.html">CSporkMessage</a> <a class="code" href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a>;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="spork_8cpp.html#af6873019c3095ea6b554795e4040395c">sporkManager</a>.<a class="code" href="class_c_spork_manager.html#a9cec53a1eb6335507d5c88a17f293e7f">GetSporkByHash</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, <a class="code" href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a>)) {</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ae4af19c6d5d69539afe179b84a91cbad">NetMsgType::SPORK</a>, <a class="code" href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a>));</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;                }</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;            }</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ae8208d8fb3855c56c3e5befaeb923fa2">MSG_GOVERNANCE_OBJECT</a>) {</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;ProcessGetData -- MSG_GOVERNANCE_OBJECT: inv = %s\n&quot;</span>, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>());</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;                <a class="code" href="class_c_data_stream.html">CDataStream</a> ss(<a class="code" href="serialize_8h.html#a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c">SER_NETWORK</a>, pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;                <span class="keywordtype">bool</span> topush = <span class="keyword">false</span>;</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;                {</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#a7a205c72456b8abf90143e8425e28f60">HaveObjectForHash</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>)) {</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                        ss.<a class="code" href="class_c_data_stream.html#a5542e71bd7af2ab7cd7be0f381d39cb5">reserve</a>(1000);</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;                        <span class="keywordflow">if</span>(<a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#a6ec5f16eef458f094696ad59dc8e6f05">SerializeObjectForHash</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, ss)) {</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;                            topush = <span class="keyword">true</span>;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;                        }</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;                    }</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;                }</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;ProcessGetData -- MSG_GOVERNANCE_OBJECT: topush = %d, inv = %s\n&quot;</span>, topush, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>());</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;                <span class="keywordflow">if</span>(topush) {</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ab93722c7e784f3a5c110e82eb3c31078">NetMsgType::MNGOVERNANCEOBJECT</a>, ss));</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;                }</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;            }</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a2cb5fe00e73ee666aa3daef76b299251">MSG_GOVERNANCE_OBJECT_VOTE</a>) {</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;                <a class="code" href="class_c_data_stream.html">CDataStream</a> ss(<a class="code" href="serialize_8h.html#a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c">SER_NETWORK</a>, pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;                <span class="keywordtype">bool</span> topush = <span class="keyword">false</span>;</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;                {</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;                    <span class="keywordflow">if</span>(<a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#aea859ef7335f27b92e6cb37b30b84b53">HaveVoteForHash</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>)) {</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;                        ss.<a class="code" href="class_c_data_stream.html#a5542e71bd7af2ab7cd7be0f381d39cb5">reserve</a>(1000);</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;                        <span class="keywordflow">if</span>(<a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#a44147b0a9cf22ed16d3411fe119958e0">SerializeVoteForHash</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, ss)) {</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;                            topush = <span class="keyword">true</span>;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;                        }</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;                    }</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;                }</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;                <span class="keywordflow">if</span>(topush) {</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;ProcessGetData -- pushing: inv = %s\n&quot;</span>, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>());</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a4dc585a49c4b1374d2bd49ae4d4569ca">NetMsgType::MNGOVERNANCEOBJECTVOTE</a>, ss));</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                }</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;            }</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ad5de2518f7a7e23590f870cf0c57a188">MSG_QUORUM_FINAL_COMMITMENT</a>)) {</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                <a class="code" href="classllmq_1_1_c_final_commitment.html">llmq::CFinalCommitment</a> o;</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#a32533f25ea72d1153af50d680a75434d">llmq::quorumBlockProcessor</a>-&gt;GetMinableCommitmentByHash(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a0407dddb23706af2320d25a1fb26d4f5">NetMsgType::QFCOMMITMENT</a>, o));</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                }</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            }</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a83fb276c8e205804cbe67bfc620564ea">MSG_QUORUM_CONTRIB</a>)) {</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;                <a class="code" href="classllmq_1_1_c_d_k_g_contribution.html">llmq::CDKGContribution</a> o;</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;GetContribution(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a68df2f22acd8a7d824405c121f6f0708">NetMsgType::QCONTRIB</a>, o));</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;                }</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            }</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a205fd50253ff168914d8feb2b18d24fa">MSG_QUORUM_COMPLAINT</a>)) {</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                <a class="code" href="classllmq_1_1_c_d_k_g_complaint.html">llmq::CDKGComplaint</a> o;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;GetComplaint(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a8f94dab7cc977c0b2e06e2f4bf41b84b">NetMsgType::QCOMPLAINT</a>, o));</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;                }</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;            }</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a1d84425becf1d3c0ee012002b187d717">MSG_QUORUM_JUSTIFICATION</a>)) {</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;                <a class="code" href="classllmq_1_1_c_d_k_g_justification.html">llmq::CDKGJustification</a> o;</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;GetJustification(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa742e9f571614294522b03e9b019836a">NetMsgType::QJUSTIFICATION</a>, o));</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;                }</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            }</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa20b81ee7b9d9af13d5669dc7617efaf">MSG_QUORUM_PREMATURE_COMMITMENT</a>)) {</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                <a class="code" href="classllmq_1_1_c_d_k_g_premature_commitment.html">llmq::CDKGPrematureCommitment</a> o;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;GetPrematureCommitment(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a76f6fb5033f1e1a7930642475a961ac5">NetMsgType::QPCOMMITMENT</a>, o));</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;                }</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;            }</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa9afeebb1d379d86fc2fdafedc5fb004">MSG_QUORUM_RECOVERED_SIG</a>)) {</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;                <a class="code" href="classllmq_1_1_c_recovered_sig.html">llmq::CRecoveredSig</a> o;</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#ab7c4af133e9f8609793106eaceffd8a3">llmq::quorumSigningManager</a>-&gt;GetRecoveredSigForGetData(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a5e28a66012d1391df8c419f51ed078cf">NetMsgType::QSIGREC</a>, o));</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;                }</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;            }</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abd3619e681a4ee498cce0c77e1794e08">MSG_CLSIG</a>)) {</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;                <a class="code" href="classllmq_1_1_c_chain_lock_sig.html">llmq::CChainLockSig</a> o;</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#aab0e6e59f5052f34a32a83bdd4c2999d">llmq::chainLocksHandler</a>-&gt;GetChainLockByHash(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ac1a82e10726a8270c2b47168e86a43d3">NetMsgType::CLSIG</a>, o));</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;                }</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;            }</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;            <span class="keywordflow">if</span> (!push &amp;&amp; (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236">MSG_ISLOCK</a>)) {</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;                <a class="code" href="classllmq_1_1_c_instant_send_lock.html">llmq::CInstantSendLock</a> o;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a>-&gt;GetInstantSendLockByHash(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, o)) {</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ab76fe0ce1c92f8d93e86679c08889dc9">NetMsgType::ISLOCK</a>, o));</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                    push = <span class="keyword">true</span>;</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;                }</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;            }</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;            <span class="keywordflow">if</span> (!push)</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;                vNotFound.push_back(inv);</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        }</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;    } <span class="comment">// release cs_main</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;    <span class="keywordflow">if</span> (it != pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.end() &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a73b323f9e310e3054d909934b37ae671">fPauseSend</a>) {</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a> &amp;inv = *it;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        <span class="keywordflow">if</span> (inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a> || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33">MSG_FILTERED_BLOCK</a> || inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc">MSG_CMPCT_BLOCK</a>) {</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;            it++;</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;            <a class="code" href="net__processing_8cpp.html#a2f59958b48b742e03a34f3aaf865240b">ProcessGetBlockData</a>(pfrom, chainparams, inv, connman, interruptMsgProc);</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;        }</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;    }</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;    pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.erase(pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.begin(), it);</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    <span class="keywordflow">if</span> (!vNotFound.empty()) {</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;        <span class="comment">// Let the peer know that we didn&#39;t find what it asked for, so it doesn&#39;t</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        <span class="comment">// have to wait around forever.</span></div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <span class="comment">// SPV clients care about this message: it&#39;s needed when they are</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        <span class="comment">// recursively walking the dependencies of relevant unconfirmed</span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;        <span class="comment">// transactions. SPV clients want to do that because they want to know</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <span class="comment">// about (and store and rebroadcast and risk analyze) the dependencies</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;        <span class="comment">// of transactions relevant to them, without having to download the</span></div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;        <span class="comment">// entire memory pool.</span></div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <span class="comment">// Also, other nodes can use these messages to automatically request a</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="comment">// transaction from some other peer that annnounced it, and stop</span></div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;        <span class="comment">// waiting for us to respond.</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;        <span class="comment">// In normal operation, we often send NOTFOUND messages for parents of</span></div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;        <span class="comment">// transactions that we relay; if a peer is missing a parent, they may</span></div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;        <span class="comment">// assume we have them and request the parents from us.</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a567653d3f26a7e711889682e7fd1c484">NetMsgType::NOTFOUND</a>, vNotFound));</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    }</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;}</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;</div><div class="line"><a name="l01709"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aec1d19218087514e02f3cd63bab79be4"> 1709</a></span>&#160;<span class="keyword">inline</span> <span class="keywordtype">void</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#aec1d19218087514e02f3cd63bab79be4">SendBlockTransactions</a>(<span class="keyword">const</span> <a class="code" href="class_c_block.html">CBlock</a>&amp; block, <span class="keyword">const</span> <a class="code" href="class_block_transactions_request.html">BlockTransactionsRequest</a>&amp; req, <a class="code" href="class_c_node.html">CNode</a>* pfrom, <a class="code" href="class_c_connman.html">CConnman</a>* connman) {</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <a class="code" href="class_block_transactions.html">BlockTransactions</a> resp(req);</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; req.<a class="code" href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">indexes</a>.size(); i++) {</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        <span class="keywordflow">if</span> (req.<a class="code" href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">indexes</a>[i] &gt;= block.<a class="code" href="class_c_block.html#a33fcab2e8b903f5be812c714cee42626">vtx</a>.size()) {</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Peer %d sent us a getblocktxn with out-of-bounds tx indices&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;        }</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        resp.<a class="code" href="class_block_transactions.html#a1a88870022bf6c5d7522689c961fc570">txn</a>[i] = block.<a class="code" href="class_c_block.html#a33fcab2e8b903f5be812c714cee42626">vtx</a>[req.<a class="code" href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">indexes</a>[i]];</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    }</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;    <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ac23245c939bfe57d37c0a2db68e05e05">NetMsgType::BLOCKTXN</a>, resp));</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;}</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;</div><div class="line"><a name="l01724"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#ac9ffabd4f0b59fcf738fdd9b546fb6e7"> 1724</a></span>&#160;<span class="keywordtype">bool</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#ac9ffabd4f0b59fcf738fdd9b546fb6e7">ProcessHeadersMessage</a>(<a class="code" href="class_c_node.html">CNode</a> *pfrom, <a class="code" href="class_c_connman.html">CConnman</a> *connman, <span class="keyword">const</span> std::vector&lt;CBlockHeader&gt;&amp; headers, <span class="keyword">const</span> <a class="code" href="class_c_chain_params.html">CChainParams</a>&amp; chainparams, <span class="keywordtype">bool</span> punish_duplicate_invalid)</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;{</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <span class="keywordtype">size_t</span> nCount = headers.size();</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    <span class="keywordflow">if</span> (nCount == 0) {</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        <span class="comment">// Nothing interesting. Stop asking this peers for more headers.</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    }</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;    <span class="keywordtype">bool</span> received_new_header = <span class="keyword">false</span>;</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexLast = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;    {</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;        CNodeState *nodestate = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;        <span class="comment">// If this looks like it could be a block announcement (nCount &lt;</span></div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;        <span class="comment">// MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;        <span class="comment">// don&#39;t connect:</span></div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="comment">// - Send a getheaders message in response to try to connect the chain.</span></div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        <span class="comment">// - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that</span></div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        <span class="comment">//   don&#39;t connect before giving DoS points</span></div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;        <span class="comment">// - Once a headers message is received that is valid and does connect,</span></div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;        <span class="comment">//   nUnconnectingHeaders gets reset back to 0.</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(headers[0].hashPrevBlock) == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end() &amp;&amp; nCount &lt; <a class="code" href="validation_8h.html#ad4d4718d1ec747708a31bc47aaa66578">MAX_BLOCKS_TO_ANNOUNCE</a>) {</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;            nodestate-&gt;nUnconnectingHeaders++;</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>), <a class="code" href="classuint256.html">uint256</a>()));</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\n&quot;</span>,</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;                    headers[0].GetHash().ToString(),</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;                    headers[0].hashPrevBlock.ToString(),</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                    <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>,</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nodestate-&gt;nUnconnectingHeaders);</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;            <span class="comment">// Set hashLastUnknownBlock for this peer, so that if we</span></div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;            <span class="comment">// eventually get the headers - even from a different peer -</span></div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;            <span class="comment">// we can use this peer to download.</span></div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;            UpdateBlockAvailability(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), headers.back().GetHash());</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;            <span class="keywordflow">if</span> (nodestate-&gt;nUnconnectingHeaders % <a class="code" href="validation_8h.html#a42afcf61a20d8754d8285f6a1f958134">MAX_UNCONNECTING_HEADERS</a> == 0) {</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20);</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;            }</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        }</div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;        <a class="code" href="classuint256.html">uint256</a> hashLastBlock;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_block_header.html">CBlockHeader</a>&amp; header : headers) {</div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;            <span class="keywordflow">if</span> (!hashLastBlock.<a class="code" href="classbase__blob.html#aba89c6722866a5850882a509d27d7bbd">IsNull</a>() &amp;&amp; header.hashPrevBlock != hashLastBlock) {</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20, <span class="stringliteral">&quot;non-continuous headers sequence&quot;</span>);</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;            }</div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;            hashLastBlock = header.GetHash();</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        }</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;        <span class="comment">// If we don&#39;t have the last header, then they&#39;ll have given us</span></div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <span class="comment">// something new (if these headers are valid).</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(hashLastBlock) == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end()) {</div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;            received_new_header = <span class="keyword">true</span>;</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;        }</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    }</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    <a class="code" href="class_c_validation_state.html">CValidationState</a> state;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;    <a class="code" href="class_c_block_header.html">CBlockHeader</a> first_invalid_header;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#ac38e65e42c4799a42e2e45c62cd91c19">ProcessNewBlockHeaders</a>(headers, state, chainparams, &amp;pindexLast, &amp;first_invalid_header)) {</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;        <span class="keywordtype">int</span> nDoS;</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;        <span class="keywordflow">if</span> (state.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDoS)) {</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;            <span class="keywordflow">if</span> (nDoS &gt; 0) {</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nDoS, <span class="stringliteral">&quot;invalid header received&quot;</span>);</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;peer=%d: invalid header received\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;            }</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;            <span class="keywordflow">if</span> (punish_duplicate_invalid &amp;&amp; <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(first_invalid_header.<a class="code" href="class_c_block_header.html#af0239f86a13f622a826e9eea66b2d7f3">GetHash</a>()) != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end()) {</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;                <span class="comment">// Goal: don&#39;t allow outbound peers to use up our outbound</span></div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;                <span class="comment">// connection slots if they are on incompatible chains.</span></div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;                <span class="comment">//</span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;                <span class="comment">// We ask the caller to set punish_invalid appropriately based</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;                <span class="comment">// on the peer and the method of header delivery (compact</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;                <span class="comment">// blocks are allowed to be invalid in some circumstances,</span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;                <span class="comment">// under BIP 152).</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;                <span class="comment">// Here, we try to detect the narrow situation that we have a</span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;                <span class="comment">// valid block header (ie it was valid at the time the header</span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;                <span class="comment">// was received, and hence stored in mapBlockIndex) but know the</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;                <span class="comment">// block is invalid, and that a peer has announced that same</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;                <span class="comment">// block as being on its active chain.</span></div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;                <span class="comment">// Disconnect the peer in such a situation.</span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;                <span class="comment">//</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;                <span class="comment">// Note: if the header that is invalid was not accepted to our</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;                <span class="comment">// mapBlockIndex at all, that may also be grounds for</span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;                <span class="comment">// disconnecting the peer, as the chain they are on is likely</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;                <span class="comment">// to be incompatible. However, there is a circumstance where</span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;                <span class="comment">// that does not hold: if the header&#39;s timestamp is more than</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;                <span class="comment">// 2 hours ahead of our current time. In that case, the header</span></div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;                <span class="comment">// may become valid in the future, and we don&#39;t want to</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;                <span class="comment">// disconnect a peer merely for serving us one too-far-ahead</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;                <span class="comment">// block header, to prevent an attacker from splitting the</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;                <span class="comment">// network by mining a block right at the 2 hour boundary.</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;                <span class="comment">//</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;                <span class="comment">// TODO: update the DoS logic (or, rather, rewrite the</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;                <span class="comment">// DoS-interface between validation and net_processing) so that</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;                <span class="comment">// the interface is cleaner, and so that we disconnect on all the</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;                <span class="comment">// reasons that a peer&#39;s headers chain is incompatible</span></div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;                <span class="comment">// with ours (eg block-&gt;nVersion softforks, MTP violations,</span></div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;                <span class="comment">// etc), and not just the duplicate-invalid case.</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;            }</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;        }</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    }</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    {</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        CNodeState *nodestate = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        <span class="keywordflow">if</span> (nodestate-&gt;nUnconnectingHeaders &gt; 0) {</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;peer=%d: resetting nUnconnectingHeaders (%d -&gt; 0)\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nodestate-&gt;nUnconnectingHeaders);</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        }</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;        nodestate-&gt;nUnconnectingHeaders = 0;</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;        assert(pindexLast);</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;        UpdateBlockAvailability(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pindexLast-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>());</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;        <span class="comment">// From here, pindexBestKnownBlock should be guaranteed to be non-null,</span></div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        <span class="comment">// because it is set in UpdateBlockAvailability. Some nullptr checks</span></div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;        <span class="comment">// are still present, however, as belt-and-suspenders.</span></div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;        <span class="keywordflow">if</span> (received_new_header &amp;&amp; pindexLast-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &gt; <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a>) {</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;            nodestate-&gt;m_last_block_announcement = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        }</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        <span class="keywordflow">if</span> (nCount == <a class="code" href="validation_8h.html#ae90d2acb26fa19fdcd983626b0d37d0b">MAX_HEADERS_RESULTS</a>) {</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;            <span class="comment">// Headers message had its maximum size; the peer may have more headers.</span></div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;            <span class="comment">// TODO: optimize: if pindexLast is an ancestor of chainActive.Tip or pindexBestHeader, continue</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;            <span class="comment">// from there instead.</span></div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;more getheaders (%d) to end to peer=%d (startheight:%d)\n&quot;</span>, pindexLast-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a>);</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(pindexLast), <a class="code" href="classuint256.html">uint256</a>()));</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        }</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;        <span class="keywordtype">bool</span> fCanDirectFetch = CanDirectFetch(chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>());</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;        <span class="comment">// If this set of headers is valid and ends in a block with at least as</span></div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        <span class="comment">// much work as our tip, download as much as possible.</span></div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;        <span class="keywordflow">if</span> (fCanDirectFetch &amp;&amp; pindexLast-&gt;<a class="code" href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">IsValid</a>(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573">BLOCK_VALID_TREE</a>) &amp;&amp; <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &lt;= pindexLast-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a>) {</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;            std::vector&lt;const CBlockIndex*&gt; vToFetch;</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexWalk = pindexLast;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;            <span class="comment">// Calculate all the blocks we&#39;d need to switch to pindexLast, up to a limit.</span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;            <span class="keywordflow">while</span> (pindexWalk &amp;&amp; !<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#af1786dc229c215dea7f727c11df2c8dc">Contains</a>(pindexWalk) &amp;&amp; vToFetch.size() &lt;= <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a>) {</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;                <span class="keywordflow">if</span> (!(pindexWalk-&gt;<a class="code" href="class_c_block_index.html#aef7d4c3c9a4538e62821988bf6193ad8">nStatus</a> &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a>) &amp;&amp;</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;                        !mapBlocksInFlight.count(pindexWalk-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>())) {</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;                    <span class="comment">// We don&#39;t have this block, and it&#39;s not yet in flight.</span></div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;                    vToFetch.push_back(pindexWalk);</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;                }</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;                pindexWalk = pindexWalk-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>;</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;            }</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;            <span class="comment">// If pindexWalk still isn&#39;t on our main chain, we&#39;re looking at a</span></div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;            <span class="comment">// very large reorg at a time we think we&#39;re close to caught up to</span></div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;            <span class="comment">// the main chain -- this shouldn&#39;t really happen.  Bail out on the</span></div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;            <span class="comment">// direct fetch and rely on parallel download instead.</span></div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#af1786dc229c215dea7f727c11df2c8dc">Contains</a>(pindexWalk)) {</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Large reorg, won&#39;t direct fetch to %s (%d)\n&quot;</span>,</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;                        pindexLast-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(),</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;                        pindexLast-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>);</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;                std::vector&lt;CInv&gt; vGetData;</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;                <span class="comment">// Download as much as possible, from earliest to latest.</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;                <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex : <a class="code" href="reverse__iterator_8h.html#a5c42501cbdd92bec9f5a7886c4e9cfd5">reverse_iterate</a>(vToFetch)) {</div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;                    <span class="keywordflow">if</span> (nodestate-&gt;nBlocksInFlight &gt;= <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a>) {</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;                        <span class="comment">// Can&#39;t download any more from this peer</span></div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;                    }</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;                    vGetData.push_back(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()));</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;                    MarkBlockAsInFlight(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>(), pindex);</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Requesting block %s from  peer=%d\n&quot;</span>,</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;                            pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;                }</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;                <span class="keywordflow">if</span> (vGetData.size() &gt; 1) {</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Downloading blocks toward %s (%d) via headers direct fetch\n&quot;</span>,</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;                            pindexLast-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), pindexLast-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>);</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;                }</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;                <span class="keywordflow">if</span> (vGetData.size() &gt; 0) {</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;                    <span class="keywordflow">if</span> (nodestate-&gt;fSupportsDesiredCmpctVersion &amp;&amp; vGetData.size() == 1 &amp;&amp; mapBlocksInFlight.size() == 1 &amp;&amp; pindexLast-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>-&gt;<a class="code" href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">IsValid</a>(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65">BLOCK_VALID_CHAIN</a>)) {</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;                        <span class="comment">// In any case, we want to download using a compact block, not a regular one</span></div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;                        vGetData[0] = <a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc">MSG_CMPCT_BLOCK</a>, vGetData[0].hash);</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;                    }</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vGetData));</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;                }</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;            }</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        }</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        <span class="comment">// If we&#39;re in IBD, we want outbound peers that will serve us a useful</span></div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;        <span class="comment">// chain. Disconnect peers that are on chains with insufficient work.</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>() &amp;&amp; nCount != <a class="code" href="validation_8h.html#ae90d2acb26fa19fdcd983626b0d37d0b">MAX_HEADERS_RESULTS</a>) {</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;            <span class="comment">// When nCount &lt; MAX_HEADERS_RESULTS, we know we have no more</span></div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;            <span class="comment">// headers to fetch from this peer.</span></div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;            <span class="keywordflow">if</span> (nodestate-&gt;pindexBestKnownBlock &amp;&amp; nodestate-&gt;pindexBestKnownBlock-&gt;nChainWork &lt; <a class="code" href="validation_8cpp.html#a0bf92b1be4135700eeff6a48f01e3896">nMinimumChainWork</a>) {</div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;                <span class="comment">// This peer has too little work on their headers chain to help</span></div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;                <span class="comment">// us sync -- disconnect if using an outbound slot (unless</span></div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;                <span class="comment">// whitelisted or addnode).</span></div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;                <span class="comment">// Note: We compare their tip to nMinimumChainWork (rather than</span></div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;                <span class="comment">// chainActive.Tip()) because we won&#39;t start block download</span></div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;                <span class="comment">// until we have a headers chain that has at least</span></div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;                <span class="comment">// nMinimumChainWork, even if a peer has a chain past our tip,</span></div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;                <span class="comment">// as an anti-DoS measure.</span></div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a>(pfrom)) {</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;                    <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Disconnecting outbound peer %d -- headers chain has insufficient work\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;                }</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;            }</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;        }</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> &amp;&amp; <a class="code" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a>(pfrom) &amp;&amp; nodestate-&gt;pindexBestKnownBlock != <span class="keyword">nullptr</span>) {</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;            <span class="comment">// If this is an outbound peer, check to see if we should protect</span></div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;            <span class="comment">// it from the bad/lagging chain logic.</span></div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;            <span class="keywordflow">if</span> (g_outbound_peers_with_protect_from_disconnect &lt; MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT &amp;&amp; nodestate-&gt;pindexBestKnownBlock-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &gt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &amp;&amp; !nodestate-&gt;m_chain_sync.m_protect) {</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Protecting outbound peer=%d from eviction\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;                nodestate-&gt;m_chain_sync.m_protect = <span class="keyword">true</span>;</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;                ++g_outbound_peers_with_protect_from_disconnect;</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;            }</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        }</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    }</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;}</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="keywordtype">void</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a>(<a class="code" href="class_c_connman.html">CConnman</a>* connman, std::set&lt;uint256&gt;&amp; orphan_work_set) <a class="code" href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>)</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;{</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l01947"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a216e33c20d428fd73b444471958301e0"> 1947</a></span>&#160;    std::set&lt;NodeId&gt; <a class="code" href="net__processing_8cpp.html#a216e33c20d428fd73b444471958301e0">setMisbehaving</a>;</div><div class="line"><a name="l01948"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33"> 1948</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l01949"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a4c3f4b7e7b0e61fb40a351f816b363c5"> 1949</a></span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a> &amp;&amp; !orphan_work_set.empty()) {</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;        <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> orphanHash = *orphan_work_set.<a class="code" href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">begin</a>();</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;        orphan_work_set.erase(orphan_work_set.begin());</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        <span class="keyword">auto</span> orphan_it = mapOrphanTransactions.find(orphanHash);</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;        <span class="keywordflow">if</span> (orphan_it == mapOrphanTransactions.end()) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;        <span class="keyword">const</span> <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a> porphanTx = orphan_it-&gt;second.tx;</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_transaction.html">CTransaction</a>&amp; orphanTx = *porphanTx;</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;        <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> fromPeer = orphan_it-&gt;second.fromPeer;</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        <span class="keywordtype">bool</span> fMissingInputs2 = <span class="keyword">false</span>;</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;        <span class="comment">// Use a dummy CValidationState so someone can&#39;t setup nodes to counter-DoS based on orphan</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;        <span class="comment">// resolution (that is, feeding people an invalid transaction based on LegitTxX in order to get</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        <span class="comment">// anyone relaying LegitTxX banned)</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        <a class="code" href="class_c_validation_state.html">CValidationState</a> stateDummy;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a216e33c20d428fd73b444471958301e0">setMisbehaving</a>.count(fromPeer)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#a69b1be2d5750e0ba945e2a0a0f38cadc">AcceptToMemoryPool</a>(<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>, stateDummy, porphanTx, &amp;fMissingInputs2 <span class="comment">/* pfMissingInputs */</span>,</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;                <span class="keyword">false</span> <span class="comment">/* bypass_limits */</span>, 0 <span class="comment">/* nAbsurdFee */</span>)) {</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;   accepted orphan tx %s\n&quot;</span>, orphanHash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#a5fdad96946aa2bc67961ad973bf65fa5">RelayTransaction</a>(orphanTx);</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; orphanTx.<a class="code" href="class_c_transaction.html#a708645274ddfd83829315ffe5c7c5c3e">vout</a>.size(); i++) {</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;                <span class="keyword">auto</span> it_by_prev = mapOrphanTransactionsByPrev.find(<a class="code" href="class_c_out_point.html">COutPoint</a>(orphanHash, i));</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;                <span class="keywordflow">if</span> (it_by_prev != mapOrphanTransactionsByPrev.end()) {</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; elem : it_by_prev-&gt;second) {</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;                        orphan_work_set.insert(elem-&gt;first);</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;                    }</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;                }</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;            }</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;            <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(orphanHash);</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;            <a class="code" href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fMissingInputs2) {</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;            <span class="keywordtype">int</span> nDos = 0;</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;            <span class="keywordflow">if</span> (stateDummy.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDos) &amp;&amp; nDos &gt; 0) {</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;                <span class="comment">// Punish peer that gave us an invalid orphan tx</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(fromPeer, nDos);</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;                <a class="code" href="net__processing_8cpp.html#a216e33c20d428fd73b444471958301e0">setMisbehaving</a>.insert(fromPeer);</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;   invalid orphan tx %s\n&quot;</span>, orphanHash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;            }</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;            <span class="comment">// Has inputs but not accepted to mempool</span></div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;            <span class="comment">// Probably non-standard or insufficient fee</span></div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;   removed orphan tx %s\n&quot;</span>, orphanHash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;            <span class="keywordflow">if</span> (!stateDummy.<a class="code" href="class_c_validation_state.html#add2b2dc505a8527fda32295b65bb636b">CorruptionPossible</a>()) {</div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;                assert(recentRejects);</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;                recentRejects-&gt;insert(orphanHash);</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;            }</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;            <a class="code" href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a>(orphanHash);</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;            <a class="code" href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;        }</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;        <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#ab30fadfa811829e79accca41da6a8328">check</a>(<a class="code" href="validation_8cpp.html#a751114a714075a2a620f6bedfc36fef3">pcoinsTip</a>.get());</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    }</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;}</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;</div><div class="line"><a name="l02002"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#aafd21e2e5beded09e8826d455ac8e17b"> 2002</a></span>&#160;<span class="keywordtype">bool</span> <span class="keyword">static</span> <a class="code" href="net__processing_8cpp.html#aafd21e2e5beded09e8826d455ac8e17b">ProcessMessage</a>(<a class="code" href="class_c_node.html">CNode</a>* pfrom, <span class="keyword">const</span> std::string&amp; strCommand, <a class="code" href="class_c_data_stream.html">CDataStream</a>&amp; vRecv, int64_t nTimeReceived, <span class="keyword">const</span> <a class="code" href="class_c_chain_params.html">CChainParams</a>&amp; chainparams, <a class="code" href="class_c_connman.html">CConnman</a>* connman, <span class="keyword">const</span> std::atomic&lt;bool&gt;&amp; interruptMsgProc)</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;{</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;received: %s (%u bytes) peer=%d\n&quot;</span>, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), vRecv.<a class="code" href="class_c_data_stream.html#add30f866dd928fc28c47fe79a0a6723a">size</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#a797473ebdea9030ae99f9aa8c0744a6f">IsArgSet</a>(<span class="stringliteral">&quot;-dropmessagestest&quot;</span>) &amp;&amp; <a class="code" href="random_8cpp.html#a27d9149d522b1fa87d84e5e9ca902aef">GetRand</a>(<a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">GetArg</a>(<span class="stringliteral">&quot;-dropmessagestest&quot;</span>, 0)) == 0)</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;    {</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;        <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;dropmessagestest DROPPING RECV MESSAGE\n&quot;</span>);</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    }</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;</div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;    <span class="keywordflow">if</span> (!(pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>() &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb">NODE_BLOOM</a>) &amp;&amp;</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;              (strCommand == <a class="code" href="namespace_net_msg_type.html#a0e95085c85cbbb8330fa1a5ffe49070f">NetMsgType::FILTERLOAD</a> ||</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;               strCommand == <a class="code" href="namespace_net_msg_type.html#a75c8dba2361ddda663917c27f14c3a16">NetMsgType::FILTERADD</a>))</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    {</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a262584ad779f848883e0cc89ef2781f8">NO_BLOOM_VERSION</a>) {</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100);</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        }</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;    }</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;</div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>)</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    {</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;        std::string strMsg; <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ccode; std::string strReason;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;        <a class="code" href="classuint256.html">uint256</a> hash;</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;        <span class="keywordflow">try</span> {</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;            vRecv &gt;&gt; <a class="code" href="serialize_8h.html#a78e63691a056ce2368984400605e4f6e">LIMITED_STRING</a>(strMsg, <a class="code" href="class_c_message_header.html#ae440f94400fb825098e4c23fe4b129aa">CMessageHeader::COMMAND_SIZE</a>) &gt;&gt; ccode &gt;&gt; <a class="code" href="serialize_8h.html#a78e63691a056ce2368984400605e4f6e">LIMITED_STRING</a>(strReason, <a class="code" href="validation_8h.html#af83a9cbb7b3fe9d34a7c4b43f2e040f8">MAX_REJECT_MESSAGE_LENGTH</a>);</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;            <span class="keywordflow">if</span> (strMsg == <a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a> || strMsg == <a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>) {</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;                vRecv &gt;&gt; hash;</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;            }</div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;        } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::ios_base::failure&amp;) {</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;            <span class="comment">// Avoid feedback loops by preventing reject messages from triggering a new reject message.</span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Unparseable reject message received\n&quot;</span>);</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        }</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;        <span class="keywordflow">if</span> (strMsg == <a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a>) {</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;            <span class="comment">// The node requested a block from us and then rejected it, which indicates that it&#39;s most likely running</span></div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;            <span class="comment">// on rules which are incompatible to ours. Better to ban him after some time as it might otherwise keep</span></div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;            <span class="comment">// asking for the same block (if -addnode/-connect was used on the other side).</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1);</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;        }</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#ace3eef3e04606342f2d6de114a1cae26">LogAcceptCategory</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>)) {</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;            std::ostringstream ss;</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;            ss &lt;&lt; strMsg &lt;&lt; <span class="stringliteral">&quot; code &quot;</span> &lt;&lt; <a class="code" href="utilstrencodings_8cpp.html#a565b3ea015b133d01dc52b4ec6e45f07">itostr</a>(ccode) &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; strReason;</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;            <span class="keywordflow">if</span> (strMsg == <a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a> || strMsg == <a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>) {</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;                ss &lt;&lt; <span class="stringliteral">&quot;: hash &quot;</span> &lt;&lt; hash.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>();</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;            }</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Reject %s\n&quot;</span>, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(ss.str()));</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;        }</div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    }</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a79d16fca661ece8c17e786943721fd34">NetMsgType::VERSION</a>) {</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;        <span class="comment">// Each connection can only send one version message</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> != 0)</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        {</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a>) {</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, strCommand, <a class="code" href="consensus_2validation_8h.html#aae810f65f020df86be128d0c026edf44">REJECT_DUPLICATE</a>, std::string(<span class="stringliteral">&quot;Duplicate version message&quot;</span>)));</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;            }</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1);</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        }</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;        int64_t nTime;</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        <a class="code" href="class_c_address.html">CAddress</a> addrMe;</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        <a class="code" href="class_c_address.html">CAddress</a> addrFrom;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;        uint64_t nNonce = 1;</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        uint64_t nServiceInt;</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;        <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537">ServiceFlags</a> nServices;</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;        <span class="keywordtype">int</span> nVersion;</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;        <span class="keywordtype">int</span> nSendVersion;</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;        std::string strSubVer;</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;        std::string cleanSubVer;</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;        <span class="keywordtype">int</span> nStartingHeight = -1;</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        <span class="keywordtype">bool</span> fRelay = <span class="keyword">true</span>;</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;        vRecv &gt;&gt; nVersion &gt;&gt; nServiceInt &gt;&gt; nTime &gt;&gt; addrMe;</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;        nSendVersion = std::min(nVersion, <a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>);</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;        nServices = <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537">ServiceFlags</a>(nServiceInt);</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>)</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;        {</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#a46915b82dd2183baf2944d74d88a4228">SetServices</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>, nServices);</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;        }</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a25c9b62c42159cc94c6e8ede9ad0ed9d">fFeeler</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a6d81efc365079ca499a5f6465967d8d9">m_manual_connection</a> &amp;&amp; !<a class="code" href="protocol_8h.html#a704107b66bfb835ad593b1045e663e8f">HasAllDesirableServiceFlags</a>(nServices))</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        {</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nServices, <a class="code" href="protocol_8cpp.html#a4a92bd3e5b80138a55fafae4c4770ecd">GetDesirableServiceFlags</a>(nServices));</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a>) {</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, strCommand, <a class="code" href="consensus_2validation_8h.html#aaebbd8495fbce589cdf05570198c4240">REJECT_NONSTANDARD</a>,</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;                                   <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Expected to offer services %08x&quot;</span>, <a class="code" href="protocol_8cpp.html#a4a92bd3e5b80138a55fafae4c4770ecd">GetDesirableServiceFlags</a>(nServices))));</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;            }</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        }</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;        <span class="keywordflow">if</span> (nVersion &lt; <a class="code" href="version_8h.html#a7ef2601209957b98b7cc1a186f8e6e62">MIN_PEER_PROTO_VERSION</a>)</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;        {</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;            <span class="comment">// disconnect from peers older than this proto version</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;peer=%d using obsolete version %i; disconnecting\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nVersion);</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a>) {</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, strCommand, <a class="code" href="consensus_2validation_8h.html#a33438febc90b2b44c11530b8207d2e0f">REJECT_OBSOLETE</a>,</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;                                   <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Version must be %d or greater&quot;</span>, <a class="code" href="version_8h.html#a7ef2601209957b98b7cc1a186f8e6e62">MIN_PEER_PROTO_VERSION</a>)));</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;            }</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;        }</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;        <span class="keywordflow">if</span> (nVersion == 10300)</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;            nVersion = 300;</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>())</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;            vRecv &gt;&gt; addrFrom &gt;&gt; nNonce;</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>()) {</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;            vRecv &gt;&gt; <a class="code" href="serialize_8h.html#a78e63691a056ce2368984400605e4f6e">LIMITED_STRING</a>(strSubVer, <a class="code" href="net_8h.html#a2f02122aa15cdc5ac394b010f97422e9">MAX_SUBVERSION_LENGTH</a>);</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;            cleanSubVer = <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strSubVer);</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;        }</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>()) {</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;            vRecv &gt;&gt; nStartingHeight;</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;        }</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>())</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;            vRecv &gt;&gt; fRelay;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>()) {</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a28c9c18f0d9c7488288b87610f0adb91">cs_mnauth</a>);</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;            vRecv &gt;&gt; pfrom-&gt;<a class="code" href="class_c_node.html#a98b31d12a78834edc4a12ff48747d78d">receivedMNAuthChallenge</a>;</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;        }</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;        <span class="keywordflow">if</span> (!vRecv.<a class="code" href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">empty</a>()) {</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;            <span class="keywordtype">bool</span> fOtherMasternode = <span class="keyword">false</span>;</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;            vRecv &gt;&gt; fOtherMasternode;</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>) {</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a> = fOtherMasternode;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                <span class="keywordflow">if</span> (fOtherMasternode) {</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a08053ad8cb32039ead7f837fdc92e6f5">BCLog::NET_NETCONN</a>, <span class="stringliteral">&quot;peer=%d is an inbound masternode connection, not relaying anything to it\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="util_8cpp.html#aab0b2c1be849102968dfee289f3b3e2a">fMasternodeMode</a>) {</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a08053ad8cb32039ead7f837fdc92e6f5">BCLog::NET_NETCONN</a>, <span class="stringliteral">&quot;but we&#39;re not a masternode, disconnecting\n&quot;</span>);</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;                        pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;                    }</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;                }</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;            }</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;        }</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;        <span class="comment">// Disconnect if we connected to ourself</span></div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> &amp;&amp; !connman-&gt;<a class="code" href="class_c_connman.html#ac95687bc3457cbc25a78abcc2a5cc7fc">CheckIncomingNonce</a>(nNonce))</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;        {</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;connected to self at %s, disconnecting\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>());</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;        }</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> &amp;&amp; addrMe.IsRoutable())</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;        {</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;            <a class="code" href="net_8cpp.html#af7487aacfc9d708b3db40c255ec070a8">SeenLocal</a>(addrMe);</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;        }</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;        <span class="comment">// Be shy and don&#39;t send version until we hear</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>)</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;            PushNodeVersion(pfrom, connman, <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>());</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>().NetworkIDString() == <a class="code" href="class_c_base_chain_params.html#a86abcc91bfa683e47bb113e32ff86dec">CBaseChainParams::DEVNET</a>) {</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;            <span class="keywordflow">if</span> (strSubVer.find(<a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;devnet=%s&quot;</span>, <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#a7c11364ea29c86c5c69d324acd81b543">GetDevNetName</a>())) == std::string::npos) {</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;                <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;connected to wrong devnet. Reported version is %s, expected devnet name is %s\n&quot;</span>, strSubVer, <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#a7c11364ea29c86c5c69d324acd81b543">GetDevNetName</a>());</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;                <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>)</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100); <span class="comment">// don&#39;t try to connect again</span></div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1); <span class="comment">// whover connected, might just have made a mistake, don&#39;t ban him immediately</span></div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;            }</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        }</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#aaf8228cc7b3374862bcb3d79f5ff38e6">NetMsgType::VERACK</a>));</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a3d311ea99f2524e5c2cdb9a311725b9f">nServices</a> = nServices;</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a331888bc15bb49775451d951735e4b6a">SetAddrLocal</a>(addrMe);</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        {</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#acf48a43182292a6636c9de3ea7453d72">cs_SubVer</a>);</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;            pfrom-&gt;strSubVer = strSubVer;</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;            pfrom-&gt;cleanSubVer = cleanSubVer;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;        }</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a> = nStartingHeight;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;        <span class="comment">// set nodes not relaying blocks and tx and not serving (parts) of the historical blockchain as &quot;clients&quot;</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a721e2470c2c961b7599768a14be68781">fClient</a> = (!(nServices &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c">NODE_NETWORK</a>) &amp;&amp; !(nServices &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372">NODE_NETWORK_LIMITED</a>));</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="comment">// set nodes not capable of serving the complete blockchain history as &quot;limited nodes&quot;</span></div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#ad145fde29bb13ec1f761bacbf8674df9">m_limited_node</a> = (!(nServices &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c">NODE_NETWORK</a>) &amp;&amp; (nServices &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372">NODE_NETWORK_LIMITED</a>));</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;        {</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#ab387bb0c4ffd42e3f0aea233dca0e301">fRelayTxes</a> = fRelay; <span class="comment">// set to true after we get the first filter* message</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;        }</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;        <span class="comment">// Change version</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a0a55cea2748b1837610b2caed8069a90">SetSendVersion</a>(nSendVersion);</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> = nVersion;</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;        <span class="comment">// Potentially mark this peer as a preferred download peer.</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;        {</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        UpdatePreferredDownload(pfrom, State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;        }</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>)</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;        {</div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;            <span class="comment">// Advertise our address</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net_8cpp.html#a5067f8b9215406011fa3461be92d819c">fListen</a> &amp;&amp; !<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>())</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;            {</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;                <a class="code" href="class_c_address.html">CAddress</a> addr = <a class="code" href="net_8cpp.html#a01304c8caa7997b48da307d19d1d284a">GetLocalAddress</a>(&amp;pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>, pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>());</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;                <a class="code" href="class_fast_random_context.html">FastRandomContext</a> insecure_rand;</div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;                <span class="keywordflow">if</span> (addr.<a class="code" href="class_c_net_addr.html#a4e3b2fea2a6151c76684b3812df4a5c3">IsRoutable</a>())</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                {</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;ProcessMessages: advertising address %s\n&quot;</span>, addr.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>());</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#a1f39037c55bed93b832bcbef00597ca5">PushAddress</a>(addr, insecure_rand);</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="net_8cpp.html#a058b75c6fcc94a0643184c237ad6de93">IsPeerAddrLocalGood</a>(pfrom)) {</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;                    addr.<a class="code" href="class_c_net_addr.html#a1c6087345e5ca07a151451cd6deb974f">SetIP</a>(addrMe);</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;ProcessMessages: advertising address %s\n&quot;</span>, addr.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>());</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#a1f39037c55bed93b832bcbef00597ca5">PushAddress</a>(addr, insecure_rand);</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;                }</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;            }</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;            <span class="comment">// Get recent addresses</span></div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a> || pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a04ad229ffd8c41a83118551a4d395205">CADDR_TIME_VERSION</a> || connman-&gt;<a class="code" href="class_c_connman.html#a47a0fe62e6fb1008c77f3b2150214213">GetAddressCount</a>() &lt; 1000)</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;            {</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(nSendVersion).Make(<a class="code" href="namespace_net_msg_type.html#a4d0f984b71f9e4c4b8b3619cb3f3dadd">NetMsgType::GETADDR</a>));</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a3da9c559959e182aff8439cd004ff624">fGetAddr</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;            }</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#a85dedb235a648a1b8370228ba62ebacb">MarkAddressGood</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>);</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;        }</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;        std::string remoteAddr;</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a8e02420c2f7c53579ccb90acf301ae75">fLogIPs</a>)</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;            remoteAddr = <span class="stringliteral">&quot;, peeraddr=&quot;</span> + pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>();</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\n&quot;</span>,</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;                  cleanSubVer, pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a>,</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;                  pfrom-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a>, addrMe.ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(),</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;                  remoteAddr);</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;        int64_t <a class="code" href="timedata_8cpp.html#af9b8f3d7f6fc349e8c8fffb2733896c5">nTimeOffset</a> = nTime - <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a1ab8dcaa79a208ee8b9ce58587b206af">nTimeOffset</a> = <a class="code" href="timedata_8cpp.html#af9b8f3d7f6fc349e8c8fffb2733896c5">nTimeOffset</a>;</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;        <a class="code" href="timedata_8cpp.html#ac2624434f4891e8d74f9b13ec91f95d2">AddTimeData</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>, <a class="code" href="timedata_8cpp.html#af9b8f3d7f6fc349e8c8fffb2733896c5">nTimeOffset</a>);</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;        <span class="comment">// Feeler connections exist only to verify if address is online.</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a25c9b62c42159cc94c6e8ede9ad0ed9d">fFeeler</a>) {</div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;            assert(pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> == <span class="keyword">false</span>);</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;        }</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;    }</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;    <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> == 0) {</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;        <span class="comment">// Must have a version message before anything else</span></div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1);</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    }</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;    <span class="comment">// At this point, the outgoing message serialization version can&#39;t change.</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pfrom-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#aaf8228cc7b3374862bcb3d79f5ff38e6">NetMsgType::VERACK</a>)</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;    {</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a94438c6285d1635c62ccff10593780e6">SetRecvVersion</a>(std::min(pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a>.load(), <a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>));</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>) {</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;            <span class="comment">// Mark this node as currently connected, so we update its timestamp later.</span></div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;            State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())-&gt;fCurrentlyConnected = <span class="keyword">true</span>;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;New outbound peer connected: version: %d, blocks=%d, peer=%d%s\n&quot;</span>,</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;                      pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a>.load(), pfrom-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(),</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;                      (<a class="code" href="util_8cpp.html#a8e02420c2f7c53579ccb90acf301ae75">fLogIPs</a> ? <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;, peeraddr=%s&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>.<a class="code" href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">ToString</a>()) : <span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;        }</div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a352cc543eb23823a6b16a5166c8db2c3">LLMQS_PROTO_VERSION</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a347c7f2314f8bc7dfa3261deaa428af6">fMasternodeProbe</a>) {</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;            <a class="code" href="class_c_m_n_auth.html#a388fbfbd32337976fc3916f52dfd0e73">CMNAuth::PushMNAUTH</a>(pfrom, *connman);</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;        }</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a4e18717137ea36916ec24018040cf954">SENDHEADERS_VERSION</a>) {</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;            <span class="comment">// Tell our peer we prefer to receive headers rather than inv&#39;s</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;            <span class="comment">// We send this to non-NODE NETWORK peers as well, because even</span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;            <span class="comment">// non-NODE NETWORK peers can announce blocks (such as pruning</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;            <span class="comment">// nodes)</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a34f999f9e5179be5fc361aaca9c0e5b3">NetMsgType::SENDHEADERS</a>));</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;        }</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a43420c87666449f8132e21687abcfda9">SHORT_IDS_BLOCKS_VERSION</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;            <span class="comment">// Tell our peer we are willing to provide version-1 cmpctblocks</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;            <span class="comment">// However, we do not request new block announcements using</span></div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;            <span class="comment">// cmpctblock messages.</span></div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;            <span class="comment">// We send this to non-NODE NETWORK peers as well, because</span></div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;            <span class="comment">// they may wish to request compact blocks from us</span></div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;            <span class="keywordtype">bool</span> fAnnounceUsingCMPCTBLOCK = <span class="keyword">false</span>;</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;            uint64_t nCMPCTBLOCKVersion = 1;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a4cdafba4d585b4699628412c7f1c3d8b">NetMsgType::SENDCMPCT</a>, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;        }</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#acdca0ff5df4d6afbaca01bcfe83f37ee">SENDDSQUEUE_PROTO_VERSION</a>) {</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;            <span class="comment">// Tell our peer that he should send us PrivateSend queue messages</span></div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a83f0bd58fd86df5b4dd80afa5818ac5b">NetMsgType::SENDDSQUEUE</a>, <span class="keyword">true</span>));</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;            <span class="comment">// older nodes do not support SENDDSQUEUE and expect us to always send PrivateSend queue messages</span></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;            <span class="comment">// TODO we can remove this compatibility code in 0.15.0</span></div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a283b81dec17d8f75ad4eb9ddc874876b">fSendDSQueue</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;        }</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt;= <a class="code" href="version_8h.html#a352cc543eb23823a6b16a5166c8db2c3">LLMQS_PROTO_VERSION</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;            <span class="comment">// Tell our peer that we&#39;re interested in plain LLMQ recovered signatures.</span></div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;            <span class="comment">// Otherwise the peer would only announce/send messages resulting from QRECSIG,</span></div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;            <span class="comment">// e.g. InstantSend locks or ChainLocks. SPV nodes should not send this message</span></div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;            <span class="comment">// as they are usually only interested in the higher level messages</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a424f64542eaaf2a84d57e3c4b7b3d34b">NetMsgType::QSENDRECSIGS</a>, <span class="keyword">true</span>));</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;        }</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#af81c6e2a9dcd6b12557a2387fd67b2a6">GetBoolArg</a>(<span class="stringliteral">&quot;-watchquorums&quot;</span>, <a class="code" href="namespacellmq.html#a41c9d2058d9a5a58a3a7c29a42c7c1de">llmq::DEFAULT_WATCH_QUORUMS</a>) &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a19dda2012adbad9f24e0cbd286d08676">NetMsgType::QWATCH</a>));</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;        }</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a359647a8e7ad1fc72243b126b35729b6">fSuccessfullyConnected</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    }</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;    <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#a359647a8e7ad1fc72243b126b35729b6">fSuccessfullyConnected</a>) {</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;        <span class="comment">// Must have a verack message before anything else</span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;        <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1);</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;    }</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;    <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a7ad782061899c99918ec9e239b387f92">nTimeFirstMessageReceived</a> == 0) {</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;        <span class="comment">// First message after VERSION/VERACK</span></div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a7ad782061899c99918ec9e239b387f92">nTimeFirstMessageReceived</a> = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>();</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a561a6acb4365b4b3ad9c35e0bba66619">fFirstMessageIsMNAUTH</a> = strCommand == <a class="code" href="namespace_net_msg_type.html#af32be9381de5ac2bf6f40d606b39eef5">NetMsgType::MNAUTH</a>;</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;        <span class="comment">// Note: do not break the flow here</span></div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a347c7f2314f8bc7dfa3261deaa428af6">fMasternodeProbe</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a561a6acb4365b4b3ad9c35e0bba66619">fFirstMessageIsMNAUTH</a>) {</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;connection is a masternode probe but first received message is not MNAUTH, peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;        }</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    }</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a77d83bbf95702906ee01ca4fd934e1c0">NetMsgType::ADDR</a>) {</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;        std::vector&lt;CAddress&gt; vAddr;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        vRecv &gt;&gt; vAddr;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;        <span class="comment">// Don&#39;t want addr from older versions unless seeding</span></div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &lt; <a class="code" href="version_8h.html#a04ad229ffd8c41a83118551a4d395205">CADDR_TIME_VERSION</a> &amp;&amp; connman-&gt;<a class="code" href="class_c_connman.html#a47a0fe62e6fb1008c77f3b2150214213">GetAddressCount</a>() &gt; 1000)</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;        <span class="keywordflow">if</span> (vAddr.size() &gt; 1000)</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        {</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;message addr size() = %u&quot;</span>, vAddr.size()));</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        }</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;        <span class="comment">// Store the new addresses</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;        std::vector&lt;CAddress&gt; vAddrOk;</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;        int64_t nNow = <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>();</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;        int64_t nSince = nNow - 10 * 60;</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="class_c_address.html">CAddress</a>&amp; addr : vAddr)</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;        {</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;            <span class="keywordflow">if</span> (interruptMsgProc)</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;            <span class="comment">// We only bother storing full nodes, though this may include</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;            <span class="comment">// things which we would not make an outbound connection to, in</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;            <span class="comment">// part because we may make feeler connections to them.</span></div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="protocol_8h.html#aefab12794628ce5447d5edb26c05f4f5">MayHaveUsefulAddressDB</a>(addr.<a class="code" href="class_c_address.html#a24e2309d92694a5a234751634bdf0458">nServices</a>) &amp;&amp; !<a class="code" href="protocol_8h.html#a704107b66bfb835ad593b1045e663e8f">HasAllDesirableServiceFlags</a>(addr.<a class="code" href="class_c_address.html#a24e2309d92694a5a234751634bdf0458">nServices</a>))</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;            <span class="keywordflow">if</span> (addr.<a class="code" href="class_c_address.html#ac1c44aac968b11f90ce529b133ae4e9b">nTime</a> &lt;= 100000000 || addr.<a class="code" href="class_c_address.html#ac1c44aac968b11f90ce529b133ae4e9b">nTime</a> &gt; nNow + 10 * 60)</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;                addr.<a class="code" href="class_c_address.html#ac1c44aac968b11f90ce529b133ae4e9b">nTime</a> = nNow - 5 * 24 * 60 * 60;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a923c9640a28f97cf9c23a21ae8e13c97">AddAddressKnown</a>(addr);</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;            <span class="keywordtype">bool</span> fReachable = <a class="code" href="net_8cpp.html#af6de8e47b01a96206402ddef734114f2">IsReachable</a>(addr);</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;            <span class="keywordflow">if</span> (addr.<a class="code" href="class_c_address.html#ac1c44aac968b11f90ce529b133ae4e9b">nTime</a> &gt; nSince &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a3da9c559959e182aff8439cd004ff624">fGetAddr</a> &amp;&amp; vAddr.size() &lt;= 10 &amp;&amp; addr.<a class="code" href="class_c_net_addr.html#a4e3b2fea2a6151c76684b3812df4a5c3">IsRoutable</a>())</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;            {</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;                <a class="code" href="net__processing_8cpp.html#a9d817cb9e570c539378f8c17a759c157">RelayAddress</a>(addr, fReachable, connman);</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;            }</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;            <span class="comment">// Do not store addresses outside our network</span></div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;            <span class="keywordflow">if</span> (fReachable)</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;                vAddrOk.push_back(addr);</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;        }</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        connman-&gt;<a class="code" href="class_c_connman.html#a47d9024273a8c421fa7de641c30e9081">AddNewAddresses</a>(vAddrOk, pfrom-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>, 2 * 60 * 60);</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;        <span class="keywordflow">if</span> (vAddr.size() &lt; 1000)</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a3da9c559959e182aff8439cd004ff624">fGetAddr</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;        if (pfrom-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a>)</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;    }</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a34f999f9e5179be5fc361aaca9c0e5b3">NetMsgType::SENDHEADERS</a>) {</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())-&gt;fPreferHeaders = <span class="keyword">true</span>;</div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;    }</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;     <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a4cdafba4d585b4699628412c7f1c3d8b">NetMsgType::SENDCMPCT</a>) {</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;        <span class="keywordtype">bool</span> fAnnounceUsingCMPCTBLOCK = <span class="keyword">false</span>;</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;        uint64_t nCMPCTBLOCKVersion = 1;</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;        vRecv &gt;&gt; fAnnounceUsingCMPCTBLOCK &gt;&gt; nCMPCTBLOCKVersion;</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;        <span class="keywordflow">if</span> (nCMPCTBLOCKVersion == 1) {</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;            State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())-&gt;fProvidesHeaderAndIDs = <span class="keyword">true</span>;</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;            State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())-&gt;fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;            State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())-&gt;fSupportsDesiredCmpctVersion = <span class="keyword">true</span>;</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;        }</div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;    }</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;</div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;</div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a83f0bd58fd86df5b4dd80afa5818ac5b">NetMsgType::SENDDSQUEUE</a>)</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;    {</div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;        <span class="keywordtype">bool</span> b;</div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;        vRecv &gt;&gt; b;</div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a283b81dec17d8f75ad4eb9ddc874876b">fSendDSQueue</a> = b;</div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;    }</div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;</div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;</div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a424f64542eaaf2a84d57e3c4b7b3d34b">NetMsgType::QSENDRECSIGS</a>) {</div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;        <span class="keywordtype">bool</span> b;</div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;        vRecv &gt;&gt; b;</div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a1a1bccbef28288774a6e38ae5a913d49">fSendRecSigs</a> = b;</div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;    }</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>) {</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;        std::vector&lt;CInv&gt; vInv;</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;        vRecv &gt;&gt; vInv;</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;        <span class="keywordflow">if</span> (vInv.size() &gt; <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>)</div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;        {</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;message inv size() = %u&quot;</span>, vInv.size()));</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;        }</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;        <span class="keywordtype">bool</span> fBlocksOnly = !<a class="code" href="net_8cpp.html#a7935254c613d6f3cdadd3ce45f7efbff">fRelayTxes</a>;</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;        <span class="comment">// Allow whitelisted peers to send data other than blocks in blocks only mode if whitelistrelay is true</span></div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a> &amp;&amp; <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#af81c6e2a9dcd6b12557a2387fd67b2a6">GetBoolArg</a>(<span class="stringliteral">&quot;-whitelistrelay&quot;</span>, <a class="code" href="validation_8h.html#a5289ed91f1daf187bba005dd54d62649">DEFAULT_WHITELISTRELAY</a>))</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;            fBlocksOnly = <span class="keyword">false</span>;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        <span class="keyword">const</span> <span class="keyword">auto</span> current_time = GetTime&lt;std::chrono::microseconds&gt;();</div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;        <span class="keywordflow">for</span> (<a class="code" href="class_c_inv.html">CInv</a> &amp;inv : vInv)</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;        {</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;            <span class="keywordflow">if</span>(!inv.IsKnownType()) {</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;got inv of unknown type %d: %s peer=%d\n&quot;</span>, inv.type, inv.hash.ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;            }</div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;</div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;            <span class="keywordflow">if</span> (interruptMsgProc)</div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;</div><div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;            <span class="keywordtype">bool</span> fAlreadyHave = <a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(inv);</div><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;got inv: %s  %s peer=%d\n&quot;</span>, inv.ToString(), fAlreadyHave ? <span class="stringliteral">&quot;have&quot;</span> : <span class="stringliteral">&quot;new&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;            <span class="keywordflow">if</span> (inv.type == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>) {</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;                UpdateBlockAvailability(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), inv.hash);</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;                <span class="keywordflow">if</span> (fAlreadyHave || <a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> || <a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a> || mapBlocksInFlight.count(inv.hash)) {</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;                }</div><div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;</div><div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;                CNodeState *state = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;                <span class="keywordflow">if</span> (!state) {</div><div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;                }</div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;</div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;                <span class="comment">// Download if this is a nice peer, or we have no nice peers and this one might do.</span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;                <span class="keywordtype">bool</span> fFetch = state-&gt;fPreferredDownload || (nPreferredDownload == 0 &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a>);</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;                <span class="comment">// Only actively request headers from a single peer, unless we&#39;re close to end of initial download.</span></div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;                <span class="keywordflow">if</span> ((nSyncStarted == 0 &amp;&amp; fFetch) || <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() &gt; <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - <a class="code" href="validation_8cpp.html#af66174e55ad9bafa7a92e4740db6b575">nMaxTipAge</a>) {</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;                    <span class="comment">// Make sure to mark this peer as the one we are currently syncing with etc.</span></div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;                    state-&gt;fSyncStarted = <span class="keyword">true</span>;</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;                    state-&gt;nHeadersSyncTimeout = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>() + <a class="code" href="net__processing_8h.html#a09ba6681dd87e0136d25acc054a335a0">HEADERS_DOWNLOAD_TIMEOUT_BASE</a> + <a class="code" href="net__processing_8h.html#a8a4d3867ceb626ccda62b3b728425d07">HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</a> * (<a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>())/(chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>().<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a>);</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;                    nSyncStarted++;</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;                    <span class="comment">// We used to request the full block here, but since headers-announcements are now the</span></div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;                    <span class="comment">// primary method of announcement on the network, and since, in the case that a node</span></div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;                    <span class="comment">// fell back to inv we probably have a reorg which we should get the headers for first,</span></div><div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;                    <span class="comment">// we now only provide a getheaders response here. When we receive the headers, we will</span></div><div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;                    <span class="comment">// then ask for the blocks we need.</span></div><div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>), inv.hash));</div><div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;getheaders (%d) %s to peer=%d\n&quot;</span>, <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, inv.hash.ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;                }</div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;            }</div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;            {</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;                <span class="keyword">static</span> std::set&lt;int&gt; allowWhileInIBDObjs = {</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;                        <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abacdb1618207a44c1301ae59acf7f5d8">MSG_SPORK</a></div><div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;                };</div><div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;</div><div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#ac3054eb6ade84e8968f032ce3e700f6a">AddInventoryKnown</a>(inv);</div><div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;                <span class="keywordflow">if</span> (fBlocksOnly) {</div><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;transaction (%s) inv sent in violation of protocol peer=%d\n&quot;</span>, inv.hash.ToString(),</div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;                             pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAlreadyHave) {</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;                    <span class="keywordtype">bool</span> allowWhileInIBD = allowWhileInIBDObjs.count(inv.type);</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;                    <span class="keywordflow">if</span> (allowWhileInIBD || (!<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a> &amp;&amp; !<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>())) {</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;                        <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()), inv, current_time);</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;                    }</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;                }</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;            }</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;        }</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;    }</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;</div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>) {</div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;        std::vector&lt;CInv&gt; vInv;</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;        vRecv &gt;&gt; vInv;</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;        <span class="keywordflow">if</span> (vInv.size() &gt; <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>)</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;        {</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;message getdata size() = %u&quot;</span>, vInv.size()));</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        }</div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;received getdata (%u invsz) peer=%d\n&quot;</span>, vInv.size(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;        <span class="keywordflow">if</span> (vInv.size() &gt; 0) {</div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;received getdata for: %s peer=%d\n&quot;</span>, vInv[0].ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160;        }</div><div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;</div><div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.insert(pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.end(), vInv.begin(), vInv.end());</div><div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;        <a class="code" href="net__processing_8cpp.html#a9f058406be3ef6ad83afbb7021424d21">ProcessGetData</a>(pfrom, chainparams, connman, interruptMsgProc);</div><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    }</div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;</div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a7a51f1ef81fa21178b6e241937934fed">NetMsgType::GETBLOCKS</a>) {</div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;        <a class="code" href="struct_c_block_locator.html">CBlockLocator</a> locator;</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;        <a class="code" href="classuint256.html">uint256</a> hashStop;</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;        vRecv &gt;&gt; locator &gt;&gt; hashStop;</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;        <span class="comment">// We might have announced the currently-being-connected tip using a</span></div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        <span class="comment">// compact block, which resulted in the peer sending a getblocks</span></div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;        <span class="comment">// request, which we would otherwise respond to without the new block.</span></div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;        <span class="comment">// To avoid this situation we simply verify that we are on our best</span></div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;        <span class="comment">// known chain now. This is super overkill, but we handle it better</span></div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;        <span class="comment">// for getheaders requests, and there are no known nodes which support</span></div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;        <span class="comment">// compact blocks but still use getblocks to request blocks.</span></div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;        {</div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;            std::shared_ptr&lt;const CBlock&gt; a_recent_block;</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;            {</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>);</div><div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;                a_recent_block = <a class="code" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a>;</div><div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;            }</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;            <a class="code" href="class_c_validation_state.html">CValidationState</a> dummy;</div><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;            <a class="code" href="validation_8cpp.html#a8cfbc84b7aa211f3368d4d3813be276c">ActivateBestChain</a>(dummy, <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>(), a_recent_block);</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;        }</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;</div><div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;        <span class="comment">// Find the last block the caller has in the main chain</span></div><div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex = <a class="code" href="validation_8cpp.html#af43d57aa8b46a53839777e8b670c9d66">FindForkInGlobalIndex</a>(<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>, locator);</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;        <span class="comment">// Send the rest of the chain</span></div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;        <span class="keywordflow">if</span> (pindex)</div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;            pindex = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a3077e83c87e8a974765fa76a57fd040b">Next</a>(pindex);</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;        <span class="keywordtype">int</span> nLimit = 500;</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;getblocks %d to %s limit %d from peer=%d\n&quot;</span>, (pindex ? pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> : -1), hashStop.IsNull() ? <span class="stringliteral">&quot;end&quot;</span> : hashStop.ToString(), nLimit, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;        <span class="keywordflow">for</span> (; pindex; pindex = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a3077e83c87e8a974765fa76a57fd040b">Next</a>(pindex))</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;        {</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;            <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>() == hashStop)</div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;            {</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;  getblocks stopping at %d %s\n&quot;</span>, pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;            }</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;            <span class="comment">// If pruning, don&#39;t inv blocks unless we have on disk and are likely to still have</span></div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;            <span class="comment">// for some reasonable time window (1 hour) that block relay might require.</span></div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">int</span> nPrunedBlocksLikelyToHave = <a class="code" href="validation_8h.html#a5caf4122a735df55a443242fa5ccb5cf">MIN_BLOCKS_TO_KEEP</a> - 3600 / chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>().<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a>;</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#ab3d3252ad7773f86035217d3a08f16ba">fPruneMode</a> &amp;&amp; (!(pindex-&gt;<a class="code" href="class_c_block_index.html#aef7d4c3c9a4538e62821988bf6193ad8">nStatus</a> &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a>) || pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> &lt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> - nPrunedBlocksLikelyToHave))</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;            {</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot; getblocks stopping, pruned or too old block at %d %s\n&quot;</span>, pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;            }</div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;            <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a7cef2333aa8776127a7e7fcab659eb6a">PushInventory</a>(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()));</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;            }</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;            <span class="keywordflow">if</span> (--nLimit &lt;= 0)</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;            {</div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;                <span class="comment">// When this block is requested, we&#39;ll send an inv that&#39;ll</span></div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;                <span class="comment">// trigger the peer to getblocks the next batch of inventory.</span></div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;  getblocks stopping at limit %d %s\n&quot;</span>, pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a1a1c0d94de0197c5c4abf5a8d13364f3">hashContinue</a> = pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>();</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;            }</div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;        }</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    }</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#af9b6c7c7cc77f2f0b6af1949a6ee5920">NetMsgType::GETBLOCKTXN</a>) {</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;        <a class="code" href="class_block_transactions_request.html">BlockTransactionsRequest</a> req;</div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;        vRecv &gt;&gt; req;</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;</div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;        std::shared_ptr&lt;const CBlock&gt; recent_block;</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;        {</div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>);</div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d">most_recent_block_hash</a> == req.blockhash)</div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;                recent_block = <a class="code" href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a>;</div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;            <span class="comment">// Unlock cs_most_recent_block to avoid cs_main lock inversion</span></div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;        }</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;        <span class="keywordflow">if</span> (recent_block) {</div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;            <a class="code" href="net__processing_8cpp.html#aec1d19218087514e02f3cd63bab79be4">SendBlockTransactions</a>(*recent_block, req, pfrom, connman);</div><div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;        }</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;</div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;        BlockMap::iterator it = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(req.blockhash);</div><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;        <span class="keywordflow">if</span> (it == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end() || !(it-&gt;second-&gt;nStatus &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a>)) {</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Peer %d sent us a getblocktxn for a block we don&#39;t have\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;        }</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;        <span class="keywordflow">if</span> (it-&gt;second-&gt;nHeight &lt; <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#ad4758bc8872ce065a9579f77c3171d40">Height</a>() - <a class="code" href="validation_8h.html#a6cee75436117a7a79d4e0bc5b87bc2a6">MAX_BLOCKTXN_DEPTH</a>) {</div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;            <span class="comment">// If an older block is requested (should never happen in practice,</span></div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;            <span class="comment">// but can happen in tests) send a block response instead of a</span></div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;            <span class="comment">// blocktxn response. Sending a full block response instead of a</span></div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;            <span class="comment">// small blocktxn response is preferable in the case where a peer</span></div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;            <span class="comment">// might maliciously send lots of getblocktxn requests to trigger</span></div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;            <span class="comment">// expensive disk reads, because it will require the peer to</span></div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;            <span class="comment">// actually receive all the data read from disk over the network.</span></div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Peer %d sent us a getblocktxn for a block &gt; %i deep&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <a class="code" href="validation_8h.html#a6cee75436117a7a79d4e0bc5b87bc2a6">MAX_BLOCKTXN_DEPTH</a>);</div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;            <a class="code" href="class_c_inv.html">CInv</a> inv;</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;            inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a> = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>;</div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;            inv.hash = req.blockhash;</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.push_back(inv);</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;            <span class="comment">// The message processing loop will go around again (without pausing) and we&#39;ll respond then (without cs_main)</span></div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;        }</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;</div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;        <a class="code" href="class_c_block.html">CBlock</a> block;</div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;        <span class="keywordtype">bool</span> ret = <a class="code" href="validation_8cpp.html#a578c1df234b05798180f0235d469a5ba">ReadBlockFromDisk</a>(block, it-&gt;second, chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>());</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;        assert(ret);</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;</div><div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;        <a class="code" href="net__processing_8cpp.html#aec1d19218087514e02f3cd63bab79be4">SendBlockTransactions</a>(block, req, pfrom, connman);</div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;    }</div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;</div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>) {</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;        <a class="code" href="struct_c_block_locator.html">CBlockLocator</a> locator;</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;        <a class="code" href="classuint256.html">uint256</a> hashStop;</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;        vRecv &gt;&gt; locator &gt;&gt; hashStop;</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;</div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>() &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>) {</div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Ignoring getheaders from peer=%d because node is in initial block download\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;        }</div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;        CNodeState *nodestate = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;        <span class="keywordflow">if</span> (locator.<a class="code" href="struct_c_block_locator.html#a77ebc693cf47cbab5c13777840f6bce1">IsNull</a>())</div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;        {</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;            <span class="comment">// If locator is null, return the hashStop block</span></div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;            BlockMap::iterator mi = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(hashStop);</div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;            <span class="keywordflow">if</span> (mi == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end())</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;            pindex = (*mi).second;</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;</div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="net__processing_8cpp.html#a089eec67c3dbd97a69949d830f71d3be">BlockRequestAllowed</a>(pindex, chainparams.<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>())) {</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: ignoring request from peer=%i for old block header that isn&#39;t in the main chain\n&quot;</span>, __func__, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;            }</div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;        }</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;        {</div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;            <span class="comment">// Find the last block the caller has in the main chain</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;            pindex = <a class="code" href="validation_8cpp.html#af43d57aa8b46a53839777e8b670c9d66">FindForkInGlobalIndex</a>(<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>, locator);</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;            <span class="keywordflow">if</span> (pindex)</div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;                pindex = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a3077e83c87e8a974765fa76a57fd040b">Next</a>(pindex);</div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;        }</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;</div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;        <span class="comment">// we must use CBlocks, as CBlockHeaders won&#39;t include the 0x00 nTx count at the end</span></div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;        std::vector&lt;CBlock&gt; vHeaders;</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;        <span class="keywordtype">int</span> nLimit = <a class="code" href="validation_8h.html#ae90d2acb26fa19fdcd983626b0d37d0b">MAX_HEADERS_RESULTS</a>;</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;getheaders %d to %s from peer=%d\n&quot;</span>, (pindex ? pindex-&gt;nHeight : -1), hashStop.IsNull() ? <span class="stringliteral">&quot;end&quot;</span> : hashStop.ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;        <span class="keywordflow">for</span> (; pindex; pindex = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a3077e83c87e8a974765fa76a57fd040b">Next</a>(pindex))</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;        {</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;            vHeaders.push_back(pindex-&gt;GetBlockHeader());</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;            <span class="keywordflow">if</span> (--nLimit &lt;= 0 || pindex-&gt;<a class="code" href="validation_8cpp.html#a08c25cc0ab8b9731b46a1bfbe6057fca">GetBlockHash</a>() == hashStop)</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;                <span class="keywordflow">break</span>;</div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;        }</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;        <span class="comment">// pindex can be nullptr either if we sent chainActive.Tip() OR</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;        <span class="comment">// if our peer has chainActive.Tip() (and thus we are sending an empty</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;        <span class="comment">// headers message). In both cases it&#39;s safe to update</span></div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;        <span class="comment">// pindexBestHeaderSent to be our tip.</span></div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;        <span class="comment">// It is important that we simply reset the BestHeaderSent value here,</span></div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;        <span class="comment">// and not max(BestHeaderSent, newHeaderSent). We might have announced</span></div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;        <span class="comment">// the currently-being-connected tip using a compact block, which</span></div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;        <span class="comment">// resulted in the peer sending a headers request, which we respond to</span></div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;        <span class="comment">// without the new block. By resetting the BestHeaderSent, we ensure we</span></div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;        <span class="comment">// will re-announce the new block via headers (or compact blocks again)</span></div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;        <span class="comment">// in the SendMessages logic.</span></div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;        nodestate-&gt;pindexBestHeaderSent = pindex ? pindex : <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>();</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;        connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a216e35db319a5d508043639fd3170776">NetMsgType::HEADERS</a>, vHeaders));</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    }</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a> || strCommand == <a class="code" href="namespace_net_msg_type.html#a0138bc5c11da6ec5f5890a53ef15ca0c">NetMsgType::DSTX</a> || strCommand == <a class="code" href="namespace_net_msg_type.html#a57e38f9cdcd648eb2d43c237cc1b8b0b">NetMsgType::LEGACYTXLOCKREQUEST</a>) {</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;        <span class="comment">// Stop processing the transaction early if</span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;        <span class="comment">// We are in blocks only mode and peer is either not whitelisted or whitelistrelay is off</span></div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="net_8cpp.html#a7935254c613d6f3cdadd3ce45f7efbff">fRelayTxes</a> &amp;&amp; (!pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a> || !<a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#af81c6e2a9dcd6b12557a2387fd67b2a6">GetBoolArg</a>(<span class="stringliteral">&quot;-whitelistrelay&quot;</span>, <a class="code" href="validation_8h.html#a5289ed91f1daf187bba005dd54d62649">DEFAULT_WHITELISTRELAY</a>)))</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;        {</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;transaction sent in violation of protocol peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;        }</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;        <a class="code" href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a> ptx;</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;        <a class="code" href="class_c_private_send_broadcast_tx.html">CPrivateSendBroadcastTx</a> dstx;</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;        <span class="keywordtype">int</span> nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>;</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;        <span class="comment">// Read data and assign inv type</span></div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;        <span class="keywordflow">if</span>(strCommand == <a class="code" href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a>) {</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;            vRecv &gt;&gt; ptx;</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strCommand == <a class="code" href="namespace_net_msg_type.html#a57e38f9cdcd648eb2d43c237cc1b8b0b">NetMsgType::LEGACYTXLOCKREQUEST</a>) {</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;            <span class="comment">// we keep processing the legacy IX message here but revert to handling it as a regular TX</span></div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;            vRecv &gt;&gt; ptx;</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a0138bc5c11da6ec5f5890a53ef15ca0c">NetMsgType::DSTX</a>) {</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;            vRecv &gt;&gt; dstx;</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;            ptx = dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a81c64d79239c3881b8c9131337656ddd">tx</a>;</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;            nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>;</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;        }</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_transaction.html">CTransaction</a>&amp; tx = *ptx;</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;        <a class="code" href="class_c_inv.html">CInv</a> inv(nInvType, tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>());</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#ac3054eb6ade84e8968f032ce3e700f6a">AddInventoryKnown</a>(inv);</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;        <span class="comment">// Process custom logic, no matter if tx will be accepted to mempool later or not</span></div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;        <span class="keywordflow">if</span> (nInvType == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>) {</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;            <a class="code" href="classuint256.html">uint256</a> hashTx = tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>();</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;            <span class="keywordflow">if</span> (!dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a4ab80169447e38f64dfa26b63252ee4a">IsValidStructure</a>()) {</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Invalid DSTX structure: %s\n&quot;</span>, hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;            }</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a>(hashTx)) {</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Already have %s, skipping...\n&quot;</span>, hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// not an error</span></div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;            }</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a>* pindex{<span class="keyword">nullptr</span>};</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;            <a class="code" href="deterministicmns_8h.html#af1cbfb65604ae5f6b1507a860b15786f">CDeterministicMNCPtr</a> dmn{<span class="keyword">nullptr</span>};</div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;            {</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;                pindex = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>();</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;            }</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;            <span class="comment">// It could be that a MN is no longer in the list but its DSTX is not yet mined.</span></div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;            <span class="comment">// Try to find a MN up to 24 blocks deep to make sure such dstx-es are relayed and processed correctly.</span></div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 24 &amp;&amp; pindex; ++i) {</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;                dmn = <a class="code" href="deterministicmns_8cpp.html#ac56941f32bc28d3bcbe6fa12fd9b1033">deterministicMNManager</a>-&gt;GetListForBlock(pindex).GetMNByCollateral(dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a323d1fce5e220f62a20f2619f8627588">masternodeOutpoint</a>);</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;                <span class="keywordflow">if</span> (dmn) <span class="keywordflow">break</span>;</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;                pindex = pindex-&gt;pprev;</div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;            }</div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;            <span class="keywordflow">if</span>(!dmn) {</div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Can&#39;t find masternode %s to verify %s\n&quot;</span>, dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a323d1fce5e220f62a20f2619f8627588">masternodeOutpoint</a>.<a class="code" href="class_c_out_point.html#a85f13609edc1f66afe82fb68f28fb8b7">ToStringShort</a>(), hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;            }</div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="masternode-meta_8cpp.html#a024536f114ea52e8aac13d062afd5ef0">mmetaman</a>.<a class="code" href="class_c_masternode_meta_man.html#ad45986b1df2884b15582cd09e9db2c01">GetMetaInfo</a>(dmn-&gt;proTxHash)-&gt;IsValidForMixingTxes()) {</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Masternode %s is sending too many transactions %s\n&quot;</span>, dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a323d1fce5e220f62a20f2619f8627588">masternodeOutpoint</a>.<a class="code" href="class_c_out_point.html#a85f13609edc1f66afe82fb68f28fb8b7">ToStringShort</a>(), hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;                <span class="comment">// TODO: Not an error? Could it be that someone is relaying old DSTXes</span></div><div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;                <span class="comment">// we have no idea about (e.g we were offline)? How to handle them?</span></div><div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;            }</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;            <span class="keywordflow">if</span> (!dstx.<a class="code" href="class_c_private_send_broadcast_tx.html#a2064670875bc7610705f6f816148144d">CheckSignature</a>(dmn-&gt;pdmnState-&gt;pubKeyOperator.Get())) {</div><div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- CheckSignature() failed for %s\n&quot;</span>, hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;            }</div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Got Masternode transaction %s\n&quot;</span>, hashTx.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;            <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#a076041ea11b38722d1419c1640bf6ac4">PrioritiseTransaction</a>(hashTx, 0.1*<a class="code" href="amount_8h.html#aed6bcb17bc73a5dcf33250e9c2c023cc">COIN</a>);</div><div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;            <a class="code" href="masternode-meta_8cpp.html#a024536f114ea52e8aac13d062afd5ef0">mmetaman</a>.<a class="code" href="class_c_masternode_meta_man.html#ab871eeb584c81035414193ab0994479b">DisallowMixing</a>(dmn-&gt;proTxHash);</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;        }</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;        <a class="code" href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;        <span class="keywordtype">bool</span> fMissingInputs = <span class="keyword">false</span>;</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;        <a class="code" href="class_c_validation_state.html">CValidationState</a> state;</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;</div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;        <a class="code" href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">EraseObjectRequest</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), inv);</div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;</div><div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(inv) &amp;&amp; <a class="code" href="validation_8cpp.html#a69b1be2d5750e0ba945e2a0a0f38cadc">AcceptToMemoryPool</a>(<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>, state, ptx, &amp;fMissingInputs <span class="comment">/* pfMissingInputs */</span>,</div><div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;                <span class="keyword">false</span> <span class="comment">/* bypass_limits */</span>, 0 <span class="comment">/* nAbsurdFee */</span>)) {</div><div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;            <span class="comment">// Process custom txes, this changes AlreadyHave to &quot;true&quot;</span></div><div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;            <span class="keywordflow">if</span> (nInvType == <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>) {</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a>, <span class="stringliteral">&quot;DSTX -- Masternode transaction accepted, txid=%s, peer=%d\n&quot;</span>,</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;                         tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;                <a class="code" href="class_c_private_send.html#a34bb28453d0906baa0e63001c502cc30">CPrivateSend::AddDSTX</a>(dstx);</div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;            }</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;</div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;            <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#ab30fadfa811829e79accca41da6a8328">check</a>(<a class="code" href="validation_8cpp.html#a751114a714075a2a620f6bedfc36fef3">pcoinsTip</a>.get());</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#a5fdad96946aa2bc67961ad973bf65fa5">RelayTransaction</a>(tx);</div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;</div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; tx.<a class="code" href="class_c_transaction.html#a708645274ddfd83829315ffe5c7c5c3e">vout</a>.size(); i++) {</div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;                <span class="keyword">auto</span> it_by_prev = mapOrphanTransactionsByPrev.find(<a class="code" href="class_c_out_point.html">COutPoint</a>(inv.hash, i));</div><div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;                <span class="keywordflow">if</span> (it_by_prev != mapOrphanTransactionsByPrev.end()) {</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;                    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; elem : it_by_prev-&gt;second) {</div><div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;                        pfrom-&gt;<a class="code" href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">orphan_work_set</a>.insert(elem-&gt;first);</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;                    }</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;                }</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;            }</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a973d29d89889cba8fe7909b1b8959592">nLastTXTime</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;</div><div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;AcceptToMemoryPool: peer=%d: accepted %s (poolsz %u txn, %u kB)\n&quot;</span>,</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;                     pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(),</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;                     tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(),</div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;                     <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#a867f7b452141770f3b2e8697fb3513d8">size</a>(), <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#a4fcf05ad5f15a565c4b43c4b9f29906e">DynamicMemoryUsage</a>() / 1000);</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;</div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;            <span class="comment">// Recursively process any orphan transactions that depended on this one</span></div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;            <a class="code" href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a>(connman, pfrom-&gt;<a class="code" href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">orphan_work_set</a>);</div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;        }</div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fMissingInputs)</div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;        {</div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;            <span class="keywordtype">bool</span> fRejectedParents = <span class="keyword">false</span>; <span class="comment">// It may be the case that the orphans parents have all been rejected</span></div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_tx_in.html">CTxIn</a>&amp; txin : tx.<a class="code" href="class_c_transaction.html#ad64447ea044ec850313696fc99412d95">vin</a>) {</div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;                <span class="keywordflow">if</span> (recentRejects-&gt;contains(txin.<a class="code" href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">prevout</a>.<a class="code" href="class_c_out_point.html#af131c7194a660558b0ff158f4efa7a28">hash</a>)) {</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;                    fRejectedParents = <span class="keyword">true</span>;</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;                    <span class="keywordflow">break</span>;</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;                }</div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;            }</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;            <span class="keywordflow">if</span> (!fRejectedParents) {</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;                <span class="keyword">const</span> <span class="keyword">auto</span> current_time = GetTime&lt;std::chrono::microseconds&gt;();</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;                <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_tx_in.html">CTxIn</a>&amp; txin : tx.<a class="code" href="class_c_transaction.html#ad64447ea044ec850313696fc99412d95">vin</a>) {</div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;                    <a class="code" href="class_c_inv.html">CInv</a> _inv(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>, txin.<a class="code" href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">prevout</a>.<a class="code" href="class_c_out_point.html#af131c7194a660558b0ff158f4efa7a28">hash</a>);</div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#ac3054eb6ade84e8968f032ce3e700f6a">AddInventoryKnown</a>(_inv);</div><div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(_inv)) <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()), _inv, current_time);</div><div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;                    <span class="comment">// We don&#39;t know if the previous tx was a regular or a mixing one, try both</span></div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;                    <a class="code" href="class_c_inv.html">CInv</a> _inv2(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>, txin.<a class="code" href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">prevout</a>.<a class="code" href="class_c_out_point.html#af131c7194a660558b0ff158f4efa7a28">hash</a>);</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;                    pfrom-&gt;<a class="code" href="class_c_node.html#ac3054eb6ade84e8968f032ce3e700f6a">AddInventoryKnown</a>(_inv2);</div><div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(_inv2)) <a class="code" href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a>(State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()), _inv2, current_time);</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;                }</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;                <a class="code" href="net__processing_8cpp.html#abd6140f46766ceef29bf97f4e83bbec1">AddOrphanTx</a>(ptx, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;                <span class="comment">// DoS prevention: do not allow mapOrphanTransactions to grow unbounded</span></div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nMaxOrphanTxSize = (<span class="keywordtype">unsigned</span> int)std::max((int64_t)0, <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">GetArg</a>(<span class="stringliteral">&quot;-maxorphantxsize&quot;</span>, <a class="code" href="net__processing_8h.html#ac247f5643d4d6d3ff5830ab7f9d5edb2">DEFAULT_MAX_ORPHAN_TRANSACTIONS_SIZE</a>)) * 1000000;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nEvicted = <a class="code" href="net__processing_8cpp.html#ac880655d6e6468a46d21e713e3f6e3de">LimitOrphanTxSize</a>(nMaxOrphanTxSize);</div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;                <span class="keywordflow">if</span> (nEvicted &gt; 0) {</div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;mapOrphan overflow, removed %u tx\n&quot;</span>, nEvicted);</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;                }</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a>, <span class="stringliteral">&quot;not keeping orphan with rejected parents %s\n&quot;</span>,tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;                <span class="comment">// We will continue to reject this tx since it has rejected</span></div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;                <span class="comment">// parents so avoid re-requesting it from other peers.</span></div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;                recentRejects-&gt;insert(tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>());</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;            }</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;            <span class="keywordflow">if</span> (!state.<a class="code" href="class_c_validation_state.html#add2b2dc505a8527fda32295b65bb636b">CorruptionPossible</a>()) {</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;                assert(recentRejects);</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;                recentRejects-&gt;insert(tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>());</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="core__memusage_8h.html#a18e1e611662fcad8ad04ad0a85e84d08">RecursiveDynamicUsage</a>(*ptx) &lt; 100000) {</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a189a835fa7e6ae93a2391f38eefd7d2d">AddToCompactExtraTransactions</a>(ptx);</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;                }</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;            }</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a> &amp;&amp; <a class="code" href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a>.<a class="code" href="class_args_manager.html#af81c6e2a9dcd6b12557a2387fd67b2a6">GetBoolArg</a>(<span class="stringliteral">&quot;-whitelistforcerelay&quot;</span>, <a class="code" href="validation_8h.html#a41af4f24e6f8ec02a4a6fd7e679acf3d">DEFAULT_WHITELISTFORCERELAY</a>)) {</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;                <span class="comment">// Always relay transactions received from whitelisted peers, even</span></div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;                <span class="comment">// if they were already in the mempool or rejected from it due</span></div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;                <span class="comment">// to policy, allowing the node to function as a gateway for</span></div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;                <span class="comment">// nodes hidden behind it.</span></div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;                <span class="comment">//</span></div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;                <span class="comment">// Never relay transactions that we would assign a non-zero DoS</span></div><div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;                <span class="comment">// score for, as we expect peers to do the same with us in that</span></div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;                <span class="comment">// case.</span></div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;                <span class="keywordtype">int</span> nDoS = 0;</div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;                <span class="keywordflow">if</span> (!state.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDoS) || nDoS == 0) {</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;                    <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Force relaying tx %s from whitelisted peer=%d\n&quot;</span>, tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#a5fdad96946aa2bc67961ad973bf65fa5">RelayTransaction</a>(tx);</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;                    <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Not relaying invalid transaction %s from whitelisted peer=%d (%s)\n&quot;</span>, tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <a class="code" href="validation_8cpp.html#a86ed1d2d0837b905d74c2e4192b6c06a">FormatStateMessage</a>(state));</div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;                }</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;            }</div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;        }</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;        <span class="keywordtype">int</span> nDoS = 0;</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <span class="keywordflow">if</span> (state.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDoS))</div><div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        {</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541aa471bb09916fba65e151b0f4ce623c26">BCLog::MEMPOOLREJ</a>, <span class="stringliteral">&quot;%s from peer=%d was not accepted: %s\n&quot;</span>, tx.<a class="code" href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">GetHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(),</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(),</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;                <a class="code" href="validation_8cpp.html#a86ed1d2d0837b905d74c2e4192b6c06a">FormatStateMessage</a>(state));</div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a> &amp;&amp; state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>() &gt; 0 &amp;&amp; state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>() &lt; <a class="code" href="validation_8h.html#ae98e9fff288e3029a25765a7f924d960">REJECT_INTERNAL</a>) { <span class="comment">// Never send AcceptToMemoryPool&#39;s internal codes over P2P</span></div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, strCommand, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)state.<a class="code" href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">GetRejectCode</a>(),</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;                                   state.<a class="code" href="class_c_validation_state.html#a8fa9612cb40c3c8592f7cd29b5931ccd">GetRejectReason</a>().substr(0, <a class="code" href="validation_8h.html#af83a9cbb7b3fe9d34a7c4b43f2e040f8">MAX_REJECT_MESSAGE_LENGTH</a>), inv.hash));</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;            }</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;            <span class="keywordflow">if</span> (nDoS &gt; 0) {</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nDoS);</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;            }</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;        }</div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;    }</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a>) <span class="comment">// Ignore blocks received while importing</span></div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;    {</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;        <a class="code" href="class_c_block_header_and_short_tx_i_ds.html">CBlockHeaderAndShortTxIDs</a> cmpctblock;</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;        vRecv &gt;&gt; cmpctblock;</div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;</div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;        <span class="keywordtype">bool</span> received_new_header = <span class="keyword">false</span>;</div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;</div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;        {</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(cmpctblock.header.hashPrevBlock) == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end()) {</div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;            <span class="comment">// Doesn&#39;t connect (or is genesis), instead of DoSing in AcceptBlockHeader, request deeper headers</span></div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>())</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>), <a class="code" href="classuint256.html">uint256</a>()));</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;        }</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(cmpctblock.header.GetHash()) == <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end()) {</div><div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;            received_new_header = <span class="keyword">true</span>;</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;        }</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;        }</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;        <a class="code" href="class_c_validation_state.html">CValidationState</a> state;</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#ac38e65e42c4799a42e2e45c62cd91c19">ProcessNewBlockHeaders</a>({cmpctblock.header}, state, chainparams, &amp;pindex)) {</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;            <span class="keywordtype">int</span> nDoS;</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;            <span class="keywordflow">if</span> (state.<a class="code" href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">IsInvalid</a>(nDoS)) {</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;                <span class="keywordflow">if</span> (nDoS &gt; 0) {</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;                    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), nDoS, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Peer %d sent us invalid header via cmpctblock&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Peer %d sent us invalid header via cmpctblock\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;                }</div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;            }</div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;        }</div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;        <span class="comment">// When we succeed in decoding a block&#39;s txids from a cmpctblock</span></div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;        <span class="comment">// message we typically jump to the BLOCKTXN handling code, with a</span></div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;        <span class="comment">// dummy (empty) BLOCKTXN message, to re-use the logic there in</span></div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;        <span class="comment">// completing processing of the putative block (without cs_main).</span></div><div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;        <span class="keywordtype">bool</span> fProcessBLOCKTXN = <span class="keyword">false</span>;</div><div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;        <a class="code" href="class_c_data_stream.html">CDataStream</a> blockTxnMsg(<a class="code" href="serialize_8h.html#a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c">SER_NETWORK</a>, <a class="code" href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a>);</div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;        <span class="comment">// If we end up treating this as a plain headers message, call that as well</span></div><div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;        <span class="comment">// without cs_main.</span></div><div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;        <span class="keywordtype">bool</span> fRevertToHeaderProcessing = <span class="keyword">false</span>;</div><div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;</div><div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;        <span class="comment">// Keep a CBlock for &quot;optimistic&quot; compactblock reconstructions (see</span></div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;        <span class="comment">// below)</span></div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;        std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;        <span class="keywordtype">bool</span> fBlockReconstructed = <span class="keyword">false</span>;</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;</div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;        {</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;        <a class="code" href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;        <span class="comment">// If AcceptBlockHeader returned true, it set pindex</span></div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;        assert(pindex);</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;        UpdateBlockAvailability(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>());</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;</div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;        CNodeState *nodestate = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;</div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;        <span class="comment">// If this was a new header with more work than our tip, update the</span></div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;        <span class="comment">// peer&#39;s last block announcement time</span></div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <span class="keywordflow">if</span> (received_new_header &amp;&amp; pindex-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &gt; <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a>) {</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;            nodestate-&gt;m_last_block_announcement = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;        }</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        std::map&lt;uint256, std::pair&lt;NodeId, std::list&lt;QueuedBlock&gt;::iterator&gt; &gt;::iterator blockInFlightIt = mapBlocksInFlight.find(pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>());</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        <span class="keywordtype">bool</span> fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;</div><div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;        <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#aef7d4c3c9a4538e62821988bf6193ad8">nStatus</a> &amp; <a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a>) <span class="comment">// Nothing to do here</span></div><div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;</div><div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;        <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> &lt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a> || <span class="comment">// We know something better</span></div><div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;                pindex-&gt;<a class="code" href="class_c_block_index.html#ac8e219a377839d2f9133a4387f46e44e">nTx</a> != 0) { <span class="comment">// We had this block at some point, but pruned it</span></div><div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;            <span class="keywordflow">if</span> (fAlreadyInFlight) {</div><div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;                <span class="comment">// We requested this block for some reason, but our mempool will probably be useless</span></div><div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;                <span class="comment">// so we just grab the block via normal getdata</span></div><div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;                std::vector&lt;CInv&gt; vInv(1);</div><div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;                vInv[0] = <a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, cmpctblock.header.GetHash());</div><div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vInv));</div><div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;            }</div><div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;        }</div><div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;</div><div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;        <span class="comment">// If we&#39;re not close to tip yet, give up and let parallel block fetch work its magic</span></div><div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;        <span class="keywordflow">if</span> (!fAlreadyInFlight &amp;&amp; !CanDirectFetch(chainparams.GetConsensus()))</div><div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;</div><div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;        <span class="comment">// We want to be a bit conservative just to be extra careful about DoS</span></div><div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;        <span class="comment">// possibilities in compact block processing...</span></div><div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;        <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a> &lt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#ad4758bc8872ce065a9579f77c3171d40">Height</a>() + 2) {</div><div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;            <span class="keywordflow">if</span> ((!fAlreadyInFlight &amp;&amp; nodestate-&gt;nBlocksInFlight &lt; <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a>) ||</div><div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;                 (fAlreadyInFlight &amp;&amp; blockInFlightIt-&gt;second.first == pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>())) {</div><div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;                std::list&lt;QueuedBlock&gt;::iterator *queuedBlockIt = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;                <span class="keywordflow">if</span> (!MarkBlockAsInFlight(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>(), pindex, &amp;queuedBlockIt)) {</div><div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;                    <span class="keywordflow">if</span> (!(*queuedBlockIt)-&gt;partialBlock)</div><div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;                        (*queuedBlockIt)-&gt;partialBlock.reset(<span class="keyword">new</span> <a class="code" href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a>(&amp;<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>));</div><div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;                    <span class="keywordflow">else</span> {</div><div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;                        <span class="comment">// The block was already in flight using compact blocks from the same peer</span></div><div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Peer sent us compact block we were already syncing!\n&quot;</span>);</div><div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;                    }</div><div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;                }</div><div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;</div><div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;                <a class="code" href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a>&amp; partialBlock = *(*queuedBlockIt)-&gt;partialBlock;</div><div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;                <a class="code" href="blockencodings_8h.html#a736e4f9aaa454215e8d1177394e170a6">ReadStatus</a> status = partialBlock.<a class="code" href="class_partially_downloaded_block.html#a04e1b3207e547c972e002c1ec472da1f">InitData</a>(cmpctblock, vExtraTxnForCompact);</div><div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;                <span class="keywordflow">if</span> (status == <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812">READ_STATUS_INVALID</a>) {</div><div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;                    MarkBlockAsReceived(pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()); <span class="comment">// Reset in-flight state in case of whitelist</span></div><div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Peer %d sent us invalid compact block&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22">READ_STATUS_FAILED</a>) {</div><div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;                    <span class="comment">// Duplicate txindexes, the block is now in-flight, so just request it</span></div><div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;                    std::vector&lt;CInv&gt; vInv(1);</div><div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;                    vInv[0] = <a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, cmpctblock.header.GetHash());</div><div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vInv));</div><div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;                }</div><div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;</div><div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;                <a class="code" href="class_block_transactions_request.html">BlockTransactionsRequest</a> req;</div><div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; cmpctblock.BlockTxCount(); i++) {</div><div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;                    <span class="keywordflow">if</span> (!partialBlock.<a class="code" href="class_partially_downloaded_block.html#ad8f41f80c9aba45402fc1033a478a97b">IsTxAvailable</a>(i))</div><div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;                        req.<a class="code" href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">indexes</a>.push_back(i);</div><div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;                }</div><div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;                <span class="keywordflow">if</span> (req.<a class="code" href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">indexes</a>.empty()) {</div><div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;                    <span class="comment">// Dirty hack to jump to BLOCKTXN code (TODO: move message handling into their own functions)</span></div><div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;                    <a class="code" href="class_block_transactions.html">BlockTransactions</a> txn;</div><div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;                    txn.<a class="code" href="class_block_transactions.html#a6d42a1840f22d90b000a579db5de490d">blockhash</a> = cmpctblock.header.GetHash();</div><div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;                    blockTxnMsg &lt;&lt; txn;</div><div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;                    fProcessBLOCKTXN = <span class="keyword">true</span>;</div><div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;                    req.<a class="code" href="class_block_transactions_request.html#ac5fd8cb4f31a492d58d6c95dd369852e">blockhash</a> = pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>();</div><div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;                    connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#af9b6c7c7cc77f2f0b6af1949a6ee5920">NetMsgType::GETBLOCKTXN</a>, req));</div><div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;                }</div><div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;                <span class="comment">// This block is either already in flight from a different</span></div><div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;                <span class="comment">// peer, or this peer has too many blocks outstanding to</span></div><div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;                <span class="comment">// download from.</span></div><div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;                <span class="comment">// Optimistically try to reconstruct anyway since we might be</span></div><div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;                <span class="comment">// able to without any round trips.</span></div><div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;                <a class="code" href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a> tempBlock(&amp;<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>);</div><div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;                <a class="code" href="blockencodings_8h.html#a736e4f9aaa454215e8d1177394e170a6">ReadStatus</a> status = tempBlock.<a class="code" href="class_partially_downloaded_block.html#a04e1b3207e547c972e002c1ec472da1f">InitData</a>(cmpctblock, vExtraTxnForCompact);</div><div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;                <span class="keywordflow">if</span> (status != <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff">READ_STATUS_OK</a>) {</div><div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;                    <span class="comment">// TODO: don&#39;t ignore failures</span></div><div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;                }</div><div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;                std::vector&lt;CTransactionRef&gt; dummy;</div><div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;                status = tempBlock.<a class="code" href="class_partially_downloaded_block.html#ae31ee4302e77d9757aae8b96df99486a">FillBlock</a>(*pblock, dummy);</div><div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;                <span class="keywordflow">if</span> (status == <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff">READ_STATUS_OK</a>) {</div><div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;                    fBlockReconstructed = <span class="keyword">true</span>;</div><div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;                }</div><div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;            }</div><div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;            <span class="keywordflow">if</span> (fAlreadyInFlight) {</div><div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;                <span class="comment">// We requested this block, but its far into the future, so our</span></div><div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;                <span class="comment">// mempool will probably be useless - request the block normally</span></div><div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;                std::vector&lt;CInv&gt; vInv(1);</div><div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;                vInv[0] = <a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, cmpctblock.header.GetHash());</div><div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vInv));</div><div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;                <span class="comment">// If this was an announce-cmpctblock, we want the same treatment as a header message</span></div><div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;                fRevertToHeaderProcessing = <span class="keyword">true</span>;</div><div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;            }</div><div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        }</div><div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;        } <span class="comment">// cs_main</span></div><div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;</div><div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;        <span class="keywordflow">if</span> (fProcessBLOCKTXN)</div><div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="net__processing_8cpp.html#aafd21e2e5beded09e8826d455ac8e17b">ProcessMessage</a>(pfrom, <a class="code" href="namespace_net_msg_type.html#ac23245c939bfe57d37c0a2db68e05e05">NetMsgType::BLOCKTXN</a>, blockTxnMsg, nTimeReceived, chainparams, connman, interruptMsgProc);</div><div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;</div><div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;        <span class="keywordflow">if</span> (fRevertToHeaderProcessing) {</div><div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;            <span class="comment">// Headers received from HB compact block peers are permitted to be</span></div><div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;            <span class="comment">// relayed before full validation (see BIP 152), so we don&#39;t want to disconnect</span></div><div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;            <span class="comment">// the peer if the header turns out to be for an invalid block.</span></div><div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;            <span class="comment">// Note that if a peer tries to build on an invalid chain, that</span></div><div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;            <span class="comment">// will be detected and the peer will be banned.</span></div><div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="net__processing_8cpp.html#ac9ffabd4f0b59fcf738fdd9b546fb6e7">ProcessHeadersMessage</a>(pfrom, connman, {cmpctblock.header}, chainparams, <span class="comment">/*punish_duplicate_invalid=*/</span><span class="keyword">false</span>);</div><div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;        }</div><div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;</div><div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;        <span class="keywordflow">if</span> (fBlockReconstructed) {</div><div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;            <span class="comment">// If we got here, we were able to optimistically reconstruct a</span></div><div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;            <span class="comment">// block that is in flight from some other peer.</span></div><div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;            {</div><div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;                mapBlockSource.emplace(pblock-&gt;GetHash(), std::make_pair(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <span class="keyword">false</span>));</div><div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;            }</div><div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;            <span class="keywordtype">bool</span> fNewBlock = <span class="keyword">false</span>;</div><div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;            <span class="comment">// Setting fForceProcessing to true means that we bypass some of</span></div><div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;            <span class="comment">// our anti-DoS protections in AcceptBlock, which filters</span></div><div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;            <span class="comment">// unrequested blocks that might be trying to waste our resources</span></div><div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;            <span class="comment">// (eg disk space). Because we only try to reconstruct blocks when</span></div><div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;            <span class="comment">// we&#39;re close to caught up (via the CanDirectFetch() requirement</span></div><div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;            <span class="comment">// above, combined with the behavior of not requesting blocks until</span></div><div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;            <span class="comment">// we have a chain with at least nMinimumChainWork), and we ignore</span></div><div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;            <span class="comment">// compact blocks with less work than our tip, it is safe to treat</span></div><div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;            <span class="comment">// reconstructed compact blocks as having been requested.</span></div><div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;            <a class="code" href="validation_8cpp.html#a290fce59049c0951b8eb73f0129bf6f0">ProcessNewBlock</a>(chainparams, pblock, <span class="comment">/*fForceProcessing=*/</span><span class="keyword">true</span>, &amp;fNewBlock);</div><div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;            <span class="keywordflow">if</span> (fNewBlock) {</div><div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#ad253434141efcbca34150864069aee7e">nLastBlockTime</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;                mapBlockSource.erase(pblock-&gt;GetHash());</div><div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;            }</div><div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>); <span class="comment">// hold cs_main for CBlockIndex::IsValid()</span></div><div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;            <span class="keywordflow">if</span> (pindex-&gt;<a class="code" href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">IsValid</a>(<a class="code" href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c">BLOCK_VALID_TRANSACTIONS</a>)) {</div><div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;                <span class="comment">// Clear download state for this block, which is in</span></div><div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;                <span class="comment">// process from some other peer.  We do this after calling</span></div><div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;                <span class="comment">// ProcessNewBlock so that a malleated cmpctblock announcement</span></div><div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;                <span class="comment">// can&#39;t be used to interfere with block relay.</span></div><div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;                MarkBlockAsReceived(pblock-&gt;GetHash());</div><div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;            }</div><div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;        }</div><div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;    }</div><div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;</div><div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#ac23245c939bfe57d37c0a2db68e05e05">NetMsgType::BLOCKTXN</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a>) <span class="comment">// Ignore blocks received while importing</span></div><div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;    {</div><div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;        <a class="code" href="class_block_transactions.html">BlockTransactions</a> resp;</div><div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;        vRecv &gt;&gt; resp;</div><div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;</div><div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;        std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</div><div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;        <span class="keywordtype">bool</span> fBlockRead = <span class="keyword">false</span>;</div><div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;        {</div><div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;</div><div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;            std::map&lt;uint256, std::pair&lt;NodeId, std::list&lt;QueuedBlock&gt;::iterator&gt; &gt;::iterator it = mapBlocksInFlight.find(resp.blockhash);</div><div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;            <span class="keywordflow">if</span> (it == mapBlocksInFlight.end() || !it-&gt;second.second-&gt;partialBlock ||</div><div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;                    it-&gt;second.first != pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()) {</div><div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Peer %d sent us block transactions for block we weren&#39;t expecting\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;            }</div><div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;</div><div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;            <a class="code" href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a>&amp; partialBlock = *it-&gt;second.second-&gt;partialBlock;</div><div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;            <a class="code" href="blockencodings_8h.html#a736e4f9aaa454215e8d1177394e170a6">ReadStatus</a> status = partialBlock.<a class="code" href="class_partially_downloaded_block.html#ae31ee4302e77d9757aae8b96df99486a">FillBlock</a>(*pblock, resp.txn);</div><div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;            <span class="keywordflow">if</span> (status == <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812">READ_STATUS_INVALID</a>) {</div><div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;                MarkBlockAsReceived(resp.blockhash); <span class="comment">// Reset in-flight state in case of whitelist</span></div><div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;                <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;Peer %d sent us invalid compact block/non-matching block transactions&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22">READ_STATUS_FAILED</a>) {</div><div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;                <span class="comment">// Might have collided, fall back to getdata now :(</span></div><div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;                std::vector&lt;CInv&gt; invs;</div><div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;                invs.push_back(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, resp.blockhash));</div><div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, invs));</div><div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;                <span class="comment">// Block is either okay, or possibly we received</span></div><div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;                <span class="comment">// READ_STATUS_CHECKBLOCK_FAILED.</span></div><div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;                <span class="comment">// Note that CheckBlock can only fail for one of a few reasons:</span></div><div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;                <span class="comment">// 1. bad-proof-of-work (impossible here, because we&#39;ve already</span></div><div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;                <span class="comment">//    accepted the header)</span></div><div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;                <span class="comment">// 2. merkleroot doesn&#39;t match the transactions given (already</span></div><div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;                <span class="comment">//    caught in FillBlock with READ_STATUS_FAILED, so</span></div><div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;                <span class="comment">//    impossible here)</span></div><div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;                <span class="comment">// 3. the block is otherwise invalid (eg invalid coinbase,</span></div><div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;                <span class="comment">//    block is too big, too many legacy sigops, etc).</span></div><div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;                <span class="comment">// So if CheckBlock failed, #3 is the only possibility.</span></div><div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;                <span class="comment">// Under BIP 152, we don&#39;t DoS-ban unless proof of work is</span></div><div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;                <span class="comment">// invalid (we don&#39;t require all the stateless checks to have</span></div><div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;                <span class="comment">// been run).  This is handled below, so just treat this as</span></div><div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;                <span class="comment">// though the block was successfully read, and rely on the</span></div><div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;                <span class="comment">// handling in ProcessNewBlock to ensure the block index is</span></div><div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;                <span class="comment">// updated, reject messages go out, etc.</span></div><div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;                MarkBlockAsReceived(resp.blockhash); <span class="comment">// it is now an empty pointer</span></div><div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;                fBlockRead = <span class="keyword">true</span>;</div><div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;                <span class="comment">// mapBlockSource is only used for sending reject messages and DoS scores,</span></div><div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;                <span class="comment">// so the race between here and cs_main in ProcessNewBlock is fine.</span></div><div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;                <span class="comment">// BIP 152 permits peers to relay compact blocks after validating</span></div><div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;                <span class="comment">// the header only; we should not punish peers if the block turns</span></div><div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;                <span class="comment">// out to be invalid.</span></div><div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;                mapBlockSource.emplace(resp.blockhash, std::make_pair(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <span class="keyword">false</span>));</div><div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;            }</div><div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;        } <span class="comment">// Don&#39;t hold cs_main when we call into ProcessNewBlock</span></div><div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;        <span class="keywordflow">if</span> (fBlockRead) {</div><div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;            <span class="keywordtype">bool</span> fNewBlock = <span class="keyword">false</span>;</div><div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;            <span class="comment">// Since we requested this block (it was in mapBlocksInFlight), force it to be processed,</span></div><div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;            <span class="comment">// even if it would not be a candidate for new tip (missing previous block, chain not long enough, etc)</span></div><div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;            <span class="comment">// This bypasses some anti-DoS logic in AcceptBlock (eg to prevent</span></div><div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;            <span class="comment">// disk-space attacks), but this should be safe due to the</span></div><div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;            <span class="comment">// protections in the compact block handler -- see related comment</span></div><div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;            <span class="comment">// in compact block optimistic reconstruction handling.</span></div><div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;            <a class="code" href="validation_8cpp.html#a290fce59049c0951b8eb73f0129bf6f0">ProcessNewBlock</a>(chainparams, pblock, <span class="comment">/*fForceProcessing=*/</span><span class="keyword">true</span>, &amp;fNewBlock);</div><div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;            <span class="keywordflow">if</span> (fNewBlock) {</div><div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#ad253434141efcbca34150864069aee7e">nLastBlockTime</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;                mapBlockSource.erase(pblock-&gt;GetHash());</div><div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;            }</div><div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;        }</div><div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;    }</div><div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;</div><div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a216e35db319a5d508043639fd3170776">NetMsgType::HEADERS</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a>) <span class="comment">// Ignore headers received while importing</span></div><div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;    {</div><div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;        std::vector&lt;CBlockHeader&gt; headers;</div><div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;</div><div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;        <span class="comment">// Bypass the normal CBlock deserialization, as we don&#39;t want to risk deserializing 2000 full blocks.</span></div><div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nCount = <a class="code" href="serialize_8h.html#ae3fd928949b7361accfec79c314aa90f">ReadCompactSize</a>(vRecv);</div><div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;        <span class="keywordflow">if</span> (nCount &gt; <a class="code" href="validation_8h.html#ae90d2acb26fa19fdcd983626b0d37d0b">MAX_HEADERS_RESULTS</a>) {</div><div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 20, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;headers message size = %u&quot;</span>, nCount));</div><div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;        }</div><div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;        headers.resize(nCount);</div><div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n = 0; n &lt; nCount; n++) {</div><div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;            vRecv &gt;&gt; headers[n];</div><div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;            <a class="code" href="serialize_8h.html#ae3fd928949b7361accfec79c314aa90f">ReadCompactSize</a>(vRecv); <span class="comment">// ignore tx count; assume it is 0.</span></div><div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;        }</div><div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;</div><div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;        <span class="comment">// Headers received via a HEADERS message should be valid, and reflect</span></div><div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;        <span class="comment">// the chain the peer is on. If we receive a known-invalid header,</span></div><div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;        <span class="comment">// disconnect the peer if it is using one of our outbound connection</span></div><div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;        <span class="comment">// slots.</span></div><div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;        <span class="keywordtype">bool</span> should_punish = !pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a> &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#a6d81efc365079ca499a5f6465967d8d9">m_manual_connection</a>;</div><div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="net__processing_8cpp.html#ac9ffabd4f0b59fcf738fdd9b546fb6e7">ProcessHeadersMessage</a>(pfrom, connman, headers, chainparams, should_punish);</div><div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;    }</div><div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;</div><div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a>) <span class="comment">// Ignore blocks received while importing</span></div><div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;    {</div><div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;        std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</div><div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;        vRecv &gt;&gt; *pblock;</div><div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;</div><div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;received block %s peer=%d\n&quot;</span>, pblock-&gt;GetHash().ToString(), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;</div><div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;        <span class="keywordtype">bool</span> forceProcessing = <span class="keyword">false</span>;</div><div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;        <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> hash(pblock-&gt;GetHash());</div><div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;        {</div><div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;            <span class="comment">// Also always process if we requested the block explicitly, as we may</span></div><div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;            <span class="comment">// need it even though it is not a candidate for a new best tip.</span></div><div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;            forceProcessing |= MarkBlockAsReceived(hash);</div><div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;            <span class="comment">// mapBlockSource is only used for sending reject messages and DoS scores,</span></div><div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;            <span class="comment">// so the race between here and cs_main in ProcessNewBlock is fine.</span></div><div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;            mapBlockSource.emplace(hash, std::make_pair(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <span class="keyword">true</span>));</div><div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;        }</div><div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;        <span class="keywordtype">bool</span> fNewBlock = <span class="keyword">false</span>;</div><div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;        <a class="code" href="validation_8cpp.html#a290fce59049c0951b8eb73f0129bf6f0">ProcessNewBlock</a>(chainparams, pblock, forceProcessing, &amp;fNewBlock);</div><div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;        <span class="keywordflow">if</span> (fNewBlock) {</div><div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#ad253434141efcbca34150864069aee7e">nLastBlockTime</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;            mapBlockSource.erase(pblock-&gt;GetHash());</div><div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;        }</div><div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;    }</div><div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;</div><div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a4d0f984b71f9e4c4b8b3619cb3f3dadd">NetMsgType::GETADDR</a>) {</div><div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;        <span class="comment">// This asymmetric behavior for inbound and outbound connections was introduced</span></div><div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;        <span class="comment">// to prevent a fingerprinting attack: an attacker can send specific fake addresses</span></div><div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;        <span class="comment">// to users&#39; AddrMan and later request them by sending getaddr messages.</span></div><div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        <span class="comment">// Making nodes which are behind NAT and can only make outgoing connections ignore</span></div><div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;        <span class="comment">// the getaddr message mitigates the attack.</span></div><div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>) {</div><div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Ignoring \&quot;getaddr\&quot; from outbound connection. peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;        }</div><div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;</div><div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;        <span class="comment">// Only send one GetAddr response per connection to reduce resource waste</span></div><div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;        <span class="comment">//  and discourage addr stamping of INV announcements.</span></div><div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#aa8d520199b103410958ba9ce4412cf61">fSentAddr</a>) {</div><div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Ignoring repeated \&quot;getaddr\&quot;. peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;        }</div><div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#aa8d520199b103410958ba9ce4412cf61">fSentAddr</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;</div><div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>.clear();</div><div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;        std::vector&lt;CAddress&gt; vAddr = connman-&gt;<a class="code" href="class_c_connman.html#a4ba34cd3557ab0ba1cfcbe7c18bf1199">GetAddresses</a>();</div><div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;        <a class="code" href="class_fast_random_context.html">FastRandomContext</a> insecure_rand;</div><div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_address.html">CAddress</a> &amp;addr : vAddr)</div><div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a1f39037c55bed93b832bcbef00597ca5">PushAddress</a>(addr, insecure_rand);</div><div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;    }</div><div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;</div><div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a68c340a8ef4f949cfd06c19a620aa32c">NetMsgType::MEMPOOL</a>) {</div><div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;        <span class="keywordflow">if</span> (!(pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>() &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb">NODE_BLOOM</a>) &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>)</div><div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;        {</div><div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;mempool request with bloom filters disabled, disconnect peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;        }</div><div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;</div><div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;        <span class="keywordflow">if</span> (connman-&gt;<a class="code" href="class_c_connman.html#aa12d154df14eef07418a36362d1cb8d7">OutboundTargetReached</a>(<span class="keyword">false</span>) &amp;&amp; !pfrom-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>)</div><div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;        {</div><div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;mempool request with bandwidth limit reached, disconnect peer=%d\n&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;        }</div><div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;</div><div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a1e8b0784cc82f33edc2dc4e2834d1ff0">cs_inventory</a>);</div><div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#ac6dfcb66887b3d26d58e25e7d3397016">fSendMempool</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;    }</div><div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;</div><div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#ad9a2ba0319f01bf1c26f5206b5156496">NetMsgType::PING</a>) {</div><div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt; <a class="code" href="version_8h.html#aa3feca3b6094096fa1b660159bdcb04a">BIP0031_VERSION</a>)</div><div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;        {</div><div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;            uint64_t nonce = 0;</div><div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;            vRecv &gt;&gt; nonce;</div><div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;            <span class="comment">// Echo the message back with the nonce. This allows for two useful features:</span></div><div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;            <span class="comment">//</span></div><div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;            <span class="comment">// 1) A remote node can quickly check if the connection is operational</span></div><div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;            <span class="comment">// 2) Remote nodes can measure the latency of the network thread. If this node</span></div><div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;            <span class="comment">//    is overloaded it won&#39;t respond to pings quickly and the remote node can</span></div><div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;            <span class="comment">//    avoid sending us more work, like chain download requests.</span></div><div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;            <span class="comment">//</span></div><div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;            <span class="comment">// The nonce stops the remote getting confused between different pings: without</span></div><div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;            <span class="comment">// it, if the remote node sends a ping once per second and this node takes 5</span></div><div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;            <span class="comment">// seconds to respond to each, the 5th ping the remote sends would appear to</span></div><div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;            <span class="comment">// return very quickly.</span></div><div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a395de13511c6ef9946844ee280b8f08e">NetMsgType::PONG</a>, nonce));</div><div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;        }</div><div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;    }</div><div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;</div><div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a395de13511c6ef9946844ee280b8f08e">NetMsgType::PONG</a>) {</div><div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;        int64_t pingUsecEnd = nTimeReceived;</div><div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;        uint64_t nonce = 0;</div><div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;        <span class="keywordtype">size_t</span> nAvail = vRecv.<a class="code" href="class_c_data_stream.html#a4f463dc716dfa40a028d6c08b803aa53">in_avail</a>();</div><div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;        <span class="keywordtype">bool</span> bPingFinished = <span class="keyword">false</span>;</div><div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;        std::string sProblem;</div><div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;</div><div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;        <span class="keywordflow">if</span> (nAvail &gt;= <span class="keyword">sizeof</span>(nonce)) {</div><div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;            vRecv &gt;&gt; nonce;</div><div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;</div><div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;            <span class="comment">// Only process pong message if there is an outstanding ping (old ping without nonce should never pong)</span></div><div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a> != 0) {</div><div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;                <span class="keywordflow">if</span> (nonce == pfrom-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a>) {</div><div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;                    <span class="comment">// Matching pong received, this ping is no longer outstanding</span></div><div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;                    bPingFinished = <span class="keyword">true</span>;</div><div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;                    int64_t pingUsecTime = pingUsecEnd - pfrom-&gt;<a class="code" href="class_c_node.html#a9f0b0d22b190db2f74afd1b24cff47a1">nPingUsecStart</a>;</div><div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;                    <span class="keywordflow">if</span> (pingUsecTime &gt; 0) {</div><div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;                        <span class="comment">// Successful ping time measurement, replace previous</span></div><div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;                        pfrom-&gt;<a class="code" href="class_c_node.html#ab7986845edae94a0aa0d64b6fcf51a38">nPingUsecTime</a> = pingUsecTime;</div><div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;                        pfrom-&gt;<a class="code" href="class_c_node.html#a99add23b72cd7eae9ea5c7d16b0fe259">nMinPingUsecTime</a> = std::min(pfrom-&gt;<a class="code" href="class_c_node.html#a99add23b72cd7eae9ea5c7d16b0fe259">nMinPingUsecTime</a>.load(), pingUsecTime);</div><div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;                        <span class="comment">// This should never happen</span></div><div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;                        sProblem = <span class="stringliteral">&quot;Timing mishap&quot;</span>;</div><div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;                    }</div><div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;                    <span class="comment">// Nonce mismatches are normal when pings are overlapping</span></div><div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;                    sProblem = <span class="stringliteral">&quot;Nonce mismatch&quot;</span>;</div><div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;                    <span class="keywordflow">if</span> (nonce == 0) {</div><div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;                        <span class="comment">// This is most likely a bug in another implementation somewhere; cancel this ping</span></div><div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;                        bPingFinished = <span class="keyword">true</span>;</div><div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;                        sProblem = <span class="stringliteral">&quot;Nonce zero&quot;</span>;</div><div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;                    }</div><div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;                }</div><div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;                sProblem = <span class="stringliteral">&quot;Unsolicited pong without ping&quot;</span>;</div><div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;            }</div><div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;            <span class="comment">// This is most likely a bug in another implementation somewhere; cancel this ping</span></div><div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;            bPingFinished = <span class="keyword">true</span>;</div><div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;            sProblem = <span class="stringliteral">&quot;Short payload&quot;</span>;</div><div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;        }</div><div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;</div><div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;        <span class="keywordflow">if</span> (!(sProblem.empty())) {</div><div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;pong peer=%d: %s, %x expected, %x received, %u bytes\n&quot;</span>,</div><div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(),</div><div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;                sProblem,</div><div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;                pfrom-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a>,</div><div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;                nonce,</div><div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;                nAvail);</div><div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;        }</div><div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;        <span class="keywordflow">if</span> (bPingFinished) {</div><div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a> = 0;</div><div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;        }</div><div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;    }</div><div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;</div><div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a0e95085c85cbbb8330fa1a5ffe49070f">NetMsgType::FILTERLOAD</a>) {</div><div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;        <a class="code" href="class_c_bloom_filter.html">CBloomFilter</a> filter;</div><div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;        vRecv &gt;&gt; filter;</div><div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;</div><div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;        <span class="keywordflow">if</span> (!filter.IsWithinSizeConstraints())</div><div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;        {</div><div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;            <span class="comment">// There is no excuse for sending a too-large filter</span></div><div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100);</div><div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;        }</div><div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;        {</div><div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;            pfrom-&gt;pfilter.reset(<span class="keyword">new</span> <a class="code" href="class_c_bloom_filter.html">CBloomFilter</a>(filter));</div><div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;            pfrom-&gt;pfilter-&gt;UpdateEmptyFull();</div><div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;            pfrom-&gt;<a class="code" href="class_c_node.html#ab387bb0c4ffd42e3f0aea233dca0e301">fRelayTxes</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;        }</div><div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    }</div><div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;</div><div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a75c8dba2361ddda663917c27f14c3a16">NetMsgType::FILTERADD</a>) {</div><div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;        std::vector&lt;unsigned char&gt; vData;</div><div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;        vRecv &gt;&gt; vData;</div><div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;</div><div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;        <span class="comment">// Nodes must NEVER send a data item &gt; 520 bytes (the max size for a script data object,</span></div><div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;        <span class="comment">// and thus, the maximum size any matched object can have) in a filteradd message</span></div><div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;        <span class="keywordtype">bool</span> bad = <span class="keyword">false</span>;</div><div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;        <span class="keywordflow">if</span> (vData.size() &gt; <a class="code" href="script_8h.html#a4e2e7158597de76ecbb03d866ec4c693">MAX_SCRIPT_ELEMENT_SIZE</a>) {</div><div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;            bad = <span class="keyword">true</span>;</div><div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;            <span class="keywordflow">if</span> (pfrom-&gt;pfilter) {</div><div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;                pfrom-&gt;pfilter-&gt;insert(vData);</div><div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;                bad = <span class="keyword">true</span>;</div><div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;            }</div><div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;        }</div><div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;        <span class="keywordflow">if</span> (bad) {</div><div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100);</div><div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;        }</div><div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;    }</div><div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;</div><div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a1ef3ccc1966cb35a59882fb97c15a30e">NetMsgType::FILTERCLEAR</a>) {</div><div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">GetLocalServices</a>() &amp; <a class="code" href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb">NODE_BLOOM</a>) {</div><div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;            pfrom-&gt;pfilter.reset(<span class="keyword">new</span> <a class="code" href="class_c_bloom_filter.html">CBloomFilter</a>());</div><div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;        }</div><div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#ab387bb0c4ffd42e3f0aea233dca0e301">fRelayTxes</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;    }</div><div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;</div><div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;</div><div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a1a6d457786a36cd01e8688d356883a47">NetMsgType::GETMNLISTDIFF</a>) {</div><div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;        <a class="code" href="class_c_get_simplified_m_n_list_diff.html">CGetSimplifiedMNListDiff</a> cmd;</div><div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;        vRecv &gt;&gt; cmd;</div><div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;</div><div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;</div><div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;        <a class="code" href="class_c_simplified_m_n_list_diff.html">CSimplifiedMNListDiff</a> mnListDiff;</div><div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;        std::string strError;</div><div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="simplifiedmns_8cpp.html#a1478cfcf5bfe0b6bf12e2c7bb628dc40">BuildSimplifiedMNListDiff</a>(cmd.baseBlockHash, cmd.blockHash, mnListDiff, strError)) {</div><div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ac4299daf3e1b6b047287708f3894113e">NetMsgType::MNLISTDIFF</a>, mnListDiff));</div><div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;            strError = <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;getmnlistdiff failed for baseBlockHash=%s, blockHash=%s. error=%s&quot;</span>, cmd.baseBlockHash.ToString(), cmd.blockHash.ToString(), strError);</div><div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;            <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 1, strError);</div><div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;        }</div><div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;    }</div><div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;</div><div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;</div><div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#ac4299daf3e1b6b047287708f3894113e">NetMsgType::MNLISTDIFF</a>) {</div><div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;        <span class="comment">// we have never requested this</span></div><div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;        <a class="code" href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), 100, <a class="code" href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a>(<span class="stringliteral">&quot;received not-requested mnlistdiff. peer=%d&quot;</span>, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()));</div><div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;    }</div><div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;</div><div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;</div><div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;    <span class="keywordflow">if</span> (strCommand == <a class="code" href="namespace_net_msg_type.html#a567653d3f26a7e711889682e7fd1c484">NetMsgType::NOTFOUND</a>) {</div><div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;        <span class="comment">// Remove the NOTFOUND transactions from the peer</span></div><div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;        CNodeState *state = State(pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;        std::vector&lt;CInv&gt; vInv;</div><div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;        vRecv &gt;&gt; vInv;</div><div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;        <span class="keywordflow">if</span> (vInv.size() &lt;= <a class="code" href="net__processing_8cpp.html#aa22ab8b72b51c86621b28b923dd85605">MAX_PEER_OBJECT_IN_FLIGHT</a> + <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a>) {</div><div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;            <span class="keywordflow">for</span> (<a class="code" href="class_c_inv.html">CInv</a> &amp;inv : vInv) {</div><div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;                <span class="keywordflow">if</span> (inv.IsKnownType()) {</div><div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;                    <span class="comment">// If we receive a NOTFOUND message for a txid we requested, erase</span></div><div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;                    <span class="comment">// it from our data structures for this peer.</span></div><div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;                    <span class="keyword">auto</span> in_flight_it = state-&gt;m_object_download.m_object_in_flight.find(inv);</div><div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;                    <span class="keywordflow">if</span> (in_flight_it == state-&gt;m_object_download.m_object_in_flight.end()) {</div><div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;                        <span class="comment">// Skip any further work if this is a spurious NOTFOUND</span></div><div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;                        <span class="comment">// message.</span></div><div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;                    }</div><div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;                    state-&gt;m_object_download.m_object_in_flight.erase(in_flight_it);</div><div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;                    state-&gt;m_object_download.m_object_announced.erase(inv);</div><div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;                }</div><div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;            }</div><div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;        }</div><div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;    }</div><div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;</div><div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;    <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;</div><div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;    <span class="keyword">const</span> std::vector&lt;std::string&gt; &amp;allMessages = <a class="code" href="protocol_8cpp.html#a5f8d18ec9217ffee378339dc22ebe20d">getAllNetMessageTypes</a>();</div><div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> std::string msg : allMessages) {</div><div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;        <span class="keywordflow">if</span>(msg == strCommand) {</div><div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;            found = <span class="keyword">true</span>;</div><div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;        }</div><div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;    }</div><div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;</div><div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;    <span class="keywordflow">if</span> (found)</div><div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;    {</div><div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;        <span class="comment">//probably one the extensions</span></div><div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;<span class="preprocessor">#ifdef ENABLE_WALLET</span></div><div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;        <a class="code" href="privatesend-client_8cpp.html#ad3fbbb845524ff48bd48ca41ea5e51a8">privateSendClient</a>.<a class="code" href="class_c_private_send_client_manager.html#a5ffa7ec563a356049bd99301b1d7e55f">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;<span class="preprocessor">#endif // ENABLE_WALLET</span></div><div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;        <a class="code" href="privatesend-server_8cpp.html#a1b2b9915fc9328ffcd70517e5c6d649a">privateSendServer</a>.<a class="code" href="class_c_private_send_server.html#a66c38d7af845bab8e22c37e2165fd5f9">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;        <a class="code" href="spork_8cpp.html#af6873019c3095ea6b554795e4040395c">sporkManager</a>.<a class="code" href="class_c_spork_manager.html#a27d0be91a9dac781937ba3656870170e">ProcessSpork</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;        <a class="code" href="masternode-sync_8cpp.html#a9807e6586e8a7cb25799ea4150520448">masternodeSync</a>.<a class="code" href="class_c_masternode_sync.html#aa61c8de4587e4135e08cf860da991542">ProcessMessage</a>(pfrom, strCommand, vRecv);</div><div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;        <a class="code" href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a>.<a class="code" href="class_c_governance_manager.html#a2b6e0b1cc473ed34714723422e0b8ae8">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;        <a class="code" href="class_c_m_n_auth.html#a6ca18dc077a8867aae448261300f3333">CMNAuth::ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;        <a class="code" href="namespacellmq.html#a32533f25ea72d1153af50d680a75434d">llmq::quorumBlockProcessor</a>-&gt;<a class="code" href="classllmq_1_1_c_quorum_block_processor.html#aa95f97977868b55a6616b54392d265f4">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;        <a class="code" href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a>-&gt;<a class="code" href="classllmq_1_1_c_d_k_g_session_manager.html#a95b9bbcb003cef356837ed097b784be4">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;        <a class="code" href="namespacellmq.html#a90e3abe3a8683f999d6165b9b68913c3">llmq::quorumSigSharesManager</a>-&gt;<a class="code" href="classllmq_1_1_c_sig_shares_manager.html#a4d59d0a6400f6bd658ad9b727a4686f1">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;        <a class="code" href="namespacellmq.html#ab7c4af133e9f8609793106eaceffd8a3">llmq::quorumSigningManager</a>-&gt;<a class="code" href="classllmq_1_1_c_signing_manager.html#a0aff9671b0801a7db9e9022351a0ef75">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;        <a class="code" href="namespacellmq.html#aab0e6e59f5052f34a32a83bdd4c2999d">llmq::chainLocksHandler</a>-&gt;<a class="code" href="classllmq_1_1_c_chain_locks_handler.html#ac3fb4545be795693b9f35e4b3e17ff8f">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;        <a class="code" href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a>-&gt;<a class="code" href="classllmq_1_1_c_instant_send_manager.html#afa51a454de242fab085d98cdf24f8611">ProcessMessage</a>(pfrom, strCommand, vRecv, *connman);</div><div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;    }</div><div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;</div><div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;    <span class="comment">// Ignore unknown commands for extensibility</span></div><div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Unknown command \&quot;%s\&quot; from peer=%d\n&quot;</span>, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;</div><div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;}</div><div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;</div><div class="line"><a name="l03510"></a><span class="lineno"><a class="line" href="net__processing_8cpp.html#a8884cd826dfda4930989e342ca8821bb"> 3510</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="net__processing_8cpp.html#a8884cd826dfda4930989e342ca8821bb">SendRejectsAndCheckIfBanned</a>(<a class="code" href="class_c_node.html">CNode</a>* pnode, <a class="code" href="class_c_connman.html">CConnman</a>* connman)</div><div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;{</div><div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;    CNodeState &amp;state = *State(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;</div><div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a>) {</div><div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">const</span> CBlockReject&amp; reject : state.rejects) {</div><div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;            connman-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pnode, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, (std::string)<a class="code" href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a>, reject.chRejectCode, reject.strRejectReason, reject.hashBlock));</div><div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        }</div><div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;    }</div><div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;    state.rejects.clear();</div><div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;</div><div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;    <span class="keywordflow">if</span> (state.fShouldBan) {</div><div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;        state.fShouldBan = <span class="keyword">false</span>;</div><div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;        <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>)</div><div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Warning: not punishing whitelisted peer %s!\n&quot;</span>, pnode-&gt;<a class="code" href="class_c_node.html#a31b644122c610cf13fca18a6ccfbd164">GetLogString</a>());</div><div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#a6d81efc365079ca499a5f6465967d8d9">m_manual_connection</a>)</div><div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Warning: not punishing manually-connected peer %s!\n&quot;</span>, pnode-&gt;<a class="code" href="class_c_node.html#a31b644122c610cf13fca18a6ccfbd164">GetLogString</a>());</div><div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;            pnode-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;            <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>.<a class="code" href="class_c_net_addr.html#a857bfcf95814b7d6ef4db309c84f179d">IsLocal</a>())</div><div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;                <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Warning: not banning local peer %s!\n&quot;</span>, pnode-&gt;<a class="code" href="class_c_node.html#a31b644122c610cf13fca18a6ccfbd164">GetLogString</a>());</div><div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;            {</div><div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;                connman-&gt;<a class="code" href="class_c_connman.html#ac57208a8ea613f814aaf1c5c5e5394a4">Ban</a>(pnode-&gt;<a class="code" href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">addr</a>, <a class="code" href="addrdb_8h.html#ae79eefa5f9d20b9761dfc7a41123e668ae46a4491319b620067723c12d5ba3c7a">BanReasonNodeMisbehaving</a>);</div><div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;            }</div><div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;        }</div><div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;    }</div><div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;}</div><div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;</div><div class="line"><a name="l03542"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#adaa77fc4eee771d8e64b6c61f52c4266"> 3542</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_peer_logic_validation.html#adaa77fc4eee771d8e64b6c61f52c4266">PeerLogicValidation::ProcessMessages</a>(<a class="code" href="class_c_node.html">CNode</a>* pfrom, std::atomic&lt;bool&gt;&amp; interruptMsgProc)</div><div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;{</div><div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_chain_params.html">CChainParams</a>&amp; chainparams = <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>();</div><div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;    <span class="comment">// Message format</span></div><div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;    <span class="comment">//  (4) message start</span></div><div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;    <span class="comment">//  (12) command</span></div><div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;    <span class="comment">//  (4) size</span></div><div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;    <span class="comment">//  (4) checksum</span></div><div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;    <span class="comment">//  (x) data</span></div><div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;    <span class="comment">//</span></div><div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;    <span class="keywordtype">bool</span> fMoreWork = <span class="keyword">false</span>;</div><div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;</div><div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;    <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.empty())</div><div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;        <a class="code" href="net__processing_8cpp.html#a9f058406be3ef6ad83afbb7021424d21">ProcessGetData</a>(pfrom, chainparams, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>, interruptMsgProc);</div><div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;</div><div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;    <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">orphan_work_set</a>.empty()) {</div><div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;        <a class="code" href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, <a class="code" href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a>);</div><div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;        <a class="code" href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a>(<a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>, pfrom-&gt;<a class="code" href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">orphan_work_set</a>);</div><div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;    }</div><div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;</div><div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;    <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a>)</div><div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;</div><div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;    <span class="comment">// this maintains the order of responses</span></div><div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;    <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.empty()) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;    <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">orphan_work_set</a>.empty()) <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div><div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;    <span class="comment">// Don&#39;t bother if send buffer is too full to respond anyway</span></div><div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;    <span class="keywordflow">if</span> (pfrom-&gt;<a class="code" href="class_c_node.html#a73b323f9e310e3054d909934b37ae671">fPauseSend</a>)</div><div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;</div><div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;    std::list&lt;CNetMessage&gt; msgs;</div><div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;    {</div><div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a81d6deb661c7386a453e0966d2dbc36f">cs_vProcessMsg</a>);</div><div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;        <span class="keywordflow">if</span> (pfrom-&gt;vProcessMsg.empty())</div><div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;        <span class="comment">// Just take one message</span></div><div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;        msgs.splice(msgs.begin(), pfrom-&gt;vProcessMsg, pfrom-&gt;vProcessMsg.begin());</div><div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a30f76a69e956d342bdbb400541c98ccb">nProcessQueueSize</a> -= msgs.front().vRecv.size() + <a class="code" href="class_c_message_header.html#a981398bab090d100b34ef439ed496654">CMessageHeader::HEADER_SIZE</a>;</div><div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#a108e17226d76c85c89f7d057dad2b088">fPauseRecv</a> = pfrom-&gt;<a class="code" href="class_c_node.html#a30f76a69e956d342bdbb400541c98ccb">nProcessQueueSize</a> &gt; <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a30095fabc2e1727514ad2f2d530a496d">GetReceiveFloodSize</a>();</div><div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;        fMoreWork = !pfrom-&gt;vProcessMsg.empty();</div><div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;    }</div><div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;    <a class="code" href="class_c_net_message.html">CNetMessage</a>&amp; msg(msgs.front());</div><div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;</div><div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;    msg.<a class="code" href="class_c_net_message.html#a63b9f2351d5e92126cacacd51d9e16b6">SetVersion</a>(pfrom-&gt;<a class="code" href="class_c_node.html#a482bcdf4b371750edd33dd8ed5f5a0bf">GetRecvVersion</a>());</div><div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;    <span class="comment">// Scan for message start</span></div><div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;    <span class="keywordflow">if</span> (memcmp(msg.hdr.pchMessageStart, chainparams.<a class="code" href="class_c_chain_params.html#a42f81df0a4f3494e3fc83ab53049fdd9">MessageStart</a>(), <a class="code" href="class_c_message_header.html#aa2f294417b6095d10135ba838fcb7902">CMessageHeader::MESSAGE_START_SIZE</a>) != 0) {</div><div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;PROCESSMESSAGE: INVALID MESSAGESTART %s peer=%d\n&quot;</span>, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(msg.hdr.GetCommand()), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;        pfrom-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;    }</div><div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;</div><div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;    <span class="comment">// Read header</span></div><div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;    <a class="code" href="class_c_message_header.html">CMessageHeader</a>&amp; hdr = msg.hdr;</div><div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;    <span class="keywordflow">if</span> (!hdr.<a class="code" href="class_c_message_header.html#a759db7100358ba4a44bf6dee757ffe51">IsValid</a>(chainparams.<a class="code" href="class_c_chain_params.html#a42f81df0a4f3494e3fc83ab53049fdd9">MessageStart</a>()))</div><div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;    {</div><div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;PROCESSMESSAGE: ERRORS IN HEADER %s peer=%d\n&quot;</span>, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(hdr.<a class="code" href="class_c_message_header.html#ab5b3807481d4b918527b86523f1efee2">GetCommand</a>()), pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;        <span class="keywordflow">return</span> fMoreWork;</div><div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;    }</div><div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;    std::string strCommand = hdr.<a class="code" href="class_c_message_header.html#ab5b3807481d4b918527b86523f1efee2">GetCommand</a>();</div><div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;</div><div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;    <span class="comment">// Message size</span></div><div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nMessageSize = hdr.<a class="code" href="class_c_message_header.html#aebbc26feb23d551467ebd58b509204d0">nMessageSize</a>;</div><div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;</div><div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;    <span class="comment">// Checksum</span></div><div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;    <a class="code" href="class_c_data_stream.html">CDataStream</a>&amp; vRecv = msg.vRecv;</div><div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;    <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash = msg.GetMessageHash();</div><div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;    <span class="keywordflow">if</span> (memcmp(hash.<a class="code" href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">begin</a>(), hdr.<a class="code" href="class_c_message_header.html#aa0da43a88e43c6ac575b8b3af98b8107">pchChecksum</a>, <a class="code" href="class_c_message_header.html#a5668d7d3e1cb2f0a80c333495ed3da35">CMessageHeader::CHECKSUM_SIZE</a>) != 0)</div><div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;    {</div><div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s(%s, %u bytes): CHECKSUM ERROR expected %s was %s\n&quot;</span>, __func__,</div><div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;           <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), nMessageSize,</div><div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;           <a class="code" href="utilstrencodings_8h.html#ace13a819ca4e98c22847d26b3b357e75">HexStr</a>(hash.<a class="code" href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">begin</a>(), hash.<a class="code" href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">begin</a>()+<a class="code" href="class_c_message_header.html#a5668d7d3e1cb2f0a80c333495ed3da35">CMessageHeader::CHECKSUM_SIZE</a>),</div><div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;           <a class="code" href="utilstrencodings_8h.html#ace13a819ca4e98c22847d26b3b357e75">HexStr</a>(hdr.<a class="code" href="class_c_message_header.html#aa0da43a88e43c6ac575b8b3af98b8107">pchChecksum</a>, hdr.<a class="code" href="class_c_message_header.html#aa0da43a88e43c6ac575b8b3af98b8107">pchChecksum</a>+<a class="code" href="class_c_message_header.html#a5668d7d3e1cb2f0a80c333495ed3da35">CMessageHeader::CHECKSUM_SIZE</a>));</div><div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;        <span class="keywordflow">return</span> fMoreWork;</div><div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;    }</div><div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;</div><div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;    <span class="comment">// Process message</span></div><div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;    <span class="keywordtype">bool</span> fRet = <span class="keyword">false</span>;</div><div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;    <span class="keywordflow">try</span></div><div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;    {</div><div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;        fRet = <a class="code" href="net__processing_8cpp.html#aafd21e2e5beded09e8826d455ac8e17b">ProcessMessage</a>(pfrom, strCommand, vRecv, msg.nTime, chainparams, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>, interruptMsgProc);</div><div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;        <span class="keywordflow">if</span> (interruptMsgProc)</div><div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;        <span class="keywordflow">if</span> (!pfrom-&gt;<a class="code" href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">vRecvGetData</a>.empty())</div><div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;            fMoreWork = <span class="keyword">true</span>;</div><div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;    }</div><div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::ios_base::failure&amp; e)</div><div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;    {</div><div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a>) {</div><div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pfrom, <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a>(<a class="code" href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a>).Make(<a class="code" href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a>, strCommand, <a class="code" href="consensus_2validation_8h.html#ae08e367e8cda26747c749b3b313a47a1">REJECT_MALFORMED</a>, std::string(<span class="stringliteral">&quot;error parsing message&quot;</span>)));</div><div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;        }</div><div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;        <span class="keywordflow">if</span> (strstr(e.what(), <span class="stringliteral">&quot;end of data&quot;</span>))</div><div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;        {</div><div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;            <span class="comment">// Allow exceptions from under-length message on vRecv</span></div><div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s(%s, %u bytes): Exception &#39;%s&#39; caught, normally caused by a message being shorter than its stated length\n&quot;</span>, __func__, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), nMessageSize, e.what());</div><div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;        }</div><div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(e.what(), <span class="stringliteral">&quot;size too large&quot;</span>))</div><div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;        {</div><div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;            <span class="comment">// Allow exceptions from over-long size</span></div><div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s(%s, %u bytes): Exception &#39;%s&#39; caught\n&quot;</span>, __func__, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), nMessageSize, e.what());</div><div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;        }</div><div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(e.what(), <span class="stringliteral">&quot;non-canonical ReadCompactSize()&quot;</span>))</div><div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;        {</div><div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;            <span class="comment">// Allow exceptions from non-canonical encoding</span></div><div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s(%s, %u bytes): Exception &#39;%s&#39; caught\n&quot;</span>, __func__, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), nMessageSize, e.what());</div><div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;        }</div><div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;        {</div><div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;            <a class="code" href="util_8cpp.html#afcb801683f7acaab09f94e56eb60b603">PrintExceptionContinue</a>(std::current_exception(), <span class="stringliteral">&quot;ProcessMessages()&quot;</span>);</div><div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;            }</div><div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;        } <span class="keywordflow">catch</span> (...) {</div><div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;        <a class="code" href="util_8cpp.html#afcb801683f7acaab09f94e56eb60b603">PrintExceptionContinue</a>(std::current_exception(), <span class="stringliteral">&quot;ProcessMessages()&quot;</span>);</div><div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;    }</div><div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;</div><div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;    <span class="keywordflow">if</span> (!fRet) {</div><div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s(%s, %u bytes) FAILED peer=%d\n&quot;</span>, __func__, <a class="code" href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a>(strCommand), nMessageSize, pfrom-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;    }</div><div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;</div><div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;    <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;    <a class="code" href="net__processing_8cpp.html#a8884cd826dfda4930989e342ca8821bb">SendRejectsAndCheckIfBanned</a>(pfrom, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>);</div><div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;</div><div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;    <span class="keywordflow">return</span> fMoreWork;</div><div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;}</div><div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;</div><div class="line"><a name="l03667"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a847dcca3d1a4475ba1bfcaae6da76bad"> 3667</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#a847dcca3d1a4475ba1bfcaae6da76bad">PeerLogicValidation::ConsiderEviction</a>(<a class="code" href="class_c_node.html">CNode</a> *pto, int64_t time_in_seconds)</div><div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;{</div><div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;    <a class="code" href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;</div><div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;    CNodeState &amp;state = *State(pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;    <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pto-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;</div><div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;    <span class="keywordflow">if</span> (!state.m_chain_sync.m_protect &amp;&amp; <a class="code" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a>(pto) &amp;&amp; state.fSyncStarted) {</div><div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;        <span class="comment">// This is an outbound peer subject to disconnection if they don&#39;t</span></div><div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;        <span class="comment">// announce a block with as much work as the current tip within</span></div><div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;        <span class="comment">// CHAIN_SYNC_TIMEOUT + HEADERS_RESPONSE_TIME seconds (note: if</span></div><div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;        <span class="comment">// their chain has more work than ours, we should sync to it,</span></div><div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;        <span class="comment">// unless it&#39;s invalid, in which case we should find that out and</span></div><div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;        <span class="comment">// disconnect from them elsewhere).</span></div><div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;        <span class="keywordflow">if</span> (state.pindexBestKnownBlock != <span class="keyword">nullptr</span> &amp;&amp; state.pindexBestKnownBlock-&gt;nChainWork &gt;= <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">nChainWork</a>) {</div><div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;            <span class="keywordflow">if</span> (state.m_chain_sync.m_timeout != 0) {</div><div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;                state.m_chain_sync.m_timeout = 0;</div><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;                state.m_chain_sync.m_work_header = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;                state.m_chain_sync.m_sent_getheaders = <span class="keyword">false</span>;</div><div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;            }</div><div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state.m_chain_sync.m_timeout == 0 || (state.m_chain_sync.m_work_header != <span class="keyword">nullptr</span> &amp;&amp; state.pindexBestKnownBlock != <span class="keyword">nullptr</span> &amp;&amp; state.pindexBestKnownBlock-&gt;nChainWork &gt;= state.m_chain_sync.m_work_header-&gt;nChainWork)) {</div><div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;            <span class="comment">// Our best block known by this peer is behind our tip, and we&#39;re either noticing</span></div><div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;            <span class="comment">// that for the first time, OR this peer was able to catch up to some earlier point</span></div><div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;            <span class="comment">// where we checked against our tip.</span></div><div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;            <span class="comment">// Either way, set a new timeout based on current tip.</span></div><div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;            state.m_chain_sync.m_timeout = time_in_seconds + <a class="code" href="net__processing_8h.html#aff73fe9e1950b05a035cfb90019dab50">CHAIN_SYNC_TIMEOUT</a>;</div><div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;            state.m_chain_sync.m_work_header = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>();</div><div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;            state.m_chain_sync.m_sent_getheaders = <span class="keyword">false</span>;</div><div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state.m_chain_sync.m_timeout &gt; 0 &amp;&amp; time_in_seconds &gt; state.m_chain_sync.m_timeout) {</div><div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;            <span class="comment">// No evidence yet that our peer has synced to a chain with work equal to that</span></div><div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;            <span class="comment">// of our tip, when we first detected it was behind. Send a single getheaders</span></div><div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;            <span class="comment">// message to give the peer a chance to update us.</span></div><div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;            <span class="keywordflow">if</span> (state.m_chain_sync.m_sent_getheaders) {</div><div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;                <span class="comment">// They&#39;ve run out of time to catch up!</span></div><div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;                <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Disconnecting outbound peer %d for old chain, best known block = %s\n&quot;</span>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), state.pindexBestKnownBlock != <span class="keyword">nullptr</span> ? state.pindexBestKnownBlock-&gt;GetBlockHash().ToString() : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>);</div><div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;                assert(state.m_chain_sync.m_work_header);</div><div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\n&quot;</span>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), state.pindexBestKnownBlock != <span class="keyword">nullptr</span> ? state.pindexBestKnownBlock-&gt;GetBlockHash().ToString() : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, state.m_chain_sync.m_work_header-&gt;GetBlockHash().ToString());</div><div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(state.m_chain_sync.m_work_header-&gt;pprev), <a class="code" href="classuint256.html">uint256</a>()));</div><div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;                state.m_chain_sync.m_sent_getheaders = <span class="keyword">true</span>;</div><div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;                constexpr int64_t HEADERS_RESPONSE_TIME = 120; <span class="comment">// 2 minutes</span></div><div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;                <span class="comment">// Bump the timeout to allow a response, which could clear the timeout</span></div><div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;                <span class="comment">// (if the response shows the peer has synced), reset the timeout (if</span></div><div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;                <span class="comment">// the peer syncs to the required work but not to our tip), or result</span></div><div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;                <span class="comment">// in disconnect (if we advance to the timeout and pindexBestKnownBlock</span></div><div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;                <span class="comment">// has not sufficiently progressed)</span></div><div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;                state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;</div><div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;            }</div><div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;        }</div><div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;    }</div><div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;}</div><div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;</div><div class="line"><a name="l03720"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#ac89bf1ee08fd8960559d19ab87564b0d"> 3720</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#ac89bf1ee08fd8960559d19ab87564b0d">PeerLogicValidation::EvictExtraOutboundPeers</a>(int64_t time_in_seconds)</div><div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;{</div><div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;    <span class="comment">// Check whether we have too many outbound peers</span></div><div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;    <span class="keywordtype">int</span> extra_peers = <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#acba1d832c1b35fca5b4624d5979df6ac">GetExtraOutboundCount</a>();</div><div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;    <span class="keywordflow">if</span> (extra_peers &gt; 0) {</div><div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;        <span class="comment">// If we have more outbound peers than we target, disconnect one.</span></div><div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;        <span class="comment">// Pick the outbound peer that least recently announced</span></div><div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;        <span class="comment">// us a new block, with ties broken by choosing the more recent</span></div><div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;        <span class="comment">// connection (higher node id)</span></div><div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;        <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> worst_peer = -1;</div><div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;        int64_t oldest_block_announcement = std::numeric_limits&lt;int64_t&gt;::max();</div><div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;</div><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;</div><div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2d665bfdec68f6484b9f0d6760f9efd1">ForEachNode</a>([&amp;](<a class="code" href="class_c_node.html">CNode</a>* pnode) {</div><div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;            <span class="comment">// Don&#39;t disconnect masternodes just because they were slow in block announcement</span></div><div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;            <span class="keywordflow">if</span> (pnode-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;            <span class="comment">// Ignore non-outbound peers, or nodes marked for disconnect already</span></div><div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;            if (!<a class="code" href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a>(pnode) || pnode-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;            CNodeState *state = State(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;            <span class="keywordflow">if</span> (state == <span class="keyword">nullptr</span>) <span class="keywordflow">return</span>; <span class="comment">// shouldn&#39;t be possible, but just in case</span></div><div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;            <span class="comment">// Don&#39;t evict our protected peers</span></div><div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;            <span class="keywordflow">if</span> (state-&gt;m_chain_sync.m_protect) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;            <span class="keywordflow">if</span> (state-&gt;m_last_block_announcement &lt; oldest_block_announcement || (state-&gt;m_last_block_announcement == oldest_block_announcement &amp;&amp; pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>() &gt; worst_peer)) {</div><div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;                worst_peer = pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>();</div><div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;                oldest_block_announcement = state-&gt;m_last_block_announcement;</div><div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;            }</div><div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;        });</div><div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;        <span class="keywordflow">if</span> (worst_peer != -1) {</div><div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;            <span class="keywordtype">bool</span> disconnected = <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a28701e595fcd7dd71791f105457db034">ForNode</a>(worst_peer, [&amp;](<a class="code" href="class_c_node.html">CNode</a> *pnode) {</div><div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;                <span class="comment">// Only disconnect a peer that has been connected to us for</span></div><div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;                <span class="comment">// some reasonable fraction of our check-frequency, to give</span></div><div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;                <span class="comment">// it time for new information to have arrived.</span></div><div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;                <span class="comment">// Also don&#39;t disconnect any peer we&#39;re trying to download a</span></div><div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;                <span class="comment">// block from.</span></div><div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;                CNodeState &amp;state = *State(pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;                <span class="keywordflow">if</span> (time_in_seconds - pnode-&gt;<a class="code" href="class_c_node.html#a4d571070a8b80c094ee1fea990ce29d3">nTimeConnected</a> &gt; <a class="code" href="net__processing_8h.html#a9c22b1ae9c34ef1e327986bba6e1d4c2">MINIMUM_CONNECT_TIME</a> &amp;&amp; state.nBlocksInFlight == 0) {</div><div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;disconnecting extra outbound peer=%d (last block announcement received at time %d)\n&quot;</span>, pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), oldest_block_announcement);</div><div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;                    pnode-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;keeping outbound peer=%d chosen for eviction (connect time: %d, blocks_in_flight: %d)\n&quot;</span>, pnode-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pnode-&gt;<a class="code" href="class_c_node.html#a4d571070a8b80c094ee1fea990ce29d3">nTimeConnected</a>, state.nBlocksInFlight);</div><div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;                }</div><div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;            });</div><div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;            <span class="keywordflow">if</span> (disconnected) {</div><div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;                <span class="comment">// If we disconnected an extra peer, that means we successfully</span></div><div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;                <span class="comment">// connected to at least one peer after the last time we</span></div><div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;                <span class="comment">// detected a stale tip. Don&#39;t try any more extra peers until</span></div><div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;                <span class="comment">// we next detect a stale tip, to limit the load we put on the</span></div><div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;                <span class="comment">// network from these extra connections.</span></div><div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2f86bde4f7b877cabf96f787aafa7068">SetTryNewOutboundPeer</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;            }</div><div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;        }</div><div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;    }</div><div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;}</div><div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;</div><div class="line"><a name="l03777"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#ad9ba8b8657346c1ce86e061d5fdaeb53"> 3777</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_peer_logic_validation.html#ad9ba8b8657346c1ce86e061d5fdaeb53">PeerLogicValidation::CheckForStaleTipAndEvictPeers</a>(<span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a> &amp;consensusParams)</div><div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;{</div><div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a> == <span class="keyword">nullptr</span>) <span class="keywordflow">return</span>;</div><div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;</div><div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;    int64_t time_in_seconds = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;</div><div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;    <a class="code" href="class_peer_logic_validation.html#ac89bf1ee08fd8960559d19ab87564b0d">EvictExtraOutboundPeers</a>(time_in_seconds);</div><div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;</div><div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;    <span class="keywordflow">if</span> (time_in_seconds &gt; <a class="code" href="class_peer_logic_validation.html#a20db0a2ffae94ecbcfe2e39017ac7ef9">m_stale_tip_check_time</a>) {</div><div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>);</div><div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;        <span class="comment">// Check whether our tip is stale, and if so, allow using an extra</span></div><div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;        <span class="comment">// outbound peer</span></div><div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;        <span class="keywordflow">if</span> (TipMayBeStale(consensusParams)) {</div><div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\n&quot;</span>, time_in_seconds - g_last_tip_update);</div><div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2f86bde4f7b877cabf96f787aafa7068">SetTryNewOutboundPeer</a>(<span class="keyword">true</span>);</div><div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a11dd47af36136db41a012f06d1976273">GetTryNewOutboundPeer</a>()) {</div><div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#a2f86bde4f7b877cabf96f787aafa7068">SetTryNewOutboundPeer</a>(<span class="keyword">false</span>);</div><div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;        }</div><div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;        <a class="code" href="class_peer_logic_validation.html#a20db0a2ffae94ecbcfe2e39017ac7ef9">m_stale_tip_check_time</a> = time_in_seconds + <a class="code" href="net__processing_8h.html#a981e8ad003ae095856a6b97679245be2">STALE_CHECK_INTERVAL</a>;</div><div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;    }</div><div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;}</div><div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;</div><div class="line"><a name="l03799"></a><span class="lineno"><a class="line" href="class_compare_inv_mempool_order.html"> 3799</a></span>&#160;<span class="keyword">class </span><a class="code" href="class_compare_inv_mempool_order.html">CompareInvMempoolOrder</a></div><div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;{</div><div class="line"><a name="l03801"></a><span class="lineno"><a class="line" href="class_compare_inv_mempool_order.html#ad6211dc6a6928d8499d5b58babe95ddd"> 3801</a></span>&#160;    <a class="code" href="class_c_tx_mem_pool.html">CTxMemPool</a> *<a class="code" href="class_compare_inv_mempool_order.html#ad6211dc6a6928d8499d5b58babe95ddd">mp</a>;</div><div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l03803"></a><span class="lineno"><a class="line" href="class_compare_inv_mempool_order.html#ab81595ec0e2a66d6be86c893e309a975"> 3803</a></span>&#160;    <span class="keyword">explicit</span> <a class="code" href="class_compare_inv_mempool_order.html#ab81595ec0e2a66d6be86c893e309a975">CompareInvMempoolOrder</a>(<a class="code" href="class_c_tx_mem_pool.html">CTxMemPool</a> *_mempool)</div><div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;    {</div><div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;        <a class="code" href="class_compare_inv_mempool_order.html#ad6211dc6a6928d8499d5b58babe95ddd">mp</a> = _mempool;</div><div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;    }</div><div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;</div><div class="line"><a name="l03808"></a><span class="lineno"><a class="line" href="class_compare_inv_mempool_order.html#a1cd3da690b8741dcc21d415f5d8d006f"> 3808</a></span>&#160;    <span class="keywordtype">bool</span> <a class="code" href="class_compare_inv_mempool_order.html#a1cd3da690b8741dcc21d415f5d8d006f">operator()</a>(std::set&lt;uint256&gt;::iterator a, std::set&lt;uint256&gt;::iterator b)</div><div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;    {</div><div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;        <span class="comment">/* As std::make_heap produces a max-heap, we want the entries with the</span></div><div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;<span class="comment">         * fewest ancestors/highest fee to sort later. */</span></div><div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="class_compare_inv_mempool_order.html#ad6211dc6a6928d8499d5b58babe95ddd">mp</a>-&gt;<a class="code" href="class_c_tx_mem_pool.html#a8544d756fb965d312077e9feccb0f4a4">CompareDepthAndScore</a>(*b, *a);</div><div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;    }</div><div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;};</div><div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;</div><div class="line"><a name="l03816"></a><span class="lineno"><a class="line" href="class_peer_logic_validation.html#a44833df64aa594c24ee271c1ece007ab"> 3816</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_peer_logic_validation.html#a44833df64aa594c24ee271c1ece007ab">PeerLogicValidation::SendMessages</a>(<a class="code" href="class_c_node.html">CNode</a>* pto, std::atomic&lt;bool&gt;&amp; interruptMsgProc)</div><div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;{</div><div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;    <span class="keyword">const</span> <a class="code" href="struct_consensus_1_1_params.html">Consensus::Params</a>&amp; consensusParams = <a class="code" href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a>().<a class="code" href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">GetConsensus</a>();</div><div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;    {</div><div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;        <span class="comment">// Don&#39;t send anything until the version handshake is complete</span></div><div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;        <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#a359647a8e7ad1fc72243b126b35729b6">fSuccessfullyConnected</a> || pto-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a>)</div><div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;</div><div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;        <span class="comment">// If we get here, the outgoing message serialization version is set and can&#39;t change.</span></div><div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;        <span class="keyword">const</span> <a class="code" href="class_c_net_msg_maker.html">CNetMsgMaker</a> msgMaker(pto-&gt;<a class="code" href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">GetSendVersion</a>());</div><div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;</div><div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;        <span class="comment">// Message: ping</span></div><div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;        <span class="keywordtype">bool</span> pingSend = <span class="keyword">false</span>;</div><div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;        <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#a2349010606131fe65879e5a44d9ab37e">fPingQueued</a>) {</div><div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;            <span class="comment">// RPC ping request by user</span></div><div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;            pingSend = <span class="keyword">true</span>;</div><div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;        }</div><div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;        <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a> == 0 &amp;&amp; pto-&gt;<a class="code" href="class_c_node.html#a9f0b0d22b190db2f74afd1b24cff47a1">nPingUsecStart</a> + <a class="code" href="net_8h.html#a24ecbac59f1e63af4c4c8c112f00468d">PING_INTERVAL</a> * 1000000 &lt; <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>()) {</div><div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;            <span class="comment">// Ping automatically sent as a latency probe &amp; keepalive.</span></div><div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;            pingSend = <span class="keyword">true</span>;</div><div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;        }</div><div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;        <span class="keywordflow">if</span> (pingSend) {</div><div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;            uint64_t nonce = 0;</div><div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;            <span class="keywordflow">while</span> (nonce == 0) {</div><div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;                <a class="code" href="random_8cpp.html#ada0c29949c4d1ac0cc027d93c4771423">GetRandBytes</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;nonce, <span class="keyword">sizeof</span>(nonce));</div><div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;            }</div><div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#a2349010606131fe65879e5a44d9ab37e">fPingQueued</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#a9f0b0d22b190db2f74afd1b24cff47a1">nPingUsecStart</a> = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>();</div><div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;            <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">nVersion</a> &gt; <a class="code" href="version_8h.html#aa3feca3b6094096fa1b660159bdcb04a">BIP0031_VERSION</a>) {</div><div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a> = nonce;</div><div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ad9a2ba0319f01bf1c26f5206b5156496">NetMsgType::PING</a>, nonce));</div><div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;                <span class="comment">// Peer is too old to support ping command with nonce, pong will never arrive.</span></div><div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">nPingNonceSent</a> = 0;</div><div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#ad9a2ba0319f01bf1c26f5206b5156496">NetMsgType::PING</a>));</div><div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;            }</div><div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;        }</div><div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div><div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;        <a class="code" href="sync_8h.html#aca08e7299069c2d60b8aa726fc550612">TRY_LOCK</a>(<a class="code" href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a>, lockMain); <span class="comment">// Acquire cs_main for IsInitialBlockDownload() and CNodeState()</span></div><div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;        <span class="keywordflow">if</span> (!lockMain)</div><div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;</div><div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a8884cd826dfda4930989e342ca8821bb">SendRejectsAndCheckIfBanned</a>(pto, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>))</div><div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;        CNodeState &amp;state = *State(pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;</div><div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;        <span class="comment">// Address refresh broadcast</span></div><div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;        int64_t nNow = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>();</div><div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;        <span class="keyword">auto</span> current_time = GetTime&lt;std::chrono::microseconds&gt;();</div><div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;</div><div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>() &amp;&amp; pto-&gt;nNextLocalAddrSend &lt; nNow) {</div><div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;            <a class="code" href="net_8cpp.html#a0cde2b3256757536c42c0bd3037847d1">AdvertiseLocal</a>(pto);</div><div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;            pto-&gt;nNextLocalAddrSend = <a class="code" href="net_8cpp.html#acec0d60e03ec326ee67e5a6531a05154">PoissonNextSend</a>(nNow, <a class="code" href="net__processing_8cpp.html#afe7eb24fb43804693ab6c6491f153581">AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</a>);</div><div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;        }</div><div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;</div><div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;        <span class="comment">// Message: addr</span></div><div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;        <span class="keywordflow">if</span> (pto-&gt;nNextAddrSend &lt; nNow) {</div><div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;            pto-&gt;nNextAddrSend = <a class="code" href="net_8cpp.html#acec0d60e03ec326ee67e5a6531a05154">PoissonNextSend</a>(nNow, <a class="code" href="net__processing_8cpp.html#a7ec45a20c72f5a43ec54d6cc213b229d">AVG_ADDRESS_BROADCAST_INTERVAL</a>);</div><div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;            std::vector&lt;CAddress&gt; vAddr;</div><div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;            vAddr.reserve(pto-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>.size());</div><div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_address.html">CAddress</a>&amp; addr : pto-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>)</div><div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;            {</div><div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;                <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#a3f3a08b1a2c85b1c6cf975b2bdb53171">addrKnown</a>.<a class="code" href="class_c_rolling_bloom_filter.html#a4f7d6161274b03c63be50aadb1fe46b7">contains</a>(addr.<a class="code" href="class_c_service.html#af21ea7db4318330b337c8bfdcc55aff0">GetKey</a>()))</div><div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;                {</div><div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;                    pto-&gt;<a class="code" href="class_c_node.html#a3f3a08b1a2c85b1c6cf975b2bdb53171">addrKnown</a>.<a class="code" href="class_c_rolling_bloom_filter.html#a0fedbf0cf38c9070a30c7c5f8299f5d7">insert</a>(addr.<a class="code" href="class_c_service.html#af21ea7db4318330b337c8bfdcc55aff0">GetKey</a>());</div><div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;                    vAddr.push_back(addr);</div><div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;                    <span class="comment">// receiver rejects addr messages larger than 1000</span></div><div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;                    <span class="keywordflow">if</span> (vAddr.size() &gt;= 1000)</div><div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                    {</div><div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a77d83bbf95702906ee01ca4fd934e1c0">NetMsgType::ADDR</a>, vAddr));</div><div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;                        vAddr.clear();</div><div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;                    }</div><div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;                }</div><div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;            }</div><div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>.clear();</div><div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;            <span class="keywordflow">if</span> (!vAddr.empty())</div><div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a77d83bbf95702906ee01ca4fd934e1c0">NetMsgType::ADDR</a>, vAddr));</div><div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;            <span class="comment">// we only send the big addr message once</span></div><div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;            <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>.capacity() &gt; 40)</div><div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">vAddrToSend</a>.shrink_to_fit();</div><div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;        }</div><div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;</div><div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;        <span class="comment">// Start block sync</span></div><div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a> == <span class="keyword">nullptr</span>)</div><div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;            <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a> = <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>();</div><div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;        <span class="keywordtype">bool</span> fFetch = state.fPreferredDownload || (nPreferredDownload == 0 &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#a721e2470c2c961b7599768a14be68781">fClient</a> &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">fOneShot</a>); <span class="comment">// Download if this is a nice peer, or we have no nice peers and this one might do.</span></div><div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;        <span class="keywordflow">if</span> (!state.fSyncStarted &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#a721e2470c2c961b7599768a14be68781">fClient</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a> &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;            <span class="comment">// Only actively request headers from a single peer, unless we&#39;re close to end of initial download.</span></div><div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;            <span class="keywordflow">if</span> ((nSyncStarted == 0 &amp;&amp; fFetch) || <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() &gt; <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - <a class="code" href="validation_8cpp.html#af66174e55ad9bafa7a92e4740db6b575">nMaxTipAge</a>) {</div><div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;                state.fSyncStarted = <span class="keyword">true</span>;</div><div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;                state.nHeadersSyncTimeout = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>() + <a class="code" href="net__processing_8h.html#a09ba6681dd87e0136d25acc054a335a0">HEADERS_DOWNLOAD_TIMEOUT_BASE</a> + <a class="code" href="net__processing_8h.html#a8a4d3867ceb626ccda62b3b728425d07">HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</a> * (<a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>())/(consensusParams.<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a>);</div><div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;                nSyncStarted++;</div><div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;                <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindexStart = <a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>;</div><div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;                <span class="comment">/* If possible, start at the block preceding the currently</span></div><div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;<span class="comment">                   best known header.  This ensures that we always get a</span></div><div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;<span class="comment">                   non-empty list of headers back as long as the peer</span></div><div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;<span class="comment">                   is up-to-date.  With a non-empty response, we can initialise</span></div><div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;<span class="comment">                   the peer&#39;s known best block.  This wouldn&#39;t be possible</span></div><div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;<span class="comment">                   if we requested starting at pindexBestHeader and</span></div><div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;<span class="comment">                   got back an empty response.  */</span></div><div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;                <span class="keywordflow">if</span> (pindexStart-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>)</div><div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;                    pindexStart = pindexStart-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a>;</div><div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;initial getheaders (%d) to peer=%d (startheight:%d)\n&quot;</span>, pindexStart-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pto-&gt;<a class="code" href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">nStartingHeight</a>);</div><div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;                <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a>, <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">GetLocator</a>(pindexStart), <a class="code" href="classuint256.html">uint256</a>()));</div><div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;            }</div><div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;        }</div><div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;</div><div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;        <span class="comment">// Resend wallet transactions that haven&#39;t gotten in a block yet</span></div><div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;        <span class="comment">// Except during reindex, importing and IBD, when old wallet</span></div><div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;        <span class="comment">// transactions become unconfirmed and spams other nodes.</span></div><div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a> &amp;&amp; !<a class="code" href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a> &amp;&amp; !<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>())</div><div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;        {</div><div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;            <span class="keyword">static</span> int64_t nLastBroadcastTime = 0;</div><div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;            <span class="comment">// HACK: Call this only once every few seconds. SendMessages is called once per peer, which makes this signal very expensive</span></div><div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;            <span class="comment">// The proper solution would be to move this out of here, but this is not worth the effort right now as bitcoin#15632 will later do this.</span></div><div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;            <span class="comment">// Luckily, the Broadcast signal is not used for anything else then CWallet::ResendWalletTransactionsBefore.</span></div><div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;            <span class="keywordflow">if</span> (nNow - nLastBroadcastTime &gt;= 5000000) {</div><div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;                <a class="code" href="validationinterface_8cpp.html#a0aaad62c8654cb1868295e0682b05866">GetMainSignals</a>().<a class="code" href="class_c_main_signals.html#ab57756efee0f6f12b5a14cbbbd283df7">Broadcast</a>(<a class="code" href="net__processing_8cpp.html#a147efbcf1410c50c56547340f1fe1ebd">nTimeBestReceived</a>, <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>);</div><div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;                nLastBroadcastTime = nNow;</div><div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;            }</div><div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;        }</div><div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;</div><div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;        <span class="comment">// Try sending block announcements via headers</span></div><div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;        <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a>) {</div><div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;            <span class="comment">// If we have less than MAX_BLOCKS_TO_ANNOUNCE in our</span></div><div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;            <span class="comment">// list of block hashes we&#39;re relaying, and our peer wants</span></div><div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;            <span class="comment">// headers announcements, then find the first header</span></div><div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;            <span class="comment">// not yet known to our peer but would connect, and send.</span></div><div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;            <span class="comment">// If no header would connect, or if we have too many</span></div><div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;            <span class="comment">// blocks, or if the peer doesn&#39;t want headers, just</span></div><div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;            <span class="comment">// add all to the inv queue.</span></div><div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;            <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pto-&gt;<a class="code" href="class_c_node.html#a1e8b0784cc82f33edc2dc4e2834d1ff0">cs_inventory</a>);</div><div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;            std::vector&lt;CBlock&gt; vHeaders;</div><div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;            <span class="keywordtype">bool</span> fRevertToInv = ((!state.fPreferHeaders &amp;&amp;</div><div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;                                 (!state.fPreferHeaderAndIDs || pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>.size() &gt; 1)) ||</div><div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;                                 pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>.size() &gt; <a class="code" href="validation_8h.html#ad4d4718d1ec747708a31bc47aaa66578">MAX_BLOCKS_TO_ANNOUNCE</a>);</div><div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pBestIndex = <span class="keyword">nullptr</span>; <span class="comment">// last header queued for delivery</span></div><div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;            ProcessBlockAvailability(pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>()); <span class="comment">// ensure pindexBestKnownBlock is up-to-date</span></div><div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;</div><div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;            <span class="keywordflow">if</span> (!fRevertToInv) {</div><div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;                <span class="keywordtype">bool</span> fFoundStartingHeader = <span class="keyword">false</span>;</div><div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;                <span class="comment">// Try to find first header that our peer doesn&#39;t have, and</span></div><div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;                <span class="comment">// then send all headers past that one.  If we come across any</span></div><div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;                <span class="comment">// headers that aren&#39;t on chainActive, give up.</span></div><div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;                <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> &amp;hash : pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>) {</div><div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;                    BlockMap::iterator mi = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(hash);</div><div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;                    assert(mi != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end());</div><div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;                    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex = mi-&gt;second;</div><div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>[pindex-&gt;nHeight] != pindex) {</div><div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;                        <span class="comment">// Bail out if we reorged away from this block</span></div><div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;                        fRevertToInv = <span class="keyword">true</span>;</div><div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;                    }</div><div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;                    <span class="keywordflow">if</span> (pBestIndex != <span class="keyword">nullptr</span> &amp;&amp; pindex-&gt;<a class="code" href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">pprev</a> != pBestIndex) {</div><div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;                        <span class="comment">// This means that the list of blocks to announce don&#39;t</span></div><div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;                        <span class="comment">// connect to each other.</span></div><div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;                        <span class="comment">// This shouldn&#39;t really be possible to hit during</span></div><div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;                        <span class="comment">// regular operation (because reorgs should take us to</span></div><div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;                        <span class="comment">// a chain that has some block not on the prior chain,</span></div><div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;                        <span class="comment">// which should be caught by the prior check), but one</span></div><div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;                        <span class="comment">// way this could happen is by using invalidateblock /</span></div><div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;                        <span class="comment">// reconsiderblock repeatedly on the tip, causing it to</span></div><div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;                        <span class="comment">// be added multiple times to vBlockHashesToAnnounce.</span></div><div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;                        <span class="comment">// Robustly deal with this rare situation by reverting</span></div><div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;                        <span class="comment">// to an inv.</span></div><div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;                        fRevertToInv = <span class="keyword">true</span>;</div><div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;                    }</div><div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;                    pBestIndex = pindex;</div><div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;                    <span class="keywordtype">bool</span> isPrevDevnetGenesisBlock = <span class="keyword">false</span>;</div><div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;                    <span class="keywordflow">if</span> (!consensusParams.<a class="code" href="struct_consensus_1_1_params.html#ad909dd557f5bf211649f95e0d6d3cbd0">hashDevnetGenesisBlock</a>.<a class="code" href="classbase__blob.html#aba89c6722866a5850882a509d27d7bbd">IsNull</a>() &amp;&amp;</div><div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;                        pindex-&gt;pprev != <span class="keyword">nullptr</span> &amp;&amp;</div><div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;                        pindex-&gt;pprev-&gt;GetBlockHash() == consensusParams.<a class="code" href="struct_consensus_1_1_params.html#ad909dd557f5bf211649f95e0d6d3cbd0">hashDevnetGenesisBlock</a>) {</div><div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;                        <span class="comment">// even though the devnet genesis block was never transferred through the wire and thus not</span></div><div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;                        <span class="comment">// appear anywhere in the node state where we track what other nodes have or not have, we can</span></div><div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;                        <span class="comment">// assume that the other node already knows the devnet genesis block</span></div><div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;                        isPrevDevnetGenesisBlock = <span class="keyword">true</span>;</div><div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;                    }</div><div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;                    <span class="keywordflow">if</span> (fFoundStartingHeader) {</div><div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;                        <span class="comment">// add this to the headers message</span></div><div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;                        vHeaders.push_back(pindex-&gt;GetBlockHeader());</div><div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PeerHasHeader(&amp;state, pindex)) {</div><div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;                        <span class="keywordflow">continue</span>; <span class="comment">// keep looking for the first new block</span></div><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pindex-&gt;pprev == <span class="keyword">nullptr</span> || PeerHasHeader(&amp;state, pindex-&gt;pprev) || isPrevDevnetGenesisBlock) {</div><div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;                        <span class="comment">// Peer doesn&#39;t have this header but they do have the prior one.</span></div><div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;                        <span class="comment">// Start sending headers.</span></div><div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;                        fFoundStartingHeader = <span class="keyword">true</span>;</div><div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;                        vHeaders.push_back(pindex-&gt;GetBlockHeader());</div><div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;                        <span class="comment">// Peer doesn&#39;t have this header or the prior one -- nothing will</span></div><div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;                        <span class="comment">// connect, so bail out.</span></div><div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;                        fRevertToInv = <span class="keyword">true</span>;</div><div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;                        <span class="keywordflow">break</span>;</div><div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;                    }</div><div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;                }</div><div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;            }</div><div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;            <span class="keywordflow">if</span> (!fRevertToInv &amp;&amp; !vHeaders.empty()) {</div><div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;                <span class="keywordflow">if</span> (vHeaders.size() == 1 &amp;&amp; state.fPreferHeaderAndIDs) {</div><div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;                    <span class="comment">// We only send up to 1 block as header-and-ids, as otherwise</span></div><div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;                    <span class="comment">// probably means we&#39;re doing an initial-ish-sync or they&#39;re slow</span></div><div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s sending header-and-ids %s to peer=%d\n&quot;</span>, __func__,</div><div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;                            vHeaders.front().GetHash().ToString(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;</div><div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;                    <span class="keywordtype">bool</span> fGotBlockFromCache = <span class="keyword">false</span>;</div><div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;                    {</div><div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;                        <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(<a class="code" href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a>);</div><div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;                        <span class="keywordflow">if</span> (<a class="code" href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d">most_recent_block_hash</a> == pBestIndex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()) {</div><div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;                            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a>, *<a class="code" href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9">most_recent_compact_block</a>));</div><div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;                            fGotBlockFromCache = <span class="keyword">true</span>;</div><div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;                        }</div><div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;                    }</div><div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;                    <span class="keywordflow">if</span> (!fGotBlockFromCache) {</div><div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;                        <a class="code" href="class_c_block.html">CBlock</a> block;</div><div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;                        <span class="keywordtype">bool</span> ret = <a class="code" href="validation_8cpp.html#a578c1df234b05798180f0235d469a5ba">ReadBlockFromDisk</a>(block, pBestIndex, consensusParams);</div><div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;                        assert(ret);</div><div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;                        <a class="code" href="class_c_block_header_and_short_tx_i_ds.html">CBlockHeaderAndShortTxIDs</a> cmpctblock(block);</div><div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a>, cmpctblock));</div><div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;                    }</div><div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;                    state.pindexBestHeaderSent = pBestIndex;</div><div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state.fPreferHeaders) {</div><div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;                    <span class="keywordflow">if</span> (vHeaders.size() &gt; 1) {</div><div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: %u headers, range (%s, %s), to peer=%d\n&quot;</span>, __func__,</div><div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;                                vHeaders.size(),</div><div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;                                vHeaders.front().GetHash().ToString(),</div><div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;                                vHeaders.back().GetHash().ToString(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: sending header %s to peer=%d\n&quot;</span>, __func__,</div><div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;                                vHeaders.front().GetHash().ToString(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;                    }</div><div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;                    <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#a216e35db319a5d508043639fd3170776">NetMsgType::HEADERS</a>, vHeaders));</div><div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;                    state.pindexBestHeaderSent = pBestIndex;</div><div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;                } <span class="keywordflow">else</span></div><div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;                    fRevertToInv = <span class="keyword">true</span>;</div><div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;            }</div><div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;            <span class="keywordflow">if</span> (fRevertToInv) {</div><div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;                <span class="comment">// If falling back to using an inv, just try to inv the tip.</span></div><div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;                <span class="comment">// The last entry in vBlockHashesToAnnounce was our tip at some point</span></div><div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;                <span class="comment">// in the past.</span></div><div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;                <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>.empty()) {</div><div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;                    <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a> &amp;hashToAnnounce = pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>.back();</div><div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;                    BlockMap::iterator mi = <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.find(hashToAnnounce);</div><div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;                    assert(mi != <a class="code" href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a>.end());</div><div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;                    <span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex = mi-&gt;second;</div><div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;</div><div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;                    <span class="comment">// Warn if we&#39;re announcing a block that is not on the main chain.</span></div><div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;                    <span class="comment">// This should be very rare and could be optimized out.</span></div><div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;                    <span class="comment">// Just log for now.</span></div><div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>[pindex-&gt;nHeight] != pindex) {</div><div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Announcing block %s not on main chain (tip=%s)\n&quot;</span>,</div><div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;                            hashToAnnounce.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(), <a class="code" href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a>.<a class="code" href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">Tip</a>()-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;                    }</div><div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;</div><div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;                    <span class="comment">// If the peer&#39;s chain has this block, don&#39;t inv it back.</span></div><div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;                    <span class="keywordflow">if</span> (!PeerHasHeader(&amp;state, pindex)) {</div><div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;                        pto-&gt;<a class="code" href="class_c_node.html#a7cef2333aa8776127a7e7fcab659eb6a">PushInventory</a>(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, hashToAnnounce));</div><div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s: sending inv peer=%d hash=%s\n&quot;</span>, __func__,</div><div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;                            pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), hashToAnnounce.<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>());</div><div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;                    }</div><div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;                }</div><div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;            }</div><div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">vBlockHashesToAnnounce</a>.clear();</div><div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;        }</div><div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;</div><div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;        <span class="comment">// Message: inventory</span></div><div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;        std::vector&lt;CInv&gt; vInv;</div><div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;        {</div><div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;            <span class="keywordtype">size_t</span> reserve = std::min&lt;size_t&gt;(pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.size(), <a class="code" href="net__processing_8cpp.html#acca6adf5d9b189ce87be23364d84261a">INVENTORY_BROADCAST_MAX_PER_1MB_BLOCK</a> * <a class="code" href="consensus_8h.html#aa372df0d6494f4aaca5ecf5a5a9d4406">MaxBlockSize</a>(<span class="keyword">true</span>) / 1000000);</div><div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;            reserve = std::max&lt;size_t&gt;(reserve, pto-&gt;vInventoryBlockToSend.size());</div><div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;            reserve = std::min&lt;size_t&gt;(reserve, <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>);</div><div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;            vInv.reserve(reserve);</div><div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;</div><div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;            <a class="code" href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a>(<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#ac7ee8c06837c7d2688e2d7e3d071bdbb">cs</a>, pto-&gt;<a class="code" href="class_c_node.html#a1e8b0784cc82f33edc2dc4e2834d1ff0">cs_inventory</a>);</div><div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;</div><div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;            <span class="comment">// Add blocks</span></div><div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash : pto-&gt;vInventoryBlockToSend) {</div><div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;                vInv.push_back(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, hash));</div><div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;                <span class="keywordflow">if</span> (vInv.size() == <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>) {</div><div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;                    <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;                    vInv.clear();</div><div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;                }</div><div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;            }</div><div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;            pto-&gt;vInventoryBlockToSend.clear();</div><div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;</div><div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;            <span class="comment">// Check whether periodic sends should happen</span></div><div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;            <span class="comment">// Note: If this node is running in a Masternode mode, it makes no sense to delay outgoing txes</span></div><div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;            <span class="comment">// because we never produce any txes ourselves i.e. no privacy is lost in this case.</span></div><div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;            <span class="keywordtype">bool</span> fSendTrickle = pto-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a> || <a class="code" href="util_8cpp.html#aab0b2c1be849102968dfee289f3b3e2a">fMasternodeMode</a>;</div><div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;            <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#aa91b5214571b8f195fec1484d4a5b96a">nNextInvSend</a> &lt; current_time) {</div><div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;                fSendTrickle = <span class="keyword">true</span>;</div><div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;                <span class="keywordflow">if</span> (pto-&gt;<a class="code" href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">fInbound</a>) {</div><div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;                    pto-&gt;<a class="code" href="class_c_node.html#aa91b5214571b8f195fec1484d4a5b96a">nNextInvSend</a> = std::chrono::microseconds{<a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#abbed3e0e20b469953fc8d72b4c2167fe">PoissonNextSendInbound</a>(current_time.count(), <a class="code" href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">INVENTORY_BROADCAST_INTERVAL</a>)};</div><div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;                    <span class="comment">// Use half the delay for regular outbound peers, as there is less privacy concern for them.</span></div><div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;                    <span class="comment">// and quarter the delay for Masternode outbound peers, as there is even less privacy concern in this case.</span></div><div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;                    pto-&gt;<a class="code" href="class_c_node.html#aa91b5214571b8f195fec1484d4a5b96a">nNextInvSend</a> = <a class="code" href="net_8cpp.html#acec0d60e03ec326ee67e5a6531a05154">PoissonNextSend</a>(current_time, std::chrono::seconds{<a class="code" href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">INVENTORY_BROADCAST_INTERVAL</a> &gt;&gt; 1 &gt;&gt; !pto-&gt;<a class="code" href="class_c_node.html#a41accf3f4c9d4aacfa013053346266a2">verifiedProRegTxHash</a>.<a class="code" href="classbase__blob.html#aba89c6722866a5850882a509d27d7bbd">IsNull</a>()});</div><div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;                }</div><div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;            }</div><div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;</div><div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;            <span class="comment">// Time to send but the peer has requested we not relay transactions.</span></div><div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;            <span class="keywordflow">if</span> (fSendTrickle) {</div><div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pto-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;                <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#ab387bb0c4ffd42e3f0aea233dca0e301">fRelayTxes</a>) pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.clear();</div><div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;            }</div><div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;</div><div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;            <span class="comment">// Respond to BIP35 mempool requests</span></div><div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;            <span class="keywordflow">if</span> (fSendTrickle &amp;&amp; pto-&gt;<a class="code" href="class_c_node.html#ac6dfcb66887b3d26d58e25e7d3397016">fSendMempool</a>) {</div><div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;                <span class="keyword">auto</span> vtxinfo = <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#a53f08d964e4fdf9c70e89bb9719d7d64">infoAll</a>();</div><div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#ac6dfcb66887b3d26d58e25e7d3397016">fSendMempool</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;</div><div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pto-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;</div><div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;                <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; txinfo : vtxinfo) {</div><div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;                    <span class="keyword">const</span> <a class="code" href="classuint256.html">uint256</a>&amp; hash = txinfo.tx-&gt;GetHash();</div><div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;                    <span class="keywordtype">int</span> nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>;</div><div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a>(hash)) {</div><div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;                        nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>;</div><div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;                    }</div><div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;                    <a class="code" href="class_c_inv.html">CInv</a> inv(nInvType, hash);</div><div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;                    pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.erase(hash);</div><div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;                    <span class="keywordflow">if</span> (pto-&gt;pfilter) {</div><div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;                        <span class="keywordflow">if</span> (!pto-&gt;pfilter-&gt;IsRelevantAndUpdate(*txinfo.tx)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;                    }</div><div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;                    pto-&gt;filterInventoryKnown.insert(hash);</div><div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;</div><div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;SendMessages -- queued inv: %s  index=%d peer=%d\n&quot;</span>, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), vInv.size(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;                    vInv.push_back(inv);</div><div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;                    <span class="keywordflow">if</span> (vInv.size() == <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>) {</div><div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;SendMessages -- pushing inv&#39;s: count=%d peer=%d\n&quot;</span>, vInv.size(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;                        vInv.clear();</div><div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;                    }</div><div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;</div><div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;                    <a class="code" href="classuint256.html">uint256</a> islockHash;</div><div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;                    <span class="keywordflow">if</span> (!<a class="code" href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a>-&gt;GetInstantSendLockHashByTxid(hash, islockHash)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;                    <a class="code" href="class_c_inv.html">CInv</a> islockInv(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236">MSG_ISLOCK</a>, islockHash);</div><div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;                    pto-&gt;filterInventoryKnown.insert(islockHash);</div><div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;</div><div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;SendMessages -- queued inv: %s  index=%d peer=%d\n&quot;</span>, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), vInv.size(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;                    vInv.push_back(inv);</div><div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;                    <span class="keywordflow">if</span> (vInv.size() == <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>) {</div><div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;                        <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;SendMessages -- pushing inv&#39;s: count=%d peer=%d\n&quot;</span>, vInv.size(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;                        vInv.clear();</div><div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;                    }</div><div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;                }</div><div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#a91ddde2164145c8d4ab033e7b75bbc40">timeLastMempoolReq</a> = <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>();</div><div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;            }</div><div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;</div><div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;            <span class="comment">// Determine transactions to relay</span></div><div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;            <span class="keywordflow">if</span> (fSendTrickle) {</div><div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;                <span class="comment">// Produce a vector with all candidates for sending</span></div><div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;                std::vector&lt;std::set&lt;uint256&gt;::iterator&gt; vInvTx;</div><div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;                vInvTx.reserve(pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.size());</div><div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;                <span class="keywordflow">for</span> (std::set&lt;uint256&gt;::iterator it = pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.begin(); it != pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.end(); it++) {</div><div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;                    vInvTx.push_back(it);</div><div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;                }</div><div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;                <span class="comment">// Topologically and fee-rate sort the inventory we send for privacy and priority reasons.</span></div><div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;                <span class="comment">// A heap is used so that not all items need sorting if only a few are being sent.</span></div><div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;                <a class="code" href="class_compare_inv_mempool_order.html">CompareInvMempoolOrder</a> compareInvMempoolOrder(&amp;<a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>);</div><div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;                std::make_heap(vInvTx.begin(), vInvTx.end(), compareInvMempoolOrder);</div><div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;                <span class="comment">// No reason to drain out at many times the network&#39;s capacity,</span></div><div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160;                <span class="comment">// especially since we have many peers and some will draw much shorter delays.</span></div><div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nRelayedTransactions = 0;</div><div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;                <a class="code" href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a>(pto-&gt;<a class="code" href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">cs_filter</a>);</div><div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;                <span class="keywordflow">while</span> (!vInvTx.empty() &amp;&amp; nRelayedTransactions &lt; <a class="code" href="net__processing_8cpp.html#acca6adf5d9b189ce87be23364d84261a">INVENTORY_BROADCAST_MAX_PER_1MB_BLOCK</a> * <a class="code" href="consensus_8h.html#aa372df0d6494f4aaca5ecf5a5a9d4406">MaxBlockSize</a>(<span class="keyword">true</span>) / 1000000) {</div><div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;                    <span class="comment">// Fetch the top element from the heap</span></div><div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;                    std::pop_heap(vInvTx.begin(), vInvTx.end(), compareInvMempoolOrder);</div><div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;                    std::set&lt;uint256&gt;::iterator it = vInvTx.back();</div><div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;                    vInvTx.pop_back();</div><div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;                    <a class="code" href="classuint256.html">uint256</a> hash = *it;</div><div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;                    <span class="comment">// Remove it from the to-be-sent set</span></div><div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;                    pto-&gt;<a class="code" href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">setInventoryTxToSend</a>.erase(it);</div><div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;                    <span class="comment">// Check if not in the filter already</span></div><div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;                    <span class="keywordflow">if</span> (pto-&gt;filterInventoryKnown.contains(hash)) {</div><div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;                    }</div><div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160;                    <span class="comment">// Not in the mempool anymore? don&#39;t bother sending it.</span></div><div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;                    <span class="keyword">auto</span> txinfo = <a class="code" href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a>.<a class="code" href="class_c_tx_mem_pool.html#acf4bb9f52c40164659f484d45d09ecc4">info</a>(hash);</div><div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;                    <span class="keywordflow">if</span> (!txinfo.tx) {</div><div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160;                        <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;                    }</div><div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;                    <span class="keywordflow">if</span> (pto-&gt;pfilter &amp;&amp; !pto-&gt;pfilter-&gt;IsRelevantAndUpdate(*txinfo.tx)) <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;                    <span class="comment">// Send</span></div><div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;                    <span class="keywordtype">int</span> nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>;</div><div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a>(hash)) {</div><div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;                        nInvType = <a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a>;</div><div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;                    }</div><div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160;                    vInv.push_back(<a class="code" href="class_c_inv.html">CInv</a>(nInvType, hash));</div><div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;                    nRelayedTransactions++;</div><div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;                    {</div><div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;                        <span class="comment">// Expire old relay messages</span></div><div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;                        <span class="keywordflow">while</span> (!vRelayExpiration.empty() &amp;&amp; vRelayExpiration.front().first &lt; nNow)</div><div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;                        {</div><div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;                            mapRelay.erase(vRelayExpiration.front().second);</div><div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;                            vRelayExpiration.pop_front();</div><div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;                        }</div><div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;</div><div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;                        <span class="keyword">auto</span> ret = mapRelay.insert(std::make_pair(hash, std::move(txinfo.tx)));</div><div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160;                        <span class="keywordflow">if</span> (ret.second) {</div><div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;                            vRelayExpiration.push_back(std::make_pair(nNow + 15 * 60 * 1000000, ret.first));</div><div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;                        }</div><div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160;                    }</div><div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;                    <span class="keywordflow">if</span> (vInv.size() == <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>) {</div><div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;                        vInv.clear();</div><div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;                    }</div><div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;                    pto-&gt;filterInventoryKnown.insert(hash);</div><div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;                }</div><div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;            }</div><div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;</div><div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160;            <span class="comment">// Send non-tx/non-block inventory items</span></div><div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; inv : pto-&gt;<a class="code" href="class_c_node.html#aca9fdf7c1fa23060ef2769cc4ec85423">vInventoryOtherToSend</a>) {</div><div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;                <span class="keywordflow">if</span> (pto-&gt;filterInventoryKnown.contains(inv.hash)) {</div><div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;                    <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;                }</div><div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;                vInv.push_back(inv);</div><div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;                pto-&gt;filterInventoryKnown.insert(inv.hash);</div><div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;                <span class="keywordflow">if</span> (vInv.size() == <a class="code" href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a>) {</div><div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;                    <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;                    vInv.clear();</div><div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160;                }</div><div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;            }</div><div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#aca9fdf7c1fa23060ef2769cc4ec85423">vInventoryOtherToSend</a>.clear();</div><div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;        }</div><div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;        <span class="keywordflow">if</span> (!vInv.empty())</div><div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a>, vInv));</div><div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;</div><div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;        <span class="comment">// Detect whether we&#39;re stalling</span></div><div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;        current_time = GetTime&lt;std::chrono::microseconds&gt;();</div><div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;        <span class="comment">// nNow is the current system time (GetTimeMicros is not mockable) and</span></div><div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;        <span class="comment">// should be replaced by the mockable current_time eventually</span></div><div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;        nNow = <a class="code" href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a>();</div><div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;        <span class="keywordflow">if</span> (state.nStallingSince &amp;&amp; state.nStallingSince &lt; nNow - 1000000 * <a class="code" href="validation_8h.html#a0a0634a396d3b8ca22455aa4158daf48">BLOCK_STALLING_TIMEOUT</a>) {</div><div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;            <span class="comment">// Stalling only triggers when the block download window cannot move. During normal steady state,</span></div><div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160;            <span class="comment">// the download window should be much larger than the to-be-downloaded set of blocks, so disconnection</span></div><div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;            <span class="comment">// should only happen during initial block download.</span></div><div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;            <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Peer=%d is stalling block download, disconnecting\n&quot;</span>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;            pto-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;        }</div><div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;        <span class="comment">// In case there is a block that has been in flight from this peer for 2 + 0.5 * N times the block interval</span></div><div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;        <span class="comment">// (with N the number of peers from which we&#39;re downloading validated blocks), disconnect due to timeout.</span></div><div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;        <span class="comment">// We compensate for other peers to prevent killing off peers due to our own downstream link</span></div><div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;        <span class="comment">// being saturated. We only count validated in-flight blocks so peers can&#39;t advertise non-existing block hashes</span></div><div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;        <span class="comment">// to unreasonably increase our timeout.</span></div><div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;        <span class="keywordflow">if</span> (state.vBlocksInFlight.size() &gt; 0) {</div><div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;            QueuedBlock &amp;queuedBlock = state.vBlocksInFlight.front();</div><div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160;            <span class="keywordtype">int</span> nOtherPeersWithValidatedDownloads = nPeersWithValidatedDownloads - (state.nBlocksInFlightValidHeaders &gt; 0);</div><div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;            <span class="keywordflow">if</span> (nNow &gt; state.nDownloadingSince + consensusParams.<a class="code" href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">nPowTargetSpacing</a> * (<a class="code" href="validation_8h.html#a8483db75666c2a1d231108b125b0b3bf">BLOCK_DOWNLOAD_TIMEOUT_BASE</a> + <a class="code" href="validation_8h.html#a98597d505d0e8c99870eeda3db92f42f">BLOCK_DOWNLOAD_TIMEOUT_PER_PEER</a> * nOtherPeersWithValidatedDownloads)) {</div><div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;                <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Timeout downloading block %s from peer=%d, disconnecting\n&quot;</span>, queuedBlock.hash.ToString(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160;                pto-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;            }</div><div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;        }</div><div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;        <span class="comment">// Check for headers sync timeouts</span></div><div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;        <span class="keywordflow">if</span> (state.fSyncStarted &amp;&amp; state.nHeadersSyncTimeout &lt; std::numeric_limits&lt;int64_t&gt;::max()) {</div><div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;            <span class="comment">// Detect whether this is a stalling initial-headers-sync peer</span></div><div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a>-&gt;<a class="code" href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">GetBlockTime</a>() &lt;= <a class="code" href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a>() - <a class="code" href="validation_8cpp.html#af66174e55ad9bafa7a92e4740db6b575">nMaxTipAge</a>) {</div><div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;                <span class="keywordflow">if</span> (nNow &gt; state.nHeadersSyncTimeout &amp;&amp; nSyncStarted == 1 &amp;&amp; (nPreferredDownload - state.fPreferredDownload &gt;= 1)) {</div><div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;                    <span class="comment">// Disconnect a (non-whitelisted) peer if it is our only sync peer,</span></div><div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;                    <span class="comment">// and we have others we could be using instead.</span></div><div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;                    <span class="comment">// Note: If all our peers are inbound, then we won&#39;t</span></div><div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;                    <span class="comment">// disconnect our sync peer for stalling; we have bigger</span></div><div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;                    <span class="comment">// problems if we can&#39;t get any outbound peers.</span></div><div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;                    <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">fWhitelisted</a>) {</div><div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160;                        <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Timeout downloading headers from peer=%d, disconnecting\n&quot;</span>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;                        pto-&gt;<a class="code" href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">fDisconnect</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;                        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;                        <a class="code" href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a>(<span class="stringliteral">&quot;Timeout downloading headers from whitelisted peer=%d, not disconnecting\n&quot;</span>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;                        <span class="comment">// Reset the headers sync state so that we have a</span></div><div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;                        <span class="comment">// chance to try downloading from a different peer.</span></div><div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;                        <span class="comment">// Note: this will also result in at least one more</span></div><div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;                        <span class="comment">// getheaders message to be sent to</span></div><div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;                        <span class="comment">// this peer (eventually).</span></div><div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;                        state.fSyncStarted = <span class="keyword">false</span>;</div><div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;                        nSyncStarted--;</div><div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;                        state.nHeadersSyncTimeout = 0;</div><div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;                    }</div><div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;                }</div><div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;                <span class="comment">// After we&#39;ve caught up once, reset the timeout so we can&#39;t trigger</span></div><div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;                <span class="comment">// disconnect later.</span></div><div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;                state.nHeadersSyncTimeout = std::numeric_limits&lt;int64_t&gt;::max();</div><div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;            }</div><div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;        }</div><div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;</div><div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;        <span class="comment">// Check that outbound peers have reasonable chains</span></div><div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;        <span class="comment">// GetTime() is used by this anti-DoS logic so we can test this using mocktime</span></div><div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;        <a class="code" href="class_peer_logic_validation.html#a847dcca3d1a4475ba1bfcaae6da76bad">ConsiderEviction</a>(pto, <a class="code" href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a>());</div><div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;</div><div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160;        <span class="comment">// Message: getdata (blocks)</span></div><div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;        std::vector&lt;CInv&gt; vGetData;</div><div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;        <span class="keywordflow">if</span> (!pto-&gt;<a class="code" href="class_c_node.html#a721e2470c2c961b7599768a14be68781">fClient</a> &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">fMasternode</a> &amp;&amp; ((fFetch &amp;&amp; !pto-&gt;<a class="code" href="class_c_node.html#ad145fde29bb13ec1f761bacbf8674df9">m_limited_node</a>) || !<a class="code" href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a>()) &amp;&amp; state.nBlocksInFlight &lt; <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a>) {</div><div class="line"><a name="l04320"></a><span class="lineno"> 4320</span>&#160;            std::vector&lt;const CBlockIndex*&gt; vToDownload;</div><div class="line"><a name="l04321"></a><span class="lineno"> 4321</span>&#160;            <a class="code" href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a> staller = -1;</div><div class="line"><a name="l04322"></a><span class="lineno"> 4322</span>&#160;            FindNextBlocksToDownload(pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), <a class="code" href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a> - state.nBlocksInFlight, vToDownload, staller, consensusParams);</div><div class="line"><a name="l04323"></a><span class="lineno"> 4323</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_c_block_index.html">CBlockIndex</a> *pindex : vToDownload) {</div><div class="line"><a name="l04324"></a><span class="lineno"> 4324</span>&#160;                vGetData.push_back(<a class="code" href="class_c_inv.html">CInv</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>()));</div><div class="line"><a name="l04325"></a><span class="lineno"> 4325</span>&#160;                MarkBlockAsInFlight(pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>(), pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>(), pindex);</div><div class="line"><a name="l04326"></a><span class="lineno"> 4326</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Requesting block %s (%d) peer=%d\n&quot;</span>, pindex-&gt;<a class="code" href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">GetBlockHash</a>().<a class="code" href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">ToString</a>(),</div><div class="line"><a name="l04327"></a><span class="lineno"> 4327</span>&#160;                    pindex-&gt;<a class="code" href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">nHeight</a>, pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04328"></a><span class="lineno"> 4328</span>&#160;            }</div><div class="line"><a name="l04329"></a><span class="lineno"> 4329</span>&#160;            <span class="keywordflow">if</span> (state.nBlocksInFlight == 0 &amp;&amp; staller != -1) {</div><div class="line"><a name="l04330"></a><span class="lineno"> 4330</span>&#160;                <span class="keywordflow">if</span> (State(staller)-&gt;nStallingSince == 0) {</div><div class="line"><a name="l04331"></a><span class="lineno"> 4331</span>&#160;                    State(staller)-&gt;nStallingSince = nNow;</div><div class="line"><a name="l04332"></a><span class="lineno"> 4332</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Stall started peer=%d\n&quot;</span>, staller);</div><div class="line"><a name="l04333"></a><span class="lineno"> 4333</span>&#160;                }</div><div class="line"><a name="l04334"></a><span class="lineno"> 4334</span>&#160;            }</div><div class="line"><a name="l04335"></a><span class="lineno"> 4335</span>&#160;        }</div><div class="line"><a name="l04336"></a><span class="lineno"> 4336</span>&#160;</div><div class="line"><a name="l04337"></a><span class="lineno"> 4337</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04338"></a><span class="lineno"> 4338</span>&#160;        <span class="comment">// Message: getdata (non-blocks)</span></div><div class="line"><a name="l04339"></a><span class="lineno"> 4339</span>&#160;        <span class="comment">//</span></div><div class="line"><a name="l04340"></a><span class="lineno"> 4340</span>&#160;</div><div class="line"><a name="l04341"></a><span class="lineno"> 4341</span>&#160;        <span class="comment">// For robustness, expire old requests after a long timeout, so that</span></div><div class="line"><a name="l04342"></a><span class="lineno"> 4342</span>&#160;        <span class="comment">// we can resume downloading objects from a peer even if they</span></div><div class="line"><a name="l04343"></a><span class="lineno"> 4343</span>&#160;        <span class="comment">// were unresponsive in the past.</span></div><div class="line"><a name="l04344"></a><span class="lineno"> 4344</span>&#160;        <span class="comment">// Eventually we should consider disconnecting peers, but this is</span></div><div class="line"><a name="l04345"></a><span class="lineno"> 4345</span>&#160;        <span class="comment">// conservative.</span></div><div class="line"><a name="l04346"></a><span class="lineno"> 4346</span>&#160;        <span class="keywordflow">if</span> (state.m_object_download.m_check_expiry_timer &lt;= current_time) {</div><div class="line"><a name="l04347"></a><span class="lineno"> 4347</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">auto</span> it=state.m_object_download.m_object_in_flight.begin(); it != state.m_object_download.m_object_in_flight.end();) {</div><div class="line"><a name="l04348"></a><span class="lineno"> 4348</span>&#160;                <span class="keywordflow">if</span> (it-&gt;second &lt;= current_time - <a class="code" href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">GetObjectExpiryInterval</a>(it-&gt;first.type)) {</div><div class="line"><a name="l04349"></a><span class="lineno"> 4349</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;timeout of inflight object %s from peer=%d\n&quot;</span>, it-&gt;first.ToString(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04350"></a><span class="lineno"> 4350</span>&#160;                    state.m_object_download.m_object_announced.erase(it-&gt;first);</div><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;                    state.m_object_download.m_object_in_flight.erase(it++);</div><div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;                    ++it;</div><div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;                }</div><div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160;            }</div><div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;            <span class="comment">// On average, we do this check every GetObjectExpiryInterval. Randomize</span></div><div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;            <span class="comment">// so that we&#39;re not doing this for all peers at the same time.</span></div><div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;            state.m_object_download.m_check_expiry_timer = current_time + <a class="code" href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">GetObjectExpiryInterval</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>)/2 + <a class="code" href="random_8cpp.html#a49fa92a85621c56f1ce50385f8778505">GetRandMicros</a>(<a class="code" href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">GetObjectExpiryInterval</a>(<a class="code" href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a>));</div><div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;        }</div><div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;</div><div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;        <span class="comment">// DASH this code also handles non-TXs (Dash specific messages)</span></div><div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;        <span class="keyword">auto</span>&amp; object_process_time = state.m_object_download.m_object_process_time;</div><div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;        <span class="keywordflow">while</span> (!object_process_time.empty() &amp;&amp; object_process_time.begin()-&gt;first &lt;= current_time &amp;&amp; state.m_object_download.m_object_in_flight.size() &lt; <a class="code" href="net__processing_8cpp.html#aa22ab8b72b51c86621b28b923dd85605">MAX_PEER_OBJECT_IN_FLIGHT</a>) {</div><div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;            <span class="keyword">const</span> <a class="code" href="class_c_inv.html">CInv</a> inv = object_process_time.begin()-&gt;second;</div><div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;            <span class="comment">// Erase this entry from object_process_time (it may be added back for</span></div><div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;            <span class="comment">// processing at a later time, see below)</span></div><div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160;            object_process_time.erase(object_process_time.begin());</div><div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;            <span class="keywordflow">if</span> (g_erased_object_requests.count(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>)) {</div><div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s -- GETDATA skipping inv=(%s), peer=%d\n&quot;</span>, __func__, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;                state.m_object_download.m_object_announced.erase(inv);</div><div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;                state.m_object_download.m_object_in_flight.erase(inv);</div><div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;            }</div><div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a>(inv)) {</div><div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;                <span class="comment">// If this object was last requested more than GetObjectInterval ago,</span></div><div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;                <span class="comment">// then request.</span></div><div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;                <span class="keyword">const</span> <span class="keyword">auto</span> last_request_time = <a class="code" href="net__processing_8cpp.html#a3223f6e35a3458b35bee4d9f6771a8ee">GetObjectRequestTime</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>);</div><div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160;                <span class="keywordflow">if</span> (last_request_time &lt;= current_time - <a class="code" href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">GetObjectInterval</a>(inv.<a class="code" href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">type</a>)) {</div><div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;Requesting %s peer=%d\n&quot;</span>, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;                    vGetData.push_back(inv);</div><div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;                    <span class="keywordflow">if</span> (vGetData.size() &gt;= <a class="code" href="net__processing_8cpp.html#a94d0bd41756163cb0cc58f36d8d6676a">MAX_GETDATA_SZ</a>) {</div><div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;                        <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vGetData));</div><div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;                        vGetData.clear();</div><div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;                    }</div><div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;                    <a class="code" href="net__processing_8cpp.html#a786a2e6872a53c3559d0ccb4c1422516">UpdateObjectRequestTime</a>(inv.<a class="code" href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">hash</a>, current_time);</div><div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;                    state.m_object_download.m_object_in_flight.emplace(inv, current_time);</div><div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;                } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;                    <span class="comment">// This object is in flight from someone else; queue</span></div><div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;                    <span class="comment">// up processing to happen after the download times out</span></div><div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;                    <span class="comment">// (with a slight delay for inbound peers, to prefer</span></div><div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;                    <span class="comment">// requests to outbound peers).</span></div><div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;                    <span class="keyword">const</span> <span class="keyword">auto</span> next_process_time = <a class="code" href="net__processing_8cpp.html#acba2818c523a6551451b8bae883e998a">CalculateObjectGetDataTime</a>(inv, current_time, !state.fPreferredDownload);</div><div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;                    object_process_time.emplace(next_process_time, inv);</div><div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;                    <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s -- GETDATA re-queue inv=(%s), next_process_time=%d, delta=%d, peer=%d\n&quot;</span>, __func__, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), next_process_time.count(), (next_process_time - current_time).<a class="code" href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;                }</div><div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;                <span class="comment">// We have already seen this object, no need to download.</span></div><div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;                state.m_object_download.m_object_announced.erase(inv);</div><div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;                state.m_object_download.m_object_in_flight.erase(inv);</div><div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;                <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;%s -- GETDATA already seen inv=(%s), peer=%d\n&quot;</span>, __func__, inv.<a class="code" href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">ToString</a>(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;            }</div><div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;        }</div><div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160;</div><div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;</div><div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;        <span class="keywordflow">if</span> (!vGetData.empty()) {</div><div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;            <a class="code" href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">connman</a>-&gt;<a class="code" href="class_c_connman.html#adc69330bc472e50487030c031d5063db">PushMessage</a>(pto, msgMaker.Make(<a class="code" href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a>, vGetData));</div><div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;            <a class="code" href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a>(<a class="code" href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a>, <span class="stringliteral">&quot;SendMessages -- GETDATA -- pushed size = %lu peer=%d\n&quot;</span>, vGetData.size(), pto-&gt;<a class="code" href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">GetId</a>());</div><div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;        }</div><div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;</div><div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160;    }</div><div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;}</div><div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;</div><div class="line"><a name="l04414"></a><span class="lineno"><a class="line" href="class_c_net_processing_cleanup.html"> 4414</a></span>&#160;<span class="keyword">class </span><a class="code" href="class_c_net_processing_cleanup.html">CNetProcessingCleanup</a></div><div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;{</div><div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l04417"></a><span class="lineno"><a class="line" href="class_c_net_processing_cleanup.html#a95f2af12fa0b9c384a80511f4b21090c"> 4417</a></span>&#160;    <a class="code" href="class_c_net_processing_cleanup.html#a95f2af12fa0b9c384a80511f4b21090c">CNetProcessingCleanup</a>() {}</div><div class="line"><a name="l04418"></a><span class="lineno"><a class="line" href="class_c_net_processing_cleanup.html#a110dfb98118bb2377fc7662fd05e4269"> 4418</a></span>&#160;    <a class="code" href="class_c_net_processing_cleanup.html#a110dfb98118bb2377fc7662fd05e4269">~CNetProcessingCleanup</a>() {</div><div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;        <span class="comment">// orphan transactions</span></div><div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;        mapOrphanTransactions.clear();</div><div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;        mapOrphanTransactionsByPrev.clear();</div><div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;        <a class="code" href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a> = 0;</div><div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;    }</div><div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160;} <a class="code" href="net__processing_8cpp.html#a450d2be8350b29dcb4f3adc3325f56b2">instance_of_cnetprocessingcleanup</a>;</div><div class="ttc" id="class_c_connman_html_a9b7efcca91a687285efcbad17523e0bf"><div class="ttname"><a href="class_c_connman.html#a9b7efcca91a687285efcbad17523e0bf">CConnman::ForEachNodeThen</a></div><div class="ttdeci">void ForEachNodeThen(const Condition &amp;cond, Callable &amp;&amp;pre, CallableAfter &amp;&amp;post)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00320">net.h:320</a></div></div>
<div class="ttc" id="class_c_block_index_html_a31e65c1f491d438dfdcd8d92bdfa73a1"><div class="ttname"><a href="class_c_block_index.html#a31e65c1f491d438dfdcd8d92bdfa73a1">CBlockIndex::nChainWork</a></div><div class="ttdeci">arith_uint256 nChainWork</div><div class="ttdoc">(memory only) Total amount of work (expected number of hashes) in the chain up to and including this ...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00195">chain.h:195</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_adc45f5fcd38f8191e52b774e09cbbfa3"><div class="ttname"><a href="net__processing_8cpp.html#adc45f5fcd38f8191e52b774e09cbbfa3">GetObjectInterval</a></div><div class="ttdeci">std::chrono::microseconds GetObjectInterval(int invType)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00720">net_processing.cpp:720</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ab0c7ed7d5c1386a05285fa52bf79a560"><div class="ttname"><a href="net__processing_8cpp.html#ab0c7ed7d5c1386a05285fa52bf79a560">RequestObject</a></div><div class="ttdeci">void RequestObject(CNodeState *state, const CInv &amp;inv, std::chrono::microseconds current_time, bool fForce=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00769">net_processing.cpp:769</a></div></div>
<div class="ttc" id="namespace_b_c_log_html_a7f38d795c5b3ac39b8f87a13ddfec541a08053ad8cb32039ead7f837fdc92e6f5"><div class="ttname"><a href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a08053ad8cb32039ead7f837fdc92e6f5">BCLog::NET_NETCONN</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00147">util.h:147</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a7d2c75d05297fcd566c04189def2b3fa"><div class="ttname"><a href="net__processing_8cpp.html#a7d2c75d05297fcd566c04189def2b3fa">GETDATA_TX_INTERVAL</a></div><div class="ttdeci">static constexpr std::chrono::microseconds GETDATA_TX_INTERVAL</div><div class="ttdoc">How long to wait (in microseconds) before downloading a transaction from an additional peer...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00069">net_processing.cpp:69</a></div></div>
<div class="ttc" id="blockencodings_8h_html_a736e4f9aaa454215e8d1177394e170a6"><div class="ttname"><a href="blockencodings_8h.html#a736e4f9aaa454215e8d1177394e170a6">ReadStatus</a></div><div class="ttdeci">enum ReadStatus_t ReadStatus</div></div>
<div class="ttc" id="namespace_net_msg_type_html_ad9a2ba0319f01bf1c26f5206b5156496"><div class="ttname"><a href="namespace_net_msg_type.html#ad9a2ba0319f01bf1c26f5206b5156496">NetMsgType::PING</a></div><div class="ttdeci">const char * PING</div><div class="ttdoc">The ping message is sent periodically to help confirm that the receiving peer is still connected...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00031">protocol.cpp:31</a></div></div>
<div class="ttc" id="validation_8cpp_html_a08c25cc0ab8b9731b46a1bfbe6057fca"><div class="ttname"><a href="validation_8cpp.html#a08c25cc0ab8b9731b46a1bfbe6057fca">GetBlockHash</a></div><div class="ttdeci">bool GetBlockHash(uint256 &amp;hashRet, int nBlockHeight)</div><div class="ttdoc">Return true if hash can be found in chainActive at nBlockHeight height. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l01894">validation.cpp:1894</a></div></div>
<div class="ttc" id="net__processing_8h_html"><div class="ttname"><a href="net__processing_8h.html">net_processing.h</a></div></div>
<div class="ttc" id="privatesend-client_8h_html"><div class="ttname"><a href="privatesend-client_8h.html">privatesend-client.h</a></div></div>
<div class="ttc" id="validation_8h_html_abc71256f703e47c9254093e32ed2994c"><div class="ttname"><a href="validation_8h.html#abc71256f703e47c9254093e32ed2994c">mempool</a></div><div class="ttdeci">CTxMemPool mempool</div></div>
<div class="ttc" id="class_c_node_html_a99f92c681f695eb637e0ffa050559b46"><div class="ttname"><a href="class_c_node.html#a99f92c681f695eb637e0ffa050559b46">CNode::nPingNonceSent</a></div><div class="ttdeci">std::atomic&lt; uint64_t &gt; nPingNonceSent</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00924">net.h:924</a></div></div>
<div class="ttc" id="class_args_manager_html_a797473ebdea9030ae99f9aa8c0744a6f"><div class="ttname"><a href="class_args_manager.html#a797473ebdea9030ae99f9aa8c0744a6f">ArgsManager::IsArgSet</a></div><div class="ttdeci">bool IsArgSet(const std::string &amp;strArg) const</div><div class="ttdoc">Return true if the given argument has been manually set. </div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00784">util.cpp:784</a></div></div>
<div class="ttc" id="group__algorithm_html_ga97883642477d6b1e8a2b8525fc113758"><div class="ttname"><a href="group__algorithm.html#ga97883642477d6b1e8a2b8525fc113758">immer::copy</a></div><div class="ttdeci">OutIter copy(Range &amp;&amp;r, OutIter out)</div><div class="ttdef"><b>Definition:</b> <a href="algorithm_8hpp_source.html#l00168">algorithm.hpp:168</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a0e95085c85cbbb8330fa1a5ffe49070f"><div class="ttname"><a href="namespace_net_msg_type.html#a0e95085c85cbbb8330fa1a5ffe49070f">NetMsgType::FILTERLOAD</a></div><div class="ttdeci">const char * FILTERLOAD</div><div class="ttdoc">The filterload message tells the receiving peer to filter all relayed transactions and requested merk...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00034">protocol.cpp:34</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ae5af2ea09090341213f7021f7741e929"><div class="ttname"><a href="namespace_net_msg_type.html#ae5af2ea09090341213f7021f7741e929">NetMsgType::MERKLEBLOCK</a></div><div class="ttdeci">const char * MERKLEBLOCK</div><div class="ttdoc">The merkleblock message is a reply to a getdata message which requested a block using the inventory t...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00023">protocol.cpp:23</a></div></div>
<div class="ttc" id="class_c_node_html_a73b323f9e310e3054d909934b37ae671"><div class="ttname"><a href="class_c_node.html#a73b323f9e310e3054d909934b37ae671">CNode::fPauseSend</a></div><div class="ttdeci">std::atomic_bool fPauseSend</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00875">net.h:875</a></div></div>
<div class="ttc" id="class_c_masternode_meta_man_html_ab871eeb584c81035414193ab0994479b"><div class="ttname"><a href="class_c_masternode_meta_man.html#ab871eeb584c81035414193ab0994479b">CMasternodeMetaMan::DisallowMixing</a></div><div class="ttdeci">void DisallowMixing(const uint256 &amp;proTxHash)</div><div class="ttdef"><b>Definition:</b> <a href="masternode-meta_8cpp_source.html#l00084">masternode-meta.cpp:84</a></div></div>
<div class="ttc" id="class_c_message_header_html_aa0da43a88e43c6ac575b8b3af98b8107"><div class="ttname"><a href="class_c_message_header.html#aa0da43a88e43c6ac575b8b3af98b8107">CMessageHeader::pchChecksum</a></div><div class="ttdeci">uint8_t pchChecksum[CHECKSUM_SIZE]</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00060">protocol.h:60</a></div></div>
<div class="ttc" id="validation_8h_html_a6cee75436117a7a79d4e0bc5b87bc2a6"><div class="ttname"><a href="validation_8h.html#a6cee75436117a7a79d4e0bc5b87bc2a6">MAX_BLOCKTXN_DEPTH</a></div><div class="ttdeci">static const int MAX_BLOCKTXN_DEPTH</div><div class="ttdoc">Maximum depth of blocks we&amp;#39;re willing to respond to GETBLOCKTXN requests for. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00097">validation.h:97</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a263ae1b219e81c6c3de9b65ee52605a9"><div class="ttname"><a href="net__processing_8cpp.html#a263ae1b219e81c6c3de9b65ee52605a9">most_recent_compact_block</a></div><div class="ttdeci">static std::shared_ptr&lt; const CBlockHeaderAndShortTxIDs &gt; most_recent_compact_block</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01142">net_processing.cpp:1142</a></div></div>
<div class="ttc" id="masternode-sync_8cpp_html_a9807e6586e8a7cb25799ea4150520448"><div class="ttname"><a href="masternode-sync_8cpp.html#a9807e6586e8a7cb25799ea4150520448">masternodeSync</a></div><div class="ttdeci">CMasternodeSync masternodeSync</div><div class="ttdef"><b>Definition:</b> <a href="masternode-sync_8cpp_source.html#l00016">masternode-sync.cpp:16</a></div></div>
<div class="ttc" id="namespacellmq_html_a90e3abe3a8683f999d6165b9b68913c3"><div class="ttname"><a href="namespacellmq.html#a90e3abe3a8683f999d6165b9b68913c3">llmq::quorumSigSharesManager</a></div><div class="ttdeci">CSigSharesManager * quorumSigSharesManager</div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing__shares_8cpp_source.html#l00022">quorums_signing_shares.cpp:22</a></div></div>
<div class="ttc" id="class_c_node_html_a253ceac237f69cc1155bfb71acd0c48f"><div class="ttname"><a href="class_c_node.html#a253ceac237f69cc1155bfb71acd0c48f">CNode::GetSendVersion</a></div><div class="ttdeci">int GetSendVersion() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00887">net.cpp:887</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ac23245c939bfe57d37c0a2db68e05e05"><div class="ttname"><a href="namespace_net_msg_type.html#ac23245c939bfe57d37c0a2db68e05e05">NetMsgType::BLOCKTXN</a></div><div class="ttdeci">const char * BLOCKTXN</div><div class="ttdoc">Contains a BlockTransactions. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00042">protocol.cpp:42</a></div></div>
<div class="ttc" id="validation_8cpp_html_ab3d3252ad7773f86035217d3a08f16ba"><div class="ttname"><a href="validation_8cpp.html#ab3d3252ad7773f86035217d3a08f16ba">fPruneMode</a></div><div class="ttdeci">bool fPruneMode</div><div class="ttdoc">True if we&amp;#39;re running in -prune mode. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00230">validation.cpp:230</a></div></div>
<div class="ttc" id="privatesend-server_8cpp_html_a1b2b9915fc9328ffcd70517e5c6d649a"><div class="ttname"><a href="privatesend-server_8cpp.html#a1b2b9915fc9328ffcd70517e5c6d649a">privateSendServer</a></div><div class="ttdeci">CPrivateSendServer privateSendServer</div><div class="ttdef"><b>Definition:</b> <a href="privatesend-server_8cpp_source.html#l00025">privatesend-server.cpp:25</a></div></div>
<div class="ttc" id="random_8cpp_html_af3aedae75efabb170337a497457f7ecf"><div class="ttname"><a href="random_8cpp.html#af3aedae75efabb170337a497457f7ecf">GetRandHash</a></div><div class="ttdeci">uint256 GetRandHash()</div><div class="ttdef"><b>Definition:</b> <a href="random_8cpp_source.html#l00384">random.cpp:384</a></div></div>
<div class="ttc" id="namespace_b_c_log_html_a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c"><div class="ttname"><a href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541af6e0b9c6b7721c3da5e0aca00bf73c4c">BCLog::NET</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00110">util.h:110</a></div></div>
<div class="ttc" id="classllmq_1_1_c_final_commitment_html"><div class="ttname"><a href="classllmq_1_1_c_final_commitment.html">llmq::CFinalCommitment</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__commitment_8h_source.html#l00024">quorums_commitment.h:24</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a2cb5fe00e73ee666aa3daef76b299251"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a2cb5fe00e73ee666aa3daef76b299251">MSG_GOVERNANCE_OBJECT_VOTE</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00411">protocol.h:411</a></div></div>
<div class="ttc" id="class_c_net_processing_cleanup_html_a95f2af12fa0b9c384a80511f4b21090c"><div class="ttname"><a href="class_c_net_processing_cleanup.html#a95f2af12fa0b9c384a80511f4b21090c">CNetProcessingCleanup::CNetProcessingCleanup</a></div><div class="ttdeci">CNetProcessingCleanup()</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l04417">net_processing.cpp:4417</a></div></div>
<div class="ttc" id="class_partially_downloaded_block_html_ae31ee4302e77d9757aae8b96df99486a"><div class="ttname"><a href="class_partially_downloaded_block.html#ae31ee4302e77d9757aae8b96df99486a">PartiallyDownloadedBlock::FillBlock</a></div><div class="ttdeci">ReadStatus FillBlock(CBlock &amp;block, const std::vector&lt; CTransactionRef &gt; &amp;vtx_missing)</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8cpp_source.html#l00178">blockencodings.cpp:178</a></div></div>
<div class="ttc" id="protocol_8h_html_ad131f3177584caea787cdbf6f85a9537"><div class="ttname"><a href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537">ServiceFlags</a></div><div class="ttdeci">ServiceFlags</div><div class="ttdoc">nServices flags </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00280">protocol.h:280</a></div></div>
<div class="ttc" id="class_c_service_html_ae274e8b6fc38955d74044d326a405024"><div class="ttname"><a href="class_c_service.html#ae274e8b6fc38955d74044d326a405024">CService::ToString</a></div><div class="ttdeci">std::string ToString(bool fUseGetnameinfo=true) const</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00581">netaddress.cpp:581</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a205fd50253ff168914d8feb2b18d24fa"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a205fd50253ff168914d8feb2b18d24fa">MSG_QUORUM_COMPLAINT</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00419">protocol.h:419</a></div></div>
<div class="ttc" id="class_c_net_addr_html_a857bfcf95814b7d6ef4db309c84f179d"><div class="ttname"><a href="class_c_net_addr.html#a857bfcf95814b7d6ef4db309c84f179d">CNetAddr::IsLocal</a></div><div class="ttdeci">bool IsLocal() const</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00177">netaddress.cpp:177</a></div></div>
<div class="ttc" id="class_c_simplified_m_n_list_diff_html"><div class="ttname"><a href="class_c_simplified_m_n_list_diff.html">CSimplifiedMNListDiff</a></div><div class="ttdef"><b>Definition:</b> <a href="simplifiedmns_8h_source.html#l00106">simplifiedmns.h:106</a></div></div>
<div class="ttc" id="class_c_node_html_a66aeed3b6534635d031dff3eee9538de"><div class="ttname"><a href="class_c_node.html#a66aeed3b6534635d031dff3eee9538de">CNode::cs_filter</a></div><div class="ttdeci">CCriticalSection cs_filter</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00868">net.h:868</a></div></div>
<div class="ttc" id="simplifiedmns_8cpp_html_a1478cfcf5bfe0b6bf12e2c7bb628dc40"><div class="ttname"><a href="simplifiedmns_8cpp.html#a1478cfcf5bfe0b6bf12e2c7bb628dc40">BuildSimplifiedMNListDiff</a></div><div class="ttdeci">bool BuildSimplifiedMNListDiff(const uint256 &amp;baseBlockHash, const uint256 &amp;blockHash, CSimplifiedMNListDiff &amp;mnListDiffRet, std::string &amp;errorRet)</div><div class="ttdef"><b>Definition:</b> <a href="simplifiedmns_8cpp_source.html#l00188">simplifiedmns.cpp:188</a></div></div>
<div class="ttc" id="init_8h_html"><div class="ttname"><a href="init_8h.html">init.h</a></div></div>
<div class="ttc" id="classbase__blob_html_aa340be5328d911272eded433d03f30a3"><div class="ttname"><a href="classbase__blob.html#aa340be5328d911272eded433d03f30a3">base_blob::SetNull</a></div><div class="ttdeci">void SetNull()</div><div class="ttdef"><b>Definition:</b> <a href="uint256_8h_source.html#l00041">uint256.h:41</a></div></div>
<div class="ttc" id="class_c_block_index_html_a9fe0d4463c07c466f66252e8eec25f5c"><div class="ttname"><a href="class_c_block_index.html#a9fe0d4463c07c466f66252e8eec25f5c">CBlockIndex::GetBlockTime</a></div><div class="ttdeci">int64_t GetBlockTime() const</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00297">chain.h:297</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_aa9781fcb90dd8cec39b429fdc489e198"><div class="ttname"><a href="class_peer_logic_validation.html#aa9781fcb90dd8cec39b429fdc489e198">PeerLogicValidation::connman</a></div><div class="ttdeci">CConnman *const connman</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00047">net_processing.h:47</a></div></div>
<div class="ttc" id="class_block_transactions_html"><div class="ttname"><a href="class_block_transactions.html">BlockTransactions</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00071">blockencodings.h:71</a></div></div>
<div class="ttc" id="struct_c_block_locator_html"><div class="ttname"><a href="struct_c_block_locator.html">CBlockLocator</a></div><div class="ttdoc">Describes a place in the block chain to another node such that if the other node doesn&amp;#39;t have the sam...</div><div class="ttdef"><b>Definition:</b> <a href="block_8h_source.html#l00127">block.h:127</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ab94135eefe3a6ea8bb6b918d69afb027"><div class="ttname"><a href="net__processing_8cpp.html#ab94135eefe3a6ea8bb6b918d69afb027">HISTORICAL_BLOCK_AGE</a></div><div class="ttdeci">static const int HISTORICAL_BLOCK_AGE</div><div class="ttdoc">Age after which a block is considered historical for purposes of rate limiting block relay...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00115">net_processing.cpp:115</a></div></div>
<div class="ttc" id="class_c_block_index_html_a1ef11137155df1dd5c81491630cece39"><div class="ttname"><a href="class_c_block_index.html#a1ef11137155df1dd5c81491630cece39">CBlockIndex::pprev</a></div><div class="ttdeci">CBlockIndex * pprev</div><div class="ttdoc">pointer to the index of the predecessor of this block </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00177">chain.h:177</a></div></div>
<div class="ttc" id="class_compare_inv_mempool_order_html_a1cd3da690b8741dcc21d415f5d8d006f"><div class="ttname"><a href="class_compare_inv_mempool_order.html#a1cd3da690b8741dcc21d415f5d8d006f">CompareInvMempoolOrder::operator()</a></div><div class="ttdeci">bool operator()(std::set&lt; uint256 &gt;::iterator a, std::set&lt; uint256 &gt;::iterator b)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03808">net_processing.cpp:3808</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a53f08d964e4fdf9c70e89bb9719d7d64"><div class="ttname"><a href="class_c_tx_mem_pool.html#a53f08d964e4fdf9c70e89bb9719d7d64">CTxMemPool::infoAll</a></div><div class="ttdeci">std::vector&lt; TxMempoolInfo &gt; infoAll() const</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01197">txmempool.cpp:1197</a></div></div>
<div class="ttc" id="class_c_sip_hasher_html_ad922bf75073152ed1a02789a63f38559"><div class="ttname"><a href="class_c_sip_hasher.html#ad922bf75073152ed1a02789a63f38559">CSipHasher::Write</a></div><div class="ttdeci">CSipHasher &amp; Write(uint64_t data)</div><div class="ttdoc">Hash a 64-bit integer worth of data It is treated as if this was the little-endian interpretation of ...</div><div class="ttdef"><b>Definition:</b> <a href="hash_8cpp_source.html#l00102">hash.cpp:102</a></div></div>
<div class="ttc" id="sync_8h_html_aca08e7299069c2d60b8aa726fc550612"><div class="ttname"><a href="sync_8h.html#aca08e7299069c2d60b8aa726fc550612">TRY_LOCK</a></div><div class="ttdeci">#define TRY_LOCK(cs, name)</div><div class="ttdef"><b>Definition:</b> <a href="sync_8h_source.html#l00180">sync.h:180</a></div></div>
<div class="ttc" id="class_c_block_index_html_aef7d4c3c9a4538e62821988bf6193ad8"><div class="ttname"><a href="class_c_block_index.html#aef7d4c3c9a4538e62821988bf6193ad8">CBlockIndex::nStatus</a></div><div class="ttdeci">uint32_t nStatus</div><div class="ttdoc">Verification status of this block. See enum BlockStatus. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00207">chain.h:207</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aaf5ed9b7e5e4fbf9830be4d0a8fde2ba"><div class="ttname"><a href="net__processing_8cpp.html#aaf5ed9b7e5e4fbf9830be4d0a8fde2ba">most_recent_block</a></div><div class="ttdeci">static std::shared_ptr&lt; const CBlock &gt; most_recent_block</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01141">net_processing.cpp:1141</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a76f6fb5033f1e1a7930642475a961ac5"><div class="ttname"><a href="namespace_net_msg_type.html#a76f6fb5033f1e1a7930642475a961ac5">NetMsgType::QPCOMMITMENT</a></div><div class="ttdeci">const char * QPCOMMITMENT</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00067">protocol.cpp:67</a></div></div>
<div class="ttc" id="class_c_connman_html_a47a0fe62e6fb1008c77f3b2150214213"><div class="ttname"><a href="class_c_connman.html#a47a0fe62e6fb1008c77f3b2150214213">CConnman::GetAddressCount</a></div><div class="ttdeci">size_t GetAddressCount() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03257">net.cpp:3257</a></div></div>
<div class="ttc" id="class_c_net_addr_html_a1c6087345e5ca07a151451cd6deb974f"><div class="ttname"><a href="class_c_net_addr.html#a1c6087345e5ca07a151451cd6deb974f">CNetAddr::SetIP</a></div><div class="ttdeci">void SetIP(const CNetAddr &amp;ip)</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00026">netaddress.cpp:26</a></div></div>
<div class="ttc" id="struct_c_node_state_stats_html_a62c2243d09166c1daaad84519700da3c"><div class="ttname"><a href="struct_c_node_state_stats.html#a62c2243d09166c1daaad84519700da3c">CNodeStateStats::nMisbehavior</a></div><div class="ttdeci">int nMisbehavior</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00080">net_processing.h:80</a></div></div>
<div class="ttc" id="class_c_connman_html_a999ec42f1515f77096556c94c29c6538"><div class="ttname"><a href="class_c_connman.html#a999ec42f1515f77096556c94c29c6538">CConnman::WakeMessageHandler</a></div><div class="ttdeci">void WakeMessageHandler()</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l01928">net.cpp:1928</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991aef9a99c0ec45622a52b26a434bf9af1b"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aef9a99c0ec45622a52b26a434bf9af1b">MSG_LEGACY_TXLOCK_REQUEST</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00405">protocol.h:405</a></div></div>
<div class="ttc" id="net__processing_8h_html_ae40c02b91a2a019adcb76e5ead8785a0"><div class="ttname"><a href="net__processing_8h.html#ae40c02b91a2a019adcb76e5ead8785a0">DEFAULT_ENABLE_BIP61</a></div><div class="ttdeci">static constexpr bool DEFAULT_ENABLE_BIP61</div><div class="ttdoc">Default for BIP61 (sending reject messages) </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00041">net_processing.h:41</a></div></div>
<div class="ttc" id="class_c_connman_html_a46915b82dd2183baf2944d74d88a4228"><div class="ttname"><a href="class_c_connman.html#a46915b82dd2183baf2944d74d88a4228">CConnman::SetServices</a></div><div class="ttdeci">void SetServices(const CService &amp;addr, ServiceFlags nServices)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03262">net.cpp:3262</a></div></div>
<div class="ttc" id="class_c_inv_html_a5bf13e9595035d2155b04cceb848c37d"><div class="ttname"><a href="class_c_inv.html#a5bf13e9595035d2155b04cceb848c37d">CInv::ToString</a></div><div class="ttdeci">std::string ToString() const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00283">protocol.cpp:283</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a158783474cd905bc1cc706330bdf1db1"><div class="ttname"><a href="net__processing_8cpp.html#a158783474cd905bc1cc706330bdf1db1">GetObjectRandomDelay</a></div><div class="ttdeci">std::chrono::microseconds GetObjectRandomDelay(int invType)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00741">net_processing.cpp:741</a></div></div>
<div class="ttc" id="class_c_block_html"><div class="ttname"><a href="class_c_block.html">CBlock</a></div><div class="ttdef"><b>Definition:</b> <a href="block_8h_source.html#l00072">block.h:72</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a0407dddb23706af2320d25a1fb26d4f5"><div class="ttname"><a href="namespace_net_msg_type.html#a0407dddb23706af2320d25a1fb26d4f5">NetMsgType::QFCOMMITMENT</a></div><div class="ttdeci">const char * QFCOMMITMENT</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00063">protocol.cpp:63</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_aea859ef7335f27b92e6cb37b30b84b53"><div class="ttname"><a href="class_c_governance_manager.html#aea859ef7335f27b92e6cb37b30b84b53">CGovernanceManager::HaveVoteForHash</a></div><div class="ttdeci">bool HaveVoteForHash(const uint256 &amp;nHash) const</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00066">governance.cpp:66</a></div></div>
<div class="ttc" id="serialize_8h_html_ae3fd928949b7361accfec79c314aa90f"><div class="ttname"><a href="serialize_8h.html#ae3fd928949b7361accfec79c314aa90f">ReadCompactSize</a></div><div class="ttdeci">uint64_t ReadCompactSize(Stream &amp;is)</div><div class="ttdef"><b>Definition:</b> <a href="serialize_8h_source.html#l00261">serialize.h:261</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a4d0f984b71f9e4c4b8b3619cb3f3dadd"><div class="ttname"><a href="namespace_net_msg_type.html#a4d0f984b71f9e4c4b8b3619cb3f3dadd">NetMsgType::GETADDR</a></div><div class="ttdeci">const char * GETADDR</div><div class="ttdoc">The getaddr message requests an addr message from the receiving node, preferably one with lots of IP ...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00029">protocol.cpp:29</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a91f72d94f777c7af376dbaddd98aaf3f"><div class="ttname"><a href="class_peer_logic_validation.html#a91f72d94f777c7af376dbaddd98aaf3f">PeerLogicValidation::UpdatedBlockTip</a></div><div class="ttdeci">void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) override</div><div class="ttdoc">Notifies listeners of updated block chain tip. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01184">net_processing.cpp:1184</a></div></div>
<div class="ttc" id="struct_c_orphan_tx_html_a09fd824b19c2e8433b44145b7b64f010"><div class="ttname"><a href="struct_c_orphan_tx.html#a09fd824b19c2e8433b44145b7b64f010">COrphanTx::nTimeExpire</a></div><div class="ttdeci">int64_t nTimeExpire</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00095">net_processing.cpp:95</a></div></div>
<div class="ttc" id="classllmq_1_1_c_signing_manager_html_a0aff9671b0801a7db9e9022351a0ef75"><div class="ttname"><a href="classllmq_1_1_c_signing_manager.html#a0aff9671b0801a7db9e9022351a0ef75">llmq::CSigningManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pnode, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing_8cpp_source.html#l00474">quorums_signing.cpp:474</a></div></div>
<div class="ttc" id="consensus_8h_html_aa372df0d6494f4aaca5ecf5a5a9d4406"><div class="ttname"><a href="consensus_8h.html#aa372df0d6494f4aaca5ecf5a5a9d4406">MaxBlockSize</a></div><div class="ttdeci">unsigned int MaxBlockSize(bool fDIP0001Active)</div><div class="ttdef"><b>Definition:</b> <a href="consensus_8h_source.html#l00012">consensus.h:12</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a78b9ead22ca5cae07b98370ffab06abc">MSG_CMPCT_BLOCK</a></div><div class="ttdoc">Defined in BIP152. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00415">protocol.h:415</a></div></div>
<div class="ttc" id="class_block_transactions_request_html_a731bbcec34e4ebd932f2d4cc840abab5"><div class="ttname"><a href="class_block_transactions_request.html#a731bbcec34e4ebd932f2d4cc840abab5">BlockTransactionsRequest::indexes</a></div><div class="ttdeci">std::vector&lt; uint16_t &gt; indexes</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00033">blockencodings.h:33</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_premature_commitment_html"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_premature_commitment.html">llmq::CDKGPrematureCommitment</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsession_8h_source.html#l00157">quorums_dkgsession.h:157</a></div></div>
<div class="ttc" id="class_c_node_html_a482bcdf4b371750edd33dd8ed5f5a0bf"><div class="ttname"><a href="class_c_node.html#a482bcdf4b371750edd33dd8ed5f5a0bf">CNode::GetRecvVersion</a></div><div class="ttdeci">int GetRecvVersion() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00997">net.h:997</a></div></div>
<div class="ttc" id="tinyformat_8h_html_a56c674871a61baaad36ad52238c08857"><div class="ttname"><a href="tinyformat_8h.html#a56c674871a61baaad36ad52238c08857">strprintf</a></div><div class="ttdeci">#define strprintf</div><div class="ttdef"><b>Definition:</b> <a href="tinyformat_8h_source.html#l01066">tinyformat.h:1066</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_ad9ba8b8657346c1ce86e061d5fdaeb53"><div class="ttname"><a href="class_peer_logic_validation.html#ad9ba8b8657346c1ce86e061d5fdaeb53">PeerLogicValidation::CheckForStaleTipAndEvictPeers</a></div><div class="ttdeci">void CheckForStaleTipAndEvictPeers(const Consensus::Params &amp;consensusParams)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03777">net_processing.cpp:3777</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a5a4ed6e4ae53db779fa322f356f9babf"><div class="ttname"><a href="net__processing_8cpp.html#a5a4ed6e4ae53db779fa322f356f9babf">AlreadyHave</a></div><div class="ttdeci">static bool AlreadyHave(const CInv &amp;inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01256">net_processing.cpp:1256</a></div></div>
<div class="ttc" id="class_c_rolling_bloom_filter_html_a0fedbf0cf38c9070a30c7c5f8299f5d7"><div class="ttname"><a href="class_c_rolling_bloom_filter.html#a0fedbf0cf38c9070a30c7c5f8299f5d7">CRollingBloomFilter::insert</a></div><div class="ttdeci">void insert(const std::vector&lt; unsigned char &gt; &amp;vKey)</div><div class="ttdef"><b>Definition:</b> <a href="bloom_8cpp_source.html#l00341">bloom.cpp:341</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_af0793c7c14e94d2d642f4ac89067a429"><div class="ttname"><a href="net__processing_8cpp.html#af0793c7c14e94d2d642f4ac89067a429">GetNodeStateStats</a></div><div class="ttdeci">bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &amp;stats)</div><div class="ttdoc">Get statistics from node state. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00880">net_processing.cpp:880</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a4fcf05ad5f15a565c4b43c4b9f29906e"><div class="ttname"><a href="class_c_tx_mem_pool.html#a4fcf05ad5f15a565c4b43c4b9f29906e">CTxMemPool::DynamicMemoryUsage</a></div><div class="ttdeci">size_t DynamicMemoryUsage() const</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01389">txmempool.cpp:1389</a></div></div>
<div class="ttc" id="quorums__commitment_8h_html"><div class="ttname"><a href="quorums__commitment_8h.html">quorums_commitment.h</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a0494732fc92c975f58783e224585c473">MSG_TX</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00399">protocol.h:399</a></div></div>
<div class="ttc" id="reverse__iterator_8h_html_a5c42501cbdd92bec9f5a7886c4e9cfd5"><div class="ttname"><a href="reverse__iterator_8h.html#a5c42501cbdd92bec9f5a7886c4e9cfd5">reverse_iterate</a></div><div class="ttdeci">reverse_range&lt; T &gt; reverse_iterate(T &amp;x)</div><div class="ttdef"><b>Definition:</b> <a href="reverse__iterator_8h_source.html#l00034">reverse_iterator.h:34</a></div></div>
<div class="ttc" id="namespacellmq_html_a79bd0846747165f96233e9b9063d42e7"><div class="ttname"><a href="namespacellmq.html#a79bd0846747165f96233e9b9063d42e7">llmq::quorumDKGSessionManager</a></div><div class="ttdeci">CDKGSessionManager * quorumDKGSessionManager</div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsessionmgr_8cpp_source.html#l00019">quorums_dkgsessionmgr.cpp:19</a></div></div>
<div class="ttc" id="class_c_inv_html"><div class="ttname"><a href="class_c_inv.html">CInv</a></div><div class="ttdoc">inv message data </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00429">protocol.h:429</a></div></div>
<div class="ttc" id="validation_8h_html_a8483db75666c2a1d231108b125b0b3bf"><div class="ttname"><a href="validation_8h.html#a8483db75666c2a1d231108b125b0b3bf">BLOCK_DOWNLOAD_TIMEOUT_BASE</a></div><div class="ttdeci">static const int64_t BLOCK_DOWNLOAD_TIMEOUT_BASE</div><div class="ttdoc">Block download timeout base, expressed in millionths of the block interval (i.e. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00110">validation.h:110</a></div></div>
<div class="ttc" id="struct_c_node_state_stats_html"><div class="ttname"><a href="struct_c_node_state_stats.html">CNodeStateStats</a></div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00079">net_processing.h:79</a></div></div>
<div class="ttc" id="namespacellmq_html_a32533f25ea72d1153af50d680a75434d"><div class="ttname"><a href="namespacellmq.html#a32533f25ea72d1153af50d680a75434d">llmq::quorumBlockProcessor</a></div><div class="ttdeci">CQuorumBlockProcessor * quorumBlockProcessor</div><div class="ttdef"><b>Definition:</b> <a href="quorums__blockprocessor_8cpp_source.html#l00023">quorums_blockprocessor.cpp:23</a></div></div>
<div class="ttc" id="governance_8h_html"><div class="ttname"><a href="governance_8h.html">governance.h</a></div></div>
<div class="ttc" id="quorums__signing__shares_8h_html"><div class="ttname"><a href="quorums__signing__shares_8h.html">quorums_signing_shares.h</a></div></div>
<div class="ttc" id="validation_8cpp_html_aeccc8c1b7fffcca5d6c0d8486cc9b48b"><div class="ttname"><a href="validation_8cpp.html#aeccc8c1b7fffcca5d6c0d8486cc9b48b">mapBlockIndex</a></div><div class="ttdeci">BlockMap &amp; mapBlockIndex</div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00215">validation.cpp:215</a></div></div>
<div class="ttc" id="net__processing_8h_html_a8a4d3867ceb626ccda62b3b728425d07"><div class="ttname"><a href="net__processing_8h.html#a8a4d3867ceb626ccda62b3b728425d07">HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</a></div><div class="ttdeci">static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00025">net_processing.h:25</a></div></div>
<div class="ttc" id="serialize_8h_html_aeb209536f7b746673a9c3fba8651b0e5"><div class="ttname"><a href="serialize_8h.html#aeb209536f7b746673a9c3fba8651b0e5">GetSerializeSize</a></div><div class="ttdeci">size_t GetSerializeSize(const T &amp;t, int nType, int nVersion=0)</div><div class="ttdef"><b>Definition:</b> <a href="serialize_8h_source.html#l01295">serialize.h:1295</a></div></div>
<div class="ttc" id="classllmq_1_1_c_instant_send_manager_html_a77f081544d3b172a0f5c89a7ffb9e806"><div class="ttname"><a href="classllmq_1_1_c_instant_send_manager.html#a77f081544d3b172a0f5c89a7ffb9e806">llmq::CInstantSendManager::AlreadyHave</a></div><div class="ttdeci">bool AlreadyHave(const CInv &amp;inv)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__instantsend_8cpp_source.html#l01428">quorums_instantsend.cpp:1428</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a4cdafba4d585b4699628412c7f1c3d8b"><div class="ttname"><a href="namespace_net_msg_type.html#a4cdafba4d585b4699628412c7f1c3d8b">NetMsgType::SENDCMPCT</a></div><div class="ttdeci">const char * SENDCMPCT</div><div class="ttdoc">Contains a 1-byte bool and 8-byte LE version number. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00039">protocol.cpp:39</a></div></div>
<div class="ttc" id="amount_8h_html_aed6bcb17bc73a5dcf33250e9c2c023cc"><div class="ttname"><a href="amount_8h.html#aed6bcb17bc73a5dcf33250e9c2c023cc">COIN</a></div><div class="ttdeci">static const CAmount COIN</div><div class="ttdef"><b>Definition:</b> <a href="amount_8h_source.html#l00014">amount.h:14</a></div></div>
<div class="ttc" id="struct_c_orphan_tx_html"><div class="ttname"><a href="struct_c_orphan_tx.html">COrphanTx</a></div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00091">net_processing.cpp:91</a></div></div>
<div class="ttc" id="validation_8h_html_a5caf4122a735df55a443242fa5ccb5cf"><div class="ttname"><a href="validation_8h.html#a5caf4122a735df55a443242fa5ccb5cf">MIN_BLOCKS_TO_KEEP</a></div><div class="ttdeci">static const unsigned int MIN_BLOCKS_TO_KEEP</div><div class="ttdoc">Block files containing a block-height within MIN_BLOCKS_TO_KEEP of chainActive.Tip() will not be prun...</div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00207">validation.h:207</a></div></div>
<div class="ttc" id="chain_8cpp_html_a821669bb03bef97dac98734b839c3006"><div class="ttname"><a href="chain_8cpp.html#a821669bb03bef97dac98734b839c3006">LastCommonAncestor</a></div><div class="ttdeci">const CBlockIndex * LastCommonAncestor(const CBlockIndex *pa, const CBlockIndex *pb)</div><div class="ttdoc">Find the last common ancestor two blocks have. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8cpp_source.html#l00155">chain.cpp:155</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_acf4bb9f52c40164659f484d45d09ecc4"><div class="ttname"><a href="class_c_tx_mem_pool.html#acf4bb9f52c40164659f484d45d09ecc4">CTxMemPool::info</a></div><div class="ttdeci">TxMempoolInfo info(const uint256 &amp;hash) const</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01220">txmempool.cpp:1220</a></div></div>
<div class="ttc" id="chain_8h_html_a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573"><div class="ttname"><a href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada67f3a88eeb793cc62f427f87ae830573">BLOCK_VALID_TREE</a></div><div class="ttdoc">All parent headers found, difficulty matches, timestamp &gt;= median previous, checkpoint. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00134">chain.h:134</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ac9ffabd4f0b59fcf738fdd9b546fb6e7"><div class="ttname"><a href="net__processing_8cpp.html#ac9ffabd4f0b59fcf738fdd9b546fb6e7">ProcessHeadersMessage</a></div><div class="ttdeci">static bool ProcessHeadersMessage(CNode *pfrom, CConnman *connman, const std::vector&lt; CBlockHeader &gt; &amp;headers, const CChainParams &amp;chainparams, bool punish_duplicate_invalid)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01724">net_processing.cpp:1724</a></div></div>
<div class="ttc" id="validation_8h_html_af83a9cbb7b3fe9d34a7c4b43f2e040f8"><div class="ttname"><a href="validation_8h.html#af83a9cbb7b3fe9d34a7c4b43f2e040f8">MAX_REJECT_MESSAGE_LENGTH</a></div><div class="ttdeci">static const unsigned int MAX_REJECT_MESSAGE_LENGTH</div><div class="ttdoc">Maximum length of reject messages. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00108">validation.h:108</a></div></div>
<div class="ttc" id="class_c_chain_html_ad4758bc8872ce065a9579f77c3171d40"><div class="ttname"><a href="class_c_chain.html#ad4758bc8872ce065a9579f77c3171d40">CChain::Height</a></div><div class="ttdeci">int Height() const</div><div class="ttdoc">Return the maximal height in the chain. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00484">chain.h:484</a></div></div>
<div class="ttc" id="validation_8cpp_html_a1ed8285f0fe3c6799c53265ce72552c8"><div class="ttname"><a href="validation_8cpp.html#a1ed8285f0fe3c6799c53265ce72552c8">cs_main</a></div><div class="ttdeci">CCriticalSection cs_main</div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00213">validation.cpp:213</a></div></div>
<div class="ttc" id="class_c_validation_state_html_a7dc31c88ba63ad17a954f247d21b550c"><div class="ttname"><a href="class_c_validation_state.html#a7dc31c88ba63ad17a954f247d21b550c">CValidationState::IsValid</a></div><div class="ttdeci">bool IsValid() const</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00061">validation.h:61</a></div></div>
<div class="ttc" id="class_c_bloom_filter_html"><div class="ttname"><a href="class_c_bloom_filter.html">CBloomFilter</a></div><div class="ttdoc">BloomFilter is a probabilistic filter which SPV clients provide so that we can filter the transaction...</div><div class="ttdef"><b>Definition:</b> <a href="bloom_8h_source.html#l00046">bloom.h:46</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_ac89bf1ee08fd8960559d19ab87564b0d"><div class="ttname"><a href="class_peer_logic_validation.html#ac89bf1ee08fd8960559d19ab87564b0d">PeerLogicValidation::EvictExtraOutboundPeers</a></div><div class="ttdeci">void EvictExtraOutboundPeers(int64_t time_in_seconds)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03720">net_processing.cpp:3720</a></div></div>
<div class="ttc" id="class_c_node_html_ac6dfcb66887b3d26d58e25e7d3397016"><div class="ttname"><a href="class_c_node.html#ac6dfcb66887b3d26d58e25e7d3397016">CNode::fSendMempool</a></div><div class="ttdeci">bool fSendMempool</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00914">net.h:914</a></div></div>
<div class="ttc" id="utilstrencodings_8h_html_ace13a819ca4e98c22847d26b3b357e75"><div class="ttname"><a href="utilstrencodings_8h.html#ace13a819ca4e98c22847d26b3b357e75">HexStr</a></div><div class="ttdeci">std::string HexStr(const T itbegin, const T itend, bool fSpaces=false)</div><div class="ttdef"><b>Definition:</b> <a href="utilstrencodings_8h_source.html#l00100">utilstrencodings.h:100</a></div></div>
<div class="ttc" id="protocol_8h_html_ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c"><div class="ttname"><a href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9d1154f0e7e56f183a5c8373abe2e86c">NODE_NETWORK</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00285">protocol.h:285</a></div></div>
<div class="ttc" id="class_c_node_html_acf48a43182292a6636c9de3ea7453d72"><div class="ttname"><a href="class_c_node.html#acf48a43182292a6636c9de3ea7453d72">CNode::cs_SubVer</a></div><div class="ttdeci">CCriticalSection cs_SubVer</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00844">net.h:844</a></div></div>
<div class="ttc" id="class_c_connman_html_a11dd47af36136db41a012f06d1976273"><div class="ttname"><a href="class_c_connman.html#a11dd47af36136db41a012f06d1976273">CConnman::GetTryNewOutboundPeer</a></div><div class="ttdeci">bool GetTryNewOutboundPeer()</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l02186">net.cpp:2186</a></div></div>
<div class="ttc" id="struct_c_orphan_tx_html_abe878e681f993451d5433d3e12261cb4"><div class="ttname"><a href="struct_c_orphan_tx.html#abe878e681f993451d5433d3e12261cb4">COrphanTx::tx</a></div><div class="ttdeci">CTransactionRef tx</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00093">net_processing.cpp:93</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ae091b569e78315bb17c4b0c178aeb3b0"><div class="ttname"><a href="net__processing_8cpp.html#ae091b569e78315bb17c4b0c178aeb3b0">RANDOMIZER_ID_ADDRESS_RELAY</a></div><div class="ttdeci">static const uint64_t RANDOMIZER_ID_ADDRESS_RELAY</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00107">net_processing.cpp:107</a></div></div>
<div class="ttc" id="timedata_8cpp_html_af9b8f3d7f6fc349e8c8fffb2733896c5"><div class="ttname"><a href="timedata_8cpp.html#af9b8f3d7f6fc349e8c8fffb2733896c5">nTimeOffset</a></div><div class="ttdeci">static int64_t nTimeOffset</div><div class="ttdef"><b>Definition:</b> <a href="timedata_8cpp_source.html#l00020">timedata.cpp:20</a></div></div>
<div class="ttc" id="class_c_node_html_a28c9c18f0d9c7488288b87610f0adb91"><div class="ttname"><a href="class_c_node.html#a28c9c18f0d9c7488288b87610f0adb91">CNode::cs_mnauth</a></div><div class="ttdeci">CCriticalSection cs_mnauth</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00938">net.h:938</a></div></div>
<div class="ttc" id="chain_8h_html_a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c"><div class="ttname"><a href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada3eef30f876594ac79b888b7d1ff6c66c">BLOCK_VALID_TRANSACTIONS</a></div><div class="ttdoc">Only first tx is coinbase, 2 &lt;= coinbase input script length &lt;= 100, transactions valid...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00141">chain.h:141</a></div></div>
<div class="ttc" id="version_8h_html_aa3feca3b6094096fa1b660159bdcb04a"><div class="ttname"><a href="version_8h.html#aa3feca3b6094096fa1b660159bdcb04a">BIP0031_VERSION</a></div><div class="ttdeci">static const int BIP0031_VERSION</div><div class="ttdoc">BIP 0031, pong message, is enabled for all versions AFTER this one. </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00033">version.h:33</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a786a2e6872a53c3559d0ccb4c1422516"><div class="ttname"><a href="net__processing_8cpp.html#a786a2e6872a53c3559d0ccb4c1422516">UpdateObjectRequestTime</a></div><div class="ttdeci">void UpdateObjectRequestTime(const uint256 &amp;hash, std::chrono::microseconds request_time) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00709">net_processing.cpp:709</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a6a39bd726ff3531e6a0d99d7802062e3"><div class="ttname"><a href="net__processing_8cpp.html#a6a39bd726ff3531e6a0d99d7802062e3">IsOutboundDisconnectionCandidate</a></div><div class="ttdeci">bool IsOutboundDisconnectionCandidate(const CNode *node)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00828">net_processing.cpp:828</a></div></div>
<div class="ttc" id="class_c_connman_html_adc69330bc472e50487030c031d5063db"><div class="ttname"><a href="class_c_connman.html#adc69330bc472e50487030c031d5063db">CConnman::PushMessage</a></div><div class="ttdeci">void PushMessage(CNode *pnode, CSerializedNetMsg &amp;&amp;msg)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03733">net.cpp:3733</a></div></div>
<div class="ttc" id="chainparams_8h_html"><div class="ttname"><a href="chainparams_8h.html">chainparams.h</a></div></div>
<div class="ttc" id="validation_8cpp_html_a0bf92b1be4135700eeff6a48f01e3896"><div class="ttname"><a href="validation_8cpp.html#a0bf92b1be4135700eeff6a48f01e3896">nMinimumChainWork</a></div><div class="ttdeci">arith_uint256 nMinimumChainWork</div><div class="ttdoc">Minimum work we will assume exists on some valid chain. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00244">validation.cpp:244</a></div></div>
<div class="ttc" id="class_c_net_message_html_a63b9f2351d5e92126cacacd51d9e16b6"><div class="ttname"><a href="class_c_net_message.html#a63b9f2351d5e92126cacacd51d9e16b6">CNetMessage::SetVersion</a></div><div class="ttdeci">void SetVersion(int nVersionIn)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00788">net.h:788</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a0e6b031d8505920b87ff88be68767f0a"><div class="ttname"><a href="net__processing_8cpp.html#a0e6b031d8505920b87ff88be68767f0a">STALE_RELAY_AGE_LIMIT</a></div><div class="ttdeci">static const int STALE_RELAY_AGE_LIMIT</div><div class="ttdoc">Age after which a stale block will no longer be served if requested as protection against fingerprint...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00111">net_processing.cpp:111</a></div></div>
<div class="ttc" id="class_c_spork_manager_html_a27d0be91a9dac781937ba3656870170e"><div class="ttname"><a href="class_c_spork_manager.html#a27d0be91a9dac781937ba3656870170e">CSporkManager::ProcessSpork</a></div><div class="ttdeci">void ProcessSpork(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdoc">ProcessSpork is used to handle the &amp;#39;getsporks&amp;#39; and &amp;#39;spork&amp;#39; p2p messages. </div><div class="ttdef"><b>Definition:</b> <a href="spork_8cpp_source.html#l00114">spork.cpp:114</a></div></div>
<div class="ttc" id="quorums__blockprocessor_8h_html"><div class="ttname"><a href="quorums__blockprocessor_8h.html">quorums_blockprocessor.h</a></div></div>
<div class="ttc" id="mnauth_8h_html"><div class="ttname"><a href="mnauth_8h.html">mnauth.h</a></div></div>
<div class="ttc" id="protocol_8cpp_html_a1b7cb231a14c1ace5268df7f7793529e"><div class="ttname"><a href="protocol_8cpp.html#a1b7cb231a14c1ace5268df7f7793529e">SetServiceFlagsIBDCache</a></div><div class="ttdeci">void SetServiceFlagsIBDCache(bool state)</div><div class="ttdoc">Set the current IBD status in order to figure out the desirable service flags. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00208">protocol.cpp:208</a></div></div>
<div class="ttc" id="class_c_rolling_bloom_filter_html"><div class="ttname"><a href="class_c_rolling_bloom_filter.html">CRollingBloomFilter</a></div><div class="ttdoc">RollingBloomFilter is a probabilistic &quot;keep track of most recently inserted&quot; set. ...</div><div class="ttdef"><b>Definition:</b> <a href="bloom_8h_source.html#l00126">bloom.h:126</a></div></div>
<div class="ttc" id="spork_8h_html"><div class="ttname"><a href="spork_8h.html">spork.h</a></div></div>
<div class="ttc" id="class_c_node_html_a9f0b0d22b190db2f74afd1b24cff47a1"><div class="ttname"><a href="class_c_node.html#a9f0b0d22b190db2f74afd1b24cff47a1">CNode::nPingUsecStart</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nPingUsecStart</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00926">net.h:926</a></div></div>
<div class="ttc" id="classllmq_1_1_c_chain_locks_handler_html_ac3fb4545be795693b9f35e4b3e17ff8f"><div class="ttname"><a href="classllmq_1_1_c_chain_locks_handler.html#ac3fb4545be795693b9f35e4b3e17ff8f">llmq::CChainLocksHandler::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__chainlocks_8cpp_source.html#l00093">quorums_chainlocks.cpp:93</a></div></div>
<div class="ttc" id="hash_8h_html"><div class="ttname"><a href="hash_8h.html">hash.h</a></div></div>
<div class="ttc" id="net_8cpp_html_a01304c8caa7997b48da307d19d1d284a"><div class="ttname"><a href="net_8cpp.html#a01304c8caa7997b48da307d19d1d284a">GetLocalAddress</a></div><div class="ttdeci">CAddress GetLocalAddress(const CNetAddr *paddrPeer, ServiceFlags nLocalServices)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00180">net.cpp:180</a></div></div>
<div class="ttc" id="class_c_scheduler_html_aab114cb7085474e0f1a47aa2b54e9cae"><div class="ttname"><a href="class_c_scheduler.html#aab114cb7085474e0f1a47aa2b54e9cae">CScheduler::scheduleEvery</a></div><div class="ttdeci">void scheduleEvery(Function f, int64_t deltaMilliSeconds)</div><div class="ttdef"><b>Definition:</b> <a href="scheduler_8cpp_source.html#l00126">scheduler.cpp:126</a></div></div>
<div class="ttc" id="version_8h_html_a4e18717137ea36916ec24018040cf954"><div class="ttname"><a href="version_8h.html#a4e18717137ea36916ec24018040cf954">SENDHEADERS_VERSION</a></div><div class="ttdeci">static const int SENDHEADERS_VERSION</div><div class="ttdoc">&quot;sendheaders&quot; command and announcing blocks with headers starts with this version ...</div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00039">version.h:39</a></div></div>
<div class="ttc" id="utiltime_8cpp_html_a0c5a06b50cd805b1923552114494c029"><div class="ttname"><a href="utiltime_8cpp.html#a0c5a06b50cd805b1923552114494c029">GetTimeMicros</a></div><div class="ttdeci">int64_t GetTimeMicros()</div><div class="ttdoc">Returns the system time (not mockable) </div><div class="ttdef"><b>Definition:</b> <a href="utiltime_8cpp_source.html#l00063">utiltime.cpp:63</a></div></div>
<div class="ttc" id="protocol_8h_html_ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb"><div class="ttname"><a href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a9ca74e44e29a412c070750bdbf2380bb">NODE_BLOOM</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00293">protocol.h:293</a></div></div>
<div class="ttc" id="class_c_chain_params_html"><div class="ttname"><a href="class_c_chain_params.html">CChainParams</a></div><div class="ttdoc">CChainParams defines various tweakable parameters of a given instance of the Dash system...</div><div class="ttdef"><b>Definition:</b> <a href="chainparams_8h_source.html#l00041">chainparams.h:41</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_a7a205c72456b8abf90143e8425e28f60"><div class="ttname"><a href="class_c_governance_manager.html#a7a205c72456b8abf90143e8425e28f60">CGovernanceManager::HaveObjectForHash</a></div><div class="ttdeci">bool HaveObjectForHash(const uint256 &amp;nHash) const</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00047">governance.cpp:47</a></div></div>
<div class="ttc" id="struct_c_block_locator_html_a77ebc693cf47cbab5c13777840f6bce1"><div class="ttname"><a href="struct_c_block_locator.html#a77ebc693cf47cbab5c13777840f6bce1">CBlockLocator::IsNull</a></div><div class="ttdeci">bool IsNull() const</div><div class="ttdef"><b>Definition:</b> <a href="block_8h_source.html#l00150">block.h:150</a></div></div>
<div class="ttc" id="class_c_data_stream_html"><div class="ttname"><a href="class_c_data_stream.html">CDataStream</a></div><div class="ttdoc">Double ended buffer combining vector and stream-like interfaces. </div><div class="ttdef"><b>Definition:</b> <a href="streams_8h_source.html#l00103">streams.h:103</a></div></div>
<div class="ttc" id="deterministicmns_8h_html_af1cbfb65604ae5f6b1507a860b15786f"><div class="ttname"><a href="deterministicmns_8h.html#af1cbfb65604ae5f6b1507a860b15786f">CDeterministicMNCPtr</a></div><div class="ttdeci">std::shared_ptr&lt; const CDeterministicMN &gt; CDeterministicMNCPtr</div><div class="ttdef"><b>Definition:</b> <a href="deterministicmns_8h_source.html#l00249">deterministicmns.h:249</a></div></div>
<div class="ttc" id="class_c_data_stream_html_ab2633ac67f098dad30d03291741c2e42"><div class="ttname"><a href="class_c_data_stream.html#ab2633ac67f098dad30d03291741c2e42">CDataStream::empty</a></div><div class="ttdeci">bool empty() const</div><div class="ttdef"><b>Definition:</b> <a href="streams_8h_source.html#l00195">streams.h:195</a></div></div>
<div class="ttc" id="class_args_manager_html_af81c6e2a9dcd6b12557a2387fd67b2a6"><div class="ttname"><a href="class_args_manager.html#af81c6e2a9dcd6b12557a2387fd67b2a6">ArgsManager::GetBoolArg</a></div><div class="ttdeci">bool GetBoolArg(const std::string &amp;strArg, bool fDefault) const</div><div class="ttdoc">Return boolean argument or default value. </div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00824">util.cpp:824</a></div></div>
<div class="ttc" id="class_c_connman_html_a2f86bde4f7b877cabf96f787aafa7068"><div class="ttname"><a href="class_c_connman.html#a2f86bde4f7b877cabf96f787aafa7068">CConnman::SetTryNewOutboundPeer</a></div><div class="ttdeci">void SetTryNewOutboundPeer(bool flag)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l02191">net.cpp:2191</a></div></div>
<div class="ttc" id="net__processing_8h_html_ab005b69fa976939a3f821412b9631068"><div class="ttname"><a href="net__processing_8h.html#ab005b69fa976939a3f821412b9631068">EXTRA_PEER_CHECK_INTERVAL</a></div><div class="ttdeci">static constexpr int64_t EXTRA_PEER_CHECK_INTERVAL</div><div class="ttdoc">How frequently to check for extra outbound peers and disconnect, in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00036">net_processing.h:36</a></div></div>
<div class="ttc" id="class_c_message_header_html_aebbc26feb23d551467ebd58b509204d0"><div class="ttname"><a href="class_c_message_header.html#aebbc26feb23d551467ebd58b509204d0">CMessageHeader::nMessageSize</a></div><div class="ttdeci">uint32_t nMessageSize</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00059">protocol.h:59</a></div></div>
<div class="ttc" id="struct_c_node_state_stats_html_a7646deac801098e973a5bc50202f92cd"><div class="ttname"><a href="struct_c_node_state_stats.html#a7646deac801098e973a5bc50202f92cd">CNodeStateStats::nSyncHeight</a></div><div class="ttdeci">int nSyncHeight</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00081">net_processing.h:81</a></div></div>
<div class="ttc" id="class_c_node_html_a1e8b0784cc82f33edc2dc4e2834d1ff0"><div class="ttname"><a href="class_c_node.html#a1e8b0784cc82f33edc2dc4e2834d1ff0">CNode::cs_inventory</a></div><div class="ttdeci">CCriticalSection cs_inventory</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00908">net.h:908</a></div></div>
<div class="ttc" id="class_c_main_signals_html_ab57756efee0f6f12b5a14cbbbd283df7"><div class="ttname"><a href="class_c_main_signals.html#ab57756efee0f6f12b5a14cbbbd283df7">CMainSignals::Broadcast</a></div><div class="ttdeci">void Broadcast(int64_t nBestBlockTime, CConnman *connman)</div><div class="ttdef"><b>Definition:</b> <a href="validationinterface_8cpp_source.html#l00206">validationinterface.cpp:206</a></div></div>
<div class="ttc" id="class_c_node_html_a3c5bbe8733398b4d14ce05d30aced57e"><div class="ttname"><a href="class_c_node.html#a3c5bbe8733398b4d14ce05d30aced57e">CNode::GetLocalNonce</a></div><div class="ttdeci">uint64_t GetLocalNonce() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00977">net.h:977</a></div></div>
<div class="ttc" id="net_8cpp_html_af7487aacfc9d708b3db40c255ec070a8"><div class="ttname"><a href="net_8cpp.html#af7487aacfc9d708b3db40c255ec070a8">SeenLocal</a></div><div class="ttdeci">bool SeenLocal(const CService &amp;addr)</div><div class="ttdoc">vote for a local address </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00296">net.cpp:296</a></div></div>
<div class="ttc" id="class_c_node_html_af17190ecdeab1d68c55090ef17dcd65c"><div class="ttname"><a href="class_c_node.html#af17190ecdeab1d68c55090ef17dcd65c">CNode::setInventoryTxToSend</a></div><div class="ttdeci">std::set&lt; uint256 &gt; setInventoryTxToSend</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00901">net.h:901</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a2f59958b48b742e03a34f3aaf865240b"><div class="ttname"><a href="net__processing_8cpp.html#a2f59958b48b742e03a34f3aaf865240b">ProcessGetBlockData</a></div><div class="ttdeci">static void ProcessGetBlockData(CNode *pfrom, const CChainParams &amp;chainparams, const CInv &amp;inv, CConnman *connman, const std::atomic&lt; bool &gt; &amp;interruptMsgProc)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01380">net_processing.cpp:1380</a></div></div>
<div class="ttc" id="class_c_node_html_a9b2d9b9182ff111c79f704594c4aa2e1"><div class="ttname"><a href="class_c_node.html#a9b2d9b9182ff111c79f704594c4aa2e1">CNode::vAddrToSend</a></div><div class="ttdeci">std::vector&lt; CAddress &gt; vAddrToSend</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00890">net.h:890</a></div></div>
<div class="ttc" id="class_c_node_html_a119824dcaebcd3c8e272a68f19a60c43"><div class="ttname"><a href="class_c_node.html#a119824dcaebcd3c8e272a68f19a60c43">CNode::fMasternode</a></div><div class="ttdeci">bool fMasternode</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00864">net.h:864</a></div></div>
<div class="ttc" id="utilmoneystr_8h_html"><div class="ttname"><a href="utilmoneystr_8h.html">utilmoneystr.h</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a4cae15fd207d555331995cd5c57689c1">MSG_BLOCK</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00400">protocol.h:400</a></div></div>
<div class="ttc" id="class_c_node_html_a6cb90622e50c1c9b1aa3dc4e81838747"><div class="ttname"><a href="class_c_node.html#a6cb90622e50c1c9b1aa3dc4e81838747">CNode::nStartingHeight</a></div><div class="ttdeci">std::atomic&lt; int &gt; nStartingHeight</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00887">net.h:887</a></div></div>
<div class="ttc" id="script_8h_html_a4e2e7158597de76ecbb03d866ec4c693"><div class="ttname"><a href="script_8h.html#a4e2e7158597de76ecbb03d866ec4c693">MAX_SCRIPT_ELEMENT_SIZE</a></div><div class="ttdeci">static const unsigned int MAX_SCRIPT_ELEMENT_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="script_8h_source.html#l00023">script.h:23</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a450d2be8350b29dcb4f3adc3325f56b2"><div class="ttname"><a href="net__processing_8cpp.html#a450d2be8350b29dcb4f3adc3325f56b2">instance_of_cnetprocessingcleanup</a></div><div class="ttdeci">class CNetProcessingCleanup instance_of_cnetprocessingcleanup</div></div>
<div class="ttc" id="class_c_node_html_a1f39037c55bed93b832bcbef00597ca5"><div class="ttname"><a href="class_c_node.html#a1f39037c55bed93b832bcbef00597ca5">CNode::PushAddress</a></div><div class="ttdeci">void PushAddress(const CAddress &amp;_addr, FastRandomContext &amp;insecure_rand)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l01026">net.h:1026</a></div></div>
<div class="ttc" id="init_8cpp_html_a8d0a31e674a78e42b06732f8420a3ffa"><div class="ttname"><a href="init_8cpp.html#a8d0a31e674a78e42b06732f8420a3ffa">scheduler</a></div><div class="ttdeci">static CScheduler scheduler</div><div class="ttdef"><b>Definition:</b> <a href="init_8cpp_source.html#l00213">init.cpp:213</a></div></div>
<div class="ttc" id="validation_8cpp_html_a290fce59049c0951b8eb73f0129bf6f0"><div class="ttname"><a href="validation_8cpp.html#a290fce59049c0951b8eb73f0129bf6f0">ProcessNewBlock</a></div><div class="ttdeci">bool ProcessNewBlock(const CChainParams &amp;chainparams, const std::shared_ptr&lt; const CBlock &gt; pblock, bool fForceProcessing, bool *fNewBlock)</div><div class="ttdoc">Process an incoming block. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l03803">validation.cpp:3803</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_af8e00fc92c92380006abda55135417c7"><div class="ttname"><a href="net__processing_8cpp.html#af8e00fc92c92380006abda55135417c7">cs_most_recent_block</a></div><div class="ttdeci">static CCriticalSection cs_most_recent_block</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01140">net_processing.cpp:1140</a></div></div>
<div class="ttc" id="class_c_message_header_html_ab5b3807481d4b918527b86523f1efee2"><div class="ttname"><a href="class_c_message_header.html#ab5b3807481d4b918527b86523f1efee2">CMessageHeader::GetCommand</a></div><div class="ttdeci">std::string GetCommand() const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00165">protocol.cpp:165</a></div></div>
<div class="ttc" id="class_c_node_html_a94438c6285d1635c62ccff10593780e6"><div class="ttname"><a href="class_c_node.html#a94438c6285d1635c62ccff10593780e6">CNode::SetRecvVersion</a></div><div class="ttdeci">void SetRecvVersion(int nVersionIn)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00993">net.h:993</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a395de13511c6ef9946844ee280b8f08e"><div class="ttname"><a href="namespace_net_msg_type.html#a395de13511c6ef9946844ee280b8f08e">NetMsgType::PONG</a></div><div class="ttdeci">const char * PONG</div><div class="ttdoc">The pong message replies to a ping message, proving to the pinging node that the ponging node is stil...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00032">protocol.cpp:32</a></div></div>
<div class="ttc" id="classbase__blob_html_aeee68e00ceeacf49086e98b661e017ff"><div class="ttname"><a href="classbase__blob.html#aeee68e00ceeacf49086e98b661e017ff">base_blob::begin</a></div><div class="ttdeci">unsigned char * begin()</div><div class="ttdef"><b>Definition:</b> <a href="uint256_8h_source.html#l00057">uint256.h:57</a></div></div>
<div class="ttc" id="transaction_8h_html_ae462b4b8f07705a82bf11cf361959b97"><div class="ttname"><a href="transaction_8h.html#ae462b4b8f07705a82bf11cf361959b97">CTransactionRef</a></div><div class="ttdeci">std::shared_ptr&lt; const CTransaction &gt; CTransactionRef</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00345">transaction.h:345</a></div></div>
<div class="ttc" id="deterministicmns_8cpp_html_ac56941f32bc28d3bcbe6fa12fd9b1033"><div class="ttname"><a href="deterministicmns_8cpp.html#ac56941f32bc28d3bcbe6fa12fd9b1033">deterministicMNManager</a></div><div class="ttdeci">std::unique_ptr&lt; CDeterministicMNManager &gt; deterministicMNManager</div><div class="ttdef"><b>Definition:</b> <a href="deterministicmns_8cpp_source.html#l00024">deterministicmns.cpp:24</a></div></div>
<div class="ttc" id="class_c_node_html_a91ddde2164145c8d4ab033e7b75bbc40"><div class="ttname"><a href="class_c_node.html#a91ddde2164145c8d4ab033e7b75bbc40">CNode::timeLastMempoolReq</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; timeLastMempoolReq</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00921">net.h:921</a></div></div>
<div class="ttc" id="class_c_message_header_html_a759db7100358ba4a44bf6dee757ffe51"><div class="ttname"><a href="class_c_message_header.html#a759db7100358ba4a44bf6dee757ffe51">CMessageHeader::IsValid</a></div><div class="ttdeci">bool IsValid(const MessageStartChars &amp;messageStart) const</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00170">protocol.cpp:170</a></div></div>
<div class="ttc" id="consensus_2validation_8h_html_a33438febc90b2b44c11530b8207d2e0f"><div class="ttname"><a href="consensus_2validation_8h.html#a33438febc90b2b44c11530b8207d2e0f">REJECT_OBSOLETE</a></div><div class="ttdeci">static const unsigned char REJECT_OBSOLETE</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00014">validation.h:14</a></div></div>
<div class="ttc" id="net__processing_8h_html_a9c22b1ae9c34ef1e327986bba6e1d4c2"><div class="ttname"><a href="net__processing_8h.html#a9c22b1ae9c34ef1e327986bba6e1d4c2">MINIMUM_CONNECT_TIME</a></div><div class="ttdeci">static constexpr int64_t MINIMUM_CONNECT_TIME</div><div class="ttdoc">Minimum time an outbound-peer-eviction candidate must be connected for, in order to evict...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00038">net_processing.h:38</a></div></div>
<div class="ttc" id="classbase__blob_html_aba89c6722866a5850882a509d27d7bbd"><div class="ttname"><a href="classbase__blob.html#aba89c6722866a5850882a509d27d7bbd">base_blob::IsNull</a></div><div class="ttdeci">bool IsNull() const</div><div class="ttdef"><b>Definition:</b> <a href="uint256_8h_source.html#l00033">uint256.h:33</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_adaa77fc4eee771d8e64b6c61f52c4266"><div class="ttname"><a href="class_peer_logic_validation.html#adaa77fc4eee771d8e64b6c61f52c4266">PeerLogicValidation::ProcessMessages</a></div><div class="ttdeci">bool ProcessMessages(CNode *pfrom, std::atomic&lt; bool &gt; &amp;interrupt) override</div><div class="ttdoc">Process protocol messages received from a given node. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03542">net_processing.cpp:3542</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a216e35db319a5d508043639fd3170776"><div class="ttname"><a href="namespace_net_msg_type.html#a216e35db319a5d508043639fd3170776">NetMsgType::HEADERS</a></div><div class="ttdeci">const char * HEADERS</div><div class="ttdoc">The headers message sends one or more block headers to a node which previously requested certain head...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00027">protocol.cpp:27</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_aa742e9f571614294522b03e9b019836a"><div class="ttname"><a href="namespace_net_msg_type.html#aa742e9f571614294522b03e9b019836a">NetMsgType::QJUSTIFICATION</a></div><div class="ttdeci">const char * QJUSTIFICATION</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00066">protocol.cpp:66</a></div></div>
<div class="ttc" id="class_c_block_index_html_af3c6d6dd8a7579e5ce516d94b98d2db5"><div class="ttname"><a href="class_c_block_index.html#af3c6d6dd8a7579e5ce516d94b98d2db5">CBlockIndex::nChainTx</a></div><div class="ttdeci">unsigned int nChainTx</div><div class="ttdoc">(memory only) Number of transactions in the chain up to and including this block. ...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00204">chain.h:204</a></div></div>
<div class="ttc" id="class_c_node_html_a7cef2333aa8776127a7e7fcab659eb6a"><div class="ttname"><a href="class_c_node.html#a7cef2333aa8776127a7e7fcab659eb6a">CNode::PushInventory</a></div><div class="ttdeci">void PushInventory(const CInv &amp;inv)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l01054">net.h:1054</a></div></div>
<div class="ttc" id="class_c_spork_message_html"><div class="ttname"><a href="class_c_spork_message.html">CSporkMessage</a></div><div class="ttdoc">Sporks are network parameters used primarily to prevent forking and turn on/off certain features...</div><div class="ttdef"><b>Definition:</b> <a href="spork_8h_source.html#l00075">spork.h:75</a></div></div>
<div class="ttc" id="util_8h_html_ace3eef3e04606342f2d6de114a1cae26"><div class="ttname"><a href="util_8h.html#ace3eef3e04606342f2d6de114a1cae26">LogAcceptCategory</a></div><div class="ttdeci">static bool LogAcceptCategory(uint64_t category)</div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00152">util.h:152</a></div></div>
<div class="ttc" id="class_compare_inv_mempool_order_html"><div class="ttname"><a href="class_compare_inv_mempool_order.html">CompareInvMempoolOrder</a></div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03799">net_processing.cpp:3799</a></div></div>
<div class="ttc" id="class_c_node_html_afa2bef684dff0fa5241f01822638af99"><div class="ttname"><a href="class_c_node.html#afa2bef684dff0fa5241f01822638af99">CNode::orphan_work_set</a></div><div class="ttdeci">std::set&lt; uint256 &gt; orphan_work_set</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00949">net.h:949</a></div></div>
<div class="ttc" id="class_c_private_send_broadcast_tx_html_a4ab80169447e38f64dfa26b63252ee4a"><div class="ttname"><a href="class_c_private_send_broadcast_tx.html#a4ab80169447e38f64dfa26b63252ee4a">CPrivateSendBroadcastTx::IsValidStructure</a></div><div class="ttdeci">bool IsValidStructure()</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_2privatesend_8cpp_source.html#l00132">privatesend.cpp:132</a></div></div>
<div class="ttc" id="validation_8cpp_html_a8cfbc84b7aa211f3368d4d3813be276c"><div class="ttname"><a href="validation_8cpp.html#a8cfbc84b7aa211f3368d4d3813be276c">ActivateBestChain</a></div><div class="ttdeci">bool ActivateBestChain(CValidationState &amp;state, const CChainParams &amp;chainparams, std::shared_ptr&lt; const CBlock &gt; pblock)</div><div class="ttdoc">Find the best known block, and make it the tip of the block chain. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l03072">validation.cpp:3072</a></div></div>
<div class="ttc" id="class_c_node_html_a3d311ea99f2524e5c2cdb9a311725b9f"><div class="ttname"><a href="class_c_node.html#a3d311ea99f2524e5c2cdb9a311725b9f">CNode::nServices</a></div><div class="ttdeci">std::atomic&lt; ServiceFlags &gt; nServices</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00805">net.h:805</a></div></div>
<div class="ttc" id="class_c_transaction_html_ad64447ea044ec850313696fc99412d95"><div class="ttname"><a href="class_c_transaction.html#ad64447ea044ec850313696fc99412d95">CTransaction::vin</a></div><div class="ttdeci">const std::vector&lt; CTxIn &gt; vin</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00215">transaction.h:215</a></div></div>
<div class="ttc" id="class_c_node_html_a331888bc15bb49775451d951735e4b6a"><div class="ttname"><a href="class_c_node.html#a331888bc15bb49775451d951735e4b6a">CNode::SetAddrLocal</a></div><div class="ttdeci">void SetAddrLocal(const CService &amp;addrLocalIn)</div><div class="ttdoc">May not be called more than once. </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00741">net.cpp:741</a></div></div>
<div class="ttc" id="protocol_8h_html_ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372"><div class="ttname"><a href="protocol_8h.html#ad131f3177584caea787cdbf6f85a9537a8294ff7e8ff77692c2fb330df0a3c372">NODE_NETWORK_LIMITED</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00300">protocol.h:300</a></div></div>
<div class="ttc" id="scheduler_8h_html"><div class="ttname"><a href="scheduler_8h.html">scheduler.h</a></div></div>
<div class="ttc" id="random_8cpp_html_a49fa92a85621c56f1ce50385f8778505"><div class="ttname"><a href="random_8cpp.html#a49fa92a85621c56f1ce50385f8778505">GetRandMicros</a></div><div class="ttdeci">std::chrono::microseconds GetRandMicros(std::chrono::microseconds duration_max) noexcept</div><div class="ttdef"><b>Definition:</b> <a href="random_8cpp_source.html#l00374">random.cpp:374</a></div></div>
<div class="ttc" id="class_c_node_html_a9649c1f27ff0d8f0ba89eb1ea5bee139"><div class="ttname"><a href="class_c_node.html#a9649c1f27ff0d8f0ba89eb1ea5bee139">CNode::vRecvGetData</a></div><div class="ttdeci">std::deque&lt; CInv &gt; vRecvGetData</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00822">net.h:822</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_afabe3cd738cb766597ff4c1ee1e47cbd"><div class="ttname"><a href="namespace_net_msg_type.html#afabe3cd738cb766597ff4c1ee1e47cbd">NetMsgType::INV</a></div><div class="ttdeci">const char * INV</div><div class="ttdoc">The inv message (inventory message) transmits one or more inventories of objects known to the transmi...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00021">protocol.cpp:21</a></div></div>
<div class="ttc" id="class_c_connman_html_a2d665bfdec68f6484b9f0d6760f9efd1"><div class="ttname"><a href="class_c_connman.html#a2d665bfdec68f6484b9f0d6760f9efd1">CConnman::ForEachNode</a></div><div class="ttdeci">void ForEachNode(const Condition &amp;cond, Callable &amp;&amp;func)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00288">net.h:288</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_abd6140f46766ceef29bf97f4e83bbec1"><div class="ttname"><a href="net__processing_8cpp.html#abd6140f46766ceef29bf97f4e83bbec1">AddOrphanTx</a></div><div class="ttdeci">bool AddOrphanTx(const CTransactionRef &amp;tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00911">net_processing.cpp:911</a></div></div>
<div class="ttc" id="validation_8cpp_html_ac38e65e42c4799a42e2e45c62cd91c19"><div class="ttname"><a href="validation_8cpp.html#ac38e65e42c4799a42e2e45c62cd91c19">ProcessNewBlockHeaders</a></div><div class="ttdeci">bool ProcessNewBlockHeaders(const std::vector&lt; CBlockHeader &gt; &amp;headers, CValidationState &amp;state, const CChainParams &amp;chainparams, const CBlockIndex **ppindex, CBlockHeader *first_invalid)</div><div class="ttdoc">Process incoming block headers. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l03682">validation.cpp:3682</a></div></div>
<div class="ttc" id="quorums__chainlocks_8h_html"><div class="ttname"><a href="quorums__chainlocks_8h.html">quorums_chainlocks.h</a></div></div>
<div class="ttc" id="class_c_base_chain_params_html_ae2c5dfdbbff4d5f92948258a7b4db47b"><div class="ttname"><a href="class_c_base_chain_params.html#ae2c5dfdbbff4d5f92948258a7b4db47b">CBaseChainParams::MAIN</a></div><div class="ttdeci">static const std::string MAIN</div><div class="ttdoc">BIP70 chain name strings (main, test or regtest) </div><div class="ttdef"><b>Definition:</b> <a href="chainparamsbase_8h_source.html#l00020">chainparamsbase.h:20</a></div></div>
<div class="ttc" id="class_c_rolling_bloom_filter_html_a4f7d6161274b03c63be50aadb1fe46b7"><div class="ttname"><a href="class_c_rolling_bloom_filter.html#a4f7d6161274b03c63be50aadb1fe46b7">CRollingBloomFilter::contains</a></div><div class="ttdeci">bool contains(const std::vector&lt; unsigned char &gt; &amp;vKey) const</div><div class="ttdef"><b>Definition:</b> <a href="bloom_8cpp_source.html#l00378">bloom.cpp:378</a></div></div>
<div class="ttc" id="quorums__init_8h_html"><div class="ttname"><a href="quorums__init_8h.html">quorums_init.h</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aae936f7cf0174e2378c22419a18f0f60"><div class="ttname"><a href="net__processing_8cpp.html#aae936f7cf0174e2378c22419a18f0f60">MAX_GETDATA_RANDOM_DELAY</a></div><div class="ttdeci">static constexpr std::chrono::microseconds MAX_GETDATA_RANDOM_DELAY</div><div class="ttdoc">Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00071">net_processing.cpp:71</a></div></div>
<div class="ttc" id="validation_8h_html_ae98e9fff288e3029a25765a7f924d960"><div class="ttname"><a href="validation_8h.html#ae98e9fff288e3029a25765a7f924d960">REJECT_INTERNAL</a></div><div class="ttdeci">static const unsigned int REJECT_INTERNAL</div><div class="ttdoc">Reject codes greater or equal to this can be returned by AcceptToMemPool for transactions, to signal internal conditions. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00484">validation.h:484</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_ab30fadfa811829e79accca41da6a8328"><div class="ttname"><a href="class_c_tx_mem_pool.html#ab30fadfa811829e79accca41da6a8328">CTxMemPool::check</a></div><div class="ttdeci">void check(const CCoinsViewCache *pcoins) const</div><div class="ttdoc">If sanity-checking is turned on, check makes sure the pool is consistent (does not contain two transa...</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01013">txmempool.cpp:1013</a></div></div>
<div class="ttc" id="masternode-meta_8cpp_html_a024536f114ea52e8aac13d062afd5ef0"><div class="ttname"><a href="masternode-meta_8cpp.html#a024536f114ea52e8aac13d062afd5ef0">mmetaman</a></div><div class="ttdeci">CMasternodeMetaMan mmetaman</div><div class="ttdef"><b>Definition:</b> <a href="masternode-meta_8cpp_source.html#l00009">masternode-meta.cpp:9</a></div></div>
<div class="ttc" id="namespacellmq_html_af23057832f6ee12385340b41832aa31f"><div class="ttname"><a href="namespacellmq.html#af23057832f6ee12385340b41832aa31f">llmq::quorumInstantSendManager</a></div><div class="ttdeci">CInstantSendManager * quorumInstantSendManager</div><div class="ttdef"><b>Definition:</b> <a href="quorums__instantsend_8cpp_source.html#l00040">quorums_instantsend.cpp:40</a></div></div>
<div class="ttc" id="validation_8cpp_html_a751114a714075a2a620f6bedfc36fef3"><div class="ttname"><a href="validation_8cpp.html#a751114a714075a2a620f6bedfc36fef3">pcoinsTip</a></div><div class="ttdeci">std::unique_ptr&lt; CCoinsViewCache &gt; pcoinsTip</div><div class="ttdoc">Global variable that points to the active CCoinsView (protected by cs_main) </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00300">validation.cpp:300</a></div></div>
<div class="ttc" id="classllmq_1_1_c_instant_send_lock_html"><div class="ttname"><a href="classllmq_1_1_c_instant_send_lock.html">llmq::CInstantSendLock</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__instantsend_8h_source.html#l00020">quorums_instantsend.h:20</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a189a835fa7e6ae93a2391f38eefd7d2d"><div class="ttname"><a href="net__processing_8cpp.html#a189a835fa7e6ae93a2391f38eefd7d2d">AddToCompactExtraTransactions</a></div><div class="ttdeci">void AddToCompactExtraTransactions(const CTransactionRef &amp;tx) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00900">net_processing.cpp:900</a></div></div>
<div class="ttc" id="class_c_block_index_html_a98490a2788c65cdd6ae9002b004dd74c"><div class="ttname"><a href="class_c_block_index.html#a98490a2788c65cdd6ae9002b004dd74c">CBlockIndex::GetBlockHash</a></div><div class="ttdeci">uint256 GetBlockHash() const</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00292">chain.h:292</a></div></div>
<div class="ttc" id="version_8h_html_a352cc543eb23823a6b16a5166c8db2c3"><div class="ttname"><a href="version_8h.html#a352cc543eb23823a6b16a5166c8db2c3">LLMQS_PROTO_VERSION</a></div><div class="ttdeci">static const int LLMQS_PROTO_VERSION</div><div class="ttdoc">introduction of LLMQs </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00051">version.h:51</a></div></div>
<div class="ttc" id="class_c_block_index_html_ad8b5a6560e7c0d4222066e2922178683"><div class="ttname"><a href="class_c_block_index.html#ad8b5a6560e7c0d4222066e2922178683">CBlockIndex::IsValid</a></div><div class="ttdeci">bool IsValid(enum BlockStatus nUpTo=BLOCK_VALID_TRANSACTIONS) const</div><div class="ttdoc">Check whether this block index entry is valid up to the passed validity level. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00332">chain.h:332</a></div></div>
<div class="ttc" id="governance_2governance_8cpp_html_a45f086f57868174ccf2cee5e7d968d8f"><div class="ttname"><a href="governance_2governance_8cpp.html#a45f086f57868174ccf2cee5e7d968d8f">governance</a></div><div class="ttdeci">CGovernanceManager governance</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00023">governance.cpp:23</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a1d39aac66e12dae50a24cd7a9100ef33"><div class="ttname"><a href="net__processing_8cpp.html#a1d39aac66e12dae50a24cd7a9100ef33">done</a></div><div class="ttdeci">bool done</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01948">net_processing.cpp:1948</a></div></div>
<div class="ttc" id="class_c_node_html_aa8d520199b103410958ba9ce4412cf61"><div class="ttname"><a href="class_c_node.html#aa8d520199b103410958ba9ce4412cf61">CNode::fSentAddr</a></div><div class="ttdeci">bool fSentAddr</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00862">net.h:862</a></div></div>
<div class="ttc" id="class_c_node_html_a561a6acb4365b4b3ad9c35e0bba66619"><div class="ttname"><a href="class_c_node.html#a561a6acb4365b4b3ad9c35e0bba66619">CNode::fFirstMessageIsMNAUTH</a></div><div class="ttdeci">std::atomic&lt; bool &gt; fFirstMessageIsMNAUTH</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00832">net.h:832</a></div></div>
<div class="ttc" id="class_c_private_send_broadcast_tx_html_a323d1fce5e220f62a20f2619f8627588"><div class="ttname"><a href="class_c_private_send_broadcast_tx.html#a323d1fce5e220f62a20f2619f8627588">CPrivateSendBroadcastTx::masternodeOutpoint</a></div><div class="ttdeci">COutPoint masternodeOutpoint</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_8h_source.html#l00300">privatesend.h:300</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a98ad80bc64f9bd92a1248db622320c81"><div class="ttname"><a href="net__processing_8cpp.html#a98ad80bc64f9bd92a1248db622320c81">Misbehaving</a></div><div class="ttdeci">void Misbehaving(NodeId pnode, int howmuch, const std::string &amp;message)</div><div class="ttdoc">Increase a node&amp;#39;s misbehavior score. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01024">net_processing.cpp:1024</a></div></div>
<div class="ttc" id="masternode-payments_8h_html"><div class="ttname"><a href="masternode-payments_8h.html">masternode-payments.h</a></div></div>
<div class="ttc" id="class_c_node_html_ab7986845edae94a0aa0d64b6fcf51a38"><div class="ttname"><a href="class_c_node.html#ab7986845edae94a0aa0d64b6fcf51a38">CNode::nPingUsecTime</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nPingUsecTime</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00928">net.h:928</a></div></div>
<div class="ttc" id="utiltime_8cpp_html_a350f99e2a13df31f2afbd7f80ab21a5e"><div class="ttname"><a href="utiltime_8cpp.html#a350f99e2a13df31f2afbd7f80ab21a5e">GetTime</a></div><div class="ttdeci">int64_t GetTime()</div><div class="ttdoc">Return system time (or mocked time, if set) </div><div class="ttdef"><b>Definition:</b> <a href="utiltime_8cpp_source.html#l00022">utiltime.cpp:22</a></div></div>
<div class="ttc" id="struct_c_node_state_stats_html_a67c910a57285a63bbf0bb88ea7a9ca05"><div class="ttname"><a href="struct_c_node_state_stats.html#a67c910a57285a63bbf0bb88ea7a9ca05">CNodeStateStats::nCommonHeight</a></div><div class="ttdeci">int nCommonHeight</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00082">net_processing.h:82</a></div></div>
<div class="ttc" id="util_8cpp_html_aab0b2c1be849102968dfee289f3b3e2a"><div class="ttname"><a href="util_8cpp.html#aab0b2c1be849102968dfee289f3b3e2a">fMasternodeMode</a></div><div class="ttdeci">bool fMasternodeMode</div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00093">util.cpp:93</a></div></div>
<div class="ttc" id="addrdb_8h_html_ae79eefa5f9d20b9761dfc7a41123e668ae46a4491319b620067723c12d5ba3c7a"><div class="ttname"><a href="addrdb_8h.html#ae79eefa5f9d20b9761dfc7a41123e668ae46a4491319b620067723c12d5ba3c7a">BanReasonNodeMisbehaving</a></div><div class="ttdef"><b>Definition:</b> <a href="addrdb_8h_source.html#l00022">addrdb.h:22</a></div></div>
<div class="ttc" id="utilstrencodings_8h_html"><div class="ttname"><a href="utilstrencodings_8h.html">utilstrencodings.h</a></div></div>
<div class="ttc" id="class_c_node_html_a99add23b72cd7eae9ea5c7d16b0fe259"><div class="ttname"><a href="class_c_node.html#a99add23b72cd7eae9ea5c7d16b0fe259">CNode::nMinPingUsecTime</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nMinPingUsecTime</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00930">net.h:930</a></div></div>
<div class="ttc" id="class_c_node_html_a62937ed6238077e4c6e4364d75b4c0b7"><div class="ttname"><a href="class_c_node.html#a62937ed6238077e4c6e4364d75b4c0b7">CNode::GetMyStartingHeight</a></div><div class="ttdeci">int GetMyStartingHeight() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00981">net.h:981</a></div></div>
<div class="ttc" id="sync_8h_html_a35644e2b75a93da0cb0f6c768f34efa8"><div class="ttname"><a href="sync_8h.html#a35644e2b75a93da0cb0f6c768f34efa8">LOCK2</a></div><div class="ttdeci">#define LOCK2(cs1, cs2)</div><div class="ttdef"><b>Definition:</b> <a href="sync_8h_source.html#l00179">sync.h:179</a></div></div>
<div class="ttc" id="class_c_connman_html_ac57208a8ea613f814aaf1c5c5e5394a4"><div class="ttname"><a href="class_c_connman.html#ac57208a8ea613f814aaf1c5c5e5394a4">CConnman::Ban</a></div><div class="ttdeci">void Ban(const CNetAddr &amp;netAddr, const BanReason &amp;reason, int64_t bantimeoffset=0, bool sinceUnixEpoch=false)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00605">net.cpp:605</a></div></div>
<div class="ttc" id="class_c_node_html_aaa7ed919e1ed445dd9589b984231ba46"><div class="ttname"><a href="class_c_node.html#aaa7ed919e1ed445dd9589b984231ba46">CNode::GetLocalServices</a></div><div class="ttdeci">ServiceFlags GetLocalServices() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l01087">net.h:1087</a></div></div>
<div class="ttc" id="chain_8h_html_a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65"><div class="ttname"><a href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada00332fcf52dbd55990d8ff86b616bc65">BLOCK_VALID_CHAIN</a></div><div class="ttdoc">Outputs do not overspend inputs, no double spends, coinbase output ok, no immature coinbase spends...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00145">chain.h:145</a></div></div>
<div class="ttc" id="quorums__signing_8h_html"><div class="ttname"><a href="quorums__signing_8h.html">quorums_signing.h</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ab76fe0ce1c92f8d93e86679c08889dc9"><div class="ttname"><a href="namespace_net_msg_type.html#ab76fe0ce1c92f8d93e86679c08889dc9">NetMsgType::ISLOCK</a></div><div class="ttdeci">const char * ISLOCK</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00076">protocol.cpp:76</a></div></div>
<div class="ttc" id="validation_8h_html_a98597d505d0e8c99870eeda3db92f42f"><div class="ttname"><a href="validation_8h.html#a98597d505d0e8c99870eeda3db92f42f">BLOCK_DOWNLOAD_TIMEOUT_PER_PEER</a></div><div class="ttdeci">static const int64_t BLOCK_DOWNLOAD_TIMEOUT_PER_PEER</div><div class="ttdoc">Additional block download timeout per parallel downloading peer (i.e. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00112">validation.h:112</a></div></div>
<div class="ttc" id="class_c_node_html_a721e2470c2c961b7599768a14be68781"><div class="ttname"><a href="class_c_node.html#a721e2470c2c961b7599768a14be68781">CNode::fClient</a></div><div class="ttdeci">bool fClient</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00849">net.h:849</a></div></div>
<div class="ttc" id="class_c_connman_html_a28701e595fcd7dd71791f105457db034"><div class="ttname"><a href="class_c_connman.html#a28701e595fcd7dd71791f105457db034">CConnman::ForNode</a></div><div class="ttdeci">bool ForNode(NodeId id, std::function&lt; bool(const CNode *pnode)&gt; cond, std::function&lt; bool(CNode *pnode)&gt; func)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03795">net.cpp:3795</a></div></div>
<div class="ttc" id="net_8cpp_html_a7935254c613d6f3cdadd3ce45f7efbff"><div class="ttname"><a href="net_8cpp.html#a7935254c613d6f3cdadd3ce45f7efbff">fRelayTxes</a></div><div class="ttdeci">bool fRelayTxes</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00114">net.cpp:114</a></div></div>
<div class="ttc" id="class_c_merkle_block_html"><div class="ttname"><a href="class_c_merkle_block.html">CMerkleBlock</a></div><div class="ttdoc">Used to relay blocks as header + vector&lt;merkle branch&gt; to filtered nodes. </div><div class="ttdef"><b>Definition:</b> <a href="merkleblock_8h_source.html#l00127">merkleblock.h:127</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a9f6abd72d04b4128a949c0c4db11d883"><div class="ttname"><a href="namespace_net_msg_type.html#a9f6abd72d04b4128a949c0c4db11d883">NetMsgType::GETHEADERS</a></div><div class="ttdeci">const char * GETHEADERS</div><div class="ttdoc">The getheaders message requests a headers message that provides block headers starting from a particu...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00025">protocol.cpp:25</a></div></div>
<div class="ttc" id="validation_8h_html_a5df18e7f16a7c3cb6ac8ea991137c5db"><div class="ttname"><a href="validation_8h.html#a5df18e7f16a7c3cb6ac8ea991137c5db">NODE_NETWORK_LIMITED_MIN_BLOCKS</a></div><div class="ttdeci">static const unsigned int NODE_NETWORK_LIMITED_MIN_BLOCKS</div><div class="ttdoc">Minimum blocks required to signal NODE_NETWORK_LIMITED. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00209">validation.h:209</a></div></div>
<div class="ttc" id="namespacellmq_html_aab0e6e59f5052f34a32a83bdd4c2999d"><div class="ttname"><a href="namespacellmq.html#aab0e6e59f5052f34a32a83bdd4c2999d">llmq::chainLocksHandler</a></div><div class="ttdeci">CChainLocksHandler * chainLocksHandler</div><div class="ttdef"><b>Definition:</b> <a href="quorums__chainlocks_8cpp_source.html#l00024">quorums_chainlocks.cpp:24</a></div></div>
<div class="ttc" id="misc_8cpp_html_ae0a67d7e5c7e47430e8b4b4438087c54"><div class="ttname"><a href="misc_8cpp.html#ae0a67d7e5c7e47430e8b4b4438087c54">spork</a></div><div class="ttdeci">UniValue spork(const JSONRPCRequest &amp;request)</div><div class="ttdef"><b>Definition:</b> <a href="misc_8cpp_source.html#l00165">misc.cpp:165</a></div></div>
<div class="ttc" id="util_8h_html_afc02c0a4258fedfb316be612bb659ba8"><div class="ttname"><a href="util_8h.html#afc02c0a4258fedfb316be612bb659ba8">LogPrintf</a></div><div class="ttdeci">#define LogPrintf(...)</div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00203">util.h:203</a></div></div>
<div class="ttc" id="txmempool_8h_html"><div class="ttname"><a href="txmempool_8h.html">txmempool.h</a></div></div>
<div class="ttc" id="validation_8h_html_a5289ed91f1daf187bba005dd54d62649"><div class="ttname"><a href="validation_8h.html#a5289ed91f1daf187bba005dd54d62649">DEFAULT_WHITELISTRELAY</a></div><div class="ttdeci">static const bool DEFAULT_WHITELISTRELAY</div><div class="ttdoc">Default for -whitelistrelay. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00052">validation.h:52</a></div></div>
<div class="ttc" id="class_c_data_stream_html_add30f866dd928fc28c47fe79a0a6723a"><div class="ttname"><a href="class_c_data_stream.html#add30f866dd928fc28c47fe79a0a6723a">CDataStream::size</a></div><div class="ttdeci">size_type size() const</div><div class="ttdef"><b>Definition:</b> <a href="streams_8h_source.html#l00194">streams.h:194</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ac4299daf3e1b6b047287708f3894113e"><div class="ttname"><a href="namespace_net_msg_type.html#ac4299daf3e1b6b047287708f3894113e">NetMsgType::MNLISTDIFF</a></div><div class="ttdeci">const char * MNLISTDIFF</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00061">protocol.cpp:61</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_acba2818c523a6551451b8bae883e998a"><div class="ttname"><a href="net__processing_8cpp.html#acba2818c523a6551451b8bae883e998a">CalculateObjectGetDataTime</a></div><div class="ttdeci">std::chrono::microseconds CalculateObjectGetDataTime(const CInv &amp;inv, std::chrono::microseconds current_time, bool use_inbound_delay) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00749">net_processing.cpp:749</a></div></div>
<div class="ttc" id="class_c_node_html_a30f76a69e956d342bdbb400541c98ccb"><div class="ttname"><a href="class_c_node.html#a30f76a69e956d342bdbb400541c98ccb">CNode::nProcessQueueSize</a></div><div class="ttdeci">size_t nProcessQueueSize</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00818">net.h:818</a></div></div>
<div class="ttc" id="class_c_message_header_html_ae440f94400fb825098e4c23fe4b129aa"><div class="ttname"><a href="class_c_message_header.html#ae440f94400fb825098e4c23fe4b129aa">CMessageHeader::COMMAND_SIZE</a></div><div class="ttdeci">static constexpr size_t COMMAND_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00032">protocol.h:32</a></div></div>
<div class="ttc" id="chain_8h_html_a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230"><div class="ttname"><a href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada47b28fca76b64d094ddca0a3aa8da230">BLOCK_VALID_SCRIPTS</a></div><div class="ttdoc">Scripts &amp; signatures ok. Implies all parents are also at least SCRIPTS. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00148">chain.h:148</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a867f7b452141770f3b2e8697fb3513d8"><div class="ttname"><a href="class_c_tx_mem_pool.html#a867f7b452141770f3b2e8697fb3513d8">CTxMemPool::size</a></div><div class="ttdeci">unsigned long size()</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8h_source.html#l00660">txmempool.h:660</a></div></div>
<div class="ttc" id="class_c_validation_state_html_ace1d536f4003d3a6689fccd0f496c977"><div class="ttname"><a href="class_c_validation_state.html#ace1d536f4003d3a6689fccd0f496c977">CValidationState::IsInvalid</a></div><div class="ttdeci">bool IsInvalid() const</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00064">validation.h:64</a></div></div>
<div class="ttc" id="class_compare_inv_mempool_order_html_ad6211dc6a6928d8499d5b58babe95ddd"><div class="ttname"><a href="class_compare_inv_mempool_order.html#ad6211dc6a6928d8499d5b58babe95ddd">CompareInvMempoolOrder::mp</a></div><div class="ttdeci">CTxMemPool * mp</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03801">net_processing.cpp:3801</a></div></div>
<div class="ttc" id="validation_8cpp_html_acfbdea59afc1824d0d1c1ff10f17fd53"><div class="ttname"><a href="validation_8cpp.html#acfbdea59afc1824d0d1c1ff10f17fd53">pindexBestHeader</a></div><div class="ttdeci">CBlockIndex * pindexBestHeader</div><div class="ttdoc">Best header we&amp;#39;ve seen so far (used for getheaders queries&amp;#39; starting points). </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00218">validation.cpp:218</a></div></div>
<div class="ttc" id="class_block_transactions_html_a1a88870022bf6c5d7522689c961fc570"><div class="ttname"><a href="class_block_transactions.html#a1a88870022bf6c5d7522689c961fc570">BlockTransactions::txn</a></div><div class="ttdeci">std::vector&lt; CTransactionRef &gt; txn</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00075">blockencodings.h:75</a></div></div>
<div class="ttc" id="class_c_node_html_a2bb91c9968a9f855c05b1121100a8797"><div class="ttname"><a href="class_c_node.html#a2bb91c9968a9f855c05b1121100a8797">CNode::fOneShot</a></div><div class="ttdeci">bool fOneShot</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00847">net.h:847</a></div></div>
<div class="ttc" id="class_c_tx_in_html"><div class="ttname"><a href="class_c_tx_in.html">CTxIn</a></div><div class="ttdoc">An input of a transaction. </div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00070">transaction.h:70</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_session_manager_html_a95b9bbcb003cef356837ed097b784be4"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_session_manager.html#a95b9bbcb003cef356837ed097b784be4">llmq::CDKGSessionManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsessionmgr_8cpp_source.html#l00071">quorums_dkgsessionmgr.cpp:71</a></div></div>
<div class="ttc" id="class_c_get_simplified_m_n_list_diff_html"><div class="ttname"><a href="class_c_get_simplified_m_n_list_diff.html">CGetSimplifiedMNListDiff</a></div><div class="ttdoc">P2P messages. </div><div class="ttdef"><b>Definition:</b> <a href="simplifiedmns_8h_source.html#l00089">simplifiedmns.h:89</a></div></div>
<div class="ttc" id="protocol_8h_html_a704107b66bfb835ad593b1045e663e8f"><div class="ttname"><a href="protocol_8h.html#a704107b66bfb835ad593b1045e663e8f">HasAllDesirableServiceFlags</a></div><div class="ttdeci">static bool HasAllDesirableServiceFlags(ServiceFlags services)</div><div class="ttdoc">A shortcut for (services &amp; GetDesirableServiceFlags(services)) == GetDesirableServiceFlags(services)...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00345">protocol.h:345</a></div></div>
<div class="ttc" id="class_c_private_send_html_a5ca6361baefaecece1640899f918fd8a"><div class="ttname"><a href="class_c_private_send.html#a5ca6361baefaecece1640899f918fd8a">CPrivateSend::GetDSTX</a></div><div class="ttdeci">static CPrivateSendBroadcastTx GetDSTX(const uint256 &amp;hash)</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_2privatesend_8cpp_source.html#l00537">privatesend.cpp:537</a></div></div>
<div class="ttc" id="sync_8h_html_a911fe23f057c2fe5aad629162d6c99d0"><div class="ttname"><a href="sync_8h.html#a911fe23f057c2fe5aad629162d6c99d0">LOCK</a></div><div class="ttdeci">#define LOCK(cs)</div><div class="ttdef"><b>Definition:</b> <a href="sync_8h_source.html#l00178">sync.h:178</a></div></div>
<div class="ttc" id="namespace_b_c_log_html_a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688"><div class="ttname"><a href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541a9de80b3d43cd0484f95e9881d521b688">BCLog::PRIVATESEND</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00142">util.h:142</a></div></div>
<div class="ttc" id="rest_8cpp_html_a8f8f80d37794cde9472343e4487ba3eb"><div class="ttname"><a href="rest_8cpp.html#a8f8f80d37794cde9472343e4487ba3eb">name</a></div><div class="ttdeci">const char * name</div><div class="ttdef"><b>Definition:</b> <a href="rest_8cpp_source.html#l00036">rest.cpp:36</a></div></div>
<div class="ttc" id="validation_8h_html_a276b0b56a72df733dda86cfe6322f604"><div class="ttname"><a href="validation_8h.html#a276b0b56a72df733dda86cfe6322f604">MAX_BLOCKS_IN_TRANSIT_PER_PEER</a></div><div class="ttdeci">static const int MAX_BLOCKS_IN_TRANSIT_PER_PEER</div><div class="ttdoc">Number of blocks that can be requested at any given time from a single peer. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00087">validation.h:87</a></div></div>
<div class="ttc" id="class_c_transaction_html_a7efd1379de830341417c0bfa23a149aa"><div class="ttname"><a href="class_c_transaction.html#a7efd1379de830341417c0bfa23a149aa">CTransaction::GetHash</a></div><div class="ttdeci">const uint256 &amp; GetHash() const</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00256">transaction.h:256</a></div></div>
<div class="ttc" id="classllmq_1_1_c_quorum_block_processor_html_aa95f97977868b55a6616b54392d265f4"><div class="ttname"><a href="classllmq_1_1_c_quorum_block_processor.html#aa95f97977868b55a6616b54392d265f4">llmq::CQuorumBlockProcessor::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__blockprocessor_8cpp_source.html#l00030">quorums_blockprocessor.cpp:30</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991ad5de2518f7a7e23590f870cf0c57a188"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ad5de2518f7a7e23590f870cf0c57a188">MSG_QUORUM_FINAL_COMMITMENT</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00416">protocol.h:416</a></div></div>
<div class="ttc" id="net_8cpp_html_a058b75c6fcc94a0643184c237ad6de93"><div class="ttname"><a href="net_8cpp.html#a058b75c6fcc94a0643184c237ad6de93">IsPeerAddrLocalGood</a></div><div class="ttdeci">bool IsPeerAddrLocalGood(CNode *pnode)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00201">net.cpp:201</a></div></div>
<div class="ttc" id="class_c_inv_html_a2da8a26c6b8824011e3144459d278c75"><div class="ttname"><a href="class_c_inv.html#a2da8a26c6b8824011e3144459d278c75">CInv::type</a></div><div class="ttdeci">int type</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00455">protocol.h:455</a></div></div>
<div class="ttc" id="version_8h_html_a2c4c900f5bd0c956cc1a64cd0cc1c318"><div class="ttname"><a href="version_8h.html#a2c4c900f5bd0c956cc1a64cd0cc1c318">INIT_PROTO_VERSION</a></div><div class="ttdeci">static const int INIT_PROTO_VERSION</div><div class="ttdoc">initial proto version, to be increased after version/verack negotiation </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00017">version.h:17</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a1d84425becf1d3c0ee012002b187d717"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a1d84425becf1d3c0ee012002b187d717">MSG_QUORUM_JUSTIFICATION</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00420">protocol.h:420</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a83fb276c8e205804cbe67bfc620564ea"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a83fb276c8e205804cbe67bfc620564ea">MSG_QUORUM_CONTRIB</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00418">protocol.h:418</a></div></div>
<div class="ttc" id="netmessagemaker_8h_html"><div class="ttname"><a href="netmessagemaker_8h.html">netmessagemaker.h</a></div></div>
<div class="ttc" id="class_c_chain_html_af1786dc229c215dea7f727c11df2c8dc"><div class="ttname"><a href="class_c_chain.html#af1786dc229c215dea7f727c11df2c8dc">CChain::Contains</a></div><div class="ttdeci">bool Contains(const CBlockIndex *pindex) const</div><div class="ttdoc">Efficiently check whether a block is present in this chain. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00471">chain.h:471</a></div></div>
<div class="ttc" id="class_c_service_html"><div class="ttname"><a href="class_c_service.html">CService</a></div><div class="ttdoc">A combination of a network address (CNetAddr) and a (TCP) port. </div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8h_source.html#l00143">netaddress.h:143</a></div></div>
<div class="ttc" id="class_fast_random_context_html"><div class="ttname"><a href="class_fast_random_context.html">FastRandomContext</a></div><div class="ttdoc">Fast randomness source. </div><div class="ttdef"><b>Definition:</b> <a href="random_8h_source.html#l00048">random.h:48</a></div></div>
<div class="ttc" id="class_c_net_message_html"><div class="ttname"><a href="class_c_net_message.html">CNetMessage</a></div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00755">net.h:755</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a57e38f9cdcd648eb2d43c237cc1b8b0b"><div class="ttname"><a href="namespace_net_msg_type.html#a57e38f9cdcd648eb2d43c237cc1b8b0b">NetMsgType::LEGACYTXLOCKREQUEST</a></div><div class="ttdeci">const char * LEGACYTXLOCKREQUEST</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00044">protocol.cpp:44</a></div></div>
<div class="ttc" id="policy_8h_html"><div class="ttname"><a href="policy_8h.html">policy.h</a></div></div>
<div class="ttc" id="consensus_2validation_8h_html"><div class="ttname"><a href="consensus_2validation_8h.html">validation.h</a></div></div>
<div class="ttc" id="class_c_connman_html_abbed3e0e20b469953fc8d72b4c2167fe"><div class="ttname"><a href="class_c_connman.html#abbed3e0e20b469953fc8d72b4c2167fe">CConnman::PoissonNextSendInbound</a></div><div class="ttdeci">int64_t PoissonNextSendInbound(int64_t now, int average_interval_seconds)</div><div class="ttdoc">Attempts to obfuscate tx time through exponentially distributed emitting. </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03814">net.cpp:3814</a></div></div>
<div class="ttc" id="class_c_connman_html_aa12d154df14eef07418a36362d1cb8d7"><div class="ttname"><a href="class_c_connman.html#aa12d154df14eef07418a36362d1cb8d7">CConnman::OutboundTargetReached</a></div><div class="ttdeci">bool OutboundTargetReached(bool historicalBlockServingLimit)</div><div class="ttdoc">check if the outbound target is reached </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03587">net.cpp:3587</a></div></div>
<div class="ttc" id="validation_8h_html_ae90d2acb26fa19fdcd983626b0d37d0b"><div class="ttname"><a href="validation_8h.html#ae90d2acb26fa19fdcd983626b0d37d0b">MAX_HEADERS_RESULTS</a></div><div class="ttdeci">static const unsigned int MAX_HEADERS_RESULTS</div><div class="ttdoc">Number of headers sent in one getheaders result. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00092">validation.h:92</a></div></div>
<div class="ttc" id="consensus_2validation_8h_html_aaebbd8495fbce589cdf05570198c4240"><div class="ttname"><a href="consensus_2validation_8h.html#aaebbd8495fbce589cdf05570198c4240">REJECT_NONSTANDARD</a></div><div class="ttdeci">static const unsigned char REJECT_NONSTANDARD</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00016">validation.h:16</a></div></div>
<div class="ttc" id="struct_consensus_1_1_params_html_aea6ebb563ceffd026cc7c11d3e9b192e"><div class="ttname"><a href="struct_consensus_1_1_params.html#aea6ebb563ceffd026cc7c11d3e9b192e">Consensus::Params::nPowTargetSpacing</a></div><div class="ttdeci">int64_t nPowTargetSpacing</div><div class="ttdef"><b>Definition:</b> <a href="params_8h_source.html#l00176">params.h:176</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a9f058406be3ef6ad83afbb7021424d21"><div class="ttname"><a href="net__processing_8cpp.html#a9f058406be3ef6ad83afbb7021424d21">ProcessGetData</a></div><div class="ttdeci">static void ProcessGetData(CNode *pfrom, const CChainParams &amp;chainparams, CConnman *connman, const std::atomic&lt; bool &gt; &amp;interruptMsgProc)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01517">net_processing.cpp:1517</a></div></div>
<div class="ttc" id="class_c_connman_html_a4ba34cd3557ab0ba1cfcbe7c18bf1199"><div class="ttname"><a href="class_c_connman.html#a4ba34cd3557ab0ba1cfcbe7c18bf1199">CConnman::GetAddresses</a></div><div class="ttdeci">std::vector&lt; CAddress &gt; GetAddresses()</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03277">net.cpp:3277</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ac6b3b660a36c39312cd3247d5da77715"><div class="ttname"><a href="net__processing_8cpp.html#ac6b3b660a36c39312cd3247d5da77715">MAX_PEER_OBJECT_ANNOUNCEMENTS</a></div><div class="ttdeci">static constexpr int32_t MAX_PEER_OBJECT_ANNOUNCEMENTS</div><div class="ttdoc">Maximum number of announced objects from a peer. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00065">net_processing.cpp:65</a></div></div>
<div class="ttc" id="class_c_chain_html_a3077e83c87e8a974765fa76a57fd040b"><div class="ttname"><a href="class_c_chain.html#a3077e83c87e8a974765fa76a57fd040b">CChain::Next</a></div><div class="ttdeci">CBlockIndex * Next(const CBlockIndex *pindex) const</div><div class="ttdoc">Find the successor of a block in this chain, or nullptr if the given index is not found or is the tip...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00476">chain.h:476</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a34f999f9e5179be5fc361aaca9c0e5b3"><div class="ttname"><a href="namespace_net_msg_type.html#a34f999f9e5179be5fc361aaca9c0e5b3">NetMsgType::SENDHEADERS</a></div><div class="ttdeci">const char * SENDHEADERS</div><div class="ttdoc">Indicates that a node prefers to receive new block announcements via a &quot;headers&quot; message rather than ...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00038">protocol.cpp:38</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a68c340a8ef4f949cfd06c19a620aa32c"><div class="ttname"><a href="namespace_net_msg_type.html#a68c340a8ef4f949cfd06c19a620aa32c">NetMsgType::MEMPOOL</a></div><div class="ttdeci">const char * MEMPOOL</div><div class="ttdoc">The mempool message requests the TXIDs of transactions that the receiving node has verified as valid ...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00030">protocol.cpp:30</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991abd3619e681a4ee498cce0c77e1794e08"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abd3619e681a4ee498cce0c77e1794e08">MSG_CLSIG</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00424">protocol.h:424</a></div></div>
<div class="ttc" id="struct_c_orphan_tx_html_a06fa313a474fd4e6d0ed20bda7cbe69c"><div class="ttname"><a href="struct_c_orphan_tx.html#a06fa313a474fd4e6d0ed20bda7cbe69c">COrphanTx::fromPeer</a></div><div class="ttdeci">NodeId fromPeer</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00094">net_processing.cpp:94</a></div></div>
<div class="ttc" id="masternode-meta_8h_html"><div class="ttname"><a href="masternode-meta_8h.html">masternode-meta.h</a></div></div>
<div class="ttc" id="version_8h_html_a43420c87666449f8132e21687abcfda9"><div class="ttname"><a href="version_8h.html#a43420c87666449f8132e21687abcfda9">SHORT_IDS_BLOCKS_VERSION</a></div><div class="ttdeci">static const int SHORT_IDS_BLOCKS_VERSION</div><div class="ttdoc">short-id-based block download starts with this version </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00045">version.h:45</a></div></div>
<div class="ttc" id="class_c_validation_state_html_a8fa9612cb40c3c8592f7cd29b5931ccd"><div class="ttname"><a href="class_c_validation_state.html#a8fa9612cb40c3c8592f7cd29b5931ccd">CValidationState::GetRejectReason</a></div><div class="ttdeci">std::string GetRejectReason() const</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00081">validation.h:81</a></div></div>
<div class="ttc" id="classllmq_1_1_c_instant_send_manager_html_ae3b62c9f60f11b7c58110fbe66f73a2f"><div class="ttname"><a href="classllmq_1_1_c_instant_send_manager.html#ae3b62c9f60f11b7c58110fbe66f73a2f">llmq::CInstantSendManager::IsLocked</a></div><div class="ttdeci">bool IsLocked(const uint256 &amp;txHash)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__instantsend_8cpp_source.html#l01464">quorums_instantsend.cpp:1464</a></div></div>
<div class="ttc" id="net__processing_8h_html_a50cdb9bf0105f8f39008a7ec09909336"><div class="ttname"><a href="net__processing_8h.html#a50cdb9bf0105f8f39008a7ec09909336">ORPHAN_TX_EXPIRE_INTERVAL</a></div><div class="ttdeci">static const int64_t ORPHAN_TX_EXPIRE_INTERVAL</div><div class="ttdoc">Minimum time between orphan transactions expire time checks in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00018">net_processing.h:18</a></div></div>
<div class="ttc" id="netbase_8cpp_html_aef250c1632d217d8f3b752ddeacc0368"><div class="ttname"><a href="netbase_8cpp.html#aef250c1632d217d8f3b752ddeacc0368">IsProxy</a></div><div class="ttdeci">bool IsProxy(const CNetAddr &amp;addr)</div><div class="ttdef"><b>Definition:</b> <a href="netbase_8cpp_source.html#l00586">netbase.cpp:586</a></div></div>
<div class="ttc" id="class_c_node_html_a6d81efc365079ca499a5f6465967d8d9"><div class="ttname"><a href="class_c_node.html#a6d81efc365079ca499a5f6465967d8d9">CNode::m_manual_connection</a></div><div class="ttdeci">bool m_manual_connection</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00848">net.h:848</a></div></div>
<div class="ttc" id="simplifiedmns_8h_html"><div class="ttname"><a href="simplifiedmns_8h.html">simplifiedmns.h</a></div></div>
<div class="ttc" id="class_c_transaction_html_a708645274ddfd83829315ffe5c7c5c3e"><div class="ttname"><a href="class_c_transaction.html#a708645274ddfd83829315ffe5c7c5c3e">CTransaction::vout</a></div><div class="ttdeci">const std::vector&lt; CTxOut &gt; vout</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00216">transaction.h:216</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a196fe0f4bf56c132a6a83a080144a43b"><div class="ttname"><a href="class_peer_logic_validation.html#a196fe0f4bf56c132a6a83a080144a43b">PeerLogicValidation::PeerLogicValidation</a></div><div class="ttdeci">PeerLogicValidation(CConnman *connmanIn, CScheduler &amp;scheduler)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01079">net_processing.cpp:1079</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_a2b6e0b1cc473ed34714723422e0b8ae8"><div class="ttname"><a href="class_c_governance_manager.html#a2b6e0b1cc473ed34714723422e0b8ae8">CGovernanceManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00088">governance.cpp:88</a></div></div>
<div class="ttc" id="class_c_address_html"><div class="ttname"><a href="class_c_address.html">CAddress</a></div><div class="ttdoc">A CService with information about it as peer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00358">protocol.h:358</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_af38e4f57b0dfe17ddfedb664338f5f51"><div class="ttname"><a href="net__processing_8cpp.html#af38e4f57b0dfe17ddfedb664338f5f51">IsBanned</a></div><div class="ttdeci">bool IsBanned(NodeId pnode)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01045">net_processing.cpp:1045</a></div></div>
<div class="ttc" id="validation_8cpp_html_a5edcd96316574fd4a7f3ae0922a5cfd6"><div class="ttname"><a href="validation_8cpp.html#a5edcd96316574fd4a7f3ae0922a5cfd6">IsInitialBlockDownload</a></div><div class="ttdeci">bool IsInitialBlockDownload()</div><div class="ttdoc">Check whether we are doing an initial block download (synchronizing from disk or network) ...</div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l01219">validation.cpp:1219</a></div></div>
<div class="ttc" id="class_c_service_html_af21ea7db4318330b337c8bfdcc55aff0"><div class="ttname"><a href="class_c_service.html#af21ea7db4318330b337c8bfdcc55aff0">CService::GetKey</a></div><div class="ttdeci">std::vector&lt; unsigned char &gt; GetKey() const</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00557">netaddress.cpp:557</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a11325f86c93e30d45af1aae8455694dd"><div class="ttname"><a href="net__processing_8cpp.html#a11325f86c93e30d45af1aae8455694dd">EraseOrphanTx</a></div><div class="ttdeci">static int EraseOrphanTx(uint256 hash) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00946">net_processing.cpp:946</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a5e28a66012d1391df8c419f51ed078cf"><div class="ttname"><a href="namespace_net_msg_type.html#a5e28a66012d1391df8c419f51ed078cf">NetMsgType::QSIGREC</a></div><div class="ttdeci">const char * QSIGREC</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00073">protocol.cpp:73</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a7ec45a20c72f5a43ec54d6cc213b229d"><div class="ttname"><a href="net__processing_8cpp.html#a7ec45a20c72f5a43ec54d6cc213b229d">AVG_ADDRESS_BROADCAST_INTERVAL</a></div><div class="ttdeci">static const unsigned int AVG_ADDRESS_BROADCAST_INTERVAL</div><div class="ttdoc">Average delay between peer address broadcasts in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00120">net_processing.cpp:120</a></div></div>
<div class="ttc" id="protocol_8cpp_html_a5f8d18ec9217ffee378339dc22ebe20d"><div class="ttname"><a href="protocol_8cpp.html#a5f8d18ec9217ffee378339dc22ebe20d">getAllNetMessageTypes</a></div><div class="ttdeci">const std::vector&lt; std::string &gt; &amp; getAllNetMessageTypes()</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00293">protocol.cpp:293</a></div></div>
<div class="ttc" id="class_c_inv_html_abfa04c38e9c0def9a2b09a9c43929744"><div class="ttname"><a href="class_c_inv.html#abfa04c38e9c0def9a2b09a9c43929744">CInv::hash</a></div><div class="ttdeci">uint256 hash</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00456">protocol.h:456</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_justification_html"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_justification.html">llmq::CDKGJustification</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsession_8h_source.html#l00123">quorums_dkgsession.h:123</a></div></div>
<div class="ttc" id="net__processing_8h_html_a1ca092f66c0d0ea7ea0e930b5a72c500"><div class="ttname"><a href="net__processing_8h.html#a1ca092f66c0d0ea7ea0e930b5a72c500">ORPHAN_TX_EXPIRE_TIME</a></div><div class="ttdeci">static const int64_t ORPHAN_TX_EXPIRE_TIME</div><div class="ttdoc">Expiration time for orphan transactions in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00016">net_processing.h:16</a></div></div>
<div class="ttc" id="tinyformat_8h_html"><div class="ttname"><a href="tinyformat_8h.html">tinyformat.h</a></div></div>
<div class="ttc" id="validationinterface_8cpp_html_a0aaad62c8654cb1868295e0682b05866"><div class="ttname"><a href="validationinterface_8cpp.html#a0aaad62c8654cb1868295e0682b05866">GetMainSignals</a></div><div class="ttdeci">CMainSignals &amp; GetMainSignals()</div><div class="ttdef"><b>Definition:</b> <a href="validationinterface_8cpp_source.html#l00079">validationinterface.cpp:79</a></div></div>
<div class="ttc" id="blockencodings_8h_html"><div class="ttname"><a href="blockencodings_8h.html">blockencodings.h</a></div></div>
<div class="ttc" id="class_c_spork_manager_html_a9cec53a1eb6335507d5c88a17f293e7f"><div class="ttname"><a href="class_c_spork_manager.html#a9cec53a1eb6335507d5c88a17f293e7f">CSporkManager::GetSporkByHash</a></div><div class="ttdeci">bool GetSporkByHash(const uint256 &amp;hash, CSporkMessage &amp;sporkRet)</div><div class="ttdoc">GetSporkByHash returns a spork message given a hash of the spork message. </div><div class="ttdef"><b>Definition:</b> <a href="spork_8cpp_source.html#l00255">spork.cpp:255</a></div></div>
<div class="ttc" id="class_c_node_html_ad47e8171d8a114592e90d7d83ee62875"><div class="ttname"><a href="class_c_node.html#ad47e8171d8a114592e90d7d83ee62875">CNode::vBlockHashesToAnnounce</a></div><div class="ttdeci">std::vector&lt; uint256 &gt; vBlockHashesToAnnounce</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00912">net.h:912</a></div></div>
<div class="ttc" id="util_8h_html"><div class="ttname"><a href="util_8h.html">util.h</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a1a6d457786a36cd01e8688d356883a47"><div class="ttname"><a href="namespace_net_msg_type.html#a1a6d457786a36cd01e8688d356883a47">NetMsgType::GETMNLISTDIFF</a></div><div class="ttdeci">const char * GETMNLISTDIFF</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00060">protocol.cpp:60</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a77d83bbf95702906ee01ca4fd934e1c0"><div class="ttname"><a href="namespace_net_msg_type.html#a77d83bbf95702906ee01ca4fd934e1c0">NetMsgType::ADDR</a></div><div class="ttdeci">const char * ADDR</div><div class="ttdoc">The addr (IP address) message relays connection information for peers on the network. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00020">protocol.cpp:20</a></div></div>
<div class="ttc" id="deterministicmns_8h_html"><div class="ttname"><a href="deterministicmns_8h.html">deterministicmns.h</a></div></div>
<div class="ttc" id="class_c_chain_params_html_a42f81df0a4f3494e3fc83ab53049fdd9"><div class="ttname"><a href="class_c_chain_params.html#a42f81df0a4f3494e3fc83ab53049fdd9">CChainParams::MessageStart</a></div><div class="ttdeci">const CMessageHeader::MessageStartChars &amp; MessageStart() const</div><div class="ttdef"><b>Definition:</b> <a href="chainparams_8h_source.html#l00055">chainparams.h:55</a></div></div>
<div class="ttc" id="net_8h_html_aa637b11e18b77724b35db2229cd12788"><div class="ttname"><a href="net_8h.html#aa637b11e18b77724b35db2229cd12788">NodeId</a></div><div class="ttdeci">int64_t NodeId</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00109">net.h:109</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a147efbcf1410c50c56547340f1fe1ebd"><div class="ttname"><a href="net__processing_8cpp.html#a147efbcf1410c50c56547340f1fe1ebd">nTimeBestReceived</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nTimeBestReceived(0)</div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a8b7a13b5289ab839d4460f41a7da9789"><div class="ttname"><a href="class_c_tx_mem_pool.html#a8b7a13b5289ab839d4460f41a7da9789">CTxMemPool::exists</a></div><div class="ttdeci">bool exists(uint256 hash) const</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8h_source.html#l00672">txmempool.h:672</a></div></div>
<div class="ttc" id="class_c_connman_html"><div class="ttname"><a href="class_c_connman.html">CConnman</a></div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00136">net.h:136</a></div></div>
<div class="ttc" id="class_c_connman_html_a47d9024273a8c421fa7de641c30e9081"><div class="ttname"><a href="class_c_connman.html#a47d9024273a8c421fa7de641c30e9081">CConnman::AddNewAddresses</a></div><div class="ttdeci">void AddNewAddresses(const std::vector&lt; CAddress &gt; &amp;vAddr, const CAddress &amp;addrFrom, int64_t nTimePenalty=0)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03272">net.cpp:3272</a></div></div>
<div class="ttc" id="struct_c_orphan_tx_html_a773aa46801b0dfe3c42f033857bd8830"><div class="ttname"><a href="struct_c_orphan_tx.html#a773aa46801b0dfe3c42f033857bd8830">COrphanTx::nTxSize</a></div><div class="ttdeci">size_t nTxSize</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00096">net_processing.cpp:96</a></div></div>
<div class="ttc" id="class_c_node_html_a347c7f2314f8bc7dfa3261deaa428af6"><div class="ttname"><a href="class_c_node.html#a347c7f2314f8bc7dfa3261deaa428af6">CNode::fMasternodeProbe</a></div><div class="ttdeci">bool fMasternodeProbe</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00866">net.h:866</a></div></div>
<div class="ttc" id="class_c_node_html_a6aee41fdb8c6a512395e66bb832c5f05"><div class="ttname"><a href="class_c_node.html#a6aee41fdb8c6a512395e66bb832c5f05">CNode::sentMNAuthChallenge</a></div><div class="ttdeci">uint256 sentMNAuthChallenge</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00939">net.h:939</a></div></div>
<div class="ttc" id="class_c_node_html_a7ad782061899c99918ec9e239b387f92"><div class="ttname"><a href="class_c_node.html#a7ad782061899c99918ec9e239b387f92">CNode::nTimeFirstMessageReceived</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nTimeFirstMessageReceived</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00831">net.h:831</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aad50a92403104f85b18da00f816ce475"><div class="ttname"><a href="net__processing_8cpp.html#aad50a92403104f85b18da00f816ce475">INVENTORY_BROADCAST_INTERVAL</a></div><div class="ttdeci">static const unsigned int INVENTORY_BROADCAST_INTERVAL</div><div class="ttdoc">Average delay between trickled inventory transmissions in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00124">net_processing.cpp:124</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a1ef3ccc1966cb35a59882fb97c15a30e"><div class="ttname"><a href="namespace_net_msg_type.html#a1ef3ccc1966cb35a59882fb97c15a30e">NetMsgType::FILTERCLEAR</a></div><div class="ttdeci">const char * FILTERCLEAR</div><div class="ttdoc">The filterclear message tells the receiving peer to remove a previously-set bloom filter...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00036">protocol.cpp:36</a></div></div>
<div class="ttc" id="class_c_node_html_a3da9c559959e182aff8439cd004ff624"><div class="ttname"><a href="class_c_node.html#a3da9c559959e182aff8439cd004ff624">CNode::fGetAddr</a></div><div class="ttdeci">bool fGetAddr</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00892">net.h:892</a></div></div>
<div class="ttc" id="validation_8h_html_a4757562fa889f0f4f7e88e096d724adb"><div class="ttname"><a href="validation_8h.html#a4757562fa889f0f4f7e88e096d724adb">fImporting</a></div><div class="ttdeci">std::atomic_bool fImporting</div></div>
<div class="ttc" id="class_c_message_header_html_a5668d7d3e1cb2f0a80c333495ed3da35"><div class="ttname"><a href="class_c_message_header.html#a5668d7d3e1cb2f0a80c333495ed3da35">CMessageHeader::CHECKSUM_SIZE</a></div><div class="ttdeci">static constexpr size_t CHECKSUM_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00034">protocol.h:34</a></div></div>
<div class="ttc" id="classllmq_1_1_c_sig_shares_manager_html_a4d59d0a6400f6bd658ad9b727a4686f1"><div class="ttname"><a href="classllmq_1_1_c_sig_shares_manager.html#a4d59d0a6400f6bd658ad9b727a4686f1">llmq::CSigSharesManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pnode, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing__shares_8cpp_source.html#l00233">quorums_signing_shares.cpp:233</a></div></div>
<div class="ttc" id="classbase__blob_html_a7a0d25782830d8b087c4da839f3ccdeb"><div class="ttname"><a href="classbase__blob.html#a7a0d25782830d8b087c4da839f3ccdeb">base_blob::ToString</a></div><div class="ttdeci">std::string ToString() const</div><div class="ttdef"><b>Definition:</b> <a href="uint256_8cpp_source.html#l00062">uint256.cpp:62</a></div></div>
<div class="ttc" id="class_partially_downloaded_block_html"><div class="ttname"><a href="class_partially_downloaded_block.html">PartiallyDownloadedBlock</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00194">blockencodings.h:194</a></div></div>
<div class="ttc" id="classbase__blob_html_a00e7426a5d1ada51c635debf85f5a810"><div class="ttname"><a href="classbase__blob.html#a00e7426a5d1ada51c635debf85f5a810">base_blob::size</a></div><div class="ttdeci">unsigned int size() const</div><div class="ttdef"><b>Definition:</b> <a href="uint256_8h_source.html#l00077">uint256.h:77</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_a6ec5f16eef458f094696ad59dc8e6f05"><div class="ttname"><a href="class_c_governance_manager.html#a6ec5f16eef458f094696ad59dc8e6f05">CGovernanceManager::SerializeObjectForHash</a></div><div class="ttdeci">bool SerializeObjectForHash(const uint256 &amp;nHash, CDataStream &amp;ss) const</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00053">governance.cpp:53</a></div></div>
<div class="ttc" id="class_c_node_html_a157903f7830c0dfbf6a93852066f0b8f"><div class="ttname"><a href="class_c_node.html#a157903f7830c0dfbf6a93852066f0b8f">CNode::GetId</a></div><div class="ttdeci">NodeId GetId() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00973">net.h:973</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a567653d3f26a7e711889682e7fd1c484"><div class="ttname"><a href="namespace_net_msg_type.html#a567653d3f26a7e711889682e7fd1c484">NetMsgType::NOTFOUND</a></div><div class="ttdeci">const char * NOTFOUND</div><div class="ttdoc">The notfound message is a reply to a getdata message which requested an object the receiving node doe...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00033">protocol.cpp:33</a></div></div>
<div class="ttc" id="txdb_8h_html"><div class="ttname"><a href="txdb_8h.html">txdb.h</a></div></div>
<div class="ttc" id="class_c_connman_html_a70b9c66fa48a69fed984062c5cfda281"><div class="ttname"><a href="class_c_connman.html#a70b9c66fa48a69fed984062c5cfda281">CConnman::GetDeterministicRandomizer</a></div><div class="ttdeci">CSipHasher GetDeterministicRandomizer(uint64_t id) const</div><div class="ttdoc">Get a unique deterministic randomizer. </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03858">net.cpp:3858</a></div></div>
<div class="ttc" id="class_c_base_chain_params_html_a86abcc91bfa683e47bb113e32ff86dec"><div class="ttname"><a href="class_c_base_chain_params.html#a86abcc91bfa683e47bb113e32ff86dec">CBaseChainParams::DEVNET</a></div><div class="ttdeci">static const std::string DEVNET</div><div class="ttdef"><b>Definition:</b> <a href="chainparamsbase_8h_source.html#l00022">chainparamsbase.h:22</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_a5a7e2f9bcf237d99a005dc72d4a6bfac"><div class="ttname"><a href="class_c_governance_manager.html#a5a7e2f9bcf237d99a005dc72d4a6bfac">CGovernanceManager::ConfirmInventoryRequest</a></div><div class="ttdeci">bool ConfirmInventoryRequest(const CInv &amp;inv)</div><div class="ttdoc">This is called by AlreadyHave in net_processing.cpp as part of the inventory retrieval process...</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00562">governance.cpp:562</a></div></div>
<div class="ttc" id="struct_consensus_1_1_params_html"><div class="ttname"><a href="struct_consensus_1_1_params.html">Consensus::Params</a></div><div class="ttdoc">Parameters that influence chain consensus. </div><div class="ttdef"><b>Definition:</b> <a href="params_8h_source.html#l00130">params.h:130</a></div></div>
<div class="ttc" id="class_c_net_processing_cleanup_html"><div class="ttname"><a href="class_c_net_processing_cleanup.html">CNetProcessingCleanup</a></div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l04414">net_processing.cpp:4414</a></div></div>
<div class="ttc" id="reverse__iterator_8h_html"><div class="ttname"><a href="reverse__iterator_8h.html">reverse_iterator.h</a></div></div>
<div class="ttc" id="class_c_private_send_html_a34bb28453d0906baa0e63001c502cc30"><div class="ttname"><a href="class_c_private_send.html#a34bb28453d0906baa0e63001c502cc30">CPrivateSend::AddDSTX</a></div><div class="ttdeci">static void AddDSTX(const CPrivateSendBroadcastTx &amp;dstx)</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_2privatesend_8cpp_source.html#l00531">privatesend.cpp:531</a></div></div>
<div class="ttc" id="class_c_out_point_html"><div class="ttname"><a href="class_c_out_point.html">COutPoint</a></div><div class="ttdoc">An outpoint - a combination of a transaction hash and an index n into its vout. </div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00026">transaction.h:26</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aa22ab8b72b51c86621b28b923dd85605"><div class="ttname"><a href="net__processing_8cpp.html#aa22ab8b72b51c86621b28b923dd85605">MAX_PEER_OBJECT_IN_FLIGHT</a></div><div class="ttdeci">static constexpr int32_t MAX_PEER_OBJECT_IN_FLIGHT</div><div class="ttdoc">Maximum number of in-flight objects from a peer. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00063">net_processing.cpp:63</a></div></div>
<div class="ttc" id="class_c_private_send_server_html_a66c38d7af845bab8e22c37e2165fd5f9"><div class="ttname"><a href="class_c_private_send_server.html#a66c38d7af845bab8e22c37e2165fd5f9">CPrivateSendServer::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="privatesend-server_8cpp_source.html#l00027">privatesend-server.cpp:27</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a1842ab3e065d8bc5180974b9e3f44377"><div class="ttname"><a href="namespace_net_msg_type.html#a1842ab3e065d8bc5180974b9e3f44377">NetMsgType::BLOCK</a></div><div class="ttdeci">const char * BLOCK</div><div class="ttdoc">The block message transmits a single serialized block. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00028">protocol.cpp:28</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aec1d19218087514e02f3cd63bab79be4"><div class="ttname"><a href="net__processing_8cpp.html#aec1d19218087514e02f3cd63bab79be4">SendBlockTransactions</a></div><div class="ttdeci">static void SendBlockTransactions(const CBlock &amp;block, const BlockTransactionsRequest &amp;req, CNode *pfrom, CConnman *connman)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01709">net_processing.cpp:1709</a></div></div>
<div class="ttc" id="class_c_node_html_adebd9bb3224ed2c5ab63fdfd9c6e9074"><div class="ttname"><a href="class_c_node.html#adebd9bb3224ed2c5ab63fdfd9c6e9074">CNode::fDisconnect</a></div><div class="ttdeci">std::atomic_bool fDisconnect</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00853">net.h:853</a></div></div>
<div class="ttc" id="quorums__dkgsessionmgr_8h_html"><div class="ttname"><a href="quorums__dkgsessionmgr_8h.html">quorums_dkgsessionmgr.h</a></div></div>
<div class="ttc" id="net_8cpp_html_a6c58f8ccc4c93105a44caf588562d609"><div class="ttname"><a href="net_8cpp.html#a6c58f8ccc4c93105a44caf588562d609">strSubVersion</a></div><div class="ttdeci">std::string strSubVersion</div><div class="ttdoc">Subversion as sent to the P2P network in version messages. </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00118">net.cpp:118</a></div></div>
<div class="ttc" id="consensus_2validation_8h_html_aae810f65f020df86be128d0c026edf44"><div class="ttname"><a href="consensus_2validation_8h.html#aae810f65f020df86be128d0c026edf44">REJECT_DUPLICATE</a></div><div class="ttdeci">static const unsigned char REJECT_DUPLICATE</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00015">validation.h:15</a></div></div>
<div class="ttc" id="validation_8cpp_html_a6b569217f0bbb0a69a42c8769df06a06"><div class="ttname"><a href="validation_8cpp.html#a6b569217f0bbb0a69a42c8769df06a06">fTxIndex</a></div><div class="ttdeci">bool fTxIndex</div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00225">validation.cpp:225</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a0bcab6d439b438550865c607e7d90d3a"><div class="ttname"><a href="net__processing_8cpp.html#a0bcab6d439b438550865c607e7d90d3a">g_cs_orphans</a></div><div class="ttdeci">static CCriticalSection g_cs_orphans</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00098">net_processing.cpp:98</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991abacdb1618207a44c1301ae59acf7f5d8"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991abacdb1618207a44c1301ae59acf7f5d8">MSG_SPORK</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00407">protocol.h:407</a></div></div>
<div class="ttc" id="namespace_b_c_log_html_a7f38d795c5b3ac39b8f87a13ddfec541aa471bb09916fba65e151b0f4ce623c26"><div class="ttname"><a href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541aa471bb09916fba65e151b0f4ce623c26">BCLog::MEMPOOLREJ</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00126">util.h:126</a></div></div>
<div class="ttc" id="classllmq_1_1_c_recovered_sig_html"><div class="ttname"><a href="classllmq_1_1_c_recovered_sig.html">llmq::CRecoveredSig</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing_8h_source.html#l00021">quorums_signing.h:21</a></div></div>
<div class="ttc" id="class_c_net_addr_html_a4e3b2fea2a6151c76684b3812df4a5c3"><div class="ttname"><a href="class_c_net_addr.html#a4e3b2fea2a6151c76684b3812df4a5c3">CNetAddr::IsRoutable</a></div><div class="ttdeci">bool IsRoutable() const</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00230">netaddress.cpp:230</a></div></div>
<div class="ttc" id="validation_8cpp_html_af66174e55ad9bafa7a92e4740db6b575"><div class="ttname"><a href="validation_8cpp.html#af66174e55ad9bafa7a92e4740db6b575">nMaxTipAge</a></div><div class="ttdeci">int64_t nMaxTipAge</div><div class="ttdoc">If the tip is older than this (in seconds), the node is considered to be in initial block download...</div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00238">validation.cpp:238</a></div></div>
<div class="ttc" id="net__processing_8h_html_a09ba6681dd87e0136d25acc054a335a0"><div class="ttname"><a href="net__processing_8h.html#a09ba6681dd87e0136d25acc054a335a0">HEADERS_DOWNLOAD_TIMEOUT_BASE</a></div><div class="ttdeci">static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE</div><div class="ttdoc">Headers download timeout expressed in microseconds Timeout = base + per_header * (expected number of ...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00024">net_processing.h:24</a></div></div>
<div class="ttc" id="class_c_net_addr_html_a8fae7d32e83e9fbb9ce0216f896133c9"><div class="ttname"><a href="class_c_net_addr.html#a8fae7d32e83e9fbb9ce0216f896133c9">CNetAddr::GetHash</a></div><div class="ttdeci">uint64_t GetHash() const</div><div class="ttdef"><b>Definition:</b> <a href="netaddress_8cpp_source.html#l00392">netaddress.cpp:392</a></div></div>
<div class="ttc" id="netbase_8h_html"><div class="ttname"><a href="netbase_8h.html">netbase.h</a></div></div>
<div class="ttc" id="class_c_node_html_a3f3a08b1a2c85b1c6cf975b2bdb53171"><div class="ttname"><a href="class_c_node.html#a3f3a08b1a2c85b1c6cf975b2bdb53171">CNode::addrKnown</a></div><div class="ttdeci">CRollingBloomFilter addrKnown</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00891">net.h:891</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_ac7ee8c06837c7d2688e2d7e3d071bdbb"><div class="ttname"><a href="class_c_tx_mem_pool.html#ac7ee8c06837c7d2688e2d7e3d071bdbb">CTxMemPool::cs</a></div><div class="ttdeci">CCriticalSection cs</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8h_source.html#l00488">txmempool.h:488</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a43d9b7acd2254c2f6ae6b34a2d344038"><div class="ttname"><a href="net__processing_8cpp.html#a43d9b7acd2254c2f6ae6b34a2d344038">GetObjectExpiryInterval</a></div><div class="ttdeci">std::chrono::microseconds GetObjectExpiryInterval(int invType)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00736">net_processing.cpp:736</a></div></div>
<div class="ttc" id="protocol_8h_html_aefab12794628ce5447d5edb26c05f4f5"><div class="ttname"><a href="protocol_8h.html#aefab12794628ce5447d5edb26c05f4f5">MayHaveUsefulAddressDB</a></div><div class="ttdeci">static bool MayHaveUsefulAddressDB(ServiceFlags services)</div><div class="ttdoc">Checks if a peer with the given service flags may be capable of having a robust address-storage DB...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00353">protocol.h:353</a></div></div>
<div class="ttc" id="class_c_connman_html_a30095fabc2e1727514ad2f2d530a496d"><div class="ttname"><a href="class_c_connman.html#a30095fabc2e1727514ad2f2d530a496d">CConnman::GetReceiveFloodSize</a></div><div class="ttdeci">unsigned int GetReceiveFloodSize() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03643">net.cpp:3643</a></div></div>
<div class="ttc" id="blockencodings_8h_html_a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22"><div class="ttname"><a href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50ceaee0cfe0767680ec8c16bb91d3c1d9b22">READ_STATUS_FAILED</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00126">blockencodings.h:126</a></div></div>
<div class="ttc" id="class_c_governance_manager_html_a44147b0a9cf22ed16d3411fe119958e0"><div class="ttname"><a href="class_c_governance_manager.html#a44147b0a9cf22ed16d3411fe119958e0">CGovernanceManager::SerializeVoteForHash</a></div><div class="ttdeci">bool SerializeVoteForHash(const uint256 &amp;nHash, CDataStream &amp;ss) const</div><div class="ttdef"><b>Definition:</b> <a href="governance_2governance_8cpp_source.html#l00080">governance.cpp:80</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_af659195932e1bac2ed2bdd1cda6d2e2b"><div class="ttname"><a href="namespace_net_msg_type.html#af659195932e1bac2ed2bdd1cda6d2e2b">NetMsgType::REJECT</a></div><div class="ttdeci">const char * REJECT</div><div class="ttdoc">The reject message informs the receiving node that one of its previous messages has been rejected...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00037">protocol.cpp:37</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ac880655d6e6468a46d21e713e3f6e3de"><div class="ttname"><a href="net__processing_8cpp.html#ac880655d6e6468a46d21e713e3f6e3de">LimitOrphanTxSize</a></div><div class="ttdeci">unsigned int LimitOrphanTxSize(unsigned int nMaxOrphansSize)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00983">net_processing.cpp:983</a></div></div>
<div class="ttc" id="policy_2fees_8h_html"><div class="ttname"><a href="policy_2fees_8h.html">fees.h</a></div></div>
<div class="ttc" id="class_c_block_header_and_short_tx_i_ds_html"><div class="ttname"><a href="class_c_block_header_and_short_tx_i_ds.html">CBlockHeaderAndShortTxIDs</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00131">blockencodings.h:131</a></div></div>
<div class="ttc" id="validation_8h_html_a42afcf61a20d8754d8285f6a1f958134"><div class="ttname"><a href="validation_8h.html#a42afcf61a20d8754d8285f6a1f958134">MAX_UNCONNECTING_HEADERS</a></div><div class="ttdeci">static const int MAX_UNCONNECTING_HEADERS</div><div class="ttdoc">Maximum number of unconnecting headers announcements before DoS score. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00136">validation.h:136</a></div></div>
<div class="ttc" id="class_c_connman_html_ac95687bc3457cbc25a78abcc2a5cc7fc"><div class="ttname"><a href="class_c_connman.html#ac95687bc3457cbc25a78abcc2a5cc7fc">CConnman::CheckIncomingNonce</a></div><div class="ttdeci">bool CheckIncomingNonce(uint64_t nonce)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00386">net.cpp:386</a></div></div>
<div class="ttc" id="class_block_transactions_request_html"><div class="ttname"><a href="class_block_transactions_request.html">BlockTransactionsRequest</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00029">blockencodings.h:29</a></div></div>
<div class="ttc" id="class_c_message_header_html_aa2f294417b6095d10135ba838fcb7902"><div class="ttname"><a href="class_c_message_header.html#aa2f294417b6095d10135ba838fcb7902">CMessageHeader::MESSAGE_START_SIZE</a></div><div class="ttdeci">static constexpr size_t MESSAGE_START_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00031">protocol.h:31</a></div></div>
<div class="ttc" id="class_c_node_html_a44bf609f563467f4998510c0b2a51951"><div class="ttname"><a href="class_c_node.html#a44bf609f563467f4998510c0b2a51951">CNode::addr</a></div><div class="ttdeci">const CAddress addr</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00834">net.h:834</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a7a51f1ef81fa21178b6e241937934fed"><div class="ttname"><a href="namespace_net_msg_type.html#a7a51f1ef81fa21178b6e241937934fed">NetMsgType::GETBLOCKS</a></div><div class="ttdeci">const char * GETBLOCKS</div><div class="ttdoc">The getblocks message requests an inv message that provides block header hashes starting from a parti...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00024">protocol.cpp:24</a></div></div>
<div class="ttc" id="class_c_node_html_a4d571070a8b80c094ee1fea990ce29d3"><div class="ttname"><a href="class_c_node.html#a4d571070a8b80c094ee1fea990ce29d3">CNode::nTimeConnected</a></div><div class="ttdeci">const int64_t nTimeConnected</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00828">net.h:828</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a20db0a2ffae94ecbcfe2e39017ac7ef9"><div class="ttname"><a href="class_peer_logic_validation.html#a20db0a2ffae94ecbcfe2e39017ac7ef9">PeerLogicValidation::m_stale_tip_check_time</a></div><div class="ttdeci">int64_t m_stale_tip_check_time</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00076">net_processing.h:76</a></div></div>
<div class="ttc" id="spork_8cpp_html_af6873019c3095ea6b554795e4040395c"><div class="ttname"><a href="spork_8cpp.html#af6873019c3095ea6b554795e4040395c">sporkManager</a></div><div class="ttdeci">CSporkManager sporkManager</div><div class="ttdef"><b>Definition:</b> <a href="spork_8cpp_source.html#l00029">spork.cpp:29</a></div></div>
<div class="ttc" id="classllmq_1_1_c_quorum_block_processor_html_a37b9067401b0136f82fa78b80bfe1777"><div class="ttname"><a href="classllmq_1_1_c_quorum_block_processor.html#a37b9067401b0136f82fa78b80bfe1777">llmq::CQuorumBlockProcessor::HasMinableCommitment</a></div><div class="ttdeci">bool HasMinableCommitment(const uint256 &amp;hash)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__blockprocessor_8cpp_source.html#l00481">quorums_blockprocessor.cpp:481</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a6be1affbdc736f974fd8acb52d1439b9"><div class="ttname"><a href="class_peer_logic_validation.html#a6be1affbdc736f974fd8acb52d1439b9">PeerLogicValidation::BlockConnected</a></div><div class="ttdeci">void BlockConnected(const std::shared_ptr&lt; const CBlock &gt; &amp;pblock, const CBlockIndex *pindexConnected, const std::vector&lt; CTransactionRef &gt; &amp;vtxConflicted) override</div><div class="ttdoc">Notifies listeners of a block being connected. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01092">net_processing.cpp:1092</a></div></div>
<div class="ttc" id="util_8h_html_a44920f41b96476395cffed459d0c8835"><div class="ttname"><a href="util_8h.html#a44920f41b96476395cffed459d0c8835">LogPrint</a></div><div class="ttdeci">#define LogPrint(category,...)</div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00214">util.h:214</a></div></div>
<div class="ttc" id="util_8cpp_html_afcb801683f7acaab09f94e56eb60b603"><div class="ttname"><a href="util_8cpp.html#afcb801683f7acaab09f94e56eb60b603">PrintExceptionContinue</a></div><div class="ttdeci">void PrintExceptionContinue(const std::exception_ptr pex, const char *pszExceptionOrigin)</div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00891">util.cpp:891</a></div></div>
<div class="ttc" id="validation_8h_html_a0c4c31af4a876d52f31d171760a9b411"><div class="ttname"><a href="validation_8h.html#a0c4c31af4a876d52f31d171760a9b411">fReindex</a></div><div class="ttdeci">std::atomic_bool fReindex</div></div>
<div class="ttc" id="namespace_net_msg_type_html_aaf8228cc7b3374862bcb3d79f5ff38e6"><div class="ttname"><a href="namespace_net_msg_type.html#aaf8228cc7b3374862bcb3d79f5ff38e6">NetMsgType::VERACK</a></div><div class="ttdeci">const char * VERACK</div><div class="ttdoc">The verack message acknowledges a previously-received version message, informing the connecting node ...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00019">protocol.cpp:19</a></div></div>
<div class="ttc" id="class_c_m_n_auth_html_a6ca18dc077a8867aae448261300f3333"><div class="ttname"><a href="class_c_m_n_auth.html#a6ca18dc077a8867aae448261300f3333">CMNAuth::ProcessMessage</a></div><div class="ttdeci">static void ProcessMessage(CNode *pnode, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="mnauth_8cpp_source.html#l00057">mnauth.cpp:57</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_contribution_html"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_contribution.html">llmq::CDKGContribution</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsession_8h_source.html#l00036">quorums_dkgsession.h:36</a></div></div>
<div class="ttc" id="class_c_block_header_html_af0239f86a13f622a826e9eea66b2d7f3"><div class="ttname"><a href="class_c_block_header.html#af0239f86a13f622a826e9eea66b2d7f3">CBlockHeader::GetHash</a></div><div class="ttdeci">uint256 GetHash() const</div><div class="ttdef"><b>Definition:</b> <a href="block_8cpp_source.html#l00014">block.cpp:14</a></div></div>
<div class="ttc" id="util_8cpp_html_a8e02420c2f7c53579ccb90acf301ae75"><div class="ttname"><a href="util_8cpp.html#a8e02420c2f7c53579ccb90acf301ae75">fLogIPs</a></div><div class="ttdeci">bool fLogIPs</div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00115">util.cpp:115</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aafd21e2e5beded09e8826d455ac8e17b"><div class="ttname"><a href="net__processing_8cpp.html#aafd21e2e5beded09e8826d455ac8e17b">ProcessMessage</a></div><div class="ttdeci">static bool ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, int64_t nTimeReceived, const CChainParams &amp;chainparams, CConnman *connman, const std::atomic&lt; bool &gt; &amp;interruptMsgProc)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l02002">net_processing.cpp:2002</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a424f64542eaaf2a84d57e3c4b7b3d34b"><div class="ttname"><a href="namespace_net_msg_type.html#a424f64542eaaf2a84d57e3c4b7b3d34b">NetMsgType::QSENDRECSIGS</a></div><div class="ttdeci">const char * QSENDRECSIGS</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00062">protocol.cpp:62</a></div></div>
<div class="ttc" id="class_c_masternode_sync_html_aa61c8de4587e4135e08cf860da991542"><div class="ttname"><a href="class_c_masternode_sync.html#aa61c8de4587e4135e08cf860da991542">CMasternodeSync::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv)</div><div class="ttdef"><b>Definition:</b> <a href="masternode-sync_8cpp_source.html#l00089">masternode-sync.cpp:89</a></div></div>
<div class="ttc" id="class_c_validation_state_html"><div class="ttname"><a href="class_c_validation_state.html">CValidationState</a></div><div class="ttdoc">Capture information about block/transaction validation. </div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00022">validation.h:22</a></div></div>
<div class="ttc" id="class_c_m_n_auth_html_a388fbfbd32337976fc3916f52dfd0e73"><div class="ttname"><a href="class_c_m_n_auth.html#a388fbfbd32337976fc3916f52dfd0e73">CMNAuth::PushMNAUTH</a></div><div class="ttdeci">static void PushMNAUTH(CNode *pnode, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="mnauth_8cpp_source.html#l00019">mnauth.cpp:19</a></div></div>
<div class="ttc" id="class_c_node_html_a2349010606131fe65879e5a44d9ab37e"><div class="ttname"><a href="class_c_node.html#a2349010606131fe65879e5a44d9ab37e">CNode::fPingQueued</a></div><div class="ttdeci">std::atomic&lt; bool &gt; fPingQueued</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00932">net.h:932</a></div></div>
<div class="ttc" id="classuint256_html"><div class="ttname"><a href="classuint256.html">uint256</a></div><div class="ttdoc">256-bit opaque blob. </div><div class="ttdef"><b>Definition:</b> <a href="uint256_8h_source.html#l00123">uint256.h:123</a></div></div>
<div class="ttc" id="class_args_manager_html_a7c11364ea29c86c5c69d324acd81b543"><div class="ttname"><a href="class_args_manager.html#a7c11364ea29c86c5c69d324acd81b543">ArgsManager::GetDevNetName</a></div><div class="ttdeci">std::string GetDevNetName() const</div><div class="ttdoc">Looks for -devnet and returns either &quot;devnet-&lt;name&gt;&quot; or simply &quot;devnet&quot; if no name was specified...</div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l01045">util.cpp:1045</a></div></div>
<div class="ttc" id="class_c_node_html_ac3054eb6ade84e8968f032ce3e700f6a"><div class="ttname"><a href="class_c_node.html#ac3054eb6ade84e8968f032ce3e700f6a">CNode::AddInventoryKnown</a></div><div class="ttdeci">void AddInventoryKnown(const CInv &amp;inv)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l01041">net.h:1041</a></div></div>
<div class="ttc" id="class_c_address_html_ac1c44aac968b11f90ce529b133ae4e9b"><div class="ttname"><a href="class_c_address.html#ac1c44aac968b11f90ce529b133ae4e9b">CAddress::nTime</a></div><div class="ttdeci">unsigned int nTime</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00390">protocol.h:390</a></div></div>
<div class="ttc" id="net_8cpp_html_af6de8e47b01a96206402ddef734114f2"><div class="ttname"><a href="net_8cpp.html#af6de8e47b01a96206402ddef734114f2">IsReachable</a></div><div class="ttdeci">bool IsReachable(enum Network net)</div><div class="ttdoc">check whether a given network is one we can probably connect to </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00316">net.cpp:316</a></div></div>
<div class="ttc" id="util_8cpp_html_a934b7735a5308149ab1bf3ca9fc4d694"><div class="ttname"><a href="util_8cpp.html#a934b7735a5308149ab1bf3ca9fc4d694">gArgs</a></div><div class="ttdeci">ArgsManager gArgs</div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00108">util.cpp:108</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a94d0bd41756163cb0cc58f36d8d6676a"><div class="ttname"><a href="net__processing_8cpp.html#a94d0bd41756163cb0cc58f36d8d6676a">MAX_GETDATA_SZ</a></div><div class="ttdeci">static const unsigned int MAX_GETDATA_SZ</div><div class="ttdoc">Limit to avoid sending big packets. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00077">net_processing.cpp:77</a></div></div>
<div class="ttc" id="class_c_address_html_a24e2309d92694a5a234751634bdf0458"><div class="ttname"><a href="class_c_address.html#a24e2309d92694a5a234751634bdf0458">CAddress::nServices</a></div><div class="ttdeci">ServiceFlags nServices</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00387">protocol.h:387</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a4ed18bc626b7e64f822912cd1057e5cb"><div class="ttname"><a href="class_peer_logic_validation.html#a4ed18bc626b7e64f822912cd1057e5cb">PeerLogicValidation::NewPoWValidBlock</a></div><div class="ttdeci">void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr&lt; const CBlock &gt; &amp;pblock) override</div><div class="ttdoc">Notifies listeners that a block which builds directly on our current tip has been received and connec...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01145">net_processing.cpp:1145</a></div></div>
<div class="ttc" id="threadsafety_8h_html_a0e2e86b0f11d9778240b0a0b263047b1"><div class="ttname"><a href="threadsafety_8h.html#a0e2e86b0f11d9778240b0a0b263047b1">EXCLUSIVE_LOCKS_REQUIRED</a></div><div class="ttdeci">#define EXCLUSIVE_LOCKS_REQUIRED(...)</div><div class="ttdef"><b>Definition:</b> <a href="threadsafety_8h_source.html#l00050">threadsafety.h:50</a></div></div>
<div class="ttc" id="class_c_block_html_a33fcab2e8b903f5be812c714cee42626"><div class="ttname"><a href="class_c_block.html#a33fcab2e8b903f5be812c714cee42626">CBlock::vtx</a></div><div class="ttdeci">std::vector&lt; CTransactionRef &gt; vtx</div><div class="ttdef"><b>Definition:</b> <a href="block_8h_source.html#l00076">block.h:76</a></div></div>
<div class="ttc" id="class_c_node_html_a98b31d12a78834edc4a12ff48747d78d"><div class="ttname"><a href="class_c_node.html#a98b31d12a78834edc4a12ff48747d78d">CNode::receivedMNAuthChallenge</a></div><div class="ttdeci">uint256 receivedMNAuthChallenge</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00940">net.h:940</a></div></div>
<div class="ttc" id="validation_8cpp_html_a86ed1d2d0837b905d74c2e4192b6c06a"><div class="ttname"><a href="validation_8cpp.html#a86ed1d2d0837b905d74c2e4192b6c06a">FormatStateMessage</a></div><div class="ttdeci">std::string FormatStateMessage(const CValidationState &amp;state)</div><div class="ttdoc">Convert CValidationState to a human-readable message for logging. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00513">validation.cpp:513</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a216e33c20d428fd73b444471958301e0"><div class="ttname"><a href="net__processing_8cpp.html#a216e33c20d428fd73b444471958301e0">setMisbehaving</a></div><div class="ttdeci">std::set&lt; NodeId &gt; setMisbehaving</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01947">net_processing.cpp:1947</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ab7e23cc7eff00496b50b04e9e98f1b85">MSG_DSTX</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00409">protocol.h:409</a></div></div>
<div class="ttc" id="class_compare_inv_mempool_order_html_ab81595ec0e2a66d6be86c893e309a975"><div class="ttname"><a href="class_compare_inv_mempool_order.html#ab81595ec0e2a66d6be86c893e309a975">CompareInvMempoolOrder::CompareInvMempoolOrder</a></div><div class="ttdeci">CompareInvMempoolOrder(CTxMemPool *_mempool)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03803">net_processing.cpp:3803</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a5b20d74bd9d268e7d73be293bfe68b8a"><div class="ttname"><a href="namespace_net_msg_type.html#a5b20d74bd9d268e7d73be293bfe68b8a">NetMsgType::CMPCTBLOCK</a></div><div class="ttdeci">const char * CMPCTBLOCK</div><div class="ttdoc">Contains a CBlockHeaderAndShortTxIDs object - providing a header and list of &quot;short txids&quot;...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00040">protocol.cpp:40</a></div></div>
<div class="ttc" id="addrman_8h_html"><div class="ttname"><a href="addrman_8h.html">addrman.h</a></div></div>
<div class="ttc" id="struct_iterator_comparator_html_a555d49207b43bdc2e33d06581254d6c1"><div class="ttname"><a href="struct_iterator_comparator.html#a555d49207b43bdc2e33d06581254d6c1">IteratorComparator::operator()</a></div><div class="ttdeci">bool operator()(const I &amp;a, const I &amp;b) const</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00085">net_processing.cpp:85</a></div></div>
<div class="ttc" id="class_c_node_html_a25c9b62c42159cc94c6e8ede9ad0ed9d"><div class="ttname"><a href="class_c_node.html#a25c9b62c42159cc94c6e8ede9ad0ed9d">CNode::fFeeler</a></div><div class="ttdeci">bool fFeeler</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00846">net.h:846</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html"><div class="ttname"><a href="class_c_tx_mem_pool.html">CTxMemPool</a></div><div class="ttdoc">CTxMemPool stores valid-according-to-the-current-best-chain transactions that may be included in the ...</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8h_source.html#l00442">txmempool.h:442</a></div></div>
<div class="ttc" id="class_c_node_html_a41accf3f4c9d4aacfa013053346266a2"><div class="ttname"><a href="class_c_node.html#a41accf3f4c9d4aacfa013053346266a2">CNode::verifiedProRegTxHash</a></div><div class="ttdeci">uint256 verifiedProRegTxHash</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00941">net.h:941</a></div></div>
<div class="ttc" id="class_c_node_html_a973d29d89889cba8fe7909b1b8959592"><div class="ttname"><a href="class_c_node.html#a973d29d89889cba8fe7909b1b8959592">CNode::nLastTXTime</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nLastTXTime</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00918">net.h:918</a></div></div>
<div class="ttc" id="namespace_b_c_log_html_a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8"><div class="ttname"><a href="namespace_b_c_log.html#a7f38d795c5b3ac39b8f87a13ddfec541add2e27f6f8b22df531c3b8919d9e46d8">BCLog::MEMPOOL</a></div><div class="ttdef"><b>Definition:</b> <a href="util_8h_source.html#l00112">util.h:112</a></div></div>
<div class="ttc" id="class_c_private_send_broadcast_tx_html"><div class="ttname"><a href="class_c_private_send_broadcast_tx.html">CPrivateSendBroadcastTx</a></div><div class="ttdoc">Helper class to store mixing transaction (tx) information. </div><div class="ttdef"><b>Definition:</b> <a href="privatesend_8h_source.html#l00291">privatesend.h:291</a></div></div>
<div class="ttc" id="class_c_node_html_addb44bcf6a96b3e18ef617b77caf6654"><div class="ttname"><a href="class_c_node.html#addb44bcf6a96b3e18ef617b77caf6654">CNode::fInbound</a></div><div class="ttdeci">const bool fInbound</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00851">net.h:851</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a8544d756fb965d312077e9feccb0f4a4"><div class="ttname"><a href="class_c_tx_mem_pool.html#a8544d756fb965d312077e9feccb0f4a4">CTxMemPool::CompareDepthAndScore</a></div><div class="ttdeci">bool CompareDepthAndScore(const uint256 &amp;hasha, const uint256 &amp;hashb)</div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01135">txmempool.cpp:1135</a></div></div>
<div class="ttc" id="privatesend-client_8cpp_html_ad3fbbb845524ff48bd48ca41ea5e51a8"><div class="ttname"><a href="privatesend-client_8cpp.html#ad3fbbb845524ff48bd48ca41ea5e51a8">privateSendClient</a></div><div class="ttdeci">CPrivateSendClientManager privateSendClient</div><div class="ttdef"><b>Definition:</b> <a href="privatesend-client_8cpp_source.html#l00025">privatesend-client.cpp:25</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_aae4bc03700ef51a1dd9e63a6c9dfd47f"><div class="ttname"><a href="net__processing_8cpp.html#aae4bc03700ef51a1dd9e63a6c9dfd47f">INBOUND_PEER_TX_DELAY</a></div><div class="ttdeci">static constexpr std::chrono::microseconds INBOUND_PEER_TX_DELAY</div><div class="ttdoc">How many microseconds to delay requesting transactions from inbound peers. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00067">net_processing.cpp:67</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a8f94dab7cc977c0b2e06e2f4bf41b84b"><div class="ttname"><a href="namespace_net_msg_type.html#a8f94dab7cc977c0b2e06e2f4bf41b84b">NetMsgType::QCOMPLAINT</a></div><div class="ttdeci">const char * QCOMPLAINT</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00065">protocol.cpp:65</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a9d817cb9e570c539378f8c17a759c157"><div class="ttname"><a href="net__processing_8cpp.html#a9d817cb9e570c539378f8c17a759c157">RelayAddress</a></div><div class="ttdeci">static void RelayAddress(const CAddress &amp;addr, bool fReachable, CConnman *connman)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01344">net_processing.cpp:1344</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a79d16fca661ece8c17e786943721fd34"><div class="ttname"><a href="namespace_net_msg_type.html#a79d16fca661ece8c17e786943721fd34">NetMsgType::VERSION</a></div><div class="ttdeci">const char * VERSION</div><div class="ttdoc">The version message provides information about the transmitting node to the receiving node at the beg...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00018">protocol.cpp:18</a></div></div>
<div class="ttc" id="class_c_data_stream_html_a5542e71bd7af2ab7cd7be0f381d39cb5"><div class="ttname"><a href="class_c_data_stream.html#a5542e71bd7af2ab7cd7be0f381d39cb5">CDataStream::reserve</a></div><div class="ttdeci">void reserve(size_type n)</div><div class="ttdef"><b>Definition:</b> <a href="streams_8h_source.html#l00197">streams.h:197</a></div></div>
<div class="ttc" id="class_c_merkle_block_html_a73bbbdcb5d83588b15461c02d0228999"><div class="ttname"><a href="class_c_merkle_block.html#a73bbbdcb5d83588b15461c02d0228999">CMerkleBlock::vMatchedTxn</a></div><div class="ttdeci">std::vector&lt; std::pair&lt; unsigned int, uint256 &gt; &gt; vMatchedTxn</div><div class="ttdoc">Public only for unit testing and relay testing (not relayed). </div><div class="ttdef"><b>Definition:</b> <a href="merkleblock_8h_source.html#l00140">merkleblock.h:140</a></div></div>
<div class="ttc" id="class_c_block_index_html"><div class="ttname"><a href="class_c_block_index.html">CBlockIndex</a></div><div class="ttdoc">The block chain is a tree shaped structure starting with the genesis block at the root...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00170">chain.h:170</a></div></div>
<div class="ttc" id="chainparams_8cpp_html_ace5c5b706d71a324a417dd2db394fd4a"><div class="ttname"><a href="chainparams_8cpp.html#ace5c5b706d71a324a417dd2db394fd4a">Params</a></div><div class="ttdeci">const CChainParams &amp; Params()</div><div class="ttdoc">Return the currently selected parameters. </div><div class="ttdef"><b>Definition:</b> <a href="chainparams_8cpp_source.html#l00947">chainparams.cpp:947</a></div></div>
<div class="ttc" id="quorums__instantsend_8h_html"><div class="ttname"><a href="quorums__instantsend_8h.html">quorums_instantsend.h</a></div></div>
<div class="ttc" id="class_c_node_html_a1a1c0d94de0197c5c4abf5a8d13364f3"><div class="ttname"><a href="class_c_node.html#a1a1c0d94de0197c5c4abf5a8d13364f3">CNode::hashContinue</a></div><div class="ttdeci">uint256 hashContinue</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00886">net.h:886</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a98bccafe6dffb0ba0adf1e78ce7b9c4c"><div class="ttname"><a href="net__processing_8cpp.html#a98bccafe6dffb0ba0adf1e78ce7b9c4c">UpdateLastBlockAnnounceTime</a></div><div class="ttdeci">void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00819">net_processing.cpp:819</a></div></div>
<div class="ttc" id="class_c_node_html_ad3096c14b54aa39a02edb63a4a734c3e"><div class="ttname"><a href="class_c_node.html#ad3096c14b54aa39a02edb63a4a734c3e">CNode::fWhitelisted</a></div><div class="ttdeci">bool fWhitelisted</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00845">net.h:845</a></div></div>
<div class="ttc" id="classllmq_1_1_c_signing_manager_html_a6d4732770e0a6ba21442fd670c0da93a"><div class="ttname"><a href="classllmq_1_1_c_signing_manager.html#a6d4732770e0a6ba21442fd670c0da93a">llmq::CSigningManager::AlreadyHave</a></div><div class="ttdeci">bool AlreadyHave(const CInv &amp;inv)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing_8cpp_source.html#l00447">quorums_signing.cpp:447</a></div></div>
<div class="ttc" id="version_8h_html_a7ef2601209957b98b7cc1a186f8e6e62"><div class="ttname"><a href="version_8h.html#a7ef2601209957b98b7cc1a186f8e6e62">MIN_PEER_PROTO_VERSION</a></div><div class="ttdeci">static const int MIN_PEER_PROTO_VERSION</div><div class="ttdoc">disconnect from peers older than this proto version </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00023">version.h:23</a></div></div>
<div class="ttc" id="version_8h_html_a4e2497f7c9c4319adcaf945159ec63f4"><div class="ttname"><a href="version_8h.html#a4e2497f7c9c4319adcaf945159ec63f4">PROTOCOL_VERSION</a></div><div class="ttdeci">static const int PROTOCOL_VERSION</div><div class="ttdoc">network protocol versioning </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00014">version.h:14</a></div></div>
<div class="ttc" id="class_c_net_processing_cleanup_html_a110dfb98118bb2377fc7662fd05e4269"><div class="ttname"><a href="class_c_net_processing_cleanup.html#a110dfb98118bb2377fc7662fd05e4269">CNetProcessingCleanup::~CNetProcessingCleanup</a></div><div class="ttdeci">~CNetProcessingCleanup()</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l04418">net_processing.cpp:4418</a></div></div>
<div class="ttc" id="class_partially_downloaded_block_html_ad8f41f80c9aba45402fc1033a478a97b"><div class="ttname"><a href="class_partially_downloaded_block.html#ad8f41f80c9aba45402fc1033a478a97b">PartiallyDownloadedBlock::IsTxAvailable</a></div><div class="ttdeci">bool IsTxAvailable(size_t index) const</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8cpp_source.html#l00172">blockencodings.cpp:172</a></div></div>
<div class="ttc" id="net__processing_8h_html_aff73fe9e1950b05a035cfb90019dab50"><div class="ttname"><a href="net__processing_8h.html#aff73fe9e1950b05a035cfb90019dab50">CHAIN_SYNC_TIMEOUT</a></div><div class="ttdeci">static constexpr int64_t CHAIN_SYNC_TIMEOUT</div><div class="ttdoc">Timeout for (unprotected) outbound peers to sync to our chainwork, in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00031">net_processing.h:31</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_complaint_html"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_complaint.html">llmq::CDKGComplaint</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsession_8h_source.html#l00088">quorums_dkgsession.h:88</a></div></div>
<div class="ttc" id="net__processing_8h_html_a9d3753f6b45e9bc12172e63922e704fd"><div class="ttname"><a href="net__processing_8h.html#a9d3753f6b45e9bc12172e63922e704fd">DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN</a></div><div class="ttdeci">static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN</div><div class="ttdoc">Default number of orphan+recently-replaced txn to keep around for block reconstruction. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00020">net_processing.h:20</a></div></div>
<div class="ttc" id="validation_8cpp_html_a69b1be2d5750e0ba945e2a0a0f38cadc"><div class="ttname"><a href="validation_8cpp.html#a69b1be2d5750e0ba945e2a0a0f38cadc">AcceptToMemoryPool</a></div><div class="ttdeci">bool AcceptToMemoryPool(CTxMemPool &amp;pool, CValidationState &amp;state, const CTransactionRef &amp;tx, bool *pfMissingInputs, bool bypass_limits, const CAmount nAbsurdFee, bool fDryRun)</div><div class="ttdoc">(try to) add transaction to memory pool </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00890">validation.cpp:890</a></div></div>
<div class="ttc" id="class_args_manager_html_adb5d644d273b3a259f792affcdca8283"><div class="ttname"><a href="class_args_manager.html#adb5d644d273b3a259f792affcdca8283">ArgsManager::GetArg</a></div><div class="ttdeci">std::string GetArg(const std::string &amp;strArg, const std::string &amp;strDefault) const</div><div class="ttdoc">Return string argument or default value. </div><div class="ttdef"><b>Definition:</b> <a href="util_8cpp_source.html#l00808">util.cpp:808</a></div></div>
<div class="ttc" id="validation_8cpp_html_af43d57aa8b46a53839777e8b670c9d66"><div class="ttname"><a href="validation_8cpp.html#af43d57aa8b46a53839777e8b670c9d66">FindForkInGlobalIndex</a></div><div class="ttdeci">CBlockIndex * FindForkInGlobalIndex(const CChain &amp;chain, const CBlockLocator &amp;locator)</div><div class="ttdoc">Find the last common block between the parameter chain and a locator. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00284">validation.cpp:284</a></div></div>
<div class="ttc" id="timedata_8cpp_html_a09f81b9c7650f898cf3cf305b87547e6"><div class="ttname"><a href="timedata_8cpp.html#a09f81b9c7650f898cf3cf305b87547e6">GetAdjustedTime</a></div><div class="ttdeci">int64_t GetAdjustedTime()</div><div class="ttdef"><b>Definition:</b> <a href="timedata_8cpp_source.html#l00035">timedata.cpp:35</a></div></div>
<div class="ttc" id="protocol_8cpp_html_a4a92bd3e5b80138a55fafae4c4770ecd"><div class="ttname"><a href="protocol_8cpp.html#a4a92bd3e5b80138a55fafae4c4770ecd">GetDesirableServiceFlags</a></div><div class="ttdeci">ServiceFlags GetDesirableServiceFlags(ServiceFlags services)</div><div class="ttdoc">Gets the set of service flags which are &quot;desirable&quot; for a given peer. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00201">protocol.cpp:201</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a089eec67c3dbd97a69949d830f71d3be"><div class="ttname"><a href="net__processing_8cpp.html#a089eec67c3dbd97a69949d830f71d3be">BlockRequestAllowed</a></div><div class="ttdeci">static bool BlockRequestAllowed(const CBlockIndex *pindex, const Consensus::Params &amp;consensusParams)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01070">net_processing.cpp:1070</a></div></div>
<div class="ttc" id="class_c_node_html_a81d6deb661c7386a453e0966d2dbc36f"><div class="ttname"><a href="class_c_node.html#a81d6deb661c7386a453e0966d2dbc36f">CNode::cs_vProcessMsg</a></div><div class="ttdeci">CCriticalSection cs_vProcessMsg</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00816">net.h:816</a></div></div>
<div class="ttc" id="class_c_node_html_a0a55cea2748b1837610b2caed8069a90"><div class="ttname"><a href="class_c_node.html#a0a55cea2748b1837610b2caed8069a90">CNode::SetSendVersion</a></div><div class="ttdeci">void SetSendVersion(int nVersionIn)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00873">net.cpp:873</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ad09b4bf7c25d4932eacafb9dd6832299"><div class="ttname"><a href="net__processing_8cpp.html#ad09b4bf7c25d4932eacafb9dd6832299">ProcessOrphanTx</a></div><div class="ttdeci">static void ProcessOrphanTx(CConnman *connman, std::set&lt; uint256 &gt; &amp;orphan_work_set) EXCLUSIVE_LOCKS_REQUIRED(cs_main</div></div>
<div class="ttc" id="privatesend-server_8h_html"><div class="ttname"><a href="privatesend-server_8h.html">privatesend-server.h</a></div></div>
<div class="ttc" id="classllmq_1_1_c_chain_locks_handler_html_a48c5e03d83e3aeb3b06b0f7d3e950289"><div class="ttname"><a href="classllmq_1_1_c_chain_locks_handler.html#a48c5e03d83e3aeb3b06b0f7d3e950289">llmq::CChainLocksHandler::AlreadyHave</a></div><div class="ttdeci">bool AlreadyHave(const CInv &amp;inv)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__chainlocks_8cpp_source.html#l00068">quorums_chainlocks.cpp:68</a></div></div>
<div class="ttc" id="class_c_chain_html_a578545bde95163bee37b1be28e7b2755"><div class="ttname"><a href="class_c_chain.html#a578545bde95163bee37b1be28e7b2755">CChain::Tip</a></div><div class="ttdeci">CBlockIndex * Tip() const</div><div class="ttdoc">Returns the index entry for the tip of this chain, or nullptr if none. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00453">chain.h:453</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a124965d7310e0df08cc027d4e1cbbe7b"><div class="ttname"><a href="class_peer_logic_validation.html#a124965d7310e0df08cc027d4e1cbbe7b">PeerLogicValidation::BlockChecked</a></div><div class="ttdeci">void BlockChecked(const CBlock &amp;block, const CValidationState &amp;state) override</div><div class="ttdoc">Notifies listeners of a block validation result. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01217">net_processing.cpp:1217</a></div></div>
<div class="ttc" id="class_c_connman_html_a36cf799d267785276497583398dfd4cd"><div class="ttname"><a href="class_c_connman.html#a36cf799d267785276497583398dfd4cd">CConnman::SetBestHeight</a></div><div class="ttdeci">void SetBestHeight(int height)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03633">net.cpp:3633</a></div></div>
<div class="ttc" id="serialize_8h_html_a78e63691a056ce2368984400605e4f6e"><div class="ttname"><a href="serialize_8h.html#a78e63691a056ce2368984400605e4f6e">LIMITED_STRING</a></div><div class="ttdeci">#define LIMITED_STRING(obj, n)</div><div class="ttdef"><b>Definition:</b> <a href="serialize_8h_source.html#l00377">serialize.h:377</a></div></div>
<div class="ttc" id="blockencodings_8h_html_a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff"><div class="ttname"><a href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea105d3aa9ec19f4c060b39c7fafba39ff">READ_STATUS_OK</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00124">blockencodings.h:124</a></div></div>
<div class="ttc" id="version_8h_html_a04ad229ffd8c41a83118551a4d395205"><div class="ttname"><a href="version_8h.html#a04ad229ffd8c41a83118551a4d395205">CADDR_TIME_VERSION</a></div><div class="ttdeci">static const int CADDR_TIME_VERSION</div><div class="ttdoc">nTime field added to CAddress, starting with this version; if possible, avoid requesting addresses no...</div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00030">version.h:30</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a4a2fcba1719100c7e9a0caf97f6988f4"><div class="ttname"><a href="net__processing_8cpp.html#a4a2fcba1719100c7e9a0caf97f6988f4">EraseOrphansFor</a></div><div class="ttdeci">void EraseOrphansFor(NodeId peer)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00966">net_processing.cpp:966</a></div></div>
<div class="ttc" id="namespacellmq_html_a41c9d2058d9a5a58a3a7c29a42c7c1de"><div class="ttname"><a href="namespacellmq.html#a41c9d2058d9a5a58a3a7c29a42c7c1de">llmq::DEFAULT_WATCH_QUORUMS</a></div><div class="ttdeci">static const bool DEFAULT_WATCH_QUORUMS</div><div class="ttdef"><b>Definition:</b> <a href="quorums__init_8h_source.html#l00015">quorums_init.h:15</a></div></div>
<div class="ttc" id="class_c_node_html_a1ab8dcaa79a208ee8b9ce58587b206af"><div class="ttname"><a href="class_c_node.html#a1ab8dcaa79a208ee8b9ce58587b206af">CNode::nTimeOffset</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nTimeOffset</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00829">net.h:829</a></div></div>
<div class="ttc" id="class_c_node_html_a31b644122c610cf13fca18a6ccfbd164"><div class="ttname"><a href="class_c_node.html#a31b644122c610cf13fca18a6ccfbd164">CNode::GetLogString</a></div><div class="ttdeci">std::string GetLogString() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00750">net.cpp:750</a></div></div>
<div class="ttc" id="validation_8h_html_ad4d4718d1ec747708a31bc47aaa66578"><div class="ttname"><a href="validation_8h.html#ad4d4718d1ec747708a31bc47aaa66578">MAX_BLOCKS_TO_ANNOUNCE</a></div><div class="ttdeci">static const unsigned int MAX_BLOCKS_TO_ANNOUNCE</div><div class="ttdoc">Maximum number of headers to announce when relaying blocks with headers message. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00133">validation.h:133</a></div></div>
<div class="ttc" id="net_8cpp_html_acec0d60e03ec326ee67e5a6531a05154"><div class="ttname"><a href="net_8cpp.html#acec0d60e03ec326ee67e5a6531a05154">PoissonNextSend</a></div><div class="ttdeci">int64_t PoissonNextSend(int64_t now, int average_interval_seconds)</div><div class="ttdoc">Return a timestamp in the future (in microseconds) for exponentially distributed events. </div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03825">net.cpp:3825</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_aa53772dc0dfe3dc5a6ac2c99444a2afe"><div class="ttname"><a href="namespace_net_msg_type.html#aa53772dc0dfe3dc5a6ac2c99444a2afe">NetMsgType::GETDATA</a></div><div class="ttdeci">const char * GETDATA</div><div class="ttdoc">The getdata message requests one or more data objects from another node. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00022">protocol.cpp:22</a></div></div>
<div class="ttc" id="net_8cpp_html_a5067f8b9215406011fa3461be92d819c"><div class="ttname"><a href="net_8cpp.html#a5067f8b9215406011fa3461be92d819c">fListen</a></div><div class="ttdeci">bool fListen</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00113">net.cpp:113</a></div></div>
<div class="ttc" id="class_block_transactions_request_html_ac5fd8cb4f31a492d58d6c95dd369852e"><div class="ttname"><a href="class_block_transactions_request.html#ac5fd8cb4f31a492d58d6c95dd369852e">BlockTransactionsRequest::blockhash</a></div><div class="ttdeci">uint256 blockhash</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00032">blockencodings.h:32</a></div></div>
<div class="ttc" id="init_8cpp_html_a152c3d2ceeeaf7a300666dcbcc8bb945"><div class="ttname"><a href="init_8cpp.html#a152c3d2ceeeaf7a300666dcbcc8bb945">g_connman</a></div><div class="ttdeci">std::unique_ptr&lt; CConnman &gt; g_connman</div><div class="ttdef"><b>Definition:</b> <a href="init_8cpp_source.html#l00097">init.cpp:97</a></div></div>
<div class="ttc" id="class_c_node_html_a359647a8e7ad1fc72243b126b35729b6"><div class="ttname"><a href="class_c_node.html#a359647a8e7ad1fc72243b126b35729b6">CNode::fSuccessfullyConnected</a></div><div class="ttdeci">std::atomic_bool fSuccessfullyConnected</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00852">net.h:852</a></div></div>
<div class="ttc" id="class_c_chain_html_a677f034f599fd3bdf447e2b064e3cc5f"><div class="ttname"><a href="class_c_chain.html#a677f034f599fd3bdf447e2b064e3cc5f">CChain::GetLocator</a></div><div class="ttdeci">CBlockLocator GetLocator(const CBlockIndex *pindex=nullptr) const</div><div class="ttdoc">Return a CBlockLocator that refers to a block in this chain (by default the tip). ...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8cpp_source.html#l00023">chain.cpp:23</a></div></div>
<div class="ttc" id="class_c_sip_hasher_html"><div class="ttname"><a href="class_c_sip_hasher.html">CSipHasher</a></div><div class="ttdoc">SipHash-2-4. </div><div class="ttdef"><b>Definition:</b> <a href="hash_8h_source.html#l00266">hash.h:266</a></div></div>
<div class="ttc" id="class_c_net_msg_maker_html"><div class="ttname"><a href="class_c_net_msg_maker.html">CNetMsgMaker</a></div><div class="ttdef"><b>Definition:</b> <a href="netmessagemaker_8h_source.html#l00012">netmessagemaker.h:12</a></div></div>
<div class="ttc" id="sync_8h_html_a2bc429e4b3e667009b3aea3a6fab8e97"><div class="ttname"><a href="sync_8h.html#a2bc429e4b3e667009b3aea3a6fab8e97">AssertLockNotHeld</a></div><div class="ttdeci">#define AssertLockNotHeld(cs)</div><div class="ttdef"><b>Definition:</b> <a href="sync_8h_source.html#l00088">sync.h:88</a></div></div>
<div class="ttc" id="validation_8cpp_html_a1a5a2a93201a25764e8f16b1385b26b2"><div class="ttname"><a href="validation_8cpp.html#a1a5a2a93201a25764e8f16b1385b26b2">pblocktree</a></div><div class="ttdeci">std::unique_ptr&lt; CBlockTreeDB &gt; pblocktree</div><div class="ttdoc">Global variable that points to the active block tree (protected by cs_main) </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00301">validation.cpp:301</a></div></div>
<div class="ttc" id="random_8cpp_html_ada0c29949c4d1ac0cc027d93c4771423"><div class="ttname"><a href="random_8cpp.html#ada0c29949c4d1ac0cc027d93c4771423">GetRandBytes</a></div><div class="ttdeci">void GetRandBytes(unsigned char *buf, int num)</div><div class="ttdoc">Functions to gather random data via the OpenSSL PRNG. </div><div class="ttdef"><b>Definition:</b> <a href="random_8cpp_source.html#l00273">random.cpp:273</a></div></div>
<div class="ttc" id="tests_8c_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="tests_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a></div><div class="ttdeci">static int count</div><div class="ttdef"><b>Definition:</b> <a href="tests_8c_source.html#l00045">tests.c:45</a></div></div>
<div class="ttc" id="class_block_transactions_html_a6d42a1840f22d90b000a579db5de490d"><div class="ttname"><a href="class_block_transactions.html#a6d42a1840f22d90b000a579db5de490d">BlockTransactions::blockhash</a></div><div class="ttdeci">uint256 blockhash</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00074">blockencodings.h:74</a></div></div>
<div class="ttc" id="net_8h_html_a2f02122aa15cdc5ac394b010f97422e9"><div class="ttname"><a href="net_8h.html#a2f02122aa15cdc5ac394b010f97422e9">MAX_SUBVERSION_LENGTH</a></div><div class="ttdeci">static const unsigned int MAX_SUBVERSION_LENGTH</div><div class="ttdoc">Maximum length of strSubVer in version message. </div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00068">net.h:68</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_acca6adf5d9b189ce87be23364d84261a"><div class="ttname"><a href="net__processing_8cpp.html#acca6adf5d9b189ce87be23364d84261a">INVENTORY_BROADCAST_MAX_PER_1MB_BLOCK</a></div><div class="ttdeci">static constexpr unsigned int INVENTORY_BROADCAST_MAX_PER_1MB_BLOCK</div><div class="ttdoc">Maximum number of inventory items to send per transmission. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00128">net_processing.cpp:128</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a0138bc5c11da6ec5f5890a53ef15ca0c"><div class="ttname"><a href="namespace_net_msg_type.html#a0138bc5c11da6ec5f5890a53ef15ca0c">NetMsgType::DSTX</a></div><div class="ttdeci">const char * DSTX</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00053">protocol.cpp:53</a></div></div>
<div class="ttc" id="class_c_node_html_a0a2cdd01cb730536adf1780c3df66430"><div class="ttname"><a href="class_c_node.html#a0a2cdd01cb730536adf1780c3df66430">CNode::nVersion</a></div><div class="ttdeci">std::atomic&lt; int &gt; nVersion</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00838">net.h:838</a></div></div>
<div class="ttc" id="class_c_node_html_ab387bb0c4ffd42e3f0aea233dca0e301"><div class="ttname"><a href="class_c_node.html#ab387bb0c4ffd42e3f0aea233dca0e301">CNode::fRelayTxes</a></div><div class="ttdeci">bool fRelayTxes</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00861">net.h:861</a></div></div>
<div class="ttc" id="class_c_private_send_broadcast_tx_html_a2064670875bc7610705f6f816148144d"><div class="ttname"><a href="class_c_private_send_broadcast_tx.html#a2064670875bc7610705f6f816148144d">CPrivateSendBroadcastTx::CheckSignature</a></div><div class="ttdeci">bool CheckSignature(const CBLSPublicKey &amp;blsPubKey) const</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_2privatesend_8cpp_source.html#l00110">privatesend.cpp:110</a></div></div>
<div class="ttc" id="class_c_validation_state_html_a01490c3326ac7d47a64976747060ac46"><div class="ttname"><a href="class_c_validation_state.html#a01490c3326ac7d47a64976747060ac46">CValidationState::GetRejectCode</a></div><div class="ttdeci">unsigned int GetRejectCode() const</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00080">validation.h:80</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_af32be9381de5ac2bf6f40d606b39eef5"><div class="ttname"><a href="namespace_net_msg_type.html#af32be9381de5ac2bf6f40d606b39eef5">NetMsgType::MNAUTH</a></div><div class="ttdeci">const char * MNAUTH</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00077">protocol.cpp:77</a></div></div>
<div class="ttc" id="core__memusage_8h_html_a18e1e611662fcad8ad04ad0a85e84d08"><div class="ttname"><a href="core__memusage_8h.html#a18e1e611662fcad8ad04ad0a85e84d08">RecursiveDynamicUsage</a></div><div class="ttdeci">static size_t RecursiveDynamicUsage(const CScript &amp;script)</div><div class="ttdef"><b>Definition:</b> <a href="core__memusage_8h_source.html#l00012">core_memusage.h:12</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a847dcca3d1a4475ba1bfcaae6da76bad"><div class="ttname"><a href="class_peer_logic_validation.html#a847dcca3d1a4475ba1bfcaae6da76bad">PeerLogicValidation::ConsiderEviction</a></div><div class="ttdeci">void ConsiderEviction(CNode *pto, int64_t time_in_seconds)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03667">net_processing.cpp:3667</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991aa20b81ee7b9d9af13d5669dc7617efaf"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa20b81ee7b9d9af13d5669dc7617efaf">MSG_QUORUM_PREMATURE_COMMITMENT</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00421">protocol.h:421</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a591ac0a5e81101dd8021f1d7270ebc93"><div class="ttname"><a href="net__processing_8cpp.html#a591ac0a5e81101dd8021f1d7270ebc93">EraseObjectRequest</a></div><div class="ttdeci">void EraseObjectRequest(CNodeState *nodestate, const CInv &amp;inv) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00676">net_processing.cpp:676</a></div></div>
<div class="ttc" id="class_partially_downloaded_block_html_a04e1b3207e547c972e002c1ec472da1f"><div class="ttname"><a href="class_partially_downloaded_block.html#a04e1b3207e547c972e002c1ec472da1f">PartiallyDownloadedBlock::InitData</a></div><div class="ttdeci">ReadStatus InitData(const CBlockHeaderAndShortTxIDs &amp;cmpctblock, const std::vector&lt; std::pair&lt; uint256, CTransactionRef &gt;&gt; &amp;extra_txn)</div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8cpp_source.html#l00050">blockencodings.cpp:50</a></div></div>
<div class="ttc" id="namespacellmq_html_ab7c4af133e9f8609793106eaceffd8a3"><div class="ttname"><a href="namespacellmq.html#ab7c4af133e9f8609793106eaceffd8a3">llmq::quorumSigningManager</a></div><div class="ttdeci">CSigningManager * quorumSigningManager</div><div class="ttdef"><b>Definition:</b> <a href="quorums__signing_8cpp_source.html#l00025">quorums_signing.cpp:25</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a68df2f22acd8a7d824405c121f6f0708"><div class="ttname"><a href="namespace_net_msg_type.html#a68df2f22acd8a7d824405c121f6f0708">NetMsgType::QCONTRIB</a></div><div class="ttdeci">const char * QCONTRIB</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00064">protocol.cpp:64</a></div></div>
<div class="ttc" id="masternode-sync_8h_html"><div class="ttname"><a href="masternode-sync_8h.html">masternode-sync.h</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a0b5c0354f95776ad5af36adb95604339"><div class="ttname"><a href="class_peer_logic_validation.html#a0b5c0354f95776ad5af36adb95604339">PeerLogicValidation::FinalizeNode</a></div><div class="ttdeci">void FinalizeNode(NodeId nodeid, bool &amp;fUpdateConnectionTime) override</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00845">net_processing.cpp:845</a></div></div>
<div class="ttc" id="net_8h_html_a24ecbac59f1e63af4c4c8c112f00468d"><div class="ttname"><a href="net_8h.html#a24ecbac59f1e63af4c4c8c112f00468d">PING_INTERVAL</a></div><div class="ttdeci">static const int PING_INTERVAL</div><div class="ttdoc">Time between pings automatically sent out for latency probing and keepalive (in seconds). </div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00054">net.h:54</a></div></div>
<div class="ttc" id="struct_iterator_comparator_html"><div class="ttname"><a href="struct_iterator_comparator.html">IteratorComparator</a></div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00082">net_processing.cpp:82</a></div></div>
<div class="ttc" id="class_c_message_header_html_a981398bab090d100b34ef439ed496654"><div class="ttname"><a href="class_c_message_header.html#a981398bab090d100b34ef439ed496654">CMessageHeader::HEADER_SIZE</a></div><div class="ttdeci">static constexpr size_t HEADER_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00037">protocol.h:37</a></div></div>
<div class="ttc" id="class_c_node_html_ad145fde29bb13ec1f761bacbf8674df9"><div class="ttname"><a href="class_c_node.html#ad145fde29bb13ec1f761bacbf8674df9">CNode::m_limited_node</a></div><div class="ttdeci">bool m_limited_node</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00850">net.h:850</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991acfe58730aa4d3c27346bb5d864f9e236">MSG_ISLOCK</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00425">protocol.h:425</a></div></div>
<div class="ttc" id="version_8h_html_a262584ad779f848883e0cc89ef2781f8"><div class="ttname"><a href="version_8h.html#a262584ad779f848883e0cc89ef2781f8">NO_BLOOM_VERSION</a></div><div class="ttdeci">static const int NO_BLOOM_VERSION</div><div class="ttdoc">&quot;filter*&quot; commands are disabled without NODE_BLOOM after and including this version ...</div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00036">version.h:36</a></div></div>
<div class="ttc" id="ui__interface_8h_html"><div class="ttname"><a href="ui__interface_8h.html">ui_interface.h</a></div></div>
<div class="ttc" id="class_c_validation_state_html_add2b2dc505a8527fda32295b65bb636b"><div class="ttname"><a href="class_c_validation_state.html#add2b2dc505a8527fda32295b65bb636b">CValidationState::CorruptionPossible</a></div><div class="ttdeci">bool CorruptionPossible() const</div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00077">validation.h:77</a></div></div>
<div class="ttc" id="class_c_connman_html_acba1d832c1b35fca5b4624d5979df6ac"><div class="ttname"><a href="class_c_connman.html#acba1d832c1b35fca5b4624d5979df6ac">CConnman::GetExtraOutboundCount</a></div><div class="ttdeci">int GetExtraOutboundCount()</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l02203">net.cpp:2203</a></div></div>
<div class="ttc" id="validation_8h_html_ae034ec95ea656e6d994828c1f5d7d596"><div class="ttname"><a href="validation_8h.html#ae034ec95ea656e6d994828c1f5d7d596">DEFAULT_BANSCORE_THRESHOLD</a></div><div class="ttdeci">static const unsigned int DEFAULT_BANSCORE_THRESHOLD</div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00126">validation.h:126</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_afe7eb24fb43804693ab6c6491f153581"><div class="ttname"><a href="net__processing_8cpp.html#afe7eb24fb43804693ab6c6491f153581">AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</a></div><div class="ttdeci">static constexpr unsigned int AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL</div><div class="ttdoc">Average delay between local address broadcasts in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00118">net_processing.cpp:118</a></div></div>
<div class="ttc" id="random_8h_html"><div class="ttname"><a href="random_8h.html">random.h</a></div></div>
<div class="ttc" id="validation_8h_html_a0a0634a396d3b8ca22455aa4158daf48"><div class="ttname"><a href="validation_8h.html#a0a0634a396d3b8ca22455aa4158daf48">BLOCK_STALLING_TIMEOUT</a></div><div class="ttdeci">static const unsigned int BLOCK_STALLING_TIMEOUT</div><div class="ttdoc">Timeout in seconds during which a peer must stall block download progress before being disconnected...</div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00089">validation.h:89</a></div></div>
<div class="ttc" id="class_c_node_html_a1a1bccbef28288774a6e38ae5a913d49"><div class="ttname"><a href="class_c_node.html#a1a1bccbef28288774a6e38ae5a913d49">CNode::fSendRecSigs</a></div><div class="ttdeci">std::atomic&lt; bool &gt; fSendRecSigs</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00945">net.h:945</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ac1a82e10726a8270c2b47168e86a43d3"><div class="ttname"><a href="namespace_net_msg_type.html#ac1a82e10726a8270c2b47168e86a43d3">NetMsgType::CLSIG</a></div><div class="ttdeci">const char * CLSIG</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00075">protocol.cpp:75</a></div></div>
<div class="ttc" id="validation_8h_html_acc576d09fdf7bf11e878a178f15d4a1a"><div class="ttname"><a href="validation_8h.html#acc576d09fdf7bf11e878a178f15d4a1a">MAX_CMPCTBLOCK_DEPTH</a></div><div class="ttdeci">static const int MAX_CMPCTBLOCK_DEPTH</div><div class="ttdoc">Maximum depth of blocks we&amp;#39;re willing to serve as compact blocks to peers when requested. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00095">validation.h:95</a></div></div>
<div class="ttc" id="version_8h_html_acdca0ff5df4d6afbaca01bcfe83f37ee"><div class="ttname"><a href="version_8h.html#acdca0ff5df4d6afbaca01bcfe83f37ee">SENDDSQUEUE_PROTO_VERSION</a></div><div class="ttdeci">static const int SENDDSQUEUE_PROTO_VERSION</div><div class="ttdoc">introduction of SENDDSQUEUE TODO we can remove this in 0.15.0.0 </div><div class="ttdef"><b>Definition:</b> <a href="version_8h_source.html#l00055">version.h:55</a></div></div>
<div class="ttc" id="classllmq_1_1_c_chain_lock_sig_html"><div class="ttname"><a href="classllmq_1_1_c_chain_lock_sig.html">llmq::CChainLockSig</a></div><div class="ttdef"><b>Definition:</b> <a href="quorums__chainlocks_8h_source.html#l00025">quorums_chainlocks.h:25</a></div></div>
<div class="ttc" id="struct_consensus_1_1_params_html_ad909dd557f5bf211649f95e0d6d3cbd0"><div class="ttname"><a href="struct_consensus_1_1_params.html#ad909dd557f5bf211649f95e0d6d3cbd0">Consensus::Params::hashDevnetGenesisBlock</a></div><div class="ttdeci">uint256 hashDevnetGenesisBlock</div><div class="ttdef"><b>Definition:</b> <a href="params_8h_source.html#l00132">params.h:132</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ab93722c7e784f3a5c110e82eb3c31078"><div class="ttname"><a href="namespace_net_msg_type.html#ab93722c7e784f3a5c110e82eb3c31078">NetMsgType::MNGOVERNANCEOBJECT</a></div><div class="ttdeci">const char * MNGOVERNANCEOBJECT</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00058">protocol.cpp:58</a></div></div>
<div class="ttc" id="class_c_node_html_a283b81dec17d8f75ad4eb9ddc874876b"><div class="ttname"><a href="class_c_node.html#a283b81dec17d8f75ad4eb9ddc874876b">CNode::fSendDSQueue</a></div><div class="ttdeci">std::atomic&lt; bool &gt; fSendDSQueue</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00935">net.h:935</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a4dc585a49c4b1374d2bd49ae4d4569ca"><div class="ttname"><a href="namespace_net_msg_type.html#a4dc585a49c4b1374d2bd49ae4d4569ca">NetMsgType::MNGOVERNANCEOBJECTVOTE</a></div><div class="ttdeci">const char * MNGOVERNANCEOBJECTVOTE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00059">protocol.cpp:59</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a75ab96e2e9fa2a1b1655f0034667604d"><div class="ttname"><a href="namespace_net_msg_type.html#a75ab96e2e9fa2a1b1655f0034667604d">NetMsgType::TX</a></div><div class="ttdeci">const char * TX</div><div class="ttdoc">The tx message transmits a single transaction. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00026">protocol.cpp:26</a></div></div>
<div class="ttc" id="class_c_transaction_html"><div class="ttname"><a href="class_c_transaction.html">CTransaction</a></div><div class="ttdoc">The basic transaction that is broadcasted on the network and contained in blocks. ...</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00198">transaction.h:198</a></div></div>
<div class="ttc" id="class_c_connman_html_a85dedb235a648a1b8370228ba62ebacb"><div class="ttname"><a href="class_c_connman.html#a85dedb235a648a1b8370228ba62ebacb">CConnman::MarkAddressGood</a></div><div class="ttdeci">void MarkAddressGood(const CAddress &amp;addr)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03267">net.cpp:3267</a></div></div>
<div class="ttc" id="class_c_block_index_html_aebfc8d6b95852546760e742553d7bfd5"><div class="ttname"><a href="class_c_block_index.html#aebfc8d6b95852546760e742553d7bfd5">CBlockIndex::nHeight</a></div><div class="ttdeci">int nHeight</div><div class="ttdoc">height of the entry in the chain. The genesis block has height 0 </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00183">chain.h:183</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a3223f6e35a3458b35bee4d9f6771a8ee"><div class="ttname"><a href="net__processing_8cpp.html#a3223f6e35a3458b35bee4d9f6771a8ee">GetObjectRequestTime</a></div><div class="ttdeci">std::chrono::microseconds GetObjectRequestTime(const uint256 &amp;hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00699">net_processing.cpp:699</a></div></div>
<div class="ttc" id="class_c_transaction_html_afcc5960eab9d35f10c6f8e6675bf2a93"><div class="ttname"><a href="class_c_transaction.html#afcc5960eab9d35f10c6f8e6675bf2a93">CTransaction::CURRENT_VERSION</a></div><div class="ttdeci">static const int32_t CURRENT_VERSION</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00202">transaction.h:202</a></div></div>
<div class="ttc" id="class_c_node_html"><div class="ttname"><a href="class_c_node.html">CNode</a></div><div class="ttdoc">Information about a peer. </div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00800">net.h:800</a></div></div>
<div class="ttc" id="class_c_chain_params_html_aa366d4f63c8d16d625336dca61ca65e5"><div class="ttname"><a href="class_c_chain_params.html#aa366d4f63c8d16d625336dca61ca65e5">CChainParams::GetConsensus</a></div><div class="ttdeci">const Consensus::Params &amp; GetConsensus() const</div><div class="ttdef"><b>Definition:</b> <a href="chainparams_8h_source.html#l00054">chainparams.h:54</a></div></div>
<div class="ttc" id="struct_c_node_state_stats_html_a4b03fd8ecaa9268f7eca836e5e79c35a"><div class="ttname"><a href="struct_c_node_state_stats.html#a4b03fd8ecaa9268f7eca836e5e79c35a">CNodeStateStats::vHeightInFlight</a></div><div class="ttdeci">std::vector&lt; int &gt; vHeightInFlight</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00083">net_processing.h:83</a></div></div>
<div class="ttc" id="validation_8cpp_html_a578c1df234b05798180f0235d469a5ba"><div class="ttname"><a href="validation_8cpp.html#a578c1df234b05798180f0235d469a5ba">ReadBlockFromDisk</a></div><div class="ttdeci">bool ReadBlockFromDisk(CBlock &amp;block, const CDiskBlockPos &amp;pos, const Consensus::Params &amp;consensusParams)</div><div class="ttdoc">Functions for disk access for blocks. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l01043">validation.cpp:1043</a></div></div>
<div class="ttc" id="class_c_scheduler_html"><div class="ttname"><a href="class_c_scheduler.html">CScheduler</a></div><div class="ttdef"><b>Definition:</b> <a href="scheduler_8h_source.html#l00037">scheduler.h:37</a></div></div>
<div class="ttc" id="chain_8h_html_a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15"><div class="ttname"><a href="chain_8h.html#a0d8c285f70a59a32f4f6ab41b78f93ada77d49f747f3df764efac2d3f4522bb15">BLOCK_HAVE_DATA</a></div><div class="ttdoc">full block available in blk*.dat </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00154">chain.h:154</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991ae8208d8fb3855c56c3e5befaeb923fa2"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991ae8208d8fb3855c56c3e5befaeb923fa2">MSG_GOVERNANCE_OBJECT</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00410">protocol.h:410</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a19dda2012adbad9f24e0cbd286d08676"><div class="ttname"><a href="namespace_net_msg_type.html#a19dda2012adbad9f24e0cbd286d08676">NetMsgType::QWATCH</a></div><div class="ttdeci">const char * QWATCH</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00068">protocol.cpp:68</a></div></div>
<div class="ttc" id="classunordered__limitedmap_html"><div class="ttname"><a href="classunordered__limitedmap.html">unordered_limitedmap</a></div><div class="ttdoc">STL-like map container that only keeps the N elements with the highest value. </div><div class="ttdef"><b>Definition:</b> <a href="limitedmap_8h_source.html#l00018">limitedmap.h:18</a></div></div>
<div class="ttc" id="consensus_2validation_8h_html_ae08e367e8cda26747c749b3b313a47a1"><div class="ttname"><a href="consensus_2validation_8h.html#ae08e367e8cda26747c749b3b313a47a1">REJECT_MALFORMED</a></div><div class="ttdeci">static const unsigned char REJECT_MALFORMED</div><div class="ttdoc">&quot;reject&quot; message codes </div><div class="ttdef"><b>Definition:</b> <a href="consensus_2validation_8h_source.html#l00012">validation.h:12</a></div></div>
<div class="ttc" id="class_c_node_html_a4f5e98d3083fe8359d4c27d97eb0dcbb"><div class="ttname"><a href="class_c_node.html#a4f5e98d3083fe8359d4c27d97eb0dcbb">CNode::GetAddrName</a></div><div class="ttdeci">std::string GetAddrName() const</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00724">net.cpp:724</a></div></div>
<div class="ttc" id="timedata_8cpp_html_ac2624434f4891e8d74f9b13ec91f95d2"><div class="ttname"><a href="timedata_8cpp.html#ac2624434f4891e8d74f9b13ec91f95d2">AddTimeData</a></div><div class="ttdeci">void AddTimeData(const CNetAddr &amp;ip, int64_t nOffsetSample)</div><div class="ttdef"><b>Definition:</b> <a href="timedata_8cpp_source.html#l00047">timedata.cpp:47</a></div></div>
<div class="ttc" id="validation_8cpp_html_ac309099e8f5fdc0aca4fac91e4264dd2"><div class="ttname"><a href="validation_8cpp.html#ac309099e8f5fdc0aca4fac91e4264dd2">chainActive</a></div><div class="ttdeci">CChain &amp; chainActive</div><div class="ttdoc">The currently-connected chain of blocks (protected by cs_main). </div><div class="ttdef"><b>Definition:</b> <a href="validation_8cpp_source.html#l00217">validation.cpp:217</a></div></div>
<div class="ttc" id="merkleblock_8h_html"><div class="ttname"><a href="merkleblock_8h.html">merkleblock.h</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_ae4af19c6d5d69539afe179b84a91cbad"><div class="ttname"><a href="namespace_net_msg_type.html#ae4af19c6d5d69539afe179b84a91cbad">NetMsgType::SPORK</a></div><div class="ttdeci">const char * SPORK</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00045">protocol.cpp:45</a></div></div>
<div class="ttc" id="class_c_net_msg_maker_html_ac314ab21062f354bbb885e65060b815f"><div class="ttname"><a href="class_c_net_msg_maker.html#ac314ab21062f354bbb885e65060b815f">CNetMsgMaker::Make</a></div><div class="ttdeci">CSerializedNetMsg Make(int nFlags, std::string sCommand, Args &amp;&amp;... args) const</div><div class="ttdef"><b>Definition:</b> <a href="netmessagemaker_8h_source.html#l00018">netmessagemaker.h:18</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a37e6419b0b18c99c5296b5a18c19e954"><div class="ttname"><a href="net__processing_8cpp.html#a37e6419b0b18c99c5296b5a18c19e954">AssertLockHeld</a></div><div class="ttdeci">AssertLockHeld(g_cs_orphans)</div></div>
<div class="ttc" id="class_c_connman_html_a5fdad96946aa2bc67961ad973bf65fa5"><div class="ttname"><a href="class_c_connman.html#a5fdad96946aa2bc67961ad973bf65fa5">CConnman::RelayTransaction</a></div><div class="ttdeci">void RelayTransaction(const CTransaction &amp;tx)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l03465">net.cpp:3465</a></div></div>
<div class="ttc" id="class_c_private_send_broadcast_tx_html_a81c64d79239c3881b8c9131337656ddd"><div class="ttname"><a href="class_c_private_send_broadcast_tx.html#a81c64d79239c3881b8c9131337656ddd">CPrivateSendBroadcastTx::tx</a></div><div class="ttdeci">CTransactionRef tx</div><div class="ttdef"><b>Definition:</b> <a href="privatesend_8h_source.html#l00299">privatesend.h:299</a></div></div>
<div class="ttc" id="class_c_node_html_a923c9640a28f97cf9c23a21ae8e13c97"><div class="ttname"><a href="class_c_node.html#a923c9640a28f97cf9c23a21ae8e13c97">CNode::AddAddressKnown</a></div><div class="ttdeci">void AddAddressKnown(const CAddress &amp;_addr)</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l01021">net.h:1021</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a96443a5441d3ad2850b2fbd7ad468014"><div class="ttname"><a href="net__processing_8cpp.html#a96443a5441d3ad2850b2fbd7ad468014">GUARDED_BY</a></div><div class="ttdeci">std::map&lt; uint256, COrphanTx &gt; mapOrphanTransactions GUARDED_BY(g_cs_orphans)</div></div>
<div class="ttc" id="arith__uint256_8h_html"><div class="ttname"><a href="arith__uint256_8h.html">arith_uint256.h</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a481dcac4bc4d9e82d3785599af5fe6be"><div class="ttname"><a href="net__processing_8cpp.html#a481dcac4bc4d9e82d3785599af5fe6be">GetRequestedObjectCount</a></div><div class="ttdeci">size_t GetRequestedObjectCount(NodeId nodeId)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00807">net_processing.cpp:807</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a90c3cb8c05c52b0c8639d51c87ce7017"><div class="ttname"><a href="class_peer_logic_validation.html#a90c3cb8c05c52b0c8639d51c87ce7017">PeerLogicValidation::InitializeNode</a></div><div class="ttdeci">void InitializeNode(CNode *pnode) override</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00833">net_processing.cpp:833</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_ab4092bed1a4f5967d73212e8b92db3e6"><div class="ttname"><a href="net__processing_8cpp.html#ab4092bed1a4f5967d73212e8b92db3e6">TX_EXPIRY_INTERVAL_FACTOR</a></div><div class="ttdeci">static constexpr int64_t TX_EXPIRY_INTERVAL_FACTOR</div><div class="ttdoc">How long to wait (expiry * factor microseconds) before expiring an in-flight getdata request to a pee...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00073">net_processing.cpp:73</a></div></div>
<div class="ttc" id="net__processing_8h_html_a981e8ad003ae095856a6b97679245be2"><div class="ttname"><a href="net__processing_8h.html#a981e8ad003ae095856a6b97679245be2">STALE_CHECK_INTERVAL</a></div><div class="ttdeci">static constexpr int64_t STALE_CHECK_INTERVAL</div><div class="ttdoc">How frequently to check for stale tips, in seconds. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00034">net_processing.h:34</a></div></div>
<div class="ttc" id="utilstrencodings_8cpp_html_aa179dc54b52ee4d555344dd5472ccb6b"><div class="ttname"><a href="utilstrencodings_8cpp.html#aa179dc54b52ee4d555344dd5472ccb6b">SanitizeString</a></div><div class="ttdeci">std::string SanitizeString(const std::string &amp;str, int rule)</div><div class="ttdoc">Remove unsafe chars. </div><div class="ttdef"><b>Definition:</b> <a href="utilstrencodings_8cpp_source.html#l00024">utilstrencodings.cpp:24</a></div></div>
<div class="ttc" id="class_c_tx_in_html_aed9312051a25380cbd7f123408ab7c20"><div class="ttname"><a href="class_c_tx_in.html#aed9312051a25380cbd7f123408ab7c20">CTxIn::prevout</a></div><div class="ttdeci">COutPoint prevout</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00073">transaction.h:73</a></div></div>
<div class="ttc" id="class_c_node_html_a108e17226d76c85c89f7d057dad2b088"><div class="ttname"><a href="class_c_node.html#a108e17226d76c85c89f7d057dad2b088">CNode::fPauseRecv</a></div><div class="ttdeci">std::atomic_bool fPauseRecv</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00874">net.h:874</a></div></div>
<div class="ttc" id="blockencodings_8h_html_a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812"><div class="ttname"><a href="blockencodings_8h.html#a2454e2824c9d3db86bf62fbc974f50cea2c4369130f1cab4f039ffe2bf247d812">READ_STATUS_INVALID</a></div><div class="ttdef"><b>Definition:</b> <a href="blockencodings_8h_source.html#l00125">blockencodings.h:125</a></div></div>
<div class="ttc" id="validation_8h_html_a41af4f24e6f8ec02a4a6fd7e679acf3d"><div class="ttname"><a href="validation_8h.html#a41af4f24e6f8ec02a4a6fd7e679acf3d">DEFAULT_WHITELISTFORCERELAY</a></div><div class="ttdeci">static const bool DEFAULT_WHITELISTFORCERELAY</div><div class="ttdoc">Default for -whitelistforcerelay. </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00054">validation.h:54</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991aa9afeebb1d379d86fc2fdafedc5fb004"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991aa9afeebb1d379d86fc2fdafedc5fb004">MSG_QUORUM_RECOVERED_SIG</a></div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00423">protocol.h:423</a></div></div>
<div class="ttc" id="transaction_8h_html"><div class="ttname"><a href="transaction_8h.html">transaction.h</a></div></div>
<div class="ttc" id="net_8h_html_af677dfc85dddc429fe0303f338878ec0"><div class="ttname"><a href="net_8h.html#af677dfc85dddc429fe0303f338878ec0">MAX_INV_SZ</a></div><div class="ttdeci">static const unsigned int MAX_INV_SZ</div><div class="ttdoc">The maximum number of entries in an &amp;#39;inv&amp;#39; protocol message. </div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00062">net.h:62</a></div></div>
<div class="ttc" id="class_c_node_html_aa91b5214571b8f195fec1484d4a5b96a"><div class="ttname"><a href="class_c_node.html#aa91b5214571b8f195fec1484d4a5b96a">CNode::nNextInvSend</a></div><div class="ttdeci">std::chrono::microseconds nNextInvSend</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00909">net.h:909</a></div></div>
<div class="ttc" id="serialize_8h_html_a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c"><div class="ttname"><a href="serialize_8h.html#a0ed680fdb405e7195d9f14032851eebba652754eeaf79fba4fcf4c18597a6961c">SER_NETWORK</a></div><div class="ttdef"><b>Definition:</b> <a href="serialize_8h_source.html#l00160">serialize.h:160</a></div></div>
<div class="ttc" id="class_peer_logic_validation_html_a44833df64aa594c24ee271c1ece007ab"><div class="ttname"><a href="class_peer_logic_validation.html#a44833df64aa594c24ee271c1ece007ab">PeerLogicValidation::SendMessages</a></div><div class="ttdeci">bool SendMessages(CNode *pto, std::atomic&lt; bool &gt; &amp;interrupt) override</div><div class="ttdoc">Send queued protocol messages to be sent to a give node. </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03816">net_processing.cpp:3816</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a83f0bd58fd86df5b4dd80afa5818ac5b"><div class="ttname"><a href="namespace_net_msg_type.html#a83f0bd58fd86df5b4dd80afa5818ac5b">NetMsgType::SENDDSQUEUE</a></div><div class="ttdeci">const char * SENDDSQUEUE</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00055">protocol.cpp:55</a></div></div>
<div class="ttc" id="class_c_node_html_ad253434141efcbca34150864069aee7e"><div class="ttname"><a href="class_c_node.html#ad253434141efcbca34150864069aee7e">CNode::nLastBlockTime</a></div><div class="ttdeci">std::atomic&lt; int64_t &gt; nLastBlockTime</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00917">net.h:917</a></div></div>
<div class="ttc" id="class_c_private_send_client_manager_html_a5ffa7ec563a356049bd99301b1d7e55f"><div class="ttname"><a href="class_c_private_send_client_manager.html#a5ffa7ec563a356049bd99301b1d7e55f">CPrivateSendClientManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="privatesend-client_8cpp_source.html#l00027">privatesend-client.cpp:27</a></div></div>
<div class="ttc" id="classllmq_1_1_c_instant_send_manager_html_afa51a454de242fab085d98cdf24f8611"><div class="ttname"><a href="classllmq_1_1_c_instant_send_manager.html#afa51a454de242fab085d98cdf24f8611">llmq::CInstantSendManager::ProcessMessage</a></div><div class="ttdeci">void ProcessMessage(CNode *pfrom, const std::string &amp;strCommand, CDataStream &amp;vRecv, CConnman &amp;connman)</div><div class="ttdef"><b>Definition:</b> <a href="quorums__instantsend_8cpp_source.html#l00668">quorums_instantsend.cpp:668</a></div></div>
<div class="ttc" id="class_c_node_html_aca9fdf7c1fa23060ef2769cc4ec85423"><div class="ttname"><a href="class_c_node.html#aca9fdf7c1fa23060ef2769cc4ec85423">CNode::vInventoryOtherToSend</a></div><div class="ttdeci">std::vector&lt; CInv &gt; vInventoryOtherToSend</div><div class="ttdef"><b>Definition:</b> <a href="net_8h_source.html#l00907">net.h:907</a></div></div>
<div class="ttc" id="class_c_tx_mem_pool_html_a076041ea11b38722d1419c1640bf6ac4"><div class="ttname"><a href="class_c_tx_mem_pool.html#a076041ea11b38722d1419c1640bf6ac4">CTxMemPool::PrioritiseTransaction</a></div><div class="ttdeci">void PrioritiseTransaction(const uint256 &amp;hash, const CAmount &amp;nFeeDelta)</div><div class="ttdoc">Affect CreateNewBlock prioritisation of transactions. </div><div class="ttdef"><b>Definition:</b> <a href="txmempool_8cpp_source.html#l01317">txmempool.cpp:1317</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a8884cd826dfda4930989e342ca8821bb"><div class="ttname"><a href="net__processing_8cpp.html#a8884cd826dfda4930989e342ca8821bb">SendRejectsAndCheckIfBanned</a></div><div class="ttdeci">static bool SendRejectsAndCheckIfBanned(CNode *pnode, CConnman *connman)</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l03510">net_processing.cpp:3510</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a49bc6b19f6102a0e3809e9debbbef3e2"><div class="ttname"><a href="net__processing_8cpp.html#a49bc6b19f6102a0e3809e9debbbef3e2">g_enable_bip61</a></div><div class="ttdeci">bool g_enable_bip61</div><div class="ttdoc">Enable BIP61 (sending reject messages) </div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00080">net_processing.cpp:80</a></div></div>
<div class="ttc" id="class_c_masternode_meta_man_html_ad45986b1df2884b15582cd09e9db2c01"><div class="ttname"><a href="class_c_masternode_meta_man.html#ad45986b1df2884b15582cd09e9db2c01">CMasternodeMetaMan::GetMetaInfo</a></div><div class="ttdeci">CMasternodeMetaInfoPtr GetMetaInfo(const uint256 &amp;proTxHash, bool fCreate=true)</div><div class="ttdef"><b>Definition:</b> <a href="masternode-meta_8cpp_source.html#l00045">masternode-meta.cpp:45</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a060fe6da0466954fc00d0eab78bb8c3d"><div class="ttname"><a href="net__processing_8cpp.html#a060fe6da0466954fc00d0eab78bb8c3d">most_recent_block_hash</a></div><div class="ttdeci">static uint256 most_recent_block_hash</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l01143">net_processing.cpp:1143</a></div></div>
<div class="ttc" id="net_8cpp_html_a0cde2b3256757536c42c0bd3037847d1"><div class="ttname"><a href="net_8cpp.html#a0cde2b3256757536c42c0bd3037847d1">AdvertiseLocal</a></div><div class="ttdeci">void AdvertiseLocal(CNode *pnode)</div><div class="ttdef"><b>Definition:</b> <a href="net_8cpp_source.html#l00209">net.cpp:209</a></div></div>
<div class="ttc" id="class_c_block_index_html_ac8e219a377839d2f9133a4387f46e44e"><div class="ttname"><a href="class_c_block_index.html#ac8e219a377839d2f9133a4387f46e44e">CBlockIndex::nTx</a></div><div class="ttdeci">unsigned int nTx</div><div class="ttdoc">Number of transactions in this block. </div><div class="ttdef"><b>Definition:</b> <a href="chain_8h_source.html#l00199">chain.h:199</a></div></div>
<div class="ttc" id="class_c_block_header_html"><div class="ttname"><a href="class_c_block_header.html">CBlockHeader</a></div><div class="ttdoc">Nodes collect new transactions into a block, hash them into a hash tree, and scan through nonce value...</div><div class="ttdef"><b>Definition:</b> <a href="block_8h_source.html#l00020">block.h:20</a></div></div>
<div class="ttc" id="net__processing_8h_html_ac247f5643d4d6d3ff5830ab7f9d5edb2"><div class="ttname"><a href="net__processing_8h.html#ac247f5643d4d6d3ff5830ab7f9d5edb2">DEFAULT_MAX_ORPHAN_TRANSACTIONS_SIZE</a></div><div class="ttdeci">static const unsigned int DEFAULT_MAX_ORPHAN_TRANSACTIONS_SIZE</div><div class="ttdoc">Default for -maxorphantxsize, maximum size in megabytes the orphan map can grow before entries are re...</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8h_source.html#l00014">net_processing.h:14</a></div></div>
<div class="ttc" id="validation_8h_html_a3db9a6c313045e841191037a97268a96"><div class="ttname"><a href="validation_8h.html#a3db9a6c313045e841191037a97268a96">BLOCK_DOWNLOAD_WINDOW</a></div><div class="ttdeci">static const unsigned int BLOCK_DOWNLOAD_WINDOW</div><div class="ttdoc">Size of the &quot;block download window&quot;: how far ahead of our current height do we fetch? Larger windows tolerate larger download speed differences between peer, but increase the potential degree of disordering of blocks on disk (which make reindexing and pruning harder). </div><div class="ttdef"><b>Definition:</b> <a href="validation_8h_source.html#l00102">validation.h:102</a></div></div>
<div class="ttc" id="class_c_data_stream_html_a4f463dc716dfa40a028d6c08b803aa53"><div class="ttname"><a href="class_c_data_stream.html#a4f463dc716dfa40a028d6c08b803aa53">CDataStream::in_avail</a></div><div class="ttdeci">int in_avail() const</div><div class="ttdef"><b>Definition:</b> <a href="streams_8h_source.html#l00292">streams.h:292</a></div></div>
<div class="ttc" id="net__processing_8cpp_html_a7e96e4902caa364ce092ec3e34a70711"><div class="ttname"><a href="net__processing_8cpp.html#a7e96e4902caa364ce092ec3e34a70711">nMapOrphanTransactionsSize</a></div><div class="ttdeci">size_t nMapOrphanTransactionsSize</div><div class="ttdef"><b>Definition:</b> <a href="net__processing_8cpp_source.html#l00101">net_processing.cpp:101</a></div></div>
<div class="ttc" id="protocol_8h_html_a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33"><div class="ttname"><a href="protocol_8h.html#a7f1603e1604ea41e417c77fdbc9b2991a11f393e43f75b471170b96ce59a07d33">MSG_FILTERED_BLOCK</a></div><div class="ttdoc">Defined in BIP37. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00402">protocol.h:402</a></div></div>
<div class="ttc" id="classllmq_1_1_c_d_k_g_session_manager_html_a030fd2b8cd39c032cddf869eb3e25ef0"><div class="ttname"><a href="classllmq_1_1_c_d_k_g_session_manager.html#a030fd2b8cd39c032cddf869eb3e25ef0">llmq::CDKGSessionManager::AlreadyHave</a></div><div class="ttdeci">bool AlreadyHave(const CInv &amp;inv) const</div><div class="ttdef"><b>Definition:</b> <a href="quorums__dkgsessionmgr_8cpp_source.html#l00106">quorums_dkgsessionmgr.cpp:106</a></div></div>
<div class="ttc" id="block_8h_html"><div class="ttname"><a href="block_8h.html">block.h</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_a75c8dba2361ddda663917c27f14c3a16"><div class="ttname"><a href="namespace_net_msg_type.html#a75c8dba2361ddda663917c27f14c3a16">NetMsgType::FILTERADD</a></div><div class="ttdeci">const char * FILTERADD</div><div class="ttdoc">The filteradd message tells the receiving peer to add a single element to a previously-set bloom filt...</div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00035">protocol.cpp:35</a></div></div>
<div class="ttc" id="class_c_critical_section_html"><div class="ttname"><a href="class_c_critical_section.html">CCriticalSection</a></div><div class="ttdoc">Wrapped mutex: supports recursive locking, but no waiting TODO: We should move away from using the re...</div><div class="ttdef"><b>Definition:</b> <a href="sync_8h_source.html#l00094">sync.h:94</a></div></div>
<div class="ttc" id="utilstrencodings_8cpp_html_a565b3ea015b133d01dc52b4ec6e45f07"><div class="ttname"><a href="utilstrencodings_8cpp.html#a565b3ea015b133d01dc52b4ec6e45f07">itostr</a></div><div class="ttdeci">std::string itostr(int n)</div><div class="ttdef"><b>Definition:</b> <a href="utilstrencodings_8cpp_source.html#l00589">utilstrencodings.cpp:589</a></div></div>
<div class="ttc" id="chain_8cpp_html_abe314b9d901829ab0166322b67cffd70"><div class="ttname"><a href="chain_8cpp.html#abe314b9d901829ab0166322b67cffd70">GetBlockProofEquivalentTime</a></div><div class="ttdeci">int64_t GetBlockProofEquivalentTime(const CBlockIndex &amp;to, const CBlockIndex &amp;from, const CBlockIndex &amp;tip, const Consensus::Params &amp;params)</div><div class="ttdoc">Return the time it would take to redo the work difference between from and to, assuming the current h...</div><div class="ttdef"><b>Definition:</b> <a href="chain_8cpp_source.html#l00136">chain.cpp:136</a></div></div>
<div class="ttc" id="random_8cpp_html_a27d9149d522b1fa87d84e5e9ca902aef"><div class="ttname"><a href="random_8cpp.html#a27d9149d522b1fa87d84e5e9ca902aef">GetRand</a></div><div class="ttdeci">uint64_t GetRand(uint64_t nMax)</div><div class="ttdef"><b>Definition:</b> <a href="random_8cpp_source.html#l00354">random.cpp:354</a></div></div>
<div class="ttc" id="namespace_net_msg_type_html_af9b6c7c7cc77f2f0b6af1949a6ee5920"><div class="ttname"><a href="namespace_net_msg_type.html#af9b6c7c7cc77f2f0b6af1949a6ee5920">NetMsgType::GETBLOCKTXN</a></div><div class="ttdeci">const char * GETBLOCKTXN</div><div class="ttdoc">Contains a BlockTransactionsRequest Peer should respond with &quot;blocktxn&quot; message. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8cpp_source.html#l00041">protocol.cpp:41</a></div></div>
<div class="ttc" id="class_c_message_header_html"><div class="ttname"><a href="class_c_message_header.html">CMessageHeader</a></div><div class="ttdoc">Message header. </div><div class="ttdef"><b>Definition:</b> <a href="protocol_8h_source.html#l00028">protocol.h:28</a></div></div>
<div class="ttc" id="class_c_out_point_html_af131c7194a660558b0ff158f4efa7a28"><div class="ttname"><a href="class_c_out_point.html#af131c7194a660558b0ff158f4efa7a28">COutPoint::hash</a></div><div class="ttdeci">uint256 hash</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8h_source.html#l00029">transaction.h:29</a></div></div>
<div class="ttc" id="policy_8h_html_aefbb84a1c575dfc90d140d06f8c8d1e9"><div class="ttname"><a href="policy_8h.html#aefbb84a1c575dfc90d140d06f8c8d1e9">MAX_STANDARD_TX_SIZE</a></div><div class="ttdeci">static const unsigned int MAX_STANDARD_TX_SIZE</div><div class="ttdoc">The maximum size for transactions we&amp;#39;re willing to relay/mine. </div><div class="ttdef"><b>Definition:</b> <a href="policy_8h_source.html#l00024">policy.h:24</a></div></div>
<div class="ttc" id="class_c_out_point_html_a85f13609edc1f66afe82fb68f28fb8b7"><div class="ttname"><a href="class_c_out_point.html#a85f13609edc1f66afe82fb68f28fb8b7">COutPoint::ToStringShort</a></div><div class="ttdeci">std::string ToStringShort() const</div><div class="ttdef"><b>Definition:</b> <a href="transaction_8cpp_source.html#l00017">transaction.cpp:17</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
		<!-- HTML footer for doxygen 1.8.14-->
		<!-- start footer part -->
		<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
		  <ul>
			<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="net__processing_8cpp.html">net_processing.cpp</a></li>
			<li class="footer">Generated on Mon Nov 2 2020 19:11:13 for Dash Core by
			<a href="http://www.doxygen.org/index.html">
			<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
		  </ul>
		</div>
		</div>
		<div class="ddfooter">
			<div class="footerlicense">Released under the <a href="http://opensource.org/licenses/mit-license.php" target="_blank">MIT license</a></div>
		  </div>
		</div>
	</body>
</html>
